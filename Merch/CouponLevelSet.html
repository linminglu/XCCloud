<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>优惠券优先级设置</title>
    <link rel="stylesheet" href="layui/css/layui.css">
    <link rel="stylesheet" href="layui/css/layui_font.css">
</head>
<body>
<div class="layui-row" style="padding: 10px">
    <form action="" class="layui-form layui-form-pane" >
        <blockquote class="layui-elem-quote" style="text-align: right">
            <button type="button" class="layui-btn layui-btn-normal">查询模板</button>
            <!--<button type="button" class="layui-btn layui-btn-normal add">新增</button>-->
        </blockquote>
        <div class="layui-col-md12 layui-col-lg12 layui-col-sm12">
            <table class="layui-hide" id="fullReductionTable"  lay-filter="fullReductionTable"></table>
        </div>
    </form>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let couponId='';
    let indexLayer;
    //初始化table
    let parm={'obj':{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
        'url':'/XCCloud/Coupon?action=QueryCouponLevel',
        'elem':'#fullReductionTable',
        'cols':[
            {field:'ID', title:'优惠券规则ID', align: 'center', sort: true}
            ,{field:'CouponName',title: '券类型', align: 'center'}
            ,{field:'EntryCouponFlag', title: '是否实物券', align: 'center'}
            ,{field:'CouponTypeStr', title: '券类别', align: 'center'}
            ,{field:'StartDate', title: '开始时间', align: 'center'}
            ,{field:'EndDate', title: '结束时间', align: 'center'}
            ,{field:'CouponLevel', title: '优先级', align: 'center',edit:true}
            ,{field:'Context', title: '备注', align: 'center'}
            ,{fixed: 'right', title: '操作', width:160, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);
    layui.use(['form','layer','table'],function(){
        let form=layui.form;
        let layer=layui.layer;
        let table=layui.table;
       
        table.on('tool(fullReductionTable)',function (obj) {
            let data=obj.data;
            let lay-event=data.event;
             couponId=data.ID
            if(lay-event==='upLevel'){ //升级
                  layer.confirm('确定升级该优惠券吗', function(index)
                    let _obj={'couponId':data.ID,'updateState':'1','userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/Coupon?action=UpdateCouponLevel',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('升级成功',{time:1500},function () {
                                    location.href='CouponLevelSet.html'
                                });
                            } else {
                                layer.msg(data.result_msg||return_msg);
                            }
                        }
                    })
                });

            }else if(lay-event==='downLevel'){ //降级
                    layer.confirm('确定降级该优惠券吗', function(index){
                                    let _obj={'couponId':data.ID,'updateState':'-1','userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                                    let parseJson = JSON.stringify(_obj);
                                    $.ajax({
                                        type:'post',
                                        url:'/XCCloud/Coupon?action=UpdateCouponLevel',
                                        contentType: "application/json; charset=utf-8",
                                        data:{parasJson: parseJson},
                                        success: function (data) {
                                            data = JSON.parse(data);
                                            if (data.result_code == 1) {
                                                layer.msg('降级成功',{time:1500},function () {
                                                    location.href='CouponLevelSet.html'
                                                });
                                            } else {
                                                layer.msg(data.result_msg||return_msg);
                                            }
                                        }
                                    })
                                });
            }
            // body...
        })
    })
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-bg-cyan" lay-event="upLevel"><i class="layui-icon">&#xe642;</i>升级优先级</a>
    <a class="layui-btn layui-btn-xs layui-bg-orange" lay-event="downLevel"><i class="layui-icon">&#xe642;</i>降级优先级</a>

</script>
</html>