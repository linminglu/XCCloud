<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>出库</title>
    <link rel="stylesheet" href="layui/css/layui.css">
    <link rel="stylesheet" href="css/myxc.css">
</head>
<style>
    .layui-table-header  tr th[data-field="0"] div div{display: none}
</style>
<body>
<div class="layui-row settingPage">
    <div class="row-box">
        <div class="layui-col-md12 layui-col-sm12 layui-col-lg12">
            <blockquote class="layui-elem-quote layui-col-md12 layui-col-sm12 layui-col-lg12">
                <div class="layui-form layui-form-pane layui-col-md9" id="form1">
                    <div class="layui-form-item" id="serchMode"></div>
                </div>

                <div class="layui-col-md2" id="form2Box" >
                    <div class="layui-form layui-form-pane" id="form2">
                        <div id="tantion" class="layui-form-item">
                        </div>
                    </div>
                </div>

                <button type="button" class="layui-btn layui-btn-normal layui-col-md1" i18n-content="查询模板" id="searchBtn">查询</button>
            </blockquote>
        </div>
        <div class="layui-col-lg12 layui-col-md12 layui-col-sm12">
            <table class="layui-hide" id="outDepotTable" lay-filter="outDepotTable"></table>

            <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-primary" id="editBtn">修改</button>-->
            <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-danger " id="delBtn">删除</button>-->
            <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-danger layui-hide" id="forbidBtn">禁止入库</button>-->
            <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-danger layui-hide" id="allowBtn">禁止入库</button>-->
            <button type="button" class="layui-btn  layui-btn-sm layui-btn-normal" id="add">出库</button>
        </div>
    </div>
</div>
<!--入库弹出层-->
<div id="openModel" style="display: none;padding: 15px;">
    <div class="layui-card layui-col-md12" style="border: 2px solid #eee;margin-bottom: 15px">
        <div class="layui-card-body">
            <form action="" class="layui-form layui-form-pane">
                <div class="layui-form-item">
                    <div class="layui-inline OrderIDBox">
                        <label class="layui-form-label">出库单号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="OrderID" id="OrderID" class="layui-input"></input>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">出库仓库</label>
                        <div class="layui-input-inline">
                            <select name="DepotID" id="DepotID" lay-filter="DepotID">
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">出库类别</label>
                        <div class="layui-input-inline">
                            <select name="OrderType" id="OrderType" lay-filter="OrderType">
                                <option>-请选择-</option>
                                <option value="0">废品出库</option>
                                <option value="1">转仓出库</option>
                                <option value="2">入库退货</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline layui-hide" id="inDepotIDBox">
                        <label class="layui-form-label">转入仓库</label>
                        <div class="layui-input-inline">
                            <select name="inDepotID" id="inDepotID" lay-filter="inDepotID">
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline layui-inline-last">
                        <label class="layui-form-label">出库总数</label>
                        <div class="layui-input-inline">
                            <input name="OutCount" id="OutCount" class="layui-input" readonly>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item  logisBox">
                    <div class="layui-inline">
                        <label class="layui-form-label">出库总额</label>
                        <div class="layui-input-inline">
                            <input name="OutTotal" id="OutTotal" class="layui-input" readonly>
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label">物流公司</label>
                        <div class="layui-input-inline">
                            <select name="logisticsCompany1" id="logisticsCompany1" lay-filter="logisticsCompany1"></select>
                        </div>
                    </div>
                    <div class="layui-inline layui-inline-last">
                        <label class="layui-form-label">物流单号</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" id="logisticsNote1">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline" style="width: 400px;">
                            <input type="text" class="layui-input" placeholder="输入商品条码或名称" id="goodsName">
                        </div>
                        <div class="layui-input-inline">
                            <button type="button" class="layui-btn layui-btn-normal" id="searchGoods"><i class="layui-icon">&#xe615;</i></button>
                        </div>
                    </div>
                </div>
                <table class="layui-hide" id="goodsStorage" lay-filter="goodsStorage"></table>
                <div class="layui-form-item">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-block">
                        <input name="note" id="note" class="layui-input">
                    </div>
                </div>
                <div style="text-align:center;">
                    <button type="button" class="layui-btn" id="save">确定</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!--礼品列表弹出层-->
<div id="goodsListBox" style="display: none;padding: 15px">
    <table class="layui-hide" id="goodsList" lay-filter="goodsList"></table>
    <div style="text-align:center;margin: 15px 0;">
        <button type="button" class="layui-btn layui-btn-danger" id="closeGoodBtn">取消</button>
        <button type="button" class="layui-btn" id="saveGoodBtn">确定</button>
    </div>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script src="js/searchModel.js"></script>
<script>

    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let merchId=JSON.parse(xc.getStorage('logMsg')).merchId;
    let storeId=JSON.parse(xc.getStorage('logMsg')).storeId;
    let id='';
    let cols=[
        {field:'ID', title:'出库流水号', align: 'center', sort: true}
        ,{field:'OrderID', title:'出库单号', align: 'center', sort: true}
        ,{field:'OrderTypeStr',title: '出库类别', align: 'center', templet: '#changeTime'} //width 支持：数字、百分比和不填写。
        ,{field:'OutCount', title: '出库数量', align: 'center'}
        ,{field:'OutTotal', title: '出库金额', align: 'center'}
        ,{field:'LogName', title: '出库仓库', align: 'center'}
        ,{field:'OPUserName', title: '出库人', align: 'center'}
        ,{field:'StateStr', title: '状态', align: 'center'}
        ,{field:'CheckDate', title: '营业日期', align: 'center'}
        ,{fixed: 'right', title: '操作', width:240, align:'center', toolbar: '#barDemo'}];
    let parm={'obj':{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
        'url':'/XCCloud/GoodsInfo?action=QueryGoodOutOrder',
        'elem':'#outDepotTable',
        'cols':cols
    };
    xc.getInitData(parm);

    let storageGood=[];let index;
    let DepotID='';let OrderType='';
    let logisticsCompany='';
    let inDepotID='';
    layui.use(['form','layer','table'],function () {
        let form=layui.form;
        let layer=layui.layer;
        let table=layui.table;
        let laydate=layui.laydate;
        seachModel({
            'elem1': 'tantion',
            'elem2': 'serchMode',
            'pagename': 'goodOutOrderSearch',
            'processname': 'goodOutOrderSearch',
            'token': token,
            'form': form,
            'layer': layer,
            'laydate':laydate,
            'searchBtn': 'searchBtn',
            'xc':xc,
            'parm':parm
        })
        form.on('select(DepotID)',function (data) {
            DepotID=data.value;
        });
        form.on('select(inDepotID)',function (data) {
            inDepotID=data.value;
        });
        form.on('select(logisticsCompany1)',function (data){
            logisticsCompany1=data.value;
        });
        form.on('select(OrderType)',function (data) {
            OrderType=data.value;
            if(data.value==1){
                inDepotID='';
                $('#inDepotIDBox').removeClass('layui-hide');
                xc.getDepotDic(merchId,storeId,token,layer,form,'inDepotID');
            }
        });
        table.on('edit(goodsStorage)', function(obj){ //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
            let value= obj.value; //得到修改后的值
            let key=obj.field; //当前编辑的字段名
            let index=obj.data.LAY_TABLE_INDEX; //所在行的所有相关数据
            storageGood[index][key]=value;
            if(key=='OutCount'){
                storageGood[index].OutTotal=value*(storageGood[index].OutPrice*100)/100;
                let sumExit=0;let sunTotal=0;
                for(let i in storageGood){
                    sumExit=parseInt(sumExit)+parseInt(storageGood[i].OutCount);
                    sunTotal=parseInt(sunTotal)+parseInt(storageGood[i].OutCount)*parseInt(storageGood[i].OutPrice*100)
                }
                $('#OutCount').val(parseInt(sumExit));
                $('#OutTotal').val(parseInt(sunTotal)/100);
            }
            newFoodLevelTable(table,storageGood,layer,form);
        });
        //事件删除监听
        table.on('tool(goodsStorage)',(obj)=> {
            let data = obj.data;
            let event = obj.event;
            if (event === 'del') { //查看
                for( let  i in storageGood){
                    if(storageGood[i].GoodID==data.GoodID){
                        storageGood.splice(i,1);
                        obj.del();
                    }
                }
            }
        });
        table.on('checkbox(goodsList)', function(obj){
            if(obj.checked){
                storageGood.push({'GoodID':obj.data.GoodID,
                    'Barcode':obj.data.Barcode,
                    'GoodName':obj.data.GoodName,
                    'GoodTypeStr':obj.data.GoodTypeStr,
                    'RemainCount':obj.data.RemainCount,
                    'OutCount':'',
                    'OutPrice':obj.data.InitialAvgValue,
                    'OutTotal':'',
                    'Note':'',
                })
            }else {
                if(storageGood.length>0){
                    let flag=false;
                    for(let i in storageGood){
                        if(storageGood[i].Barcode==obj.data.Barcode){
                            flag=true
                        }
                    }
                    if(flag){
                        storageGood.splice(i,1)
                    }
                }
            }
        });
        //操作主表
        table.on('tool(outDepotTable)',function (obj) {
            let _data=obj.data;
            let layevent=obj.event;
            id=_data.ID;

            if(layevent==='del'){      //删除
                layer.confirm('确定删除此出库信息吗？', function(index){
                    let _obj={'id':_data.ID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/GoodsInfo?action=DelGoodOutOrder',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('删除成功',{time:1500},function () {
                                    location.reload()
                                })
                            } else {
                                layer.msg(data.result_msg);
                            }
                        }
                    })
                })
            }else if(layevent==='check'){//审核
                layer.confirm('确定审核此出库信息吗？', function(index){
                    let _obj={'id':_data.ID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/GoodsInfo?action=CheckGoodOutOrder',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('审核成功',{time:1500},function () {
                                    location.reload()
                                })
                            } else {
                                layer.msg(data.result_msg);
                            }
                        }
                    })
                })
            }else if(layevent==='cancelcheck'){//撤销审核
                layer.confirm('确定撤销审核此出库信息吗？', function(index){
                    let _obj={'id':_data.ID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/GoodsInfo?action=CanGoodOutOrder',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('撤销审核成功',{time:1500},function () {
                                    location.reload()
                                })
                            } else {
                                layer.msg(data.result_msg);
                            }
                        }
                    })
                })
            }
        });
        $('#add').on('click',function () {
            id='';storageGood=[];DepotID=''; OrderType='';logisticsCompany='';
            xc.setSelect('物流公司','logisticsCompany1');
            $('.OrderIDBox').addClass('layui-hide').val('');
            xc.getDepotDic(merchId,storeId,token,layer,form,'DepotID');
            newFoodLevelTable(table,storageGood,layer,form);
            layer.open({
                title:'商品出库',
                type:1,
                area:['1010px','655px'],
                content:$('#openModel')
            })
        });
        //保存出库
        $('#save').on('click',function () {
            let _obj={
                'id':id,
                'merchId':merchId,
                'storeId':storeId,
                'orderID':$('#OrderID').val(),
                'orderType':OrderType,
                'depotId':DepotID,
                'inDepotID':inDepotID,
                'logistType':logisticsCompany1,
                'logistOrderId':$('#logisticsNote1').val(),
                'GoodOutOrderDetail':storageGood,
                'userToken':token,
                'note':$('#note').val(),
                'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parseJson = JSON.stringify(_obj);
            $.ajax({
                type:'post',
                url:'/XCCloud/GoodsInfo?action=SaveGoodOutOrder',
                contentType: "application/json; charset=utf-8",
                data:{parasJson: parseJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.result_code == 1) {
                        layer.msg('操作成功',{time:1500},function () {
                            location.reload();
                        })
                    } else {
                        layer.msg(data.result_msg||data.return_msg);
                    }
                }
            })
        });
        $('#searchGoods').on('click',function () {
            initGoodsTb(layer);
        });
        $('#saveGoodBtn').on('click',function () {
            newFoodLevelTable(table,storageGood,layer,form);
            layer.close(index);
        });
    });
    function initGoodsTb(layer) {
        var searchText=$('#goodsName').val();
        if(DepotID==''){layer.msg('请选择入库仓库')}else {
            var parm={'obj':{'depotId':DepotID,'goodNameOrBarCode':searchText,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
                'url':'/XCCloud/GoodsInfo?action=QueryGoodsStock3',
                'elem':'#goodsList',
                'height':'210px',
                'size':'sm',
                'cols':[  {type:'checkbox'},
                    {field:'GoodID', title: '商品ID', align: 'center'}
                    ,{field:'Barcode', title: '商品条码', align: 'center'}
                    ,{field:'GoodName', title: '商品名称', align: 'center'}
                    ,{field:'GoodTypeStr', title: '商品类别', align: 'center'}
                    ,{field:'InitialAvgValue', title: '库存成本', align: 'center'}
                ]};
            xc.getInitData(parm);
           index= layer.open({
                title:'选择奖品',
                type:1,
                area:'800px',
                offset:'30px',
                content:$('#goodsListBox')
            })
        }
    }
    function newFoodLevelTable(table,arr,layer,form) {
        table.render({
            elem: '#goodsStorage'
            , height:'250px'
            ,size:'sm'
            , data: arr
            , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [[
                 {field:'GoodID', title: '商品ID', align: 'center',width:70}
                ,{field:'Barcode', title: '商品条码', align: 'center'}
                ,{field:'GoodName', title: '商品名称', align: 'center'}
                ,{field:'GoodTypeStr', title: '商品类别', align: 'center'}
                ,{field:'RemainCount', title: '当前库存', align: 'center'}
                ,{field:'OutCount', title: '出库数量', align: 'center',edit:true}
                ,{field:'OutPrice', title: '库存成本', align: 'center'}
                ,{field:'OutTotal', title: '出库金额', align: 'center'}
                ,{field:'Note', title: '备注', align: 'center',edit:true}
                ,{fixed: 'right',title:'操作', width:140, align:'center', toolbar: '#barDemo1'}]]
            , page: {page: true, limits: [5,10, 15, 20]}
            , limit: 5

        });
    }
</script>
<script type="text/html" id="barDemo">
    {{# if(d.State==0){ }}
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"> <i class="layui-icon">&#xe642;</i>删除</a>
    <a class="layui-btn layui-btn-xs layui-bg-orange" lay-event="check"> <i class="layui-icon">&#xe642;</i>审核</a>
    {{# }else if(d.State==1){ }}
    <a class="layui-btn layui-btn-xs layui-bg-orange layui-btn-warm" lay-event="" > <i class="layui-icon">&#xe642;</i>无</a>
    {{# } }}
</script>
<script type="text/html" id="barDemo2">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"> <i class="layui-icon">&#xe642;</i>删除</a>
</script>
<script type="text/html" id="barDemo1">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"> <i class="layui-icon">&#xe642;</i>删除</a>
</script>
</html>