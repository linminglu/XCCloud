<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>礼品调拨</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<body>
    <div class="layui-row">
        <blockquote class="layui-elem-quote" style="text-align:right; padding-right: 100px;">
            <button type="button" id="applyBtn" class="layui-btn layui-btn-normal">申请</button>
            <button type="button" id="searchBtn" class="layui-btn layui-btn-normal">查询</button>
        </blockquote>
        <table class="layui-hide" lay-filter="giftAllocationTB" id="giftAllocationTB"></table>
    </div>
<!--申请-->
    <div id="openModel" style="display:none; padding: 15px;">
        <form action="" class="layui-form layui-form-pane">
            <div class="layui-form-item">
                <!--<div class="layui-inline">-->
                    <!--<label for="" class="layui-form-label">申请仓库</label>-->
                    <!--<div class="layui-input-inline">-->
                        <!--<select name="" id="ApplyDepot"  lay-filter="ApplyDepot">-->
                            <!--<option>-请选择-</option>-->
                            <!--<option value="2">总部向门店派货</option>-->
                            <!--<option value="3">总部向门店申请</option>-->
                        <!--</select>-->
                    <!--</div>-->
                <!--</div>-->
                <div class="layui-inline">
                    <label for="" class="layui-form-label">调拨方式</label>
                    <div class="layui-input-inline">
                        <select name="" id="RequstType" lay-filter="RequstType">
                            <option>-请选择-</option>
                            <option value="2">总部向门店派货</option>
                            <option value="3">总部向门店申请</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label for="" class="layui-form-label">发货仓库</label>
                    <div class="layui-input-inline">
                        <select name="" id="outDepotId" lay-filter="outDepotId">

                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label for="" class="layui-form-label">调拨门店</label>
                    <div class="layui-input-inline">
                        <select name="" id="SendStoreId" lay-filter="SendStoreId"></select>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                   <label for="" class="layui-form-label">调拨原因</label>
                   <div class="layui-input-block" style="width: 838px">
                       <input type="text" class="layui-input" id="RequestReason">
                   </div>
            </div>
            <div class="layui-form-item layui-hide">
                <div class="layui-inline">
                    <label for="" class="layui-form-label">物流公司</label>
                    <div class="layui-input-inline">
                        <select name="" id=""></select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label for="" class="layui-form-label">物流单号</label>
                   <div class="layui-input-inline">
                       <input type="text" class="layui-input">
                   </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <div class="layui-input-inline" style="width: 300px;">
                        <input type="text" class="layui-input" placeholder="请输入商品条码或者名称" id="searchText">
                    </div>
                   <div class="layui-input-inline">
                       <button type="button" id="searchGoodBtn" class="layui-btn layui-btn-normal"><i class="layui-icon">&#xe615;</i></button>
                   </div>
                </div>
            </div>
            <table class="layui-hide" id="giftsList" lay-filter="giftsList"></table>
            <div style="text-align:right;padding-right: 100px;">
                <button type="button" id="submitApply" class="layui-btn layui-btn-normal">确定</button>
            </div>
        </form>
    </div>
<!--弹窗2-->
    <div id="goodsBox" style="display:none; padding: 15px;">
        <table class="layui-hide" id="goodsList" lay-filter="goodsList"></table>
    </div>
<!--审核-->
    <div id="checkModel" style="display:none; padding: 15px;">
        <form action="" class="layui-form layui-form-pane">
            <div class="layui-form-item goodIsAll">
                <label class="layui-form-label">审核结果</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="switch" lay-skin="switch" lay-text="通过|拒绝" id="checkState" lay-filter="checkState">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">审核意见</label>
                <div class="layui-input-block">
                    <input type="text"  class="layui-input" id="checkNote">
                </div>
            </div>
            <div style="text-align:center;">
                <button type="button" class="layui-btn layui-btn-normal" id="submitCheck">确定</button>
            </div>
        </form>
    </div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="edit"><i class="layui-icon">&#xe642;</i>修改</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="check"><i class="layui-icon">&#xe640;</i>审核</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="handle"><i class="layui-icon">&#xe640;</i>处理</a>
</script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let parm={'obj':{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
        'url':'/XCCloud/GoodsInfo?action=QueryGoodRequest',
        'elem':'#giftAllocationTB',
        'cols':[
             {field:'ID', title:'调拨单ID', align: 'center', sort: true}
            ,{field:'RequestTime',title: '申请时间', align: 'center'}
            ,{field:'RequestStore',title: '申请门店', align: 'center'}
            ,{field:'Requester', title: '申请人', align: 'center'}
            ,{field:'RequestDepot', title: '申请仓库', align: 'center'}
            ,{field:'RequstType', title: '调拨方式', align: 'center',templet:'#reqType'}
            ,{field:'State', title: '调拨状态', align: 'center',templet:'#reqState'}
            ,{field:'SendStore', title: '调拨门店', align: 'center'}
            ,{field:'OutDepot', title: '调拨仓库', align: 'center'}
            ,{field:'DealTime', title: '调拨时间', align: 'center'}
            ,{field:'RequestReason', title: '调拨说明', align: 'center'}
            ,{fixed: 'right', title: '操作', width:260, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);
    let requestId;//调拨单号
    let outDepotId;//出库仓库
    let checkState;
   let RequstType;let SendStoreId;let GoodRequests;
    layui.addcss('layui_font.css');
    layui.use(['form','table','layer'],function () {
        let form=layui.form;
        let table=layui.table;
        let layer=layui.layer;
        form.on('select(ApplyDepot)',function (data) {
            RequestDepotId=data.value;
        });
        form.on('select(RequstType)',function (data) {
            RequstType=data.value;
        });
        form.on('select(SendStoreId)',function (data){
            SendStoreId=data.value;
        });
        form.on('switch(checkState)',function (data) {
            if(data.elem.checked){
                checkState=1;
            }else {
                checkState=0;
            }
        });
        //监听选中商品
        table.on('checkbox(goodsList)', function(obj){
            if (obj.type == "all") {
                var csss = $(".layui-table-cell.laytable-cell-checkbox");
                csss.each(function(index, e){
                    e.children[0].checked = false;
                    e.children[1].className="layui-unselect layui-form-checkbox";
                    checkListGoods=[];
                });
            } else {
                if(obj.checked==true){
                    checkListGoods=[{'foodDetailType':2,'ProjectName': obj.data.GoodName,'FoodTypeStr':'商品',
                        'ContainID':obj.data.ID,'WeightValue':obj.data.Price,'ContainCount':1,'Days':''}]
                }else {
                    checkListGoods=[];
                }
                var csss = $(".layui-table-cell.laytable-cell-checkbox");
                csss.each(function(index, e){
                    var dataIndex = e.parentNode.parentNode.getAttribute("data-index");
                    if (dataIndex != null) {
                        if(dataIndex != obj.data.LAY_TABLE_INDEX){
                            e.children[0].checked = false;
                            e.children[1].className="layui-unselect layui-form-checkbox";
                        }
                    } else {
                        e.children[0].checked = false;
                        e.children[1].className="layui-unselect layui-form-checkbox";
                    }
                });
            }
        });
        table.on('tool(giftAllocationTB)', function(obj){
           let _data=obj.data;
           let layevent=obj.event;
            requestId=_data.ID;
            if(layevent==='edit'){

            }else if(layevent==='check'){

            }else if(layevent==='handle'){

            }
        });
        //弹出层
        $('#applyBtn').on('click',function () {
            xc.getDepotDic('','',token,layer,form,'outDepotId');
            xc.GetStoreList(token,layer,form,'SendStoreId');
            layer.open({
                title:'申请记录',
                type:1,
                area:'1000px',
                content:$('#openModel')
            });
            initGoodsTb();
        });
        $('#searchGoodBtn').on('click',function () {
            layer.open({
                title:'库存礼品列表',
                type:1,
                area:['1000px','400px'],
                content:$('#goodsBox')
            });
            initGoodsTb();
        });
        //save apply
       $('#submitApply').on('click',function () {
           let _obj={ 'requestDepot':RequestDepotId,
               'requstType':RequstType,
               'sendStoreId':SendStoreId,
               'requestReason':$('#RequestReason').val(),
               'goodRequests':GoodRequests,
               'userToken':token,
               'signkey':'1f626576304bf5d95b72ece2222e42c3'};
           let url='/XCCloud/GoodsInfo?action=SaveGoodsInfo';
           let parasJson = JSON.stringify(_obj);
           $.ajax({
               type: "post",
               url: url,
               contentType: "application/json; charset=utf-8",
               data: { parasJson: parasJson },
               success: function (data) {
                   data=JSON.parse(data);
                   if(data.result_code==1){
                       layer.msg('保存成功',{time:1000},function () {
                           location.href='giftsAllocation.html'
                       });
                   }else {
                       layer.msg(data.result_msg||data.return_msg)
                   }
               }

           })
       });
       //Handle check
       $('#submitCheck').on('click',function () {
           let _obj={ 'requestId':requestId,
               'state':checkState,
               'note':$('#checkNote').val(),
               'userToken':token,
               'signkey':'1f626576304bf5d95b72ece2222e42c3'};
           let url='/XCCloud/GoodsInfo?action=GoodRequestVerify';
           let parasJson = JSON.stringify(_obj);
           $.ajax({
               type: "post",
               url: url,
               contentType: "application/json; charset=utf-8",
               data: { parasJson: parasJson },
               success: function (data) {
                   data=JSON.parse(data);
                   if(data.result_code==1){
                       layer.msg('保存成功',{time:1000},function () {
                           location.href='giftsAllocation.html'
                       });
                   }else {
                       layer.msg(data.result_msg||data.return_msg)
                   }
               }

           })
       });
    });
    function initGoodsTb() {
        var searchText=$('#searchText').val();
        var parm={'obj':{'goodNameOrBarcode':searchText,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
            'url':'/XCCloud/Promotion?action=GetGoodsInfoList',
            'elem':'#goodsList',
            'height':'210px',
            'cols':[ {field:'ID', title: '商品ID', align: 'center'}
                ,{field:'Barcode', title: '商品条码', align: 'center'}
                ,{field:'GoodName', title: '商品名称', align: 'center'}
                ,{field:'GoodTypeStr', title: '商品类别', align: 'center'}
                ,{field:'Points', title: '申请数量', align: 'center',edit: 'text'}
                ,{field:'Price', title: '库存', align: 'center',edit: 'text'}
                ,{type:'checkbox'}
            ]};
        xc.getInitData(parm);
    }
</script>
<script type="text/html" id="reqType">
    {{# if(d.RequstType==0){ }}
    门店申请
    {{# }else if(d.RequstType==1){ }}
    总部配货
    {{# }else if(d.RequstType==2){ }}
    总部申请
    {{#  } }}
</script>
<script type="text/html" id="reqState">
    {{# if(d.State==0){ }}
    申请
    {{# }else if(d.State==1){ }}
    审核通过
    {{# }else if(d.State==2){ }}
    审核拒绝
    {{# }else if(d.State==3){ }}
    处理
    {{#  } }}
</script>
</html>