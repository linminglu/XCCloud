<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>礼品调拨</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<body>
    <div class="layui-row">
        <blockquote class="layui-elem-quote" style="text-align:right; padding-right: 100px;">
            <button type="button" id="applyBtn" class="layui-btn layui-btn-normal">申请</button>
            <button type="button" id="searchBtn" class="layui-btn layui-btn-normal">查询</button>
        </blockquote>
        <table class="layui-hide" lay-filter="giftAllocationTB" id="giftAllocationTB"></table>
    </div>
<!--申请-->
    <div id="openModel" style="display:none; padding: 15px;">
        <form action="" class="layui-form layui-form-pane">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label for="" class="layui-form-label">调拨方式</label>
                    <div class="layui-input-inline">
                        <select name="" id="RequstType" lay-filter="RequstType">
                            <option>-请选择-</option>
                            <option value="2">总部向门店派货</option>
                            <option value="3">总部向门店申请</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline" id="OutDepBox">
                    <label for="" class="layui-form-label">发货仓库</label>
                    <div class="layui-input-inline">
                        <select name="" id="OutDepotId" lay-filter="OutDepotId">

                        </select>
                    </div>
                </div>
                <div class="layui-inline layui-hide" id="InDepBox">
                    <label for="" class="layui-form-label">申请仓库</label>
                    <div class="layui-input-inline">
                        <select name="" id="InDepotId" lay-filter="InDepotId">

                        </select>
                    </div>
                </div>
                <div class="layui-inline" id="InStoreBox">
                    <label class="layui-form-label">调配门店</label>
                    <div class="layui-input-inline">
                        <select name="" id="InStoreId" lay-filter="InStoreId"></select>
                    </div>
                </div>
                <div class="layui-inline layui-hide" id="OutStoreBox">
                    <label for="" class="layui-form-label">调拨门店</label>
                    <div class="layui-input-inline">
                        <select name="" id="OutStoreId" lay-filter="OutStoreId"></select>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                   <label for="" class="layui-form-label">调拨原因</label>
                   <div class="layui-input-block" style="width: 838px">
                       <input type="text" class="layui-input" id="RequestReason">
                   </div>
            </div>
            <div class="layui-form-item layui-hide">
                <div class="layui-inline">
                    <label for="" class="layui-form-label">物流公司</label>
                    <div class="layui-input-inline">
                        <select name="" id=""></select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label for="" class="layui-form-label">物流单号</label>
                   <div class="layui-input-inline">
                       <input type="text" class="layui-input">
                   </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <div class="layui-input-inline" style="width: 300px;">
                        <input type="text" class="layui-input" placeholder="请输入商品条码或者名称" id="searchText">
                    </div>
                   <div class="layui-input-inline">
                       <button type="button" id="searchGoodBtn" class="layui-btn layui-btn-normal"><i class="layui-icon">&#xe615;</i></button>
                   </div>
                </div>
            </div>
            <table class="layui-hide" id="giftsList" lay-filter="giftsList"></table>
            <div style="text-align:right;padding-right: 100px;">
                <button type="button" id="submitApply" class="layui-btn layui-btn-normal">确定</button>
            </div>
        </form>
    </div>
<!--弹窗2-->
    <div id="goodsBox" style="display:none; padding: 15px;height: 400px;overflow-y: auto">
        <table class="layui-hide" id="goodList" lay-filter="goodList"></table>
        <div style="text-align:center;">
            <button type="button" class="layui-btn layui-btn-normal" id="saveGoodsBtn">保存</button>
        </div>
    </div>
<!--审核-->
    <div id="checkModel" style="display:none; padding: 15px;">
        <form action="" class="layui-form layui-form-pane">
            <div class="layui-form-item goodIsAll">
                <label class="layui-form-label">审核结果</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="switch" lay-skin="switch" lay-text="通过|拒绝" id="checkState" lay-filter="checkState">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">审核意见</label>
                <div class="layui-input-block">
                    <input type="text"  class="layui-input" id="checkNote">
                </div>
            </div>
            <div style="text-align:center;">
                <button type="button" class="layui-btn layui-btn-normal" id="submitCheck">确定</button>
            </div>
        </form>
    </div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="edit"><i class="layui-icon">&#xe642;</i>修改</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="check"><i class="layui-icon">&#xe640;</i>审核</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="handle"><i class="layui-icon">&#xe640;</i>处理</a>
</script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let parm={'obj':{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
        'url':'/XCCloud/GoodsInfo?action=QueryGoodRequest',
        'elem':'#giftAllocationTB',
        'cols':[
             {field:'ID', title:'调拨单ID', align: 'center', sort: true}
            ,{field:'RequestTime',title: '申请时间', align: 'center'}
            ,{field:'RequestStore',title: '申请门店', align: 'center'}
            ,{field:'Requester', title: '申请人', align: 'center'}
            ,{field:'RequestDepot', title: '申请仓库', align: 'center'}
            ,{field:'RequstType', title: '调拨方式', align: 'center',templet:'#reqType'}
            ,{field:'State', title: '调拨状态', align: 'center',templet:'#reqState'}
            ,{field:'SendStore', title: '调拨门店', align: 'center'}
            ,{field:'OutDepot', title: '调拨仓库', align: 'center'}
            ,{field:'DealTime', title: '调拨时间', align: 'center'}
            ,{field:'RequestReason', title: '调拨说明', align: 'center'}
            ,{fixed: 'right', title: '操作', width:260, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);
    let indexer;
    let checkListGoods=[];
    let requestId;//调拨单号

    let checkState;
   let RequstType;
    //出库仓库
   let OutDepotId; let InDepotId;
    let OutStoreId;let InStoreId;
   let GoodRequests;
    layui.addcss('layui_font.css');
    layui.use(['form','table','layer'],function () {
        let form=layui.form;
        let table=layui.table;
        let layer=layui.layer;
        form.on('select(RequstType)',function (data) {
            RequstType=data.value;
            if(data.value==2){
                $('#OutDepBox').removeClass('layui-hide');
                $('#InStoreBox').removeClass('layui-hide');
                $('#InDepBox').addClass('layui-hide');
                $('#OutStoreBox').addClass('layui-hide');
                xc.getDepotDic('','',token,layer,form,'OutDepotId');
                xc.GetStoreList(token,layer,form,'InStoreId');
            }else if(data.value==3){
                $('#OutDepBox').addClass('layui-hide');
                $('#InStoreBox').addClass('layui-hide');
                $('#InDepBox').removeClass('layui-hide');
                $('#OutStoreBox').removeClass('layui-hide');
                xc.getDepotDic('','',token,layer,form,'InDepotId');
                xc.GetStoreList(token,layer,form,'OutStoreId');
            }
            OutDepotId='';InStoreId=''; InDepotId='';OutStoreId='';
        });//调拨方式
        form.on('select(OutDepotId)',function (data) {
            OutDepotId=data.value;
        });//发货仓库
        form.on('select(InDepotId)',function (data) {
            InDepotId=data.value;
        });//发货仓库
        form.on('select(OutStoreId)',function (data){
            OutStoreId=data.value;
        });//调拨门店
        form.on('select(InStoreId)',function (data){
            InStoreId=data.value;
        });//调配门店
        form.on('switch(checkState)',function (data) {
            if(data.elem.checked){
                checkState=1;
            }else {
                checkState=0;
            }
        });
        //监听选中商品
        table.on('checkbox(goodList)', function(obj){
            if (obj.type == "all") {
            } else {
                if(obj.checked==true){
                    let flag=false;
                    for(let i in checkListGoods){
                        if(checkListGoods[i].GoodID==obj.data.GoodID){
                            flag=true;
                            break;
                        }
                    }
                    if(flag==false){
                        checkListGoods.push({
                            'GoodID':obj.data.GoodID,
                            'GoodName':obj.data.GoodName,
                            'requestCount':'',
                            'tax':'',
                            'costPrice':'',
                            'RemainCount':obj.data.RemainCount,
                            'AvailableCount':obj.data.AvailableCount
                        });
                    }
                 
                }else {
                    for(let i in checkListGoods){
                        if(checkListGoods[i].GoodID==obj.data.GoodID){
                            checkListGoods.splice(i,1);
                            break;
                        }
                    }
                }
                console.log(checkListGoods);
            }
        });
        table.on('tool(giftAllocationTB)', function(obj){
           let _data=obj.data;
           let layevent=obj.event;
            requestId=_data.ID;
            if(layevent==='edit'){

            }else if(layevent==='check'){

            }else if(layevent==='handle'){

            }
        });
        table.on('edit(giftsList)', function(obj){ //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
           let value= obj.value; //得到修改后的值
            let key=obj.field; //当前编辑的字段名
            let index=obj.data.LAY_TABLE_INDEX; //所在行的所有相关数据
            checkListGoods[index][key]=value;
            console.log(checkListGoods)
        });
        //弹出层
        $('#applyBtn').on('click',function () {
            xc.getDepotDic('','',token,layer,form,'OutDepotId');
            xc.GetStoreList(token,layer,form,'InStoreId');
            layer.open({
                title:'申请记录',
                type:1,
                area:'1000px',
                content:$('#openModel')
            });
        });
        //
        $('#saveGoodsBtn').on('click',function () {
            initSendTable(table,checkListGoods);
            layer.close(indexer)
        });
        $('#searchGoodBtn').on('click',function () {
            if(RequstType==2){
                initGoodsTb('',OutDepotId,'',table);
            }else if(RequstType==3){
                initGoodsTb('',InDepotId,'',table);
            }else {
                layer.msg('请先选择调拨方式！')
            }
        });
        //save apply
       $('#submitApply').on('click',function () {
           let _outStore;let _outDepot; let _inDepot;


            if(RequstType==2){_outStore=InStoreId; _outDepot=OutDepotId;  _inDepot='';
            }else if(RequstType==3){_outStore=OutStoreId; _outDepot='';  _inDepot=InDepotId;}
           let _obj={
               'requstType':RequstType,
               'outStoreId':_outStore,
               'outDepotId':_outDepot,
               'inDepotId':_inDepot,
               'requestReason':$('#RequestReason').val(),
               'goodRequestDetails':checkListGoods,
               'userToken':token,
               'signkey':'1f626576304bf5d95b72ece2222e42c3'};
           let url='/XCCloud/GoodsInfo?action=GoodRequest';
           let parasJson = JSON.stringify(_obj);
           $.ajax({
               type: "post",
               url: url,
               contentType: "application/json; charset=utf-8",
               data: { parasJson: parasJson },
               success: function (data) {
                   data=JSON.parse(data);
                   if(data.result_code==1){
                       layer.msg('保存成功',{time:1000},function () {
                           location.href='giftsAllocation.html'
                       });
                   }else {
                       layer.msg(data.result_msg||data.return_msg)
                   }
               }

           })
       });
       //Handle check
       $('#submitCheck').on('click',function () {
           let _obj={ 'requestId':requestId,
               'state':checkState,
               'note':$('#checkNote').val(),
               'userToken':token,
               'signkey':'1f626576304bf5d95b72ece2222e42c3'};
           let url='/XCCloud/GoodsInfo?action=GoodRequestVerify';
           let parasJson = JSON.stringify(_obj);
           $.ajax({
               type: "post",
               url: url,
               contentType: "application/json; charset=utf-8",
               data: { parasJson: parasJson },
               success: function (data) {
                   data=JSON.parse(data);
                   if(data.result_code==1){
                       layer.msg('保存成功',{time:1000},function () {
                           location.href='giftsAllocation.html'
                       });
                   }else {
                       layer.msg(data.result_msg||data.return_msg)
                   }
               }

           })
       });
    });
    function initGoodsTb(a,b,c,table) {
        if(b!=''){
            let obj={
                'notGoodIds':a,
                'inOrOutDepotId':b,
                'goodId':c,
                'userToken':token,
                'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parseJson = JSON.stringify(obj);
            var index = layer.load(0, {shade: false});
            $.ajax({
                type: "post",
                url: '/XCCloud/GoodsInfo?action=QueryGoodsStock',
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parseJson},
                success: function (_data) {
                    _data = JSON.parse(_data);
                    if (_data.result_code == 1) {
                        let arr=[];
                         arr = _data.result_data;
                        table.render({
                            elem: '#goodList'
                            , data: arr
                            , height:'220px'
                            , size:'sm'
                            , cellMinWidth: 100 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                            , cols: [[
                                   {type: 'checkbox'}
                                , {field: 'GoodID', title: '商品ID', align: 'center',width:230}
                                , {field: 'GoodName', title: '商品名称', align: 'center',width:230}
                                , {field: 'RemainCount', title: '库存', align: 'center',width:230}
                                , {field: 'AvailableCount', title: '可调拨数量', align: 'center',width:220}
                            ]]
                            , page: {page: true, limits: [5,10, 15, 20, 30, 50]}
                            , limit: 5
                        });
                        layer.close(index);
                    indexer=layer.open({
                            title:'库存礼品列表',
                            type:1,
                            area:['1000px','400px'],
                            content:$('#goodsBox')
                        });
                    }else {
                        layer.close(index);
                        layer.msg(_data.result_msg||_data.return_msg)
                    }
                }
            });
        }else {
            layer.msg('申请仓库或发货仓库不能为空！')
        }
    }
    function initSendTable(table,checkListGood) {
        table.render({
            elem: '#giftsList'
            , data: checkListGood
            , height:'220px'
            , size:'sm'
            , cellMinWidth: 90 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [[
                 {field: 'GoodID', title: '商品ID', align: 'center',width:100}
                , {field: 'GoodName', title: '商品名称', align: 'center',width:100}
                , {field: 'RemainCount', title: '库存', align: 'center',width:100}
                , {field: 'requestCount', title: '申请数量', align: 'center',width:100,edit:true}
                , {field: 'nocostPrice', title: '不含税单价', align: 'center',width:100,edit:true}
                , {field: 'tax', title: '税率%', align: 'center',width:100,edit:true}
                , {field: 'costPrice', title: '含税代价', align: 'center',width:100,edit:true}
                , {field: 'RemainCount', title: '库存', align: 'center',width:100}
                , {field: 'AvailableCount', title: '可调拨数', align: 'center',width:100}

            ]]
            // , page: {page: true, limits: [5,10, 15, 20, 30, 50]}
            // , limit: 5
        });
    }
</script>
<script type="text/html" id="reqType">
    {{# if(d.RequstType==0){ }}
    门店申请
    {{# }else if(d.RequstType==1){ }}
    总部配货
    {{# }else if(d.RequstType==2){ }}
    总部申请
    {{#  } }}
</script>
<script type="text/html" id="reqState">
    {{# if(d.State==0){ }}
    申请
    {{# }else if(d.State==1){ }}
    审核通过
    {{# }else if(d.State==2){ }}
    审核拒绝
    {{# }else if(d.State==3){ }}
    处理
    {{#  } }}
</script>
</html>