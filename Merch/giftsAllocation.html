<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>礼品调拨</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<style>
    .layui-table-view .layui-table[lay-size="sm"] .layui-select-title .layui-input {
        height: 28px;
        margin-top: -8px;
    }
   thead .layui-table-cell .layui-form-checkbox[lay-skin=primary]{display: none}
    .layui-table-view .layui-table[lay-size="sm"] .layui-form-select dl dt, .layui-table-view .layui-form-select dl dd {
        line-height: 28px;
    }

    .layui-table-view .layui-table[lay-size="sm"] .layui-form-select dl {
        top: 28px;
    }

    .layui-table-view .layui-table .layui-select-title .layui-input {
        height: 32px;
        margin-top: -3px;
    }

    .layui-table-view .layui-table .layui-form-select dl dt, .layui-table-view .layui-form-select dl dd {
        line-height: 32px;
    }

    .layui-table-view .layui-table .layui-form-select dl {
        top: 32px;
    }

    .layui-table-view .layui-table[lay-size="lg"] .layui-select-title .layui-input {
        height: 38px;
        margin-top: 0;
    }

    .layui-table-view .layui-table[lay-size="lg"] .layui-form-select dl dt, .layui-table-view .layui-form-select dl dd {
        line-height: 38px;
    }

    .layui-table-view .layui-table[lay-size="lg"] .layui-form-select dl {
        top: 38px;
    }

    /*.tableWithoutHead .layui-table-header {*/
    /*display: none;*/
    /*}*/
</style>
<body>
    <div class="layui-row">
        <blockquote class="layui-elem-quote" style="text-align:right; padding-right: 100px;">
            <button type="button" id="applyBtn" class="layui-btn layui-btn-normal">申请</button>
            <button type="button" id="searchBtn" class="layui-btn layui-btn-normal">查询</button>
        </blockquote>
        <table class="layui-hide" lay-filter="giftAllocationTB" id="giftAllocationTB"></table>
    </div>
<!--申请-->
    <div id="openModel" style="display:none; padding: 15px;">
        <form action="" class="layui-form layui-form-pane">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label  class="layui-form-label">调拨方式</label>
                    <div class="layui-input-inline">
                        <select name="" id="RequstType" lay-filter="RequstType">
                            <option>-请选择-</option>
                            <option value="2">总部向门店派货</option>
                            <option value="3">总部向门店申请</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline layui-hide" id="OutDepBox">
                    <label  class="layui-form-label">发货仓库</label>
                    <div class="layui-input-inline">
                        <select name="" id="OutDepotId" lay-filter="OutDepotId">

                        </select>
                    </div>
                </div>
                <div class="layui-inline " id="InDepBox">
                    <label  class="layui-form-label">申请仓库</label>
                    <div class="layui-input-inline">
                        <select name="" id="InDepotId" lay-filter="InDepotId">

                        </select>
                    </div>
                </div>
                <div class="layui-inline layui-hide" id="InStoreBox">
                    <label class="layui-form-label">调配门店</label>
                    <div class="layui-input-inline">
                        <select name="" id="InStoreId" lay-filter="InStoreId"></select>
                    </div>
                </div>
                <div class="layui-inline " id="OutStoreBox">
                    <label  class="layui-form-label">调拨门店</label>
                    <div class="layui-input-inline">
                        <select name="" id="OutStoreId" lay-filter="OutStoreId"></select>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                   <label  class="layui-form-label">调拨原因</label>
                   <div class="layui-input-block" style="width: 838px">
                       <input type="text" class="layui-input" id="RequestReason">
                   </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <div class="layui-input-inline" style="width: 300px;">
                        <input type="text" class="layui-input" placeholder="请输入商品条码或者名称" id="searchText">
                    </div>
                   <div class="layui-input-inline">
                       <button type="button" id="searchGoodBtn" class="layui-btn layui-btn-normal"><i class="layui-icon">&#xe615;</i></button>
                   </div>
                </div>
            </div>
            <table class="layui-hide" id="giftsList" lay-filter="giftsList"></table>
            <div style="text-align:right;padding-right: 100px;">
                <button type="button" id="submitApply" class="layui-btn layui-btn-normal">确定</button>
            </div>
        </form>
    </div>
<!--弹窗2-->
    <div id="goodsBox" style="display:none; padding: 15px;height: 400px;overflow-y: auto">
        <table class="layui-hide" id="goodList" lay-filter="goodList"></table>
        <div style="text-align:center;">
            <button type="button" class="layui-btn layui-btn-normal" id="saveGoodsBtn">保存</button>
        </div>
    </div>
<!--调拨申请审核-->
    <div id="checkModel" style="display:none; padding: 15px;">
        <form action="" class="layui-form layui-form-pane">
            <div class="layui-form-item goodIsAll">
                <label class="layui-form-label">审核结果</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="switch" lay-skin="switch" lay-text="通过|拒绝" id="checkState" lay-filter="checkState">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">审核意见</label>
                <div class="layui-input-block">
                    <input type="text"  class="layui-input" id="checkNote">
                </div>
            </div>
            <div style="text-align:center;">
                <button type="button" class="layui-btn layui-btn-normal" id="submitCheck">确定</button>
            </div>
        </form>
    </div>
<!--调拨出库-->
   <div id="outModel" style="padding: 15px;display:none;">
       <form action="" class="layui-form layui-form-pane">
           <div class="layui-form-item">
               <div class="layui-inline">
                   <label class="layui-form-label">申请仓库</label>
                   <div class="layui-input-inline">
                       <input type="text" class="layui-input" readonly id="applyDepot">
                   </div>
               </div>
               <div class="layui-inline">
                   <label class="layui-form-label">调拨方式</label>
                   <div class="layui-input-inline">
                       <input type="text" class="layui-input" readonly id="applyWay">
                   </div>
               </div>
               <div class="layui-inline">
                   <label class="layui-form-label">调拨门店</label>
                   <div class="layui-input-inline">
                       <input type="text" class="layui-input" readonly id="applyStore">
                   </div>
               </div>
           </div>
           <div class="layui-form-item">
               <label class="layui-form-label">调拨原因</label>
               <div class="layui-input-block">
                   <input type="text" class="layui-input" readonly id="applyReason">
               </div>
           </div>
           <div class="layui-form-item">
               <div class="layui-inline">
                   <label class="layui-form-label">物流公司</label>
                   <div class="layui-input-inline">
                       <select name="logisticsCompany" id="logisticsCompany" lay-filter="logisticsCompany"></select>
                   </div>
               </div>
               <div class="layui-inline">
                   <label class="layui-form-label">物流单号</label>
                   <div class="layui-input-inline">
                       <input type="text" class="layui-input" id="logisticsNote">
                   </div>
               </div>
           </div>
       </form>
       <table id="SendDealTable" lay-filter="SendDealTable" class="layui-hide"></table>
       <div style="text-align:center;">
           <button type="button" class="layui-btn layui-btn-normal" id="saveSendDeal">确定</button>
       </div>
   </div>
    <!--调拨入库-->
    <div id="inModel" style="padding: 15px;display:none;">
        <form action="" class="layui-form layui-form-pane">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">入库仓库</label>
                    <div class="layui-input-inline">
                        <select name="inDepot" lay-filter="inDepot"  id="inDepot"></select>
                        <input type="text" class="layui-input layui-hide" readonly id="inDepot1">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">调拨方式</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" readonly id="inWay">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">调配门店</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" readonly id="inStore">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">调配原因</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" readonly id="inReason">
                </div>
            </div>
        </form>
        <table id="inDealTable" lay-filter="inDealTable" class="layui-hide"></table>
        <div style="text-align:center;">
            <button type="button" class="layui-btn layui-btn-normal" id="saveInDeal">确定</button>
        </div>
    </div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script type="text/html" id="barDemo">
    {{# if(JSON.stringify(d.PermittedTriggers).indexOf('1')!=-1){ }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="Request">调拨申请</a>
    {{#  } }}
    {{# if(JSON.stringify(d.PermittedTriggers).indexOf('2')!=-1){ }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="RequestVerify">申请审核</a>
    {{#  } }}
    {{# if(JSON.stringify(d.PermittedTriggers).indexOf('3')!=-1){ }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="SendDeal">调拨出库</a>
    {{#  } }}
    {{# if(JSON.stringify(d.PermittedTriggers).indexOf('4')!=-1){ }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="SendDealVerify">出库审核</a>
    {{#  } }}
    {{# if(JSON.stringify(d.PermittedTriggers).indexOf('5')!=-1){ }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="RequestDeal">调拨入库</a>
    {{#  } }}
    {{# if(JSON.stringify(d.PermittedTriggers).indexOf('6')!=-1){ }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="RequestDealVerify">入库审核</a>
    {{#  } }}
    {{# if(JSON.stringify(d.PermittedTriggers).indexOf('7')!=-1){ }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="Cancel">撤销</a>
    {{#  } }}
    {{# if(JSON.stringify(d.PermittedTriggers).indexOf('8')!=-1){ }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="Close">流程关闭</a>
    {{#  } }}
</script>
<script type="text/html" id="barDemo1">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
</script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let parm={'obj':{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
        'url':'/XCCloud/GoodsInfo?action=QueryGoodRequest',
        'elem':'#giftAllocationTB',
        'cols':[
             {field:'ID', title:'调拨单ID', align: 'center', sort: true}
            ,{field:'RequestCode',title: '调拨单号', align: 'center'}
            ,{field:'CreateTime',title: '申请时间', align: 'center'}
            ,{field:'CreateStore',title: '申请门店', align: 'center'}
            ,{field:'CreateUser', title: '申请人', align: 'center'}
            ,{field:'RequstTypeStr', title: '调拨方式', align: 'center'}
            ,{field:'OutStoreName', title: '调拨出库门店', align: 'center'}
            ,{field:'OutDepotName', title: '调拨出库仓库', align: 'center',templet:'#reqState'}
            ,{field:'OutDepotTime', title: '出库时间', align: 'center'}
            ,{field:'InStoreName', title: '调拨入库门店', align: 'center'}
            ,{field:'InDepotName', title: '调拨入库仓库', align: 'center'}
            ,{field:'InDepotTime', title: '入库时间', align: 'center'}
            ,{field:'StateStr', title: '调拨状态', align: 'center'}
            ,{field:'Note', title: '调拨说明', align: 'center'}
            ,{fixed: 'right', title: '操作', width:260, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);
    let logMsg=JSON.parse(xc.getStorage('logMsg'));
    if(logMsg.logType==2){
        $('#RequstType').html('<option>-请选择-</option><option value="0">门店向门店申请</option><option value="1">门店向总部申请</option>')

    }else if(logMsg.logType==3){
        $('#RequstType').html('<option>-请选择-</option><option value="2">总部向门店派货</option><option value="3">总部向门店申请</option>')
    }
    let indexer;
    let checkListGoods=[];
    let notGoodId=[];//不查询的商品id集合
    let requestId;//调拨单号
    let checkState=0;
    let RequstType;
    //出库仓库
    let OutDepotId; let InDepotId;
    let OutStoreId;let InStoreId;
    let GoodRequests;
    //调拨出库
    let checkStatus;
    let newArr=[];
    let depotList=[];//仓库列表
    let logisticsCompany='';
    //调拨入库
    let inDepotArr=[];let inDepot='';
    let __obj={'merchId':JSON.parse(xc.getStorage('logMsg')).MerchID,
        'storeId':JSON.parse(xc.getStorage('logMsg')).StoreID,
        'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
    let parseJson = JSON.stringify(__obj);
    $.ajax({
        type:'post',
        url:'/XCCloud/DepotInfo?action=GetDepotDic',
        contentType: "application/json; charset=utf-8",
        data:{parasJson: parseJson},
        success: function (data) {
            data = JSON.parse(data);
            if (data.result_code == 1) {
                depotList=data.result_data;
                console.log(depotList)
            } else {
                layer.msg(data.result_msg||data.return_msg);
            }
        }
    });

    layui.addcss('layui_font.css');
    layui.use(['form','table','layer'],function () {
        let form=layui.form;
        let table=layui.table;
        let layer=layui.layer;
        form.on('select(RequstType)',function (data) {
            RequstType=data.value;
            if(data.value==2){
                $('#OutDepBox').removeClass('layui-hide');
                $('#InStoreBox').removeClass('layui-hide');
                $('#InDepBox').addClass('layui-hide');
                $('#OutStoreBox').addClass('layui-hide');
                xc.getDepotDic('','',token,layer,form,'OutDepotId');
                xc.GetUnderStores(token,layer,form,'InStoreId',logMsg.storeId);
            }else if(data.value==3){
                $('#OutDepBox').addClass('layui-hide');
                $('#InStoreBox').addClass('layui-hide');
                $('#InDepBox').removeClass('layui-hide');
                $('#OutStoreBox').removeClass('layui-hide');
                xc.getDepotDic('','',token,layer,form,'InDepotId');
                xc.GetUnderStores(token,layer,form,'OutStoreId',logMsg.storeId);
            }else if(data.value==0){
                $('#InDepBox').removeClass('layui-hide');
                $('#OutStoreBox').removeClass('layui-hide');
                $('#InStoreBox').addClass('layui-hide');
                $('#OutDepBox').addClass('layui-hide');
                xc.getDepotDic('','',token,layer,form,'InDepotId');
                xc.GetUnderStores(token,layer,form,'OutStoreId',logMsg.storeId);
            }else if(data.value==1){
                $('#InDepBox').removeClass('layui-hide');
                $('#OutStoreBox').addClass('layui-hide');
                $('#InStoreBox').addClass('layui-hide');
                $('#OutDepBox').addClass('layui-hide');
                xc.getDepotDic('','',token,layer,form,'InDepotId');
            }
            OutDepotId='';InStoreId=''; InDepotId='';OutStoreId='';checkListGoods=[];notGoodId=[];
            table.render({
                elem: '#giftsList'
                , data: []
                , height:'220px'
                , size:'sm'
                , cellMinWidth: 90 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                , cols: [[
                    {field: 'GoodID', title: '商品ID', align: 'center',width:100}
                    , {field: 'GoodName', title: '商品名称', align: 'center',width:100}
                    , {field: 'RequestCount', title: '申请数量', align: 'center',width:100,edit:true}
                    , {field: 'RemainCount', title: '库存', align: 'center',width:100}
                    , {field: 'AvailableCount', title: '可调拨数', align: 'center',width:100}

                ]]
            });
        });//调拨方式
        form.on('select(OutDepotId)',function (data) {
            OutDepotId=data.value;
        });//发货仓库
        form.on('select(InDepotId)',function (data) {
            InDepotId=data.value;
        });//发货仓库
        form.on('select(OutStoreId)',function (data){
            OutStoreId=data.value;
        });//调拨门店
        form.on('select(InStoreId)',function (data){
            InStoreId=data.value;
        });//调配门店
        form.on('switch(checkState)',function (data) {
            if(data.elem.checked){
                checkState=1;
            }else {
                checkState=0;
            }
        });
        //监听选中商品
        table.on('checkbox(goodList)', function(obj){
            if (obj.type == "all") {
            } else {
                if(obj.checked==true){
                    let flag=false;
                    for(let i in checkListGoods){
                        if(checkListGoods[i].GoodID==obj.data.GoodID){
                            flag=true;
                            break;
                        }
                    }
                    if(flag==false){
                        if(RequstType==2||RequstType==3){
                            checkListGoods.push({
                                'GoodID':obj.data.GoodID,
                                'GoodName':obj.data.GoodName,
                                'RequestCount':'',
                                'Tax':'',
                                'NoCostPrice':'',
                                'CostPrice':'',
                                'SendCount':'',
                                'RemainCount':obj.data.RemainCount,
                                'AvailableCount':obj.data.AvailableCount
                            });
                        }else if(RequstType==0||RequstType==1){
                            checkListGoods.push({
                                'GoodID':obj.data.GoodID,
                                'GoodName':obj.data.GoodName,
                                'RequestCount':'',
                                'Tax':'',
                                'RemainCount':obj.data.RemainCount,
                                'AvailableCount':obj.data.AvailableCount
                            });
                        }

                    }
                 
                }else {
                    for(let i in checkListGoods){
                        if(checkListGoods[i].GoodID==obj.data.GoodID){
                            checkListGoods.splice(i,1);
                            break;
                        }
                    }
                }
            }
        });

        //商品出库申请
        form.on('select(testSelect)', function (data) {
            var elem = $(data.elem);
            var trElem = elem.parents('tr');
            var tableData = table.cache['SendDealTable'];
            // 更新到表格的缓存数据中，才能在获得选中行等等其他的方法中得到更新之后的值
            tableData[trElem.data('index')][elem.attr('name')] = data.value;
            let _outDepotId=data.value;
            let obj={'DepotId':data.value,
                'goodNameOrBarCode':trElem[0].children[0].firstChild.innerHTML,
                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parseJson = JSON.stringify(obj);
            $.ajax({
                type:'post',
                url:'/XCCloud/GoodsInfo?action=QueryGoodsStock',
                contentType: "application/json; charset=utf-8",
                data:{parasJson: parseJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.result_code == 1) {
                    if(data.result_data.length>0){
                        trElem[0].children[6].firstChild.innerHTML=data.result_data[0].AvailableCount
                        for(let i in newArr){
                            if(newArr[i].Barcode==trElem[0].children[0].firstChild.innerHTML){
                                newArr[i].outDepotId=_outDepotId;
                                newArr[i].RequestCount=data.result_data[0].AvailableCount;
                            }
                        }
                    }else {
                        trElem[0].children[6].firstChild.innerHTML=0;
                        for(let i in newArr){
                            if(newArr[i].Barcode==trElem[0].children[0].firstChild.innerHTML){
                                newArr[i].outDepotId=_outDepotId;
                                newArr[i].RequestCount='0';
                            }
                        }
                    }
                    } else {
                        layer.msg(data.result_msg||data.return_msg);
                    }
                }
            });
        });
        table.on('edit(SendDealTable)', function(obj){ //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
            for(let i in newArr){
                if(newArr[i].Barcode==obj.data.Barcode){
                    newArr[i][obj.field]=obj.value
                }
            }
        });
        form.on('select(logisticsCompany)',function (data){
            logisticsCompany=data.value;
        });

        table.on('tool(giftAllocationTB)', function(obj){
           let _data=obj.data;
           let layevent=obj.event;
            requestId=_data.ID;
            if(layevent==='Request'){//调拨申请

            }else if(layevent==='RequestVerify'){//申请审核
                checkStatus='apply';
                checkState=0;
                $('#checkState').attr({'checked':false});
                form.render();
                layer.open({
                    title:'调拨申请审核',
                    type:1,
                    area:'700px',
                    content:$('#checkModel')
                })
            }else if(layevent==='SendDeal'){//调拨出库
                newArr=[];
                let _obj={
                    'requestId':requestId, 'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let url='/XCCloud/GoodsInfo?action=GetGoodSendDealInfo';
                let parasJson = JSON.stringify(_obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: { parasJson: parasJson },
                    success: function (data) {
                        data=JSON.parse(data);
                        console.log(data)
                        if(data.result_code==1){
                           let arr=data.result_data.GoodRequestDetails;
                           if(arr.length>0){
                               for(i in arr){
                                   arr[i].outDepotId='';
                                   // arr[i].RequestCount='';//申请拨数
                                   arr[i].SendCount='';//调拨数量
                                   arr[i].Price='';//不含税单价
                                   arr[i].Tax='';//税率
                                   arr[i].CostPrice='';//含税单价
                                   newArr.push(arr[i])
                               }
                           }
                            table.render({
                                elem: '#SendDealTable'
                                , height:'300px'
                                , size:"sm"
                                , data: newArr
                                , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                , cols: [[
                                     // {type:'checkbox',fixed: 'left'} ,
                                     {field:'Barcode', title:'商品条码', align: 'center',width:170,fixed: 'left'}
                                    ,{field:'GoodName',title: '商品类别', align: 'center',width:120,fixed: 'left'} //width 支持：数字、百分比和不填写。
                                    ,{field:'GoodTypeStr', title: '商品类别', align: 'center',width:100,fixed: 'left'}
                                    ,{field:'RequestCount', title: '申请数量', align: 'center'}
                                    ,{field:'FinishCount', title: '已调拨数量', align: 'center'}
                                    ,{field:'outDepotId', title: '调拨仓库', align: 'center'
                                        , templet:function (d) {
                                            let _select='<select name="outDepotId" lay-filter="testSelect" lay-verify="required" data-value="' + d.outDepotId + '" ><option value=""></option>'
                                            for(i in depotList){
                                                if(d.outDepotId==depotList[i].ID){
                                                    _select+='<option value="'+depotList[i].ID+'" selected>'+depotList[i].DepotName+'</option>'
                                                }else {
                                                    _select+='<option value="'+depotList[i].ID+'">'+depotList[i].DepotName+'</option>'
                                                }

                                            }
                                            _select+='</select>';
                                            return _select;
                                        }}
                                    ,{field:'AvailableCount', title: '可调拨数', align: 'center'}
                                    ,{field:'SendCount', title: '调拨数量', align: 'center',edit:true}
                                    ,{field:'Price', title: '不含税单价', align: 'center',edit:true}
                                    ,{field:'Tax', title: '税率', align: 'center',edit:true}
                                    ,{field:'CostPrice', title: '含税单价', align: 'center',edit:true}
                                    // ,{fixed: 'right',title:'操作', width:140, align:'center', toolbar: '#barDemo2'}
                                    ]]
                                , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                                , limit: 10
                                ,done: function (res, curr, count) {
                                    var tableElem = this.elem.next('.layui-table-view');
                                    count || tableElem.find('.layui-table-header').css('overflow', 'auto');
                                    layui.each(tableElem.find('select'), function (index, item) {
                                        var elem = $(item);
                                        elem.val(elem.data('value')).parents('div.layui-table-cell').css('overflow', 'visible');
                                    });
                                    form.render();
                                }
                            });
                            $('#applyDepot').val(_data.InStoreName);
                            $('#applyWay').val(_data.RequstTypeStr);
                            $('#applyStore').val(_data.OutStoreName);
                            $('#applyReason').val(_data.RequestReason);
                             OutDepotId=data.result_data.OutDepotID||'';
                              InDepotId=data.result_data.InDepotID||'';
                             OutStoreId=data.result_data.OutStoreID||'';
                             InStoreId=data.result_data.InStoreID||'';
                            requestId=data.result_data.ID;
                            xc.setSelect('物流公司','logisticsCompany');
                            layer.open({
                                title:'调拨出库',
                                type:1,
                                area:'1000px',
                                content:$('#outModel')
                            })
                        }else {
                            layer.msg(data.result_msg||data.return_msg)
                        }
                    }

                });
            }else if(layevent==='SendDealVerify'){//调拨出库审核
                checkStatus='out';
                checkState=0;
                $('#checkState').attr({'checked':false});
                form.render();
                layer.open({
                    title:'调拨出库审核',
                    type:1,
                    area:'700px',
                    content:$('#checkModel')
                })
            }else if(layevent==='RequestDeal'){//调拨入库
                let _obj={
                    'requestId':requestId, 'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let url='/XCCloud/GoodsInfo?action=GetGoodRequestDealInfo';
                let parasJson = JSON.stringify(_obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: { parasJson: parasJson },
                    success: function (data) {
                        data=JSON.parse(data);
                        if(data.result_code==1){
                            let arr=data.result_data.GoodRequestDetails;
                            table.render({
                                elem: '#inDealTable'
                                , height:'300px'
                                , size:"sm"
                                , data: arr
                                , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                , cols: [[
                                    {type:'checkbox',fixed: 'left'} ,
                                    {field:'ID', title: '调拨ID', align: 'center'}
                                    ,{field:'GoodID', title: '商品ID', align: 'center'}
                                    , {field:'Barcode', title:'商品条码', align: 'center',width:170}
                                    ,{field:'GoodName',title: '商品类别', align: 'center',width:120} //width 支持：数字、百分比和不填写。
                                    ,{field:'GoodTypeStr', title: '商品类别', align: 'center',width:100}
                                    ,{field:'RequestCount', title: '申请数量', align: 'center'}
                                    ,{field:'SendCount', title: '实发数量', align: 'center'}
                                    ,{field:'StorageCount', title: '入库数量', align: 'center',edit:true}
                                    ,{field:'CostPrice', title: '含税单价', align: 'center'}
                                    ,{field:'Tax', title: '税率', align: 'center'}
                                ]]
                                , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                                , limit: 10
                            });
                            OutDepotId=data.result_data.OutDepotID||'';
                            InDepotId=data.result_data.InDepotID||'';
                            OutStoreId=data.result_data.OutStoreID||'';
                            InStoreId=data.result_data.InStoreID||'';


                            if(data.result_data.RequstType==2){
                                xc.getDepotDic('','',token,layer,form,'inDepot');
                                $('#inDepot').removeClass('layui-hide');
                                $('#inDepot1').addClass('layui-hide');
                                inDepot='';
                            }else {
                                $('#inDepot1').val(_data.InDepotName).removeClass('layui-hide');
                                $('#inDepot1').addClass('layui-hide');
                                inDepot=InDepotId;
                            }

                            $('#inWay').val(_data.RequstTypeStr);
                            $('#inStore').val(_data.InStoreName);
                            $('#inReason').val(_data.RequestReason);
                            layer.open({
                                title:'调拨入库',
                                type:1,
                                area:'1000px',
                                content:$('#inModel')
                            })
                        }else {
                            layer.msg(data.result_msg||data.return_msg)
                        }
                    }

                });
            }else if(layevent==='RequestDealVerify'){//调拨入库审核
                checkStatus='in';
                checkState=0;
                $('#checkState').attr({'checked':false});
                form.render();
                layer.open({
                    title:'调拨入库审核',
                    type:1,
                    area:'700px',
                    content:$('#checkModel')
                })
            }else if(layevent==='Cancel'){//撤销

            }else if(layevent==='Close'){//调拨流程关闭
                layer.confirm('是否确定关闭该流程', function(index){
                    var _obj={'requestID':requestId,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    var url='/XCCloud/GoodsInfo?action=GoodRequestClose';
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type: "post",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: {parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            console.log(data);
                            if (data.result_code == 1) {
                                layer.msg('关闭成功！',{time:1500},function () {
                                   location.reload()
                                });
                            } else {
                                layer.msg(data.result_msg||data.return_msg);
                            }
                        }
                    })
                });
            }
        });
        table.on('edit(giftsList)', function(obj){ //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
           let value= obj.value; //得到修改后的值
            let key=obj.field; //当前编辑的字段名
            let index=obj.data.LAY_TABLE_INDEX; //所在行的所有相关数据
            checkListGoods[index][key]=value;
        });
        //监听选中入库商品
        table.on('checkbox(inDealTable)', function(obj){
            if (obj.type == "all") {
                console.log(obj)
            } else {
                if(inDepotArr.length>0){
                    if(obj.checked==true){
                        let flag=false;
                        for(let i in inDepotArr){
                            if(inDepotArr[i].GoodID==obj.data.GoodID){
                                flag=true;
                                break;
                            }
                        }
                        if(flag==false){
                            inDepotArr.push({
                                'GoodID':obj.data.GoodID,
                                'ID':obj.data.ID,
                                'StorageCount':obj.data.StorageCount,
                            });
                        }

                    }else {
                        for(let i in inDepotArr){
                            if(inDepotArr[i].GoodID==obj.data.GoodID){
                                inDepotArr.splice(i,1);
                                break;
                            }
                        }
                    }
                }else {
                    inDepotArr.push({
                        'GoodID':obj.data.GoodID,
                        'ID':obj.data.ID,
                        'StorageCount':obj.data.StorageCount,
                    });
                }

            }
        });
        form.on('select(inDepot)',function (data){
            inDepot=data.value;
        });//
        //监听修改入库实发数
        table.on('edit(inDealTable)', function(obj){ //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
            for(let i in inDepotArr){
                if(inDepotArr[i].GoodID==obj.data.GoodID){
                    inDepotArr[i][obj.field]=obj.value
                }
            }
        });
        //删除调拨商品
        table.on('tool(giftsList)', function(obj){
            let _data=obj.data;
            let layevent=obj.event;
            if(layevent==='del'){//调拨流程关闭
                for(let i in checkListGoods){
                    if(_data.GoodID==checkListGoods[i].GoodID){
                        checkListGoods.splice(i,1);
                        obj.del();
                    }
                }
               for(let i in notGoodId){
                   if(_data.GoodID==notGoodId[i]){
                       notGoodId.splice(i,1)
                   }
               }
            }
        });
        //弹出层
        $('#applyBtn').on('click',function () {
            xc.getDepotDic('','',token,layer,form,'OutDepotId');
            xc.GetUnderStores(token,layer,form,'InStoreId',logMsg.storeId);
            layer.open({
                title:'申请记录',
                type:1,
                area:'1000px',
                content:$('#openModel'),
                cancel:function () {
                    location.reload();
                }
            });
        });
        $('#saveGoodsBtn').on('click',function () {
            if(checkListGoods.length>0){
                initSendTable(table,checkListGoods,RequstType);
                notGoodId =[];
                for(let i in checkListGoods){
                    notGoodId.push(checkListGoods[i].GoodID);
                }
                layer.close(indexer)
            }else {
                layer.msg('请选择商品')
            }
        });
        $('#searchGoodBtn').on('click',function () {
            if(RequstType==2){
                initGoodsTb(RequstType,notGoodId.length==0?'':notGoodId.join('|'),OutDepotId,'',table,logMsg.merchId,'');
            }else if(RequstType==0||RequstType==1||RequstType==3){

                initGoodsTb(RequstType,notGoodId.length==0?'':notGoodId.join('|'),InDepotId,'',table,logMsg.merchId,OutStoreId);
            }else {
                layer.msg('请先选择调拨方式！')
            }
        });
        //save apply
       $('#submitApply').on('click',function () {
           let _obj={
               'requstType':RequstType,
               'outStoreId':OutStoreId,
               'inStoreId':InStoreId,
               'outDepotId':OutDepotId,
               'inDepotId':InDepotId,
               'requestReason':$('#RequestReason').val(),
               'goodRequestDetails':checkListGoods,
               'note':$('#Note').val(),
               'userToken':token,
               'signkey':'1f626576304bf5d95b72ece2222e42c3'};
           let url='/XCCloud/GoodsInfo?action=GoodRequest';
           let parasJson = JSON.stringify(_obj);
           $.ajax({
               type: "post",
               url: url,
               contentType: "application/json; charset=utf-8",
               data: { parasJson: parasJson },
               success: function (data) {
                   data=JSON.parse(data);
                   if(data.result_code==1){
                       layer.msg('保存成功',{time:1800},function () {
                           location.reload();
                       });
                   }else {
                       layer.msg(data.result_msg||data.return_msg)
                   }
               }

           })
       });
       //Handle check
       $('#submitCheck').on('click',function () {

           let _obj={ 'requestId':requestId,
               'state':checkState,
               'note':$('#checkNote').val(),
               'userToken':token,
               'signkey':'1f626576304bf5d95b72ece2222e42c3'};
           let url;
           if( checkStatus=='apply'){
               url='/XCCloud/GoodsInfo?action=GoodRequestVerify';
           }else  if( checkStatus=='out'){
               url='/XCCloud/GoodsInfo?action=GoodSendDealVerify'
           }
           else  if( checkStatus=='in'){

           }
           let parasJson = JSON.stringify(_obj);
           $.ajax({
               type: "post",
               url: url,
               contentType: "application/json; charset=utf-8",
               data: { parasJson: parasJson },
               success: function (data) {
                   data=JSON.parse(data);
                   if(data.result_code==1){
                       layer.msg('保存成功',{time:1000},function () {
                           location.href='giftsAllocation.html'
                       });
                   }else {
                       layer.msg(data.result_msg||data.return_msg)
                   }
               }

           })
       });
       //保存调拨出库
        $('#saveSendDeal').on('click',function () {
            let _obj={ 'requestId':requestId,
                'logistType':logisticsCompany,
                'logistOrderId':$('#logisticsNote').val(),
                'goodRequestDetails':newArr,
                'userToken':token,
                'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let url='/XCCloud/GoodsInfo?action=GoodSendDeal';
            let parasJson = JSON.stringify(_obj);
            $.ajax({
                type: "post",
                url: url,
                contentType: "application/json; charset=utf-8",
                data: { parasJson: parasJson },
                success: function (data) {
                    data=JSON.parse(data);
                    if(data.result_code==1){
                        layer.msg('保存成功',{time:1000},function () {
                            location.href='giftsAllocation.html'
                        });
                    }else {
                        layer.msg(data.result_msg||data.return_msg)
                    }
                }

            })
        });
        //保存调拨出库
        $('#saveInDeal').on('click',function () {
            let _obj={ 'requestId':requestId,
                'inDepotId':inDepot,
                'goodRequestDetails':inDepotArr,
                'userToken':token,
                'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let url='/XCCloud/GoodsInfo?action=GoodRequestDeal';
            let parasJson = JSON.stringify(_obj);
            $.ajax({
                type: "post",
                url: url,
                contentType: "application/json; charset=utf-8",
                data: { parasJson: parasJson },
                success: function (data) {
                    data=JSON.parse(data);
                    if(data.result_code==1){
                        layer.msg('保存成功',{time:1000},function () {
                            location.href='giftsAllocation.html'
                        });
                    }else {
                        layer.msg(data.result_msg||data.return_msg)
                    }
                }

            })
        });
    });
    function initGoodsTb(requestType,a,b,c,table,merchId,storeID) {
        let obj;
        // if(b!=''){
            if(requestType==1){
                obj={
                    'merchId':merchId,
                    'storeId':'',
                    'depotId':'',
                    'notGoodIds':a,
                    'goodId':c,
                    'userToken':token,
                    'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            }else if(requestType==0||requestType==3){
                obj={
                    'merchId':'',
                    'storeId':storeID,
                    'depotId':'',
                    'notGoodIds':a,
                    'goodId':c,
                    'userToken':token,
                    'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            }else if(requestType==2){
                obj={
                    'merchId':'',
                    'storeId':'',
                    'depotId':b,//出库仓库ID
                    'notGoodIds':a,
                    'goodId':c,
                    'userToken':token,
                    'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            }

            let parseJson = JSON.stringify(obj);
            $.ajax({
                type: "post",
                url: '/XCCloud/GoodsInfo?action=QueryGoodsStock2',
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parseJson},
                success: function (_data) {
                    _data = JSON.parse(_data);
                    if (_data.result_code == 1) {
                        let arr=[];
                         arr = _data.result_data;
                        table.render({
                            elem: '#goodList'
                            , data: arr
                            , height:'220px'
                            , size:'sm'
                            , cellMinWidth: 100 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                            , cols: [[
                                   {type: 'checkbox'}
                                , {field: 'GoodID', title: '商品ID', align: 'center',width:230}
                                , {field: 'GoodName', title: '商品名称', align: 'center',width:230}
                                , {field: 'RemainCount', title: '库存', align: 'center',width:230}
                                , {field: 'AvailableCount', title: '可调拨数量', align: 'center',width:220}
                            ]]
                            , page: {page: true, limits: [5,10, 15, 20, 30, 50]}
                            , limit: 5
                        });
                    indexer=layer.open({
                            title:'库存礼品列表',
                            type:1,
                            area:['1000px','400px'],
                            content:$('#goodsBox')
                        });
                    }else {
                        layer.msg(_data.result_msg||_data.return_msg)
                    }
                }
            });
        // }else {
        //     layer.msg('申请仓库或发货仓库不能为空！')
        // }
    }
    function initSendTable(table,checkListGood,requestType) {
        let cols=[];
        if(requestType==2||requestType==3){
            cols=[
                {field: 'GoodID', title: '商品ID', align: 'center',width:100}
                , {field: 'GoodName', title: '商品名称', align: 'center',width:100}
                , {field: 'RemainCount', title: '库存', align: 'center',width:100}
                , {field: 'RequestCount', title: '申请数量', align: 'center',width:100,edit:true}
                , {field: 'NoCostPrice', title: '不含税单价', align: 'center',width:100,edit:true}
                , {field: 'Tax', title: '税率%', align: 'center',width:100,edit:true}
                , {field: 'CostPrice', title: '含税代价', align: 'center',width:100,edit:true}
                , {field: 'AvailableCount', title: '可调拨数', align: 'center',width:100}
                ,{fixed: 'right', title: '操作',  align:'center', toolbar: '#barDemo1'}
            ]
        }else if(requestType==0||requestType==1){
            cols=[
                {field: 'GoodID', title: '商品ID', align: 'center',width:160}
                , {field: 'GoodName', title: '商品名称', align: 'center',width:160}
                , {field: 'RemainCount', title: '库存', align: 'center',width:160}
                , {field: 'RequestCount', title: '申请数量', align: 'center',width:160,edit:true}
                , {field: 'AvailableCount', title: '可调拨数', align: 'center',width:100}
                ,{fixed: 'right', title: '操作',  align:'center', toolbar: '#barDemo1'}
            ]
        }
        table.render({
            elem: '#giftsList'
            , data: checkListGood
            , height:'220px'
            , size:'sm'
            , cellMinWidth: 90 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [cols]
        });
    }
    function initApplyTable(table,checkListGood) {
        table.render({
            elem: '#giftsList'
            , data: checkListGood
            , height:'220px'
            , size:'sm'
            , cellMinWidth: 90 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [[
                  {field: 'GoodID', title: '商品ID', align: 'center',width:100}
                , {field: 'GoodName', title: '商品名称', align: 'center',width:100}
                , {field: 'RequestCount', title: '申请数量', align: 'center',width:100,edit:true}
                , {field: 'RemainCount', title: '库存', align: 'center',width:100}
                , {field: 'AvailableCount', title: '可调拨数', align: 'center',width:100}

            ]]
        });
    }
</script>
</html>