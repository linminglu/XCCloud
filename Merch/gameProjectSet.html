<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>游艺项目设定</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<style>
    .boxDiv{height: 460px;border: 1px solid #aaaaaa;border-radius: 5px;padding: 3px;margin-bottom: 15px;}
    .boxDiv .deviceCheckList{height: 355px;margin: 10px;padding:5px 15px;border: 1px dashed #e2e2e2;overflow-y: scroll}
    .layui-col-md1 .lbt{height: 80px!important;}
</style>
<body>
  <div class="layui-row" style="padding:15px">
      <blockquote class="layui-elem-quote" style="text-align: right">
          <button type="button" class="layui-btn layui-btn-normal" i18n-content="查询模板">查询模板</button>
          <button type="button" class="layui-btn layui-btn-normal add" i18n-content="新增">新增</button>
      </blockquote>
      <table class="layui-hide" id="ProjectList" lay-filter="ProjectList"></table>
  </div>
<!--//弹窗层   -->
<div class="model goodIsAll" style="padding: 15px;display: none" id="openModel"  >
    <form class="layui-form layui-form-pane" lay-filter="formtest">
            <div class="layui-form-item">
                <label class="layui-form-label">游乐项目</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" id="projectName" name="projectName">
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">项目类型</label>
                    <div class="layui-input-inline">
                        <select name="projectType" id="projectType" lay-filter="projectType"></select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">区域</label>
                    <div class="layui-input-inline">
                        <select name="Area" id="Area" lay-filter="Area"></select>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">扣费类型</label>
                    <div class="layui-input-inline" style="height: 36px;border: 1px solid rgb(230,230,230)">
                        <select name="chargeType" id="chargeType" lay-filter="chargeType">
                            <option>-请选择-</option>
                            <option value="0">按此收费</option>
                            <option value="1">计时收费</option>
                        </select>
                    </div>
                    <div class="layui-form-mid" style="color: red">友情提醒：网络支付功能请到集团后台中的《套餐设定》进行添加套餐。</div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" id="Note" name="Note">
                </div>
            </div>
            <div style="text-align: center;margin-bottom: 15px">
                <button type="button" class="tosecond layui-btn-normal layui-btn" id="save">确定</button>
            </div>

    </form>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    var xc=xcActionSystem.prototype;
    var token=xc.getStorage('token');
    var parm = {
        'obj': {'userToken': token, 'signkey': '1f626576304bf5d95b72ece2222e42c3'},
        'url': '/XCCloud/Project?action=QueryProjectInfo',
        'elem': '#ProjectList',
        'cols': [{field: 'ID', title: '项目ID', align: 'center'}
            // , {field: 'MerchID', title: '商户编号', align: 'center'}
            // , {field: 'StoreID', title: '门店编号', align: 'center'}
            , {field: 'ProjectName', title: '项目名称', align: 'center'}
            , {field: 'ProjectTypeStr', title: '项目类型', align: 'center'}
            , {field: 'AreaName', title: '区域', align: 'center'}
            , {field: 'ChargeType', title: '扣费类型', align: 'center',templet:'#charge'}
            , {field: 'State', title: '状态', align: 'center',templet:'#state'}
            , {field: 'Note', title: '备注', align: 'center'}
            ,{fixed: 'right',title: '操作', width:150, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);
let id='';
   let projectType='';let Area='';let chargeType='';
    layui.use(['form','layer','table'],()=>{
        const form=layui.form;
        const layer=layui.layer;
        const table=layui.table;
      $('.add').on('click',()=>{  //弹窗
          xc.getGroupAreaDic(token,layer,form,'Area');
          setPlayMenu(form,'游戏机类型','projectType');
          layer.open({
              title:'新增',
              type:1,
              area:'700px',
              content:$('#openModel')
          })
      });
        form.on('select(projectType)',function (data) {
            projectType=data.value;
        });
        form.on('select(Area)',function (data) {
            Area=data.value;
        });
        form.on('select(chargeType)',function (data) {
            chargeType=data.value;
        });
        //save
        $('#save').click(function () {
            let obj={'id':id,
                'projectName':$('#projectName').val(),
                'areaType':Area,
                'projectType':projectType,
                'chargeType':chargeType,
                'note':$('#Note').val(),
                'userToken':token,
                'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parasJson = JSON.stringify(obj);
            $.ajax({
                type: "post",
                url: '/XCCloud/Project?action=SaveProjectInfo',
                contentType: "application/json; charset=utf-8",
                data: { parasJson: parasJson },
                success: function (data) {
                    data=JSON.parse(data);
                    if(data.result_code==1){
                        layer.msg('保存成功',{time:1500},function () {
                            location.reload()
                        })
                    }else {
                        layer.msg(data.result_msg||data.return_msg);
                        return false;
                    }
                }
            })
        });
        //页面table 删除、修改事件监听
        table.on('tool(ProjectList)', function(obj){
            var data = obj.data;
            var layEvent = obj.event;
             id=data.ID;
            if(layEvent === 'del'){ //删除
                layer.confirm('真的删除行么', function(index){
                   var _obj={'projectIds':id,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                   var url='/XCCloud/Project?action=DeleteProjectInfo';
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type: "post",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: {parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            console.log(data);
                            if (data.result_code == 1) {
                                layer.msg('删除成功！');
                            } else {
                                layer.msg(data.result_msg||data.return_msg);
                            }
                        }
                    })
                });
            } else if(layEvent === 'edit'){ //编辑

            }
        });
    });
    var setPlayMenu=function (form,objVal,id,m) {
        var  obj={"dictKey":objVal,'enabled':1,'pDicKey':'517',"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
        var url="/XCCloud/Dictionary?action=GetNodes";
        var parasJson = JSON.stringify(obj);
        $.ajax({
            type: "post",
            url: url,
            contentType: "application/json; charset=utf-8",
            data: {parasJson: parasJson},
            success: function (data) {
                data = JSON.parse(data);
                console.log(data);
                if (data.result_code == "1") {
                    var arr = data.result_data;
                    $('#' + id).html('<option>-请选择-</option>');
                    if (m == undefined) {
                             for(let i in arr[0].children){
                                 $('#'+id).append('<option value="'+arr[0].children[i].id+'">'+arr[0].children[i].name+'</option>')
                             }
                    } else {
                        for(let i in arr[0].children){
                            if(arr[0].children[i].id==m){
                                $('#'+id).append('<option value="'+arr[0].children[i].id+'" selected>'+arr[0].children[i].name+'</option>')
                            }else {
                                $('#'+id).append('<option value="'+arr[0].children[i].id+'">'+arr[0].children[i].name+'</option>')
                            }
                        }

                    }

                    form.render('select');
                } else {
                    layer.msg(data.result_msg || data.return_msg);
                }
            }

        })

    };
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"><i class="layui-icon">&#xe640;</i>删除</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="edit"><i class="layui-icon">&#xe642;</i>编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="bind"><i class="layui-icon">&#xe642;</i>设备绑定</a>
</script>
<script type="text/html" id="barDemo1">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"><i class="layui-icon">&#xe640;</i>删除</a>
</script>
<script type="text/html" id="charge">
    {{# if(d.ChargeType==0){ }}
        按次收费
    {{# }else{ }}
        计时收费
    {{#  } }}
</script>
<script type="text/html" id="state">
    {{# if(d.State==0){ }}
    有效
    {{# }else{ }}
    无效
    {{#  } }}
</script>
</html>