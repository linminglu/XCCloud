<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>游艺项目设定</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<style>
    .boxDiv{height: 460px;border: 1px solid #aaaaaa;border-radius: 5px;padding: 3px;margin-bottom: 15px;}
    .boxDiv .deviceCheckList{height: 355px;margin: 10px;padding:5px 15px;border: 1px dashed #e2e2e2;overflow-y: scroll}
    .layui-col-md1 .lbt{height: 80px!important;}
    #chargeModel .layui-form-item{margin-bottom: 0;}
    #chargeModel .layui-input-inline{width: 152px}
    .layui-card{
        margin-bottom: 0;}
</style>
<body>
  <div class="layui-row" style="padding:15px">
      <blockquote class="layui-elem-quote" style="text-align: right">
          <button type="button" class="layui-btn layui-btn-normal" i18n-content="查询模板">查询模板</button>
          <button type="button" class="layui-btn layui-btn-normal add" i18n-content="新增">新增</button>
      </blockquote>
      <table class="layui-hide" id="ProjectList" lay-filter="ProjectList"></table>
  </div>
<!--//弹窗层   -->
<div class="model goodIsAll" style="padding: 15px;display: none" id="openModel"  >
    <form class="layui-form layui-form-pane" lay-filter="formtest">
            <div class="layui-form-item">
                <label class="layui-form-label">游乐项目</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" id="projectName" name="projectName">
                </div>
            </div>
            <div class="layui-form-item">
                    <label class="layui-form-label">项目类型</label>
                    <div class="layui-input-block">
                        <!--<select name="projectType" id="projectType" lay-filter="projectType"></select>-->
                        <div class="layui-unselect layui-form-select downpanel">
                            <div class="layui-select-title">
                                <span class="layui-input layui-unselect" id="treeclass">选择栏目</span>
                                <input type="hidden" name="selectID" value="0">
                                <i class="layui-edge"></i>
                            </div>
                            <dl class="layui-anim layui-anim-upbit">
                                <dd>
                                    <ul id="classtree"></ul>
                                </dd>
                            </dl>
                        </div>
                    </div>
            </div>
            <div class="layui-form-item">

                    <label class="layui-form-label">区域</label>
                    <div class="layui-input-block">
                        <select name="Area" id="Area" lay-filter="Area"></select>
                    </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">扣费类型</label>
                    <div class="layui-input-inline" style="height: 36px;border: 1px solid rgb(230,230,230)">
                        <select name="chargeType" id="chargeType" lay-filter="chargeType">
                            <option>-请选择-</option>
                            <option value="0">按次收费</option>
                            <option value="1">计时收费</option>
                        </select>
                    </div>
                    <!--<div class="layui-input-inline">-->
                        <!--<button class="layui-btn layui-hide" type="button" id="setRuleBtn">请设置计时规则</button>-->
                    <!--</div>-->
                    <div class="layui-form-mid" style="color: red">友情提醒：若选择计时收费，请设置收费规则。<br>网络支付功能请到集团后台中的《套餐设定》进行添加套餐。</div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" id="Note" name="Note">
                </div>
            </div>
            <div style="text-align: center;margin-bottom: 15px">
                <button type="button" class="tosecond layui-btn-normal layui-btn" id="save">确定</button>
            </div>

    </form>
</div>
  <!--计时规则-->
  <div id="chargeModel" class="goodIsAll" style="padding: 15px;display: none;max-height: 550px;overflow-y: auto">
      <form class="layui-form layui-form-pane" lay-filter="chargeTime">
          <div class="layui-card">
              <div class="layui-card-body">
                  <div class="layui-form-item">
                      <div class="layui-inline">
                          <label class="layui-form-label">扣费方式</label>
                          <div class="layui-input-inline">
                              <select name="feeType" id="feeType" lay-filter="feeType">
                                  <option>-请选择-</option>
                                  <option value="0">进闸扣除基础费用</option>
                                  <option value="1">进闸扣除封顶费用</option>
                                  <option value="2">进闸验证微信票码</option>
                              </select>
                          </div>
                          <div class="layui-form-mid">后悔时间</div>
                          <div class="layui-input-inline">
                              <input type="text" name="FreeMinute" id="FreeMinute" class="layui-input" placeholder="分钟">
                          </div>
                          <div class="layui-form-mid">扣除余额</div>
                          <div class="layui-input-inline">
                              <select name="" id="feeBalance" lay-filter="feeBalance">

                              </select>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          <div class="layui-card">
              <div class="layui-card-header">陪同票</div>
              <div class="layui-card-body">
                  <div class="layui-form-item">
                      <div class="layui-inline">
                          <label class="layui-form-label">现金</label>
                          <div class="layui-input-inline">
                              <input type="text" name="AccompanyCash" class="layui-input" id="AccompanyCash">
                          </div>
                          <div class="layui-form-mid">扣除种类</div>
                          <div class="layui-input-inline">
                              <select name="" id="feekinds" lay-filter="feekinds">

                              </select>
                          </div>
                          <div class="layui-form-mid">扣除数量</div>
                          <div class="layui-input-inline">
                              <input type="text" name="Coins"  id="Coins" class="layui-input">
                          </div>
                      </div>

                  </div>
              </div>
          </div>
          <div class="layui-card">
              <div class="layui-card-header">定价</div>
              <div class="layui-card-body">
                  <div class="layui-form-item">
                      <div class="layui-inline">
                          <label class="layui-form-label">基础价格</label>
                          <div class="layui-input-inline">
                              <input type="text" name="BasePrice" class="layui-input" id="BasePrice">
                          </div>
                          <div class="layui-form-mid">计费周期</div>
                          <div class="layui-input-inline">
                              <input type="text" name="CycleTimes" id="CycleTimes" class="layui-input" placeholder="分钟">
                          </div>
                          <div class="layui-form-mid">封顶价格</div>
                          <div class="layui-input-inline">
                              <input type="text" name="TopPrice" id="TopPrice" class="layui-input">
                          </div>
                      </div>
                      <div class="layui-inline">
                          <label class="layui-form-label">计费方式</label>
                          <div class="layui-input-inline">
                              <select name="feeWays" id="feeWays" lay-filter="feeWays">
                                  <option>-请选择-</option>
                                  <option value="0">按周期扣除</option>
                                  <option value="1">出闸时扣除</option>
                              </select>
                          </div>
                      </div>
                      <div class="layui-inline">
                          <label class="layui-form-label">入场锁定</label>
                          <div class="layui-input-inline">
                              <input type="checkbox" lay-skin="switch" lay-text="启用|禁用" id="lock" name="lock" lay-filter="Lock">
                          </div>
                      </div>
                  </div>
                  <div class="layui-form-item reduceBox-item ">
                       <div class="layui-inline reduceBox ">
                              <label class="layui-form-label">超出部分</label>
                              <div class="layui-input-inline" style="width: 75px">
                                  <input type="text" class="layui-input" name="limitCount">
                              </div>
                                <div class="layui-form-mid">分钟</div>
                              <div class="layui-input-inline" style="width: 105px">
                                  <select lay-ignore style="height: 36px;width: 105px" name="limitType">
                                      <option value="0">以内</option>
                                      <option value="1">以上</option>
                                  </select>
                              </div>
                              <div class="layui-form-mid">每</div>
                              <div class="layui-input-inline" style="width: 75px">
                                  <input type="text" class="layui-input" name="consumeCount">
                              </div>
                              <div class="layui-form-mid">分钟收费</div>
                              <div class="layui-input-inline" style="width: 75px">
                                  <input type="text" class="layui-input" name="discountCount">
                              </div>
                              <div class="layui-form-mid">元</div>
                          </div>
                       <div class="layui-inline">
                          <div class="layui-btn-group">
                              <button class="layui-btn layui-btn-sm" type="button" id="addMore">
                                  <i class="layui-icon">&#xe654;</i>
                              </button>
                              <button class="layui-btn layui-btn-sm" type="button" id="reduceBtn">
                                  <i class="layui-icon">&#x1006;</i>
                              </button>
                          </div>
                      </div>

                  </div>
              </div>
          </div>
      </form>
      <blockquote class="layui-elem-quote">
          注意:使用微信票码不扣除基础费用，直到出闸时一次性结算,通过以上规则自动显示收费描述！
      </blockquote>
      <div style="text-align:center;">
          <button type="button" class="layui-btn" id="saveFee">确定</button>
      </div>
  </div>
<!--绑定设备列表-->
<div id="bindModel" style="padding: 15px;display: none">
    <blockquote class="layui-elem-quote">
        <button type="button" class="layui-btn" id="addDevice">添加设备</button>
    </blockquote>
    <table class="layui-hide" id="bindTable" lay-filter="bindTable"></table>
</div>
<!--选择绑定设备-->
<div id="deviceModel" style="padding: 15px;display:none;" class="goodIsAll">
    <form action="" class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <label class="layui-form-label">设备列表</label>
            <div class="layui-input-block">
                <select id="deviceList" lay-filter="deviceList"></select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">绑定路由器</label>
            <div class="layui-input-block">
                <select id="routerList" lay-filter="routerList"></select>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">工作方式</label>
                <div class="layui-input-inline">
                    <select id="workType" lay-filter="workType">
                        <option>-请选择-</option>
                        <option value="0">入口</option>
                        <option value="1">出口</option>
                        <option value="2">自动</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">校验顺序</label>
                <div class="layui-input-inline">
                    <input type="checkbox" id="AdjOrder" lay-filter="AdjOrder" lay-skin="switch" lay-text="开启|关闭">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">人脸识别</label>
                <div class="layui-input-inline">
                        <input type="checkbox" id="ReadFace" lay-filter="ReadFace" lay-skin="switch" lay-text="开启|关闭">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">刷卡校验</label>
                <div class="layui-input-inline">
                    <input type="checkbox" id="ReadCard" lay-filter="ReadCard" lay-skin="switch" lay-text="开启|关闭">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">阅票</label>
                <div class="layui-input-inline">
                    <input type="checkbox"  id="ReadQRCode" lay-filter="ReadQRCode" lay-skin="switch" lay-text="开启|关闭">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">现金</label>
                <div class="layui-input-inline">
                    <input type="checkbox" id="AllowCrah" lay-filter="AllowCrah" lay-skin="switch" lay-text="开启|关闭">
                </div>
            </div>
        </div>
    </form>
    <div style="text-align:center;margin-bottom: 15px">
        <button type="reset" class="layui-btn layui-hide layreset">确定</button>
        <button type="button" class="layui-btn" id="saveDevice">确定</button>
    </div>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let parm = {
        'obj': {'userToken': token, 'signkey': '1f626576304bf5d95b72ece2222e42c3'},
        'url': '/XCCloud/Project?action=QueryProjectInfo',
        'elem': '#ProjectList',
        'cols': [{field: 'ID', title: '项目ID', align: 'center'}
            , {field: 'ProjectName', title: '项目名称', align: 'center'}
            , {field: 'ProjectTypeStr', title: '项目类型', align: 'center'}
            , {field: 'AreaName', title: '区域', align: 'center'}
            , {field: 'ChargeType', title: '扣费类型', align: 'center',templet:'#charge'}
            , {field: 'Note', title: '备注', align: 'center'}
            ,{fixed: 'right',title: '操作', width:320, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);

   let id='';
   let DeviceList=[];let feeRule=[]; let projectBandPrice=[];
   let index1;let index2;
   let projectType='';let Area='';let chargeType='';

   let DeviceID='',WorkType='',AdjOrder=0,ReadFace=0,ReadCard=0,ReadQRCode=0,AllowCrah=0;let router='';
    //计时规则
    let feeType='';let feeBalance='';let feekinds='';let feeWays='';let Lock=0;
    layui.use(['form','layer','table','tree'],()=>{
        const form=layui.form;
        const layer=layui.layer;
        const table=layui.table;
        const tree=layui.tree;

        tree({
            elem:"#classtree"
            ,nodes:[{name: '常用文件夹',id: 1,alias: 'changyong',children: [{name: '所有未读',id: 11,href: 'http://www.layui.com/',alias: 'weidu'}, {name: '置顶邮件',id: 12}, {name: '标签邮件',id: 13}]}, {name: '我的邮箱',id: 2,spread: true,children: [{name: 'QQ邮箱',id: 21,spread: true,children: [{name: '收件箱',id: 211,children: [{name: '所有未读',id: 2111}, {name: '置顶邮件',id: 2112}, {name: '标签邮件',id: 2113}]}, {name: '已发出的邮件',id: 212}, {name: '垃圾邮件',id: 213}]}, {name: '阿里云邮',id: 22,children: [{name: '收件箱',id: 221}, {name: '已发出的邮件',id: 222}, {name: '垃圾邮件',id: 223}]}]}]
            ,click:function(node,e) {
                var $select=$($(this)[0].elem).parents(".layui-form-select");
                $select.removeClass("layui-form-selected").find(".layui-select-title span").html(node.name).end().find("input:hidden[name='selectID']").val(node.id);
                layui.bind(e);
            }
        });
        $(".downpanel").on("click",".layui-select-title",function(e) {
            $(".layui-form-select").not($(this).parents(".layui-form-select")).removeClass("layui-form-selected");
            $(this).parents(".downpanel").toggleClass("layui-form-selected");
            layui.stope(e);
        }).on("click","dl i",function(e) {
            layui.stope(e);
        });
        $(document).on("click",function(e) {
            $(".layui-form-select").removeClass("layui-form-selected");
        });


      $('.add').on('click',()=>{  //弹窗
           feeType=''; feeBalance=''; feekinds=''; feeWays=''; Lock=0;
           $('.layreset').trigger('click');
          xc.getGroupAreaDic(0,token,layer,form,'Area');
          setPlayMenu(form,'游戏机类型','projectType');
          layer.open({
              title:'新增',
              type:1,
              area:'700px',
              content:$('#openModel')
          })
      });
        form.on('select(projectType)',function (data) {
            projectType=data.value;
        });
        form.on('select(Area)',function (data) {
            Area=data.value;
        });
        form.on('select(chargeType)',function (data) {
            chargeType=data.value;
            // if(data.value==1){
            //     $('#setRuleBtn').removeClass('layui-hide');
            //     feeRule=[];
            // }else {
            //     $('#setRuleBtn').addClass('layui-hide')
            // }
        });
        //save
        $('#save').click(function () {
            let obj={'id':id,
                'projectName':$('#projectName').val(),
                'areaType':Area,
                'projectType':projectType,
                'chargeType':chargeType,
                'note':$('#Note').val(),
                // 'projectTimeInfo':feeRule,
                // 'projectBandPrices':projectBandPrice,
                'userToken':token,
                'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parasJson = JSON.stringify(obj);
            $.ajax({
                type: "post",
                url: '/XCCloud/Project?action=SaveProjectInfo',
                contentType: "application/json; charset=utf-8",
                data: { parasJson: parasJson },
                success: function (data) {
                    data=JSON.parse(data);
                    if(data.result_code==1){
                        layer.msg('保存成功',{time:1500},function () {
                            location.reload()
                        })
                    }else {
                        layer.msg(data.result_msg||data.return_msg);
                        return false;
                    }
                }
            })
        });
        $('#addDevice').on('click',()=>{  //弹窗
            xc.getUnBindDeviceDic(token,layer,form,'deviceList');
             DeviceID='';WorkType='';AdjOrder=0;ReadFace=0;ReadCard=0;ReadQRCode=0;AllowCrah=0;
            index2=   layer.open({
                title:'新增',
                type:1,
                area:'800px',
                content:$('#deviceModel')
            })
        });
        //页面table 删除、修改事件监听
        table.on('tool(ProjectList)', function(obj){
            var data = obj.data;
            var layEvent = obj.event;
             id=data.ID;
            if(layEvent === 'del'){ //删除
                layer.confirm('真的删除行么', function(index){
                   var _obj={'projectIds':id,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                var url='/XCCloud/Project?action=DeleteProjectInfo';
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: {parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        console.log(data);
                        if (data.result_code == 1) {
                            layer.msg('删除成功！',{time:1500},function () {
                                obj.del();
                            });
                        } else {
                            layer.msg(data.result_msg||data.return_msg);
                        }
                    }
                })
            });
            } else if(layEvent === 'edit'){ //编辑
                let _obj={'id':id,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let url='/XCCloud/Project?action=DelProjectInfo';
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: {parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        if (data.result_code == 1) {
                            let arr;
                            arr=data.result_data;
                            xc.getGroupAreaDic(0,token,layer,form,'Area',arr.AreaType);
                            setPlayMenu(form,'游戏机类型','projectType',arr.ProjectType);
                            form.val('formtest',{
                                'projectName':arr.ProjectName,
                                'chargeType':arr.ChargeType,
                                'Note':arr.Note
                            });
                            projectType=arr.ProjectType;
                            Area=arr.AreaType;
                            chargeType=arr.ChargeType;
                            // if(arr.ChargeType==1){
                            //     $('#setRuleBtn').removeClass('layui-hide');
                            //
                            // }else {
                            //     $('#setRuleBtn').addClass('layui-hide')
                            // }
                            index1=   layer.open({
                                title:'新增',
                                type:1,
                                area:'900px',
                                content:$('#openModel')
                            })
                        } else {
                            layer.msg(data.result_msg||data.return_msg);
                        }
                    }
                })
            }else if(layEvent === 'bind'){ //设备绑定
                let _obj={'projectId':id,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let url='/XCCloud/Project?action=QueryBindDevice';
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: {parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        console.log(data);
                        if (data.result_code == 1) {
                            setDeviceTable(table,data.result_data);
                            xc.getRouteDevice(token,layer,form,'routerList');
                            index1=   layer.open({
                                title:'新增',
                                type:1,
                                area:'900px',
                                content:$('#bindModel')
                            })
                        } else {
                            layer.msg(data.result_msg||data.return_msg);
                        }
                    }
                })
            }else if(layEvent === 'setTime'){
                let _obj={'id':id,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let url='/XCCloud/Project?action=GetProjectTimeInfo';
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: {parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        console.log(data);
                        if (data.result_code == 1) {
                            let arr;
                            arr=data.result_data;
                            form.val('chargeTime',{
                                'feeType':arr.ChargeType==null?'':arr.ChargeType,
                                'FreeMinute':arr.FreeMinute||'',
                                'AccompanyCash':arr.AccompanyCash||'',
                                'Coins':arr.Coins||'',
                                'BasePrice':arr.BasePrice||'',
                                'CycleTimes':arr.CycleTimes||'',
                                'TopPrice':arr.TopPrice||'',
                                'feeWays':arr.CycleType==null?'':arr.CycleType,
                                'lock':arr.LockMember==1?true:false
                            });
                            if(arr.ProjectBandPrices.length==1){
                                $('.reduceBox input[name="limitCount"]').val(arr.ProjectBandPrices[0].UseTimeCount);
                                $('.reduceBox select[name="limitType"]').val(arr.ProjectBandPrices[0].UseType);
                                $('.reduceBox input[name="consumeCount"]').val(arr.ProjectBandPrices[0].CycleTime);
                                $('.reduceBox input[name="discountCount"]').val(arr.ProjectBandPrices[0].Count);

                            }else if(arr.ProjectBandPrices.length>1){
                                for(let i=1;i<arr.ProjectBandPrices.length;i++){
                                    $('.reduceBox-item').append($('body').find($('.reduceBox')).eq(0).clone())
                                }
                                for(let i=0;i<arr.ProjectBandPrices.length;i++){
                                    $('.reduceBox-item').find($('.reduceBox')).eq(i).find('input[name="limitCount"]').val(arr.ProjectBandPrices[i].UseTimeCount);
                                    $('.reduceBox-item').find($('.reduceBox')).eq(i).find('select[name="limitType"]').val(arr.ProjectBandPrices[i].UseType);
                                    $('.reduceBox-item').find($('.reduceBox')).eq(i).find('input[name="consumeCount"]').val(arr.ProjectBandPrices[i].CycleTime);
                                    $('.reduceBox-item').find($('.reduceBox')).eq(i).find('input[name="discountCount"]').val(arr.ProjectBandPrices[i].Count);
                                }
                            }
                            xc.getBalanceTypeDic('',token,layer,form,'feeBalance',arr.ChargeBalanceIndex==null?'':arr.ChargeBalanceIndex);
                            xc.getBalanceTypeDic('',token,layer,form,'feekinds',arr.BalanceIndex==null?'':arr.BalanceIndex);
                            feeType=arr.ChargeType==null?'':arr.ChargeType;
                            feeBalance=arr.ChargeBalanceIndex==null?'':arr.ChargeBalanceIndex;
                            feeWays=arr.CycleType==null?'':arr.CycleType;
                            feekinds=arr.BalanceIndex==null?'':arr.BalanceIndex;
                            Lock=arr.LockMember==1?1:0;

                        } else {
                            layer.msg(data.result_msg||data.return_msg);
                        }
                    }
                });

                index1= layer.open({
                    title:'计时规则设定',
                    type:1,
                    area:'840px',
                    content:$('#chargeModel'),
                    cancel:function () {
                        location.reload()
                    }
                })
            }
            });
        table.on('tool(bindTable)', function(obj){
            var data = obj.data;
            var layEvent = obj.event;
            if(layEvent === 'del'){ //删除
                layer.confirm('真的删除行么', function(index){
                    var _obj={'id':data.ID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    var url='/XCCloud/Project?action=DelBindDevice';
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type: "post",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: {parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            console.log(data);
                            if (data.result_code == 1) {
                                layer.msg('删除成功！',{time:1500},function () {
                                    obj.del();
                                });
                            } else {
                                layer.msg(data.result_msg||data.return_msg);
                            }
                        }
                    })
                });
            }
        });
        form.on('select(deviceList)',function (data) {
            DeviceID=data.value;
        });
        form.on('select(workType)',function (data) {
            WorkType=data.value;
        });
        form.on('switch(AdjOrder)',function (data) {
            if(data.elem.checked==true){
                AdjOrder=1
            }else {
                AdjOrder=0
            }
        });
        form.on('switch(ReadFace)',function (data) {
            if(data.elem.checked==true){
                ReadFace=1
            }else {
                ReadFace=0
            }
        });
        form.on('switch(ReadCard)',function (data) {
            if(data.elem.checked==true){
                ReadCard=1
            }else {
                ReadCard=0
            }
        });
        form.on('switch(ReadQRCode)',function (data) {
            if(data.elem.checked==true){
                ReadQRCode=1
            }else {
                ReadQRCode=0
            }
        });
        form.on('switch(AllowCrah)',function (data) {
            if(data.elem.checked==true){
                AllowCrah=1
            }else {
                AllowCrah=0
            }
        });
        //保存选定的设备
        $('#saveDevice').on('click',function () {
            let canBind=false;
            if(DeviceList.length>0){
                let flag=false;
                for(let i in DeviceList){
                    if(DeviceList[i].DeviceID==DeviceID){
                        flag==true
                    }
                }
                if(flag){
                    layer.msg('当前设备已选中，请重新选择设备');
                }else {
                    canBind=true;
                }
            }else {
                canBind=true;
            }
          if(canBind){
              let obj={'projectid':id,
                  'DeviceID':DeviceID,
                  'WorkType':WorkType,
                  'AdjOrder':AdjOrder,
                  'ReadFace':ReadFace,
                  'ReadCard':ReadCard,
                  'ReadQRCode':ReadQRCode,
                  'AllowCash':AllowCrah,
                  'DeviceList':DeviceList,
                  'userToken':token,
                  'signkey':'1f626576304bf5d95b72ece2222e42c3'};
              let parasJson = JSON.stringify(obj);
              $.ajax({
                  type: "post",
                  url: '/XCCloud/Project?action=SaveBindDevice',
                  contentType: "application/json; charset=utf-8",
                  data: { parasJson: parasJson },
                  success: function (data) {
                      data=JSON.parse(data);
                      if(data.result_code==1){
                          layer.msg('保存成功',{time:1500},function () {
                              setDeviceTable(table,DeviceList);
                              layer.close(index2);
                          })
                      }else {
                          layer.msg(data.result_msg||data.return_msg);
                          return false;
                      }
                  }
              })
          }

        });
        form.on('select(feeType)',function (data) {
            feeType=data.value;
        });
        form.on('select(feeBalance)',function (data) {
            feeBalance=data.value;
        });
        form.on('select(feekinds)',function (data) {
            feekinds=data.value;
        });
        form.on('select(feeWays)',function (data) {
            feeWays=data.value;
        });
        form.on('switch(Lock)',function (data) {
            if(data.elem.checked==true){
                Lock=1
            }else {
                Lock=0
            }
        });
        $('#addMore').click(function () {
            $('.reduceBox-item').append($('body').find($('.reduceBox')).eq(0).clone())
        });
        $('#reduceBtn').click(function () {
            if($('.reduceBox-item').find($('.reduceBox')).length>1){
                $('.reduceBox-item').find($('.reduceBox')).last().remove();
            }else {
            }
        });
        //保存计时规则
        $('#saveFee').on('click',function (){
            $('.reduceBox-item .reduceBox').each(function () {
                if($(this).find('input[name="limitCount"]').val()!=''&&
                    $(this).find('select[name="limitType"] option:selected').val()!=''&&
                    $(this).find('input[name="consumeCount"]').val()!=''&&
                    $(this).find('input[name="discountCount"]').val()!=''
                ){
                    projectBandPrice.push({

                        'UseTimeCount': $(this).find('input[name="limitCount"]').val(),
                        'UseType': $(this).find('select[name="limitType"] option:selected').val(),
                        'CycleTime': $(this).find('input[name="consumeCount"]').val(),
                        'Count': $(this).find('input[name="discountCount"]').val()
                    });
                }
            });
            let obj={
                'ProjectTimeID':id,
                'ChargeType':feeType,
                'FreeMinute':$('#FreeMinute').val(),
                'ChargeBalanceIndex':feeBalance,
                'AccompanyCash':$('#AccompanyCash').val(),
                'BalanceIndex':feekinds,
                'Coins':$('#Coins').val(),
                'BasePrice':$('#BasePrice').val(),
                'CycleTimes':$('#CycleTimes').val(),
                'TopPrice':$('#TopPrice').val(),
                'CycleType':feeWays,
                'LockMember':Lock,
                'projectBandPrices':projectBandPrice,
                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'
            };
            let parasJson = JSON.stringify(obj);
            $.ajax({
                type: "post",
                url: '/XCCloud/Project?action=SaveProjectTimeInfo',
                contentType: "application/json; charset=utf-8",
                data: { parasJson: parasJson },
                success: function (data) {
                    data=JSON.parse(data);
                    if(data.result_code==1){
                        layer.msg('保存成功',{time:1500},function () {
                            location.reload()
                        })
                    }else {
                        layer.msg(data.result_msg||data.return_msg);
                        return false;
                    }
                }
            })

        })
    });
    var setPlayMenu=function (form,objVal,id,m) {
        var  obj={"dictKey":objVal,'enabled':1,'pDicKey':'517',"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
        var url="/XCCloud/Dictionary?action=GetNodes";
        var parasJson = JSON.stringify(obj);
        $.ajax({
            type: "post",
            url: url,
            contentType: "application/json; charset=utf-8",
            data: {parasJson: parasJson},
            success: function (data) {
                data = JSON.parse(data);
                console.log(data);
                if (data.result_code == "1") {
                    var arr1 = data.result_data.children;
                    let arr=arr1;
                    $('#' + id).html('<option>-请选择-</option>');
                    if (m == undefined) {
                        for(let i=0; i< arr.length;i++){
                            if(arr[i].children.length>0){
                                $('#'+id).append("<optgroup  label='"+arr[i].name+"'>");
                                for(let j in arr[i].children){
                                    $('#'+id).append('<option value="'+arr[i].children[j].id+'">'+arr[i].children[j].name+'</option>')
                                }
                                $('#'+id).append("</optgroup >");
                            }else {
                                $('#'+id).append('<option value="'+arr[i].id+'">'+arr[i].name+'</option>')
                            }

                        }
                    } else {
                        for(let i=0; i< arr.length;i++){
                            if(arr[i].children.length>0){
                                $('#'+id).append("<optgroup  label='"+arr[i].name+"'>");
                                for(let j in arr[i].children){
                                    if(arr[i].children[j].id==m){
                                        $('#'+id).append('<option value="'+arr[i].children[j].id+'" selected>'+arr[i].children[j].name+'</option>')
                                    }else {
                                        $('#'+id).append('<option value="'+arr[i].children[j].id+'">'+arr[i].children[j].name+'</option>')
                                    }
                                }
                                $('#'+id).append("</optgroup >");
                            }else {
                                if(arr[i].id==m){
                                    $('#'+id).append('<option value="'+arr[i].id+'" selected>'+arr[i].name+'</option>')
                                }else {
                                    $('#'+id).append('<option value="'+arr[i].id+'">'+arr[i].name+'</option>')
                                }
                            }

                        }

                    }

                    form.render('select');
                } else {
                    layer.msg(data.result_msg || data.return_msg);
                }
            }

        })

    };
    var setDeviceTable=function (table,datas) {
        table.render({
            elem: '#bindTable'
            , height:'250px'
            // , size:"sm"
            , data: datas
            , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [[
                {field:'DeviceID', title:'设备编号', align: 'center',width:121}
                // ,{field:'FoodTypeStr',title: '设备类别', align: 'center',width:205} //width 支持：数字、百分比和不填写。
                ,{field:'WorkType', title: '工作方式', align: 'center',width:100,templet:'#wt'}
                ,{field:'AdjOrder', title: '顺序校验', align: 'center',width:100,templet:'#ao'}
                ,{field:'ReadFace', title: '人脸', align: 'center',width:100,templet:'#rf'}
                ,{field:'ReadCard', title: '刷卡', align: 'center',width:100,templet:'#rc'}
                ,{field:'ReadQRCode', title: '阅票', align: 'center',width:100,templet:'#rr'}
                ,{field:'AllowCash', title: '现金', align: 'center',width:100,templet:'#ac'}
                ,{fixed: 'right',title:'操作', width:140, align:'center', toolbar: '#barDemo1'}]]
            , page: {page: true, limits: [7,10, 15, 20, 30, 50, 100]}
            , limit: 7
        });
    }
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"><i class="layui-icon">&#xe640;</i>删除</a>
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-bg-orange" lay-event="bind">设备绑定</a>
    {{# if(d.ChargeType==1){ }}
    <a class="layui-btn layui-btn-xs layui-bg-orange" lay-event="setTime">计时项目</a>
    {{#  } }}
</script>
<script type="text/html" id="barDemo1">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"><i class="layui-icon">&#xe640;</i>删除</a>
</script>
<script type="text/html" id="charge">
    {{# if(d.ChargeType==0){ }}
    按次收费
    {{# }else if(d.ChargeType==1){ }}
    计时收费
    {{#  } }}
</script>
<script type="text/html" id="wt">
    {{# if(d.WorkType==0){ }}
       入口
    {{# }else if(d.WorkType==1){ }}
        出口
    {{# }else if(d.WorkType==2){ }}
    自动
    {{#  } }}
</script>
<script type="text/html" id="ao">
    {{# if(d.AdjOrder==1){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{# }else{ }}
    <input type="checkbox"  name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
<script type="text/html" id="rf">
    {{# if(d.ReadFace==1){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{# }else{ }}
    <input type="checkbox"  name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
<script type="text/html" id="rc">
    {{# if(d.ReadCard==1){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{# }else{ }}
    <input type="checkbox"  name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
<script type="text/html" id="rr">
    {{# if(d.ReadQRCode==1){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{# }else{ }}
    <input type="checkbox"  name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
<script type="text/html" id="ac">
    {{# if(d.AllowCash==1){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{# }else{ }}
    <input type="checkbox"  name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
</html>