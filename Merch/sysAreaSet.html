<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>区域设置</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<style>
    .layui-table-view .layui-table[lay-size="sm"] .layui-select-title .layui-input {
        height: 28px;
        margin-top: -8px;
    }

    .layui-table-view .layui-table[lay-size="sm"] .layui-form-select dl dt, .layui-table-view .layui-form-select dl dd {
        line-height: 28px;
    }

    .layui-table-view .layui-table[lay-size="sm"] .layui-form-select dl {
        top: 28px;
    }

    .layui-table-view .layui-table .layui-select-title .layui-input {
        height: 32px;
        margin-top: -3px;
    }

    .layui-table-view .layui-table .layui-form-select dl dt, .layui-table-view .layui-form-select dl dd {
        line-height: 32px;
    }

    .layui-table-view .layui-table .layui-form-select dl {
        top: 32px;
    }

    .layui-table-view .layui-table[lay-size="lg"] .layui-select-title .layui-input {
        height: 38px;
        margin-top: 0;
    }

    .layui-table-view .layui-table[lay-size="lg"] .layui-form-select dl dt, .layui-table-view .layui-form-select dl dd {
        line-height: 38px;
    }

    .layui-table-view .layui-table[lay-size="lg"] .layui-form-select dl {
        top: 38px;
    }

    /*.tableWithoutHead .layui-table-header {*/
    /*display: none;*/
    /*}*/
</style>
<body>
<div class="layui-row" style="padding:15px">
    <!--<blockquote class="layui-elem-quote" style="text-align: right">-->
        <!--<button type="button" class="layui-btn layui-btn-normal" i18n-content="查询模板">查询模板</button>-->
        <!--<button type="button" class="layui-btn layui-btn-normal add" i18n-content="新增">新增</button>-->
    <!--</blockquote>-->

    <div class="layui-col-md3">
      <div style="height: 100%;">
          <div class="layui-card">
              <div class="layui-card-header">全部 <span class="sumArea"></span></div>
              <div class="layui-card-body" style="padding-left: 60px;height: 524px">
                  <div id="areaLise" class="layui-form layui-form-pane" style="height: 471px">

                  </div>
                  <div style="text-align:center;">
                      <button type="button" class="layui-btn add">新增</button>
                      <button type="button" class="layui-btn del">删除</button>
                      <button type="button" class="layui-btn modify">修改</button>
                  </div>
              </div>
          </div>
      </div>
    </div>
    <div class="layui-col-md9">
        <table class="layui-hide" id="areaSet" lay-filter="areaSet"></table>
    </div>
    <div style="text-align:right;padding-right: 50px;margin-bottom: 15px;" class="layui-col-md12">
        <button class="layui-btn" id="saveMore">批量修改区域</button>
    </div>
</div>

 <div id="openModel" style="padding: 15px;display: none;">
     <form action="" class="layui-form layui-form-pane">
         <div class="layui-form-item">
             <label for="" class="layui-form-label">区域名称</label>
             <div class="layui-input-block">
                 <input type="text" class="layui-input" name="areaName">
             </div>
         </div>

         <div class="layui-form-item">
             <div class="layui-input-block">
                <button type="button" class="layui-btn" id="save">确定</button>
             </div>
         </div>
     </form>
 </div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="layui/layui-xtree-game.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    var xc=xcActionSystem.prototype;
    var token=xc.getStorage('token');
    let checkArea='';let _areaName='';
    let _areaList=[];
    let projectAreaList=[];
    var getAreaList=function (token,id,form,arr) {
        var  obj={"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
        var  parasJson = JSON.stringify(obj);
        $.ajax({
            type: "post",
            url: '/XCCloud/GroupArea?action=QueryGroupArea',
            contentType: "application/json; charset=utf-8",
            data: {parasJson: parasJson},
            success: function (data) {
                data = JSON.parse(data);
                console.log(data)
                if(data.result_code==1){
                    $('#'+id).html('');
                     arr=data.result_data;
                     console.log(arr)
                    for(i in arr){
                        $('#'+id).append('<input type="radio" name="aa" value="'+arr[i].id+'" lay-filter="areaList" title="'+arr[i].areaName+'"><span class="projectCount-span">'+arr[i].projectCount+'</span><br>')
                    }
                    form.render();
                }
            }
        });
    };
    var showAreaMsg=function (id,token,table,form,_areaList) {
        var  obj={'id':id,"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
        var  parasJson = JSON.stringify(obj);
        $.ajax({
            type: "post",
            url: '/XCCloud/GroupArea?action=GetGroupArea',
            contentType: "application/json; charset=utf-8",
            data: {parasJson: parasJson},
            success: function (data) {
                data = JSON.parse(data);
                console.log(data)
                if(data.result_code==1){
                    let arr=data.result_data;
                    table.render({
                        elem: '#areaSet'
                        , height:'full-200'
                        , data: arr
                        , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                        , cols: [[
                            {field:'ID', title: 'ID', align: 'center'} ,
                            {field:'AreaName', title: '区域', align: 'center'}
                            ,{field:'ProjectName', title:'项目名称', align: 'center'}
                            ,{field:'ProjectTypeParent',title: '项目大类', align: 'center'} //width 支持：数字、百分比和不填写。
                            ,{field:'ProjectTypeName', title: '项目分类', align: 'center'}
                            ,{field:'AreaType',
                                title: '当前区域',
                                align: 'center',
                                templet:function (d) {
                                let _select='<select name="AreaType" lay-filter="testSelect" lay-verify="required" data-value="' + d.AreaType + '" ><option value=""></option>'
                                for(i in _areaList){
                                    if(d.AreaType==_areaList[i].id){
                                        _select+='<option value="'+_areaList[i].id+'" selected>'+_areaList[i].areaName+'</option>'
                                    }else {
                                        _select+='<option value="'+_areaList[i].id+'">'+_areaList[i].areaName+'</option>'
                                    }

                                }
                                    _select+='</select>'
                                    return _select;
                                }}
                            ]]
                        , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                        , limit: 10
                        ,done: function (res, curr, count) {
                            var tableElem = this.elem.next('.layui-table-view');
                            count || tableElem.find('.layui-table-header').css('overflow', 'auto');
                            layui.each(tableElem.find('select'), function (index, item) {
                                var elem = $(item);
                                elem.val(elem.data('value')).parents('div.layui-table-cell').css('overflow', 'visible');
                            });
                            form.render();
                        }
                    });
                }
            }
        });
    };
    layui.use(['form','table','layer'],function () {
        let form=layui.form;
        let table=layui.table;
        let layer=layui.layer;
        table.render({
            elem: '#areaSet'
            , height:'full-200'
            , data: []
            , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [[
                {field:'ID', title: 'ID', align: 'center'} ,
                {field:'AreaName', title: '区域', align: 'center'}
                ,{field:'ProjectName', title:'项目名称', align: 'center'}
                ,{field:'ProjectTypeParent',title: '项目大类', align: 'center'} //width 支持：数字、百分比和不填写。
                ,{field:'ProjectTypeName', title: '项目分类', align: 'center'}
                ,{field:'AreaType',
                    title: '当前区域',
                    align: 'center'
                 }
              ]]
            , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
            , limit: 10
        });
        var  obj={"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
        var  parasJson = JSON.stringify(obj);
        $.ajax({
            type: "post",
            url: '/XCCloud/GroupArea?action=QueryGroupArea',
            contentType: "application/json; charset=utf-8",
            data: {parasJson: parasJson},
            success: function (data) {
                data = JSON.parse(data);
                console.log(data)
                if(data.result_code==1){
                    $('#areaLise').html('');
                    _areaList=data.result_data;
                    for(i in _areaList){
                        $('#areaLise').append('<input type="radio" name="aa" value="'+_areaList[i].id+'" lay-filter="areaList" title="'+_areaList[i].areaName+'"><span class="projectCount-span">'+_areaList[i].projectCount+'</span><br>')
                    }
                    form.render();
                }
            }
        });
        form.on('radio(areaList)',function (data) {
           showAreaMsg (data.value,token,table,form,_areaList);
            projectAreaList=[];
            checkArea=data.value;
            _areaName=data.elem.title;
        });
        form.on('select(testSelect)', function (data) {
            var elem = $(data.elem);
            var trElem = elem.parents('tr');
            var tableData = table.cache['areaSet'];
            // 更新到表格的缓存数据中，才能在获得选中行等等其他的方法中得到更新之后的值
            tableData[trElem.data('index')][elem.attr('name')] = data.value;
            if(projectAreaList.length>0){
                    let flag=false;
                    let index;
                for(i in projectAreaList){
                    if(projectAreaList[i].projectId==trElem[0].children[0].firstChild.innerHTML){
                        flag=true;
                        index=i;
                    }
                }
                if(flag){
                    projectAreaList[index].areaType=data.value
                }else {
                    projectAreaList.push({'projectId':trElem[0].children[0].firstChild.innerHTML,'areaType':data.value})
                }
            }else {
                projectAreaList.push({'projectId':trElem[0].children[0].firstChild.innerHTML,'areaType':data.value})
            }
        });
        $('#getCheckedData').click(function () {
            // 验证一下下拉选择之后有没有作用到表格缓存数据
            var checkStatus = table.checkStatus('areaSet'); //test即为基础参数id对应的值
            layer.alert(JSON.stringify(checkStatus));
        });
        //新增
        $('.add').click(function () {
            checkArea='';
            $('input[name="areaName"]').val('');
            layer.open({
                title:'新增',
                type:1,
                area:'600px',
                content:$('#openModel')
            })
        });
        //修改
        $('.modify').click(function () {
            if(checkArea==''){
                layer.msg('请选则一条区域数据')
            }else {
                $('input[name="areaName"]').val(_areaName);
                layer.open({
                    title:'修改',
                    type:1,
                    area:'600px',
                    content:$('#openModel')
                })
            }
        });
        //删除
        $('.del').click(function () {
            if(checkArea==''){
                layer.msg('请选则一条区域数据')
            }else {
                layer.confirm('确定删除此条数据吗？', function(index){
                    let _obj={'id':checkArea,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/GroupArea?action=DelGroupArea',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('删除成功',{time:1500},function () {
                                    location.reload()
                                })
                            } else {
                                layer.msg(data.result_msg);
                            }
                        }
                    })
                });
            }
        });
        //保存
        $('#save').click(function () {
            var  obj={'id':checkArea,'areaName':$('input[name="areaName"]').val(),"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
            var  parasJson = JSON.stringify(obj);
            $.ajax({
                type: "post",
                url: '/XCCloud/GroupArea?action=SaveGroupArea',
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parasJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if(data.result_code==1){
                        layer.msg('保存成功',{time:1500},function () {
                            location.reload()
                        })
                    }else {
                        layer.msg(data.result_msg||data.return_msg)
                    }
                }
            });
        });
        //批量修改区域
        $('#saveMore').click(function () {
            var  obj={'projectAreaList':projectAreaList,"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
            var  parasJson = JSON.stringify(obj);
            $.ajax({
                type: "post",
                url: '/XCCloud/GroupArea?action=ChangeGroupAreaBatch',
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parasJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if(data.result_code==1){
                        layer.msg('保存成功',{time:1500},function () {
                            location.reload()
                        })
                    }else {
                        layer.msg(data.result_msg||data.return_msg)
                    }
                }
            });
        });
    })
</script>

</html>