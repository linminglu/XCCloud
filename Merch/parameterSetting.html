<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>系统参数配置</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<style>
    .layui-form-item .layui-input-inline{width: 179px;}
    .layui-form-item .layui-form-label{width: 140px;padding: 8px 0;}
    .layui-form-switch{width: 169px!important;}
    .goodIsAll .layui-form-switch i{
        width: 83px;
    }
</style>
<body>
<div class="goodIsAll" style="padding: 5px; height: 550px;overflow-y: auto">
    <form action="" class="layui-form layui-form-pane" lay-filter="storeParm">
        <div class="layui-collapse">
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">运营参数设定</h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-form-item ">
                        <div class="layui-inline">
                            <label class="layui-form-label">小票是否打印二维码</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" name="chkPrintBarcode" lay-skin="switch" lay-text="启用|禁用" id="chkPrintBarcode" lay-filter="chkPrintBarcode">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">吧台送币时是否授权</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" name="chkBarSendCoinAuthorize" lay-skin="switch" lay-text="启用|禁用" id="chkBarSendCoinAuthorize" lay-filter="chkBarSendCoinAuthorize">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">每次售币最小币数</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" name="txtOnceSellCoinMin" id="txtOnceSellCoinMin">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">营业日期内班次个数</label>
                            <div class="layui-input-inline">
                                <select  id="txtBusinessClass"lay-filter="txtBusinessClass" name="txtBusinessClass">
                                    <option>-请选择-</option>
                                    <option value="0">A班</option>
                                    <option value="1">AB班</option>
                                    <option value="2">ABC班</option>
                                </select>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label" style="white-space: normal;padding: 0;">换班时需要输入实点数</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" name="chkShift" lay-skin="switch" lay-text="启用|禁用" id="chkShift" lay-filter="chkShift">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" style="padding: 8px 0;">销售方式</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" name="chkTaxInSale" lay-skin="switch" lay-text="含税|不含税" id="chkTaxInSale " lay-filter="chkTaxInSale">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">线上开卡级别</label>
                            <div class="layui-input-inline">
                                <select  id="cmbCardOpenLevel" name="cmbCardOpenLevel" lay-filter="cmbCardOpenLevel">

                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" style="padding: 8px 0;">是否开启赠送区</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" name="chkGiftArea" lay-skin="switch" lay-text="是|否" id="chkGiftArea" lay-filter="chkGiftArea">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">授权通道</label>
                        <div class="layui-input-block" id="cmbAuthChannelBox">

                            <input type="checkbox" lay-filter="cmbAuthChannel" title="授权卡" value="0" lay-skin="primary">
                            <input type="checkbox" lay-filter="cmbAuthChannel" title="公众号通知" value="1" lay-skin="primary">
                            <input type="checkbox" lay-filter="cmbAuthChannel" title="扫码授权" value="2" lay-skin="primary">

                        </div>
                    </div>
                    <div class="layui-form-item priceCoinBox">
                        <div class="layui-inline priceCoin">
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" name="CashPrice">
                            </div>
                            <div class="layui-form-mid">元=</div>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" name="CoinCount">
                            </div>
                            <div class="layui-input-inline">
                                <select lay-ignore style="height: 36px;width: 105px" name="limitType">

                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                    <div class="layui-btn-group">
                                        <button type="button" class="layui-btn" id="addPrice"> <i class="layui-icon">&#xe654;</i></button>
                                        <button type="button" class="layui-btn" id="delPrice"><i class="layui-icon layui-icon-close"></i></button>
                                    </div>
                            </div>
                        </div>
                    </div>
                    <blockquote>例如：设置1元=1代币时，套餐为100元150币，则会员赠送代币为50币。若需要退款时，仅按照非赠送（100币）值退款，赠送代币不能退。</blockquote>
                </div>
            </div>
            <div class="layui-colla-item lci3 layui-hide">
                <h2 class="layui-colla-title">博彩专用设定</h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-form-item ">
                        <div class="layui-inline">
                            <label class="layui-form-label">每天免授权赢币上限</label>
                            <div class="layui-input-inline">
                                <input type="text" id="txtOnceSellCoinMin1" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label">每天免授权赢币倍数</label>
                            <div class="layui-input-inline">
                                <input type="text" id="txtOnceSellCoinMax" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label">每次免授权赢币上限</label>
                            <div class="layui-input-inline">
                                <input type="text" id="txtOnceRefunMin" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item ">
                        <div class="layui-inline">
                            <label class="layui-form-label">每天免授权退币上限</label>
                            <div class="layui-input-inline">
                                <input type="text" id="txtDayWithoutRightWinCoinMax" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label">条码退款方式</label>
                            <div class="layui-input-inline">
                                <select name="" id="">
                                    <option>-请选择-</option>
                                    <option value="0">显示退款和退到会员卡</option>
                                    <option value="1">仅显示退款</option>
                                    <option value="2">仅显示退到会员卡</option>
                                </select>
                            </div>
                        </div>

                    </div>

                    <div class="layui-form-item ">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="white-space: normal;padding: 0;">临时开卡是否显示手机号输入框</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" lay-filter="showPhone" lay-skin="switch" lay-text="启用|禁用" id="chkTempShowPhone">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label" style="white-space: normal;padding: 0;">临时卡首次入会验证短信码</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" lay-filter="afmsc" lay-skin="switch" lay-text="启用|禁用" id="chkTempAllowFirstMemberSmsCode">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label">临时卡是否允许返还</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" lay-filter="Giveback" lay-skin="switch" lay-text="启用|禁用" id="chkTempGiveback">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">会员设定</h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-form-item ">
                        <div class="layui-inline">
                            <label class="layui-form-label">会员生日提醒</label>
                            <div class="layui-input-inline">
                                <select name="cmbBirthdaySendSms" lay-filter="cmbBirthdaySendSms" id="cmbBirthdaySendSms">
                                    <option value="0">不提醒</option>
                                    <option value="1">当天提醒</option>
                                    <option value="2">提前1天提醒</option>
                                    <option value="3">提前2天提醒</option>
                                    <option value="4">提前3天提醒</option>
                                    <option value="5">提前4天提醒</option>
                                    <option value="6">提前5天提醒</option>
                                    <option value="7">提前6天提醒</option>
                                    <option value="8">提前7天提醒</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" style="white-space: normal;padding: 0;">会员入会时必须抓拍照片</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" name="chkPhotograph" lay-filter="chkPhotograph" lay-skin="switch" lay-text="启用|禁用" id="chkPhotograph">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label" style="white-space: normal;padding: 0;">吧台退卡时必须抓拍照片</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" name="chkExitCardCatch" lay-filter="chkExitCardCatch" lay-skin="switch" lay-text="启用|禁用" id="chkExitCardCatch">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">退餐时必须抓拍相片</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" name="chkExitFoodCatch" lay-filter="chkExitFoodCatch" lay-skin="switch" lay-text="启用|禁用" id="chkExitFoodCatch">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" style="white-space: normal;padding: 0;">会员退卡时余额强制清零</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" name="chkForceClearBalanceOnExitCard" lay-filter="chkForceClearBalanceOnExitCard" lay-skin="switch" lay-text="启用|禁用" id="chkForceClearBalanceOnExitCard">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-colla-item lci3 layui-hide">
                <h2 class="layui-colla-title">返还设定</h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-form-item ">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="white-space: normal;padding: 0;">返还时卡里余额不能超过</label>
                            <div class="layui-input-inline">
                                <input type="text" id="txtGiveBackMax" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" style="white-space: normal;padding: 0;">退款后禁止拿返还时间(分)</label>
                            <div class="layui-input-inline">
                                <input type="text" id="txtExitMoneyGiveBackTime" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label" style="white-space: normal;padding: 0;">拿返还时是否验证短信码</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" lay-filter="GiveBackAllowSmsCode" lay-skin="switch" lay-text="启用|禁用" id="chkGiveBackAllowSmsCode">
                            </div>
                        </div>
                    </div>
                    <hr class="layui-bg-blue">
                    <div style="text-align: right">
                       <button type="button" class="layui-btn layui-btn-normal layui-btn-primary" id="addNewBackRule"> 新增</button>
                    </div>
                    <div>
                        <table class="layui-hide" id="test" lay-filter="test"></table>
                    </div>
                </div>
            </div>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">游乐项目规则设定</h2>
                <div class="layui-colla-content layui-show">
                   <div class="layui-form-item">
                       <div class="layui-inline">
                           <div class="layui-input-inline" style="width: 300px">
                               <input type="checkbox" name="chkAccompanyOutWithMain" lay-filter="chkAccompanyOutWithMain" title="陪同票是否必须与主票一同出闸" lay-skin="primary">
                           </div>
                       </div>
                       <div class="layui-inline">
                           <div class="layui-input-inline"  style="width: 300px">
                               <input type="checkbox"name="chkAddLeaveTime" lay-filter="chkAddLeaveTime" title="离场时间是否进行累计" lay-skin="primary">
                           </div>
                       </div>
                   </div>
                    <br>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <div class="layui-form-mid">散客领取卡进行计时项目游玩时,自动入会</div>
                            <div class="layui-input-inline">
                                <select name="cmbAutoJoinMemberLevel" id="cmbAutoJoinMemberLevel" lay-filter="cmbAutoJoinMemberLevel">

                                </select>
                            </div>
                            <div class="layui-form-mid">级别</div>
                        </div>

                    </div>
                    <div class="layui-form-item">
                        <div class="layui-form-mid">散客打印门票时需要强制填写如下信息</div>
                        <div class="layui-input-block" id="cusmor">
                            <input type="checkbox" value="0" title="姓名" lay-skin="primary" lay-filter="cusmor">
                            <input type="checkbox" value="1" title="手机" lay-skin="primary" lay-filter="cusmor">
                            <input type="checkbox" value="2" title="性别" lay-skin="primary" lay-filter="cusmor">
                            <input type="checkbox" value="3" title="身份证" lay-skin="primary" lay-filter="cusmor">
                            <input type="checkbox" value="4" title="生日" lay-skin="primary" lay-filter="cusmor">
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">兑换规则</h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-form-item">
                        <div class="layui-inline" >
                            <label class="layui-form-label">每日额度</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" name="txtCreditEveryday">
                            </div>
                        </div>
                        <div class="layui-inline" >
                            <label class="layui-form-label">最大发卡张数</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" name="txtMaxSendCard">
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">招待币/补币规则</h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-form-item specilCoinBox ">
                        <div class="layui-inline specilCoin" >
                            <label class="layui-form-label" style="width: 100px">余额类别</label>
                            <div class="layui-input-inline" style="width: 100px">
                                <select name="BalanceIndex" lay-ignore style="height: 36px;width: 105px">

                                </select>
                            </div>
                            <div class="layui-form-mid" style="width: 90px">单次最大额度</div>
                            <div class="layui-input-inline" style="width: 70px">
                                <input type="text" class="layui-input" name="OnceSigleMax">
                            </div>
                            <div class="layui-form-mid">单次警戒</div>
                            <div class="layui-input-inline" style="width: 70px">
                                <input type="text" class="layui-input" name="OnceWarningValue">
                            </div>
                            <div class="layui-form-mid">每天最大额度</div>
                            <div class="layui-input-inline" style="width: 70px">
                                <input type="text" class="layui-input" name="DayMax">
                            </div>
                            <div class="layui-form-mid">每天警戒</div>
                            <div class="layui-input-inline" style="width: 70px">
                                <input type="text" class="layui-input" name="DayWaringValue">
                            </div>
                        </div >
                        <div class="layui-inline" style="width: 140px;">
                            <div class="layui-input-inline">
                                <div class="layui-btn-group">
                                    <button type="button" class="layui-btn" id="addCoin"> <i class="layui-icon">&#xe654;</i></button>
                                    <button type="button" class="layui-btn" id="delCoin"><i class="layui-icon layui-icon-close"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div style="text-align: right;margin: 20px;">
            <button type="button" class="layui-btn layui-btn-normal">重置</button>
            <button type="button" class="layui-btn layui-btn-normal layui-btn-danger" id="parameterBtn">提交</button>
            <button type="button" class="layui-btn layui-btn-normal">取消</button>
        </div>
    </form>
    <div class="addReturnSetting" style="display: none">
        <form action="" class="layui-form layui-form-pane" >
            <div class="layui-form-item item_two">
                <div class="layui-inline">
                    <label class="layui-form-label">会员级别</label>
                    <div class="layui-input-inline"  >
                        <select name=""  id="memberLvlId"  style="width: 234px; height: 38px;" lay-filter="memberLvlId">
                            <option value="0" >普通卡</option>
                            <option value="1">银卡</option>
                            <option value="2">金卡</option>
                            <option value="3">钻卡</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">返还累计天数</label>
                    <div class="layui-input-inline"  style="width: 202px;">
                        <input type="text" name="price_min" placeholder="(填0表示当天有效)" id="totalDays" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item item_two">
                <div class="layui-inline">
                    <label class="layui-form-label">返还方式</label>
                    <div class="layui-input-inline" style="width: 100px;">
                        <input type="checkbox" name="zzz" checked lay-skin="switch" lay-text="按自然日期|按营业日期" id="backType" lay-filter="backType">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">统计方式</label>
                    <div class="layui-input-inline" style="width: 100px;">
                        <input type="checkbox" name="zzz" checked lay-skin="switch" lay-text="包含当天|不包含当天" id="allowContainToday"lay-filter="allowToday">
                    </div>
                </div>
            </div>
            <div class="layui-form-item item_two">
                <div class="layui-inline">
                    <label class="layui-form-label">输币区间</label>
                    <div class="layui-input-inline" style="width: 100px;">
                        <input type="text" name="price_min" placeholder="￥" id="backMin" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">至</div>
                    <div class="layui-input-inline" style="width: 100px;">
                        <input type="text" name="price_max" placeholder="￥" id="backMax" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">返还比例</label>
                    <div class="layui-input-inline" style="width: 202px;">
                        <input type="text" name="price_min" id="backScale" placeholder="percent" autocomplete="off" class="layui-input">
                    </div>
                </div>

            </div>
            <div class="layui-form-item item_one">
                <div class="layui-inline">
                    <label class="layui-form-label" style="padding: 0;white-space: normal;">兑币单价(重启生效)</label>
                    <div class="layui-input-inline">
                        <input type="text" name="price_min" placeholder="返还到会员卡时无效" id="exitCardMin" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">币不能退卡</div>
                </div>
            </div>
            <div class="layui-form-item  item_one">
                <div class="layui-inline">
                    <label class="layui-form-label">是否扣除返还币</label>
                    <div class="layui-input-inline">
                        <input type="checkbox" name="zzz" checked lay-skin="switch" lay-text="是|否" id="allowBackPrincipal" lay-filter="allowBackPrincipal">
                    </div>
                    <div class="layui-form-mid">返还到会员卡时无效</div>
                </div>
            </div>
            <div style="text-align: right;">
                <button type="reset" class="layui-btn layui-btn-normal">重置</button>
                <button type="button" class="layui-btn layui-btn-normal layui-btn-danger" id="submitBtn">确定</button>
                <button type="button" class="layui-btn layui-btn-normal">取消</button>
            </div>
        </form>
    </div>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/manchartSystem.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    let token=getStorage('token');
    let xc=xcActionSystem.prototype;
    let _storeId=getStorage('storeId_merch');
    // //运营参数设定
    let  chkPrintBarcode=0;let chkBarSendCoinAuthorize=0;let txtBusinessClass;
    let cmbAuthChannel=[] ;let chkShift=0;let chkTaxInSale=0;let  cmbCardOpenLevel='';let chkGiftArea=0;
    //会员设定
    let cmbBirthdaySendSms;let chkPhotograph=0;let chkExitCardCatch=0;
    let chkExitFoodCatch=0; let chkForceClearBalanceOnExitCard=0;
    //游乐项目规则设定
    let txtClientBuyTicketInfo;
    let chkAccompanyOutWithMain=0;
    let chkAddLeaveTime=0;
    let cmbAutoJoinMemberLevel;
    let cmbAutoJoinMemberLevels=[];
    function ifNeedSet(storeId,form,layer) {
        let obj={'storeId':storeId,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        $.ajax({
            type: "post",
            // async:false,
            url: '/XCCloud/Parameter?action=GetStandardCoinPrice',
            contentType: "application/json; charset=utf-8",
            data: {parasJson: JSON.stringify(obj)},
            success: function (data) {
                data = JSON.parse(data);
                if(data.result_code==1){
                    let arr=data.result_data;
                    if(arr.length==1){
                        $('.priceCoin input[name="CashPrice"]').val(arr[0].CashPrice);
                        $('.priceCoin input[name="CoinCount"]').val(arr[0].CoinCount);
                        xc.getBalanceTypeDicNode(_storeId,1,token,layer,form,$('.priceCoin select[name="limitType"]'),arr[0].BalanceIndex);
                    }else if(arr.length>1){
                        for(let i=1;i<arr.length;i++){
                            $('.priceCoinBox').append($('body').find($('.priceCoin')).eq(0).clone())
                        }
                        for(let i=0;i<arr.length;i++){
                            $('.priceCoinBox').find($('.priceCoin')).eq(i).find('input[name="CashPrice"]').val(arr[i].CashPrice);
                            $('.priceCoinBox').find($('.priceCoin')).eq(i).find('input[name="CoinCount"]').val(arr[i].CoinCount);
                            xc.getBalanceTypeDicNode(_storeId,1,token,layer,form, $('.priceCoinBox').find($('.priceCoin')).eq(i).find('select[name="limitType"]'),arr[i].BalanceIndex);
                        }
                    }
                }
            }
        });
        //设置招待币/补币

        //设置基本参数
        $.ajax({
            type: "post",
            // async:false,
            url: '/XCCloud/Parameter?action=GetParamList',
            contentType: "application/json; charset=utf-8",
            data: {parasJson: JSON.stringify(obj)},
            success: function (data) {
                data = JSON.parse(data);
                 console.log(data);
                if(data.result_code==1){
                    let arr=data.result_data;
                    if(arr[0].Tag==0){
                        $('.lci3').addClass('layui-hide');
                    }else  if(arr[0].Tag==1){
                        getBackRule(_storeId);
                        $('.lci3').removeClass('layui-hide');
                    }
                    form.val("storeParm", {
                        "chkPrintBarcode": arr[3].ParameterValue==1?true:false
                        ,"chkBarSendCoinAuthorize": arr[4].ParameterValue==1?true:false
                        ,'cmbAutoJoinMemberLevel':arr[16].ParameterValue
                        ,'cmbCardOpenLevel':arr[24].ParameterValue
                        ,"txtOnceSellCoinMin": arr[7].ParameterValue
                        ,"txtBusinessClass": arr[5].ParameterValue
                        ,"chkShift":  arr[6].ParameterValue==1?true:false
                        ,"cmbBirthdaySendSms": arr[10].ParameterValue
                        ,"chkPhotograph": arr[11].ParameterValue==1?true:false
                        ,"chkExitCardCatch": arr[12].ParameterValue==1?true:false
                        ,"chkExitFoodCatch": arr[13].ParameterValue==1?true:false
                        ,"txtCreditEveryday": arr[18].ParameterValue
                        ,"txtMaxSendCard": arr[19].ParameterValue
                        // ,"cmbAuthChannel": arr[21].ParameterValue
                        ,"chkTaxInSale": arr[22].ParameterValue,
                        'chkGiftArea':arr[25].ParameterValue==1?true:false
                        ,"chkForceClearBalanceOnExitCard": arr[23].ParameterValue==1?true:false
                    });

                    chkPrintBarcode=arr[3].ParameterValue;
                    chkBarSendCoinAuthorize=arr[4].ParameterValue;
                    txtBusinessClass=arr[5].ParameterValue||'';
                    cmbAuthChannel=arr[21].ParameterValue!=''?arr[21].ParameterValue.split('|'):[];

                    for(let i in cmbAuthChannel){
                        $('#cmbAuthChannelBox').find('input[value="'+cmbAuthChannel[i]+'"]').attr('checked',true);
                    }
                    chkShift=arr[6].ParameterValue;
                    chkTaxInSale=arr[22].ParameterValue||'';
                    cmbCardOpenLevel=arr[24].ParameterValue||'';
                    //会员设定
                    cmbBirthdaySendSms=arr[10].ParameterValue;
                    chkPhotograph=arr[11].ParameterValue;
                    chkExitCardCatch=arr[12].ParameterValue;
                    chkExitFoodCatch=arr[13].ParameterValue;
                    //游乐项目规则设定
                    chkAccompanyOutWithMain=arr[14].ParameterValue;
                    cmbAutoJoinMemberLevel=arr[16].ParameterValue;
                    chkForceClearBalanceOnExitCard=arr[23].ParameterValue;

                   if(chkAccompanyOutWithMain==1){
                       $('input[name="chkAccompanyOutWithMain"]').attr({'checked':true})
                   }else {
                       $('input[name="chkAccompanyOutWithMain"]').attr({'checked':false})
                   }

                   chkAddLeaveTime=arr[15].ParameterValue;
                    if(chkAddLeaveTime==1){
                        $('input[name="chkAddLeaveTime"]').attr({'checked':true})
                    }else {
                        $('input[name="chkAddLeaveTime"]').attr({'checked':false})
                    }
                    txtClientBuyTicketInfo=arr[17].ParameterValue;
                    if(txtClientBuyTicketInfo!=''){
                        cmbAutoJoinMemberLevels=txtClientBuyTicketInfo.split('|');
                        for(let i in cmbAutoJoinMemberLevels){
                            $('#cusmor').find('input[value="'+cmbAutoJoinMemberLevels[i]+'"]').attr({'checked':true})
                        }
                    }
                    form.render();
                }
            }
        });
        //设置正价币

    }
    function setBbi(storeId,form,layer) {
    let obj={'storeId':storeId,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
    $.ajax({
        type: "post",
         async:false,
        url: '/XCCloud/Parameter?action=GetFreeCoinRule',
        contentType: "application/json; charset=utf-8",
        data: {parasJson: JSON.stringify(obj)},
        success: function (data) {
            data = JSON.parse(data);
            if(data.result_code==1){
                let arr=data.result_data;
                if(arr.length==1){
                    xc.getBalanceTypeDicNode(_storeId,1,token,layer,form,$('.specilCoin select[name="BalanceIndex"]'),arr[0].BalanceIndex);
                    $('.specilCoin input[name="OnceSigleMax"]').val(arr[0].OnceSigleMax);
                    $('.specilCoin input[name="OnceWarningValue"]').val(arr[0].OnceWarningValue);
                    $('.specilCoin input[name="DayMax"]').val(arr[0].DayMax);
                    $('.specilCoin input[name="DayWaringValue"]').val(arr[0].DayWaringValue);
                }else if(arr.length>1){
                    for(let i=1;i<arr.length;i++){
                        $('.specilCoinBox').append($('body').find($('.specilCoin')).eq(0).clone());
                    }
                    for(let i=0;i<arr.length;i++){
                        xc.getBalanceTypeDicNode(_storeId,1,token,layer,form, $('.specilCoinBox').find($('.specilCoin')).eq(i).find('select[name="BalanceIndex"]'),arr[i].BalanceIndex);
                        $('.specilCoinBox').find($('.specilCoin')).eq(i).find('input[name="OnceSigleMax"]').val(arr[i].OnceSigleMax);
                        $('.specilCoinBox').find($('.specilCoin')).eq(i).find('input[name="OnceWarningValue"]').val(arr[i].OnceWarningValue);
                        $('.specilCoinBox').find($('.specilCoin')).eq(i).find('input[name="DayMax"]').val(arr[i].DayMax);
                        $('.specilCoinBox').find($('.specilCoin')).eq(i).find('input[name="DayWaringValue"]').val(arr[i].DayWaringValue);
                    }
                }
            }
        }
    })
}
    function initMember(token,layer,form){
        let _obj={'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(_obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/Member?action=GetMemberLevelDic',
            contentType: "application/json; charset=utf-8",
            async:false,
            data:{parasJson: parseJson},
            success: function (data) {
                data = JSON.parse(data);
                if (data.result_code == 1) {
                    let arr=data.result_data;
                    $('#cmbAutoJoinMemberLevel').html('<option>-请选择-</option>');
                    $('#cmbCardOpenLevel').html('<option>-请选择-</option>');
                    for(let i in arr){
                        $('#cmbAutoJoinMemberLevel').append('<option value="'+arr[i].MemberLevelID+'">'+arr[i].MemberLevelName+'</option>')
                        $('#cmbCardOpenLevel').append('<option value="'+arr[i].MemberLevelID+'">'+arr[i].MemberLevelName+'</option>')
                    }
                    form.render('select');
                } else {
                    layer.msg(data.result_msg);
                }
            }
        });

    }
    layui.use(['element','form','layer','table'], function(){
        let element = layui.element;
        let form=layui.form;
        let layer=layui.layer;
        let table=layui.table;

        initMember(token,layer,form);
        ifNeedSet(_storeId,form,layer);
        setTimeout(setBbi(_storeId,form,layer),200);
        //正价币增加 或者减少一条
        $('#addPrice').on('click',function () {
           if($('.priceCoinBox').find($('.priceCoin')).length<$('body').find('select[name="limitType"]').eq(0).find('option').length-1) {
               $('.priceCoinBox').append($('body').find($('.priceCoin')).eq(0).clone())
           }
        });
        $('#delPrice').click(function () {
            if($('.priceCoinBox').find($('.priceCoin')).length>1){
                $('.priceCoinBox').find($('.priceCoin')).last().remove();
            }else {
            }
        });
        //补币增加 或者减少一条
        $('#addCoin').on('click',function () {
            // if($('.priceCoinBox').find($('.priceCoin')).length<$('body').find('select[name="limitType"]').eq(0).find('option').length-1) {
                $('.specilCoinBox').append($('body').find($('.specilCoin')).eq(0).clone())
            // }
        });
        $('#delCoin').click(function () {
            if($('.specilCoinBox').find($('.specilCoin')).length>1){
                $('.specilCoinBox').find($('.specilCoin')).last().remove();
            }else {
            }
        });
        //运营参数设定
        form.on('switch(chkPrintBarcode)',(data)=>{
            data.elem.checked==true ?chkPrintBarcode=1 :chkPrintBarcode=0
        });
        form.on('switch(chkBarSendCoinAuthorize)',(data)=>{
            data.elem.checked==true ?chkBarSendCoinAuthorize=1 :chkBarSendCoinAuthorize=0
        });
        form.on('select(txtBusinessClass)',function (data) {
            txtBusinessClass=data.value;
            // sourceTypeStr=data.elem[data.elem.selectedIndex].text;
        });
        form.on('select(cmbAuthChannel)',function (data) {
            cmbAuthChannel =data.value;
        });
        form.on('select(cmbCardOpenLevel)',function (data) {
            cmbCardOpenLevel =data.value;
        });
        form.on('switch(chkShift)',(data)=>{
            data.elem.checked==true ?chkShift=1 :chkShift=0
        });
        form.on('switch(chkTaxInSale)',(data)=>{
            data.elem.checked==true ?chkTaxInSale=1 :chkTaxInSale=0
        });
        form.on('switch(chkGiftArea)',(data)=>{
            data.elem.checked==true ?chkGiftArea=1 :chkGiftArea=0
    });
        //会员设定
        form.on('select(cmbBirthdaySendSms)',function (data) {
            cmbBirthdaySendSms=data.value;
        });
        form.on('switch(chkPhotograph)',(data)=>{
            data.elem.checked==true ?chkPhotograph=1 :chkPhotograph=0
        });
        form.on('switch(chkExitCardCatch)',(data)=>{
            data.elem.checked==true ?chkExitCardCatch=1 :chkExitCardCatch=0
        });
        form.on('switch(chkExitFoodCatch)',(data)=>{
            data.elem.checked==true ?chkExitFoodCatch=1 :chkExitFoodCatch=0
        });
        form.on('switch(chkForceClearBalanceOnExitCard)',(data)=>{
            data.elem.checked==true ?chkForceClearBalanceOnExitCard=1 :chkForceClearBalanceOnExitCard=0
        });
        //游乐项目规则设定
        form.on('checkbox(chkAccompanyOutWithMain)',(data)=>{
            data.elem.checked==true ?chkAccompanyOutWithMain=1 :chkAccompanyOutWithMain=0
        });
        form.on('checkbox(chkAddLeaveTime)',(data)=>{
            data.elem.checked==true ?chkAddLeaveTime=1 :chkAddLeaveTime=0
        });
        form.on('select(cmbAutoJoinMemberLevel)',(data)=>{
            cmbAutoJoinMemberLevel=data.value;
        });
        $('#rulesBtn').on('click',function (){
            arrRule.push({
                'SourceType':sourceType,
                'SourceTypeStr':chargeTypeStr,
                'SourceCount':$('#sourceCount').val(),
                'ChargeType':chargeType,
                'ChargeTypeStr':chargeTypeStr,
                'ChargeCount':$('#chargeCount').val(),
                'AlertValue':$('#alertValue').val(),
            });
            table.render({
                elem: '#chargeRules'
                ,data:arrRule
                ,cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                ,height:200
                ,size:'sm'
                ,cols: [[
                    {field:'SourceTypeStr', title: '原类型', align: 'center'} //width 支持：数字、百分比和不填写。你还可以通过 minWidth 参数局部定义当前单元格的最小宽度，layui 2.2.1 新增
                    ,{field:'SourceCount', title: '原数量', sort: true}
                    ,{field:'ChargeTypeStr', title: '兑换类型', align: 'center'}
                    ,{field:'ChargeCount', title: '兑换数量', align: 'center'}
                    ,{field:'AlertValue', title: '警戒值', align: 'center'} //单元格内容水平居中
                    ,{fixed: 'right', title: '操作', width:100, align:'center', toolbar: '#barDemoRule'}
                ]]
                ,page:true
                ,limit:10
            });
        });
        form.on('checkbox(cusmor)',function (data) {
            if(data.elem.checked){
                cmbAutoJoinMemberLevels.push(data.elem.value)
            }else {
                for(let i in cmbAutoJoinMemberLevels ){
                    if(cmbAutoJoinMemberLevels[i]==data.elem.value){
                        cmbAutoJoinMemberLevels.splice(i,1);
                    }
                }
            }
        });

        form.on('checkbox(cmbAuthChannel)',function (data) {
            if(data.elem.checked){
                cmbAuthChannel.push(data.elem.value)
            }else {
                for(let i in cmbAuthChannel ){
                    if(cmbAuthChannel[i]==data.elem.value){
                        cmbAuthChannel.splice(i,1);
                    }
                }
            }
        });
        table.on('tool(chargeRules)',function (obj) {
            let data=obj.data;
            let enevt=obj.event;
            if(event==='del'){

            }
        });
    function getBackRule(storeId) {
        let obj={"storeId":storeId,"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
        let url = "/XCCloud/Parameter?action=GetGivebackRules";
        let parasJson = JSON.stringify(obj);
        $.ajax({
            type: "post",
            url: url,
            contentType: "application/json; charset=utf-8",
            data: { parasJson: parasJson },
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code=="1"){
                    dataTable=data.result_data;
                    layui.use('table', function(){
                        var table = layui.table;
                        table.render({
                            elem: '#test'
                            ,data:dataTable
                            ,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                            ,height:220
                            ,size:'sm'
                            ,cols: [[
                                {field:'MemberLevelID', title: '会员级别', align: 'center'} //width 支持：数字、百分比和不填写。你还可以通过 minWidth 参数局部定义当前单元格的最小宽度，layui 2.2.1 新增
                                ,{field:'BackMin', title: '最小币数', sort: true}
                                ,{field:'BackMax', title: '最大币数', align: 'center'}
                                ,{field:'BackScale', title: '返还比例', align: 'center'}
                                ,{field:'ExitCardMin', title: '退卡最小余额', align: 'center'} //单元格内容水平居中
                                ,{field:'Backtype', title: '计算方式', align: 'center'} //单元格内容水平居中
                                ,{field:'TotalDays', title: '累计天数',  align: 'center'}
                                ,{field:'AllowBackPrincipal', title: '是否扣除返还币', align: 'center'}
                                ,{field:'AllowContainToday', title: '是否当天统计', align: 'center'}
                            ]]
                            ,page:true
                            ,limit:10
                        });
                    });

                }else {
                    // alert("添加失败，请核对后再次提交！");
                    console.log(data.result_msg||data.return_msg);
                }
            }
        });
    }
    $('.checkBox>span').click(function () {
            $(this).addClass("layui-hide").siblings().removeClass("layui-hide");
        });
    function setParamList(storeIds,layer) {
        let a,b,c;
        let submitData=[
            { "storeId":storeIds, "system":"chkPrintBarcode", "isAllow":1, "pValue":chkPrintBarcode, "note":""},//4
            { "storeId":storeIds, "system":"chkBarSendCoinAuthorize", "isAllow":1, "pValue":chkBarSendCoinAuthorize, "note":""},  //5
            { "storeId":storeIds, "system":"txtOnceSellCoinMin", "isAllow":"1", "pValue":$('#txtOnceSellCoinMin').val(), "note":""},//7
            { "storeId":storeIds, "system":"txtBusinessClass", "isAllow":"1", "pValue":txtBusinessClass, "note":""},//7
            { "storeId":storeIds, "system":"cmbAuthChannel", "isAllow":1, "pValue":cmbAuthChannel.length>0?cmbAuthChannel.join('|'):'', "note":""},
            { "storeId":storeIds, "system":"chkShift", "isAllow":1, "pValue":chkShift, "note":""},
            { "storeId":storeIds, "system":"chkTaxInSale", "isAllow":1, "pValue":chkTaxInSale, "note":""},
            { "storeId":storeIds, "system":"cmbBirthdaySendSms", "isAllow":"1", "pValue":cmbBirthdaySendSms, "note":""},
            { "storeId":storeIds, "system":"chkPhotograph", "isAllow":1, "pValue":chkPhotograph, "note":""},
            { "storeId":storeIds, "system":"chkExitCardCatch", "isAllow":1, "pValue":chkExitCardCatch, "note":""},
            { "storeId":storeIds, "system":"chkExitFoodCatch", "isAllow":1, "pValue":chkExitFoodCatch, "note":""},
            { "storeId":storeIds, "system":"chkAccompanyOutWithMain", "isAllow":1, "pValue":chkAccompanyOutWithMain, "note":""},
            { "storeId":storeIds, "system":"chkForceClearBalanceOnExitCard", "isAllow":1, "pValue":chkForceClearBalanceOnExitCard, "note":""},
            { "storeId":storeIds, "system":"chkAddLeaveTime", "isAllow":1, "pValue":chkAddLeaveTime, "note":""},
            { "storeId":storeIds, "system":"cmbAutoJoinMemberLevel", "isAllow":1, "pValue":cmbAutoJoinMemberLevel, "note":""},
            { "storeId":storeIds, "system":"txtClientBuyTicketInfo", "isAllow":1, "pValue":cmbAutoJoinMemberLevels.length>0?cmbAutoJoinMemberLevels.join('|'):'', "note":""},
            { "storeId":storeIds, "system":"txtCreditEveryday", "isAllow":1, "pValue":$('input[name="txtCreditEveryday"]').val(), "note":""},
            { "storeId":storeIds, "system":"txtMaxSendCard", "isAllow":"1", "pValue":$('input[name="txtMaxSendCard"]').val(), "note":""},
            { "storeId":storeIds, "system":"cmbCardOpenLevel", "isAllow":"1", "pValue":cmbCardOpenLevel, "note":""},
            { "storeId":storeIds, "system":"chkGiftArea", "isAllow":1, "pValue":chkGiftArea, "note":""},
        ];
        let obj={"submitData":submitData, "userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
        let parasJson = JSON.stringify(obj);
        $.ajax({
            type: "post",
            url: "/XCCloud/Parameter?action=SetParamList",
            contentType: "application/json; charset=utf-8",
            data: { parasJson: parasJson },
            async: false,
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code=="1"){
                    a=1;
                }else {
                   a=0;
                }
            }
        });
        //保存正价币
        let StandardCoinPrice=[];
        $('.priceCoinBox .priceCoin').each(function () {
            if($(this).find('select[name="limitType"] option:selected').val()&&$(this).find('input[name="CoinCount"]').val()!=''&&
                $(this).find('input[name="CashPrice"]').val()!=''
            ) {
                StandardCoinPrice.push({
                    'balanceIndex': $(this).find('select[name="limitType"] option:selected').val(),
                    'coinCount': $(this).find('input[name="CoinCount"]').val(),
                    'cashPrice': $(this).find('input[name="CashPrice"]').val()
                })
            }
        });
        let obj1={"storeId":storeIds,
            'standardCoinPrice': StandardCoinPrice.length>0?StandardCoinPrice:'',
            "userToken":token,
            "signkey":"1f626576304bf5d95b72ece2222e42c3"};
        $.ajax({
            type: "post",
            url: "/XCCloud/Parameter?action=SaveStandardCoinPrice",
            contentType: "application/json; charset=utf-8",
            data: { parasJson: JSON.stringify(obj1) },
            async: false,
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code=="1"){
                    b=1;
                }else {
                    b=0;
                }
            }
        });
        //保存补币F
        let FreeCoinRule=[];
        $('.specilCoinBox .specilCoin').each(function () {
            if($(this).find('select[name="BalanceIndex"] option:selected').val()
                &&$(this).find('input[name="OnceSigleMax"]').val()!=''&&
                $(this).find('input[name="OnceWarningValue"]').val()!=''
                &&$(this).find('input[name="DayMax"]').val()!=''&&
                $(this).find('input[name="DayWaringValue"]').val()!=''){
                FreeCoinRule.push({'balanceIndex':$(this).find('select[name="BalanceIndex"] option:selected').val(),
                    'onceSigleMax':$(this).find('input[name="OnceSigleMax"]').val(),
                    'onceWarningValue':$(this).find('input[name="OnceWarningValue"]').val(),
                    'dayMax':$(this).find('input[name="DayMax"]').val(),
                    'dayWarningValue':$(this).find('input[name="DayWaringValue"]').val()})
            }
        });
        let obj2={"storeId":storeIds,
            'freeCoinRule': FreeCoinRule.length>0?FreeCoinRule:'',
            "userToken":token,
            "signkey":"1f626576304bf5d95b72ece2222e42c3"};
        $.ajax({
            type: "post",
            url: "/XCCloud/Parameter?action=SaveFreeCoinRule",
            contentType: "application/json; charset=utf-8",
            data: { parasJson: JSON.stringify(obj2) },
            async: false,
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code=="1"){
                    c=1;
                }else {
                    c=0;
                }
                if(a&&b&&c){
                    layer.msg('参数设置成功',{time:1500},function () {
                        parent.location.reload()
                    })
                }else if(a==0){
                    layer.msg('请检查基本参数设置是否正确')
                } else if(b==0){
                    layer.msg('请检查正价币规则是否重复')
                }else if(c==0){
                    layer.msg('请检查补币规则是否正确')
                }

            }
        });
    }
    function showAddReturnRule() {
        layui.use('layer',function () {
            var layer=layui.layer;
            layer.open({
                title:'返还规则',
                type:1,
                content:$('.addReturnSetting'),
                area:['860px','450px']
            })
        });

    }
    function addReturnRule(layer,memberLvlId1,allowBackPrincipal1,backType1,allowToday1) {
        let storeIds=getStorage('storeId_merch');
        let memberLvlId=memberLvlId1;
        let allowBackPrincipal=allowBackPrincipal1;
        let backMin=$('#backMin').val();
        let backMax=$('#backMax').val();
        let backScale=$('#backScale').val();
        let exitCardMin=$('#exitCardMin').val();
        let backType=backType1;
        let totalDays=$('#memberLvlId').val();
        let allowContainToday=allowToday1;
        let obj={"storeId":storeIds,
            "memberLvlId":memberLvlId,
            "backMin":backMin,
            "backMax":backMax,
            "backScale":backScale,
            "exitCardMin":exitCardMin,
            "allowBackPrincipal":allowBackPrincipal,
            "backType":backType,
            "totalDays":totalDays,
            "allowContainToday":allowContainToday,
            "userToken":token,
            "signkey":"1f626576304bf5d95b72ece2222e42c3"};
        let url = "/XCCloud/Parameter?action=AddGivebackRule";
        let parasJson = JSON.stringify(obj);
        $.ajax({
            type: "post",
            url: url,
            contentType: "application/json; charset=utf-8",
            data: { parasJson: parasJson },
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code=="1"){
                    getBackRule(_storeId);
                    layer.closeAll();
                }else {
                        layer.msg(data.result_msg);
                }
            }
        })
    }
        $('#submitBtn').on('click',()=>{
            addReturnRule(layer,memberLvlId,allowBackPrincipal,backType,allowToday);
        });
        $('#parameterBtn').on('click',()=>{
            setParamList(_storeId,layer)
        });
        $('#addNewBackRule').on('click',()=>{
            showAddReturnRule();
        })
    });
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn  layui-btn-xs layui-btn-danger" lay-event="del"><i class="layui-icon">&#xe640;</i>删除</a>
</script>
<script type="text/html" id="barDemoRule">
    <a class="layui-btn  layui-btn-xs layui-btn-danger" lay-event="del"><i class="layui-icon">&#xe640;</i>删除</a>
</script>
</html>