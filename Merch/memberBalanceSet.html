<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>会员余额设置</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<body>
<div class="layui-row" style="padding: 15px;">
    <blockquote class="layui-elem-quote" style="text-align: right;padding-right: 100px;">
        <button type="button" class="layui-btn layui-btn-normal" id="add">新增</button>
    </blockquote>
    <div class="layui-col-md12 layui-col-lg12 layui-col-sm12">
        <table class="layui-hide" id="memberBalanceTb"  lay-filter="memberBalanceTb"></table>
    </div>
</div>
<div id="openModel" style="display:none;padding: 0 15px;max-height: 550px;overflow-y: auto">
    <form class="layui-form" lay-filter="formTest">
        <div class="layui-col-md7" style="height: 435px;border: 1px dashed #aaa; padding: 15px;">
                <div class="layui-form-item">
                    <label class="layui-form-label">类别名称</label>
                    <div class="layui-input-block">
                        <input type="text" class="layui-input" id="TypeName" name="unchange">
                    </div>
                </div>
            <div class="layui-form-item">
                <label class="layui-form-label">类别单位</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" id="unit" placeholder="最多2个汉字">
                </div>
            </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">映射类别</label>
                    <div class="layui-input-block">
                        <select id="HKType" lay-filter="HKType" name="HKType">
                            <option >-请选择-</option>
                            <option value="0" selected>不绑定</option>
                            <option value="1">代币</option>
                            <option value="2">彩票</option>
                            <option value="3">积分</option>
                            <option value="4">储值金</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">保留小数位</label>
                    <div class="layui-input-block">
                        <input type="text" class="layui-input" id="saveFloat">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label" style="padding:8px 0;width: 90px">保留小数规则</label>
                    <div class="layui-input-block">
                        <select id="saveFloatRule" name="saveFloatRule" lay-filter="saveFloatRule">
                            <option >-请选择-</option>
                            <option value="0">全部舍弃</option>
                            <option value="1">全部保留</option>
                            <option value="2">四舍五入</option>
                      </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label" style="height: 185px;">适用说明</label>
                    <div class="layui-input-block">
                        <textarea name="" id="Note" class="layui-textarea" style="height: 135px;"></textarea>
                    </div>
                </div>
            <!--</div>-->
        </div>
        <div class="layui-col-md5" style="height: 435px;overflow-y: scroll;border: 1px dashed #aaa ;padding: 15px;border-left: none;">
            <div class="layui-form-item">
                <div class="layui-inline" style="">
                    <div class="layui-input-inline" id="balanceStoreList">

                    </div>
                </div>

            </div>
        </div>
        <div class="layui-col-md12" style="margin: 15px 0;padding-right: 60px;text-align:right;">
            <button type="button" class="layui-btn layui-btn-danger" id="cancelBtn">取消</button>
            <button type="reset" class="layui-btn layui-btn-normal layui-hide" id="reset">取消</button>
            <button type="button" class="layui-btn layui-btn-normal" id="saveBtn">保存</button>
        </div>
    </form>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let storeId=[];
    let Id='';
    let HKType='0';
    let saveFloatRule;
    let parm={'obj':{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
        'url':'/XCCloud/BalanceType?action=GetBalanceTypeList',
        'elem':'#memberBalanceTb',
        'cols':[
            {field:'ID', title:'流水号', align: 'center', sort: true}
            ,{field:'TypeName', title: '类别名称', align: 'center'}
            ,{field:'StoreNames', title: '适用门店', align: 'center'}
            ,{field:'HkTypeStr', title: '关联类别', align: 'center'}
            ,{field:'AddingTypeStr', title: '小数位舍弃方式', align: 'center'}
            ,{field:'DecimalNumber', title: '小数位', align: 'center'}
            ,{field:'Note', title: '使用说明', align: 'center'}
            ,{fixed: 'right', title: '操作', width:160, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);
    layui.use(['form','layer','table'],function () {
        let form=layui.form;
        let layer=layui.layer;
        let table=layui.table;
        form.on('select(HKType)',function (data) {
            HKType=data.value=='-请选择-'?'':data.value;
        });
        form.on('select(saveFloatRule)',function (data) {
            saveFloatRule=data.value=='-请选择-'?'':data.value;
        });
        $('#add').on('click',function () {
            setStore(form,token);
            $('#reset').trigger('click');
             storeId=[];
             Id='';
             HKType='0';
             saveFloatRule='';
            layer.open({
                title:'会员余额类别设定',
                type:1,
                area:'650px',
                content:$('#openModel'),
                cancel:function () {
                    location.reload()
                }
            })
        });
        //saveBtn
        $('#saveBtn').on('click',function () {
            let obj={'id':Id,
                'typeName':$('#TypeName').val(),
                'hkType':HKType,
                'storeIds':storeId==''?'':storeId.join('|'),
                'note':$('#Note').val(),
                'unit':$('#unit').val(),
                'addingType':saveFloatRule,
                'decimalNumber':$('#saveFloat').val(),
                'userToken':token,
                'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parseJson = JSON.stringify(obj);
            $.ajax({
                type:'post',
                url:'/XCCloud/BalanceType?action=SaveBalanceTypeInfo',
                contentType: "application/json; charset=utf-8",
                data:{parasJson: parseJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.result_code == 1) {
                        layer.msg('保存成功！',{time:1500},function () {
                            window.location.reload();
                        });
                    } else {
                        layer.msg(data.result_msg);
                    }
                }
            })
        });
        $('#cancelBtn').on('click',function () {
           layer.closeAll();
            storeId=[];
             Id='';
        });
        form.on('checkbox(balanceStore)',function (data) {
            if (data.elem.checked==true){
                storeId.push(data.value);
            }else if(data.elem.checked==false){
                for (let i=0;i<storeId.length;i++){
                    if(storeId[i]==data.value){
                        storeId.splice(i,1)
                    }
                }
            }
        });
        table.on('tool(memberBalanceTb)',function(obj){
    
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event;
            let DecimalNumber_=data.DecimalNumber;
            if(layEvent === 'edit'){ //查看
                Id=data.ID;
                let _obj={'id':data.ID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type:'post',
                    url:'/XCCloud/BalanceType?action=GetBalanceTypeInfo',
                    contentType: "application/json; charset=utf-8",
                    data:{parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        if (data.result_code == 1) {
                            form.val("formTest", {
                                "HKType": data.result_data.HKType
                                ,"saveFloatRule": data.result_data.AddingType
                            })
                                $('#saveFloat').val(DecimalNumber_);
                                $('#TypeName').val(data.result_data.TypeName);
                                $('#Note').val(data.result_data.Note);
                            $('#unit').val(data.result_data.Unit),
                                setStore(form,token,data.result_data.StoreIDs);
                                if(data.result_data.StoreIDs){
                                      storeId=data.result_data.StoreIDs.split("|");
                                  }else{
                                    storeId=[];
                                  }
                                saveFloatRule=data.result_data.AddingType;
                                HKType=data.result_data.HKType;
                                form.render();
                                // $('#openModel').find('[name="unchange"]').prop('disabled',true);
                                layer.open({
                                    title:'修改会员余额类别',
                                    type:1,
                                    area:'650px',
                                    content:$('#openModel'),
                                    cancel:function () {
                                        location.reload()
                                    }
                                }) 
                        }else {
                            layer.msg(data.result_msg);
                        }
                    }
                });
            }else if(layEvent === 'del'){
                layer.confirm('确定删除该类别吗？', function(index){
                let _obj={'id':data.ID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type:'post',
                    url:'/XCCloud/BalanceType?action=DelBalanceTypeInfo',
                    contentType: "application/json; charset=utf-8",
                    data:{parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        if (data.result_code == 1) {
                         layer.msg('删除成功',{time:1500},function () {
                             xc.getInitData(parm);
                         })

                        }else {
                            layer.msg(data.result_msg||data.return_msg);
                        }
                    }
                });
                });
            }
        })
    });
    function setStore(form,token,StoreId) {
        let obj={'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/StoreInfo?action=GetUnderStores',
            contentType: "application/json; charset=utf-8",
            data:{parasJson: parseJson},
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code==1){
                    $('#balanceStoreList').html('');
                    let array=data.result_data;
                    for(let i in array){
                        $('#balanceStoreList').append('<input type="checkbox" lay-skin="primary" value="'
                           +array[i].Key+'" lay-filter="balanceStore" title="'+array[i].Value+'">')
                    }
                    if(StoreId){
                        let storeIdArr=StoreId.split('|');
                        for(let i in storeIdArr){
                            $('#balanceStoreList').find('input[value="'+storeIdArr[i]+'"]').attr('checked',true);
                        }
                    }
                    form.render('checkbox');
                }else {
                    layer.msg('获取门店列表失败，err:'+data.result_msg||data.return_msg)
                }
            }
        })
    }
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="edit"><i class="layui-icon">&#xe642;</i>编辑</a>
     <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"><i class="layui-icon">&#xe640;</i>删除</a>
</script>
</html>