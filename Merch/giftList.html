<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>商品档案维护</title>
    <link rel="stylesheet" href="layui/css/layui.css">
    <link rel="stylesheet" href=" css/myxc.css">
</head>
<style>
    .layui-form-pane .layui-inline .layui-form-label {
        padding: 8px 0;
    }

    #test2 {
        width: 300px;
        height: 170px;
        border: 1px solid #8D8D8D;
        position: relative;
    }

    #imgBtn {
        width: 60px;
        height: 60px;
        position: absolute;
        top: 55px;
        left: 130px;
        cursor: pointer;
    }

    .imgBox button {
        position: absolute;
        top: 15px;
        right: 15px;
    }

    .imgBox button i {
        font-size: 24px;
        color: red;
    }

    #timeTypeSetBox .layui-input-inline, #timeTypeSetBox .layui-form-label {
        width: 90px;
    }
</style>
<body>
<div class="layui-row settingPage">
    <div class="row-box">
        <div class="layui-col-md12 layui-col-sm12 layui-col-lg12">
            <blockquote class="layui-elem-quote layui-col-md12 layui-col-sm12 layui-col-lg12">
                <div class="layui-form layui-form-pane layui-col-md9" id="form1">
                    <div class="layui-form-item" id="serchMode"></div>
                </div>

                <div class="layui-col-md2" id="form2Box" >
                    <div class="layui-form layui-form-pane" id="form2">
                        <div id="tantion" class="layui-form-item">
                        </div>
                    </div>
                </div>

                <button type="button" class="layui-btn layui-btn-normal layui-col-md1" i18n-content="查询模板" id="searchBtn">查询</button>
            </blockquote>
        </div>
        <div class="layui-col-lg12 layui-col-md12 layui-col-sm12">
            <table class="layui-hide" id="productFileTable" lay-filter="productFileTable"></table>

            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" id="editBtn">修改</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-danger " id="delBtn">删除</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-danger layui-hide" id="forbidBtn">禁止入库</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-danger layui-hide" id="allowBtn">禁止入库</button>
            <button type="button" class="layui-btn  layui-btn-sm layui-btn-normal" id="addNew">新增</button>
        </div>
    </div>
</div>

<!--新增商品弹窗-->
<div id="addNewProduct" style="display: none;padding: 15px;height:550px;overflow-y: scroll">
    <form action="" class="layui-form layui-form-pane">
        <div class="layui-col-md8">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">商品条码</label>
                    <div class="layui-input-inline" style="width: 302px;">
                        <input type="text" class="layui-input" id="Barcode" readonly>
                    </div>
                    <div class="layui-input-inline" style="width: 100px">
                        <button type="button" class="layui-btn layui-btn-normal" id="createBarcodeBtn">自动生成</button>
                    </div>
                    <div class="layui-input-inline" style="width: 100px">
                        <button type="button" class="layui-btn layui-btn-normal">打印条码</button>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">商品名称</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" id="GoodName">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">商品类别</label>
                    <div class="layui-input-inline">
                        <select type="select" id="GoodType" lay-filter="GoodType" title="商品类别"></select>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline goodIsAll">
                    <label class="layui-form-label">商品状态</label>
                    <div class="layui-input-inline">
                        <input type="checkbox" checked lay-skin="switch" lay-text="有效|无效" id="Status"
                               lay-filter="Status">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">添加来源</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" id="Source" disabled readonly>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">零售价格</label>
                <div class="layui-input-block" style="width: 512px;">
                    <input type="text" class="layui-input" id="Prices">
                </div>
            </div>
        </div>
        <div class="layui-col-md4">
            <div class="layui-card" style="height: 220px">
                <div class="layui-card-header">
                    选择上传礼品图片
                </div>
                <div class="layui-card-body">
                    <div id="test2">
                        <div id="imgBtn"><i class="layui-icon" style="font-size: 60px;color: #9F9F9F">&#xe654;</i></div>
                        <div class="layui-upload-list" id="demo2" style="margin: 0;">
                            <input id="nameImage" name="list[0]" maxlength="255" class="input-xlarge required"
                                   type="hidden">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-col-md12 ">

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">兑购余额类型</label>
                    <!--</div>-->
                    <!--<div class="layui-inline">-->
                    <div class="layui-input-inline">
                        <select id="balanceType" lay-filter="balanceType"></select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 60px">兑换</label>
                    <div class="layui-input-inline" style="width: 150px">
                        <input type="text" id="salePrice" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 60px">回购</label>
                    <div class="layui-input-inline" style="width: 150px">
                        <input type="text" id="backPrice" class="layui-input" placeholder="必须小于兑换价格">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-input-inline" style="width: 60px">
                        <button type="button" class="layui-btn" id="setPrice"><i class="layui-icon">&#xe654;</i>
                        </button>
                    </div>
                </div>
            </div>


            <table class="layui-hide" id="priceTable" lay-filter="priceTable"></table>

        </div>
        <div style="" class="layui-col-md12">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <div class="layui-input-inline">
                        <input type="checkbox" id="ReturnFlag" lay-filter="ReturnFlag" title="允许退货" lay-skin="primary">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-input-inline">
                        <input type="checkbox" id="AllowCreatePoint" lay-filter="AllowCreatePoint" title="零售产生积分"
                               lay-skin="primary">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">

                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 80px">销售</label>
                    <div class="layui-input-inline" style="width: 80px">
                        <input type="text" class="layui-input" id="sold">
                    </div>
                    <div class="layui-input-inline" style="width: 140px">
                        <select name="" id="time" lay-filter="time">
                            <option value="0">小时</option>
                            <option value="1">天</option>
                        </select>
                    </div>
                    <div class="layui-form-mid">
                        后不可退货
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">退货手续费</label>
                    <div class="layui-input-inline" style="width: 40px">
                        <input type="checkbox" id="money" lay-filter="money" lay-skin="primary">
                    </div>
                    <div class="layui-input-inline" style="width: 140px">
                        <input type="text" id="setmoney" class="layui-input">
                        <span class="layui-unit">元</span>
                    </div>
                    <div class="layui-input-inline" style="width: 40px">
                        <input type="checkbox" id="present" lay-filter="present" lay-skin="primary">
                    </div>
                    <div class="layui-input-inline" style="width: 140px">
                        <input type="text" id="setpresent" class="layui-input">
                        <span class="layui-unit">%</span>
                    </div>

                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">&nbsp;备注&nbsp;</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" id="Note">
                </div>
            </div>
            <div style="margin-bottom: 15px; text-align:center;">
                <button type="button" class="layui-btn layui-btn-normal" id="save"><i class="layui-icon">&#xe605;</i>保存
                </button>
            </div>

        </div>
    </form>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script src="js/searchModel.js"></script>
<script>
    let xc = xcActionSystem.prototype;
    let token = xc.getStorage('token');
    let merchId = JSON.parse(xc.getStorage('logMsg')).merchId;
    let Status = 1;
    let GoodType = '';
    let id = '';
    let priceArr = [];
    let balanceType = '';
    let balanceTypeStr = '';
    let AllowStorage = 1;
    let ReturnFlag = 0;
    let AllowCreatePoint = 0;
    let time = 0;
    let money = 0;
    let present = 0;

    //初始化表格
    let checkedArr=[]
    let parm = {
        'obj': {'conditions': [], 'userToken': token, 'signkey': '1f626576304bf5d95b72ece2222e42c3'},
        'url': '/XCCloud/GoodsInfo?action=QueryGoodsInfo',
        'elem': '#productFileTable',
        'cols': [
            // {field:'ID', title:'商品ID', align: 'center', sort: true}
            // ,
            {type:'checkbox'}
            ,{field: 'Barcode', title: '商品条码', align: 'center'}
            , {field: 'GoodTypeStr', title: '商品类别', align: 'center'} //width 支持：数字、百分比和不填写。
            , {field: 'GoodName', title: '商品名称', align: 'center'}
            , {field: 'Source', title: '添加来源', align: 'center'}
            , {field: 'AllowStorage', title: '入库状态', align: 'center', templet: '#AllowStorage'}
            , {field: 'Price', title: '零售价格', align: 'center'}
            , {field: 'AllowCreatePoint', title: '是否产生积分', align: 'center', templet: '#createPoint'}
            , {field: 'Note', title: '备注', align: 'center'}
            // , {fixed: 'right', title: '操作', width: 260, align: 'center', toolbar: '#barDemo'}
            ]
    };
    xc.getInitData(parm);
    layui.addcss('layui_font.css');
    layui.use(['layer', 'form', 'table', 'upload','laydate'], () => {
        let layer = layui.layer;
        let form = layui.form;
        let table = layui.table;
        let upload = layui.upload;
        let laydate=layui.laydate;
        seachModel({
            'elem1': 'tantion',
            'elem2': 'serchMode',
            'pagename': 'projectTicketSearch',
            'processname': 'projectTicketSearch',
            'token': token,
            'form': form,
            'layer': layer,
            'laydate':laydate,
            'searchBtn': 'searchBtn',
            'xc':xc,
            'parm':parm
        })
        form.on('select(GoodType)', (data) => {
            GoodType = data.value;
        });
        form.on('select(balanceType)', (data) => {
            balanceType = data.value;
            balanceTypeStr = data.elem[data.elem.selectedIndex].text;
        });
        form.on('switch(Status)', (data) => {
            if (data.elem.checked == true) {
                Status = 1;
            } else {
                Status = 0;
            }
        });
        form.on('checkbox(ReturnFlag)', (data) => {
            if (data.elem.checked == true) {
                ReturnFlag = 1;
            } else {
                ReturnFlag = 0;
            }
        });
        form.on('checkbox(AllowCreatePoint)', (data) => {
            if (data.elem.checked == true) {
                AllowCreatePoint = 1;
            } else {
                AllowCreatePoint = 0;
            }
        });
        form.on('select(time)', (data) => {
            time = data.value;
        });
        form.on('checkbox(money)', (data) => {
            if (data.elem.checked == true) {
                money = 1;
            } else {
                money = 0;
            }
            $('#present').attr({'checked': false});
            form.render('checkbox');
            $('#setmoney').val('');
        });
        form.on('checkbox(present)', (data) => {
            if (data.elem.checked == true) {
                present = 1;
            } else {
                present = 0;
            }
            $('#money').attr({'checked': false});
            form.render('checkbox');
            $('#setpresent').val('');
        });

        //上传图片
        var demoListViewStore = $('#demo2'), uploadListInsStore = upload.render({
            elem: '#imgBtn'
            , url: '/XCCloud/GoodsInfo?action=UploadGoodPhoto'
            , data: {'userToken': token, 'signkey': '1f626576304bf5d95b72ece2222e42c3'}
            , multiple: true
            , accept: "images"
            , size: 1000
            , auto: true
            , done: function (res, index, upload) {
                //上传完毕
                console.log(res);
                if (res.result_code == 1) {
                    $('#demo2').children('div[class="imgBox"]').remove();
                    $('#demo2 .loadTips').addClass('layui-hide');
                    $('#demo2').append('<div style="display: inline-block;position: relative" class="imgBox">' +
                        '<button type="button" ><i class="layui-icon"><i class="layui-icon">&#xe640</i></i></button>' +
                        '<img src="' + res.result_data[0].Value + '" alt="' + res.result_data[0].Value + '" class="layui-upload-img_md" ' +
                        'style="display: block;width: 300px;height: 170px"></div>');
                    layer.msg("图片上传成功！");
                    $('.imgBox button').click(function () {
                        $(this).parent('div').remove();
                    });
                    $('.imgBox img').click(function () {
                        layer.open({
                            title: res.result_data.ID,
                            type: 1,
                            area: ['600px', '400px'], //宽高
                            content: '<div><img src="' + res.result_data[0].Value + '" alt="" style="display: block;"></div>'
                        });
                    });
                } else {
                    layer.msg(res.return_msg);
                }
            }
            , error: function (index, upload) {
                layer.msg("服务器返回错误！");
                layer.closeAll('loading');
            }
        });
        $('#addNew').on('click', () => {
            Status = 1;
            GoodType = '';
            id = '';
            priceArr = [];
            balanceType = '';
            balanceTypeStr = '';
            AllowStorage = 0;
            ReturnFlag = 0;
            AllowCreatePoint = 0;
            time = 0;
            money = 0;
            present = 0;
            $('#createBarcodeBtn').removeClass('layui-hide');
            $('#Status').attr('disabled', true);
            form.render();
            // xc.setSelect('商品类别','GoodType');
            xc.getGoogsTypeDic(merchId, '商品类别', 'GoodType', form, layer)
            xc.getBalanceTypeDic('', token, layer, form, 'balanceType');
            layer.open({
                title: '新增商品',
                area: '1030px',
                type: 1,
                content: $('#addNewProduct'),
                cancel: function (index, layero) {
                    location.href = 'giftList.html'
                }
            })
        });
        $('#save').on('click', () => {
            let feeTypes;
            let ReturnFees;
            if (money == 0 && present == 0) {
                layer.msg('请设置退货手续费')
            } else {
                money == 0 ? feeTypes = 1 : feeTypes = 0
                money = 0 ? ReturnFees = $('#setpresent').val() : ReturnFees = $('#setmoney').val()
            }
            let _obj = {
                'id': id,
                'Barcode': $('#Barcode').val(),
                'Status': Status,
                'GoodType': GoodType,
                'GoodName': $('#GoodName').val(),
                // 'AllowStorage':0,
                'returnFlag': ReturnFlag,
                'allowCreatePoint': AllowCreatePoint,
                'returnTime': $('#sold').val(),
                'timeType': time,
                'price': $('#Prices').val(),
                'feeType': feeTypes,
                'ReturnFee': ReturnFees,
                'GoodPhoteURL': $('.layui-upload-img_md').attr('src'),
                'GoodInfoPrice': priceArr,
                'Note': $('#Note').val(),
                'userToken': token, 'signkey': '1f626576304bf5d95b72ece2222e42c3'
            };
            let url = '/XCCloud/GoodsInfo?action=SaveGoodsInfo';
            let parasJson = JSON.stringify(_obj);
            $.ajax({
                type: "post",
                url: url,
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parasJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.result_code == 1) {
                        layer.msg('保存成功', {time: 1000}, function () {
                            location.href = 'giftList.html'
                        });
                    } else {
                        layer.msg(data.result_msg)
                    }
                }

            })
        });
        //零售回购价格设置
        $('#setPrice').on('click', () => {
            if (priceArr.length > 0) {
                let flag = false;
                for (let i in priceArr) {
                    if (priceArr[i].BalanceIndex == balanceType) {
                        flag = true;
                    }
                }
                if (flag) {
                    layer.open({
                        title: 'tips',
                        area: '300px',
                        content: '该余额类型已存在，如需修改请先删除该余额类型！'
                    })
                } else {
                    //表格数据增加一条
                    priceArr.push({
                        'BalanceIndex': balanceType,
                        'BalanceIndexStr': balanceTypeStr,
                        'Count0': $('#salePrice').val(),
                        'Count1': $('#backPrice').val(),
                    });
                    //渲染表格
                    table.render({
                        elem: '#priceTable'
                        , height: '250px'
                        , size: "sm"
                        , data: priceArr
                        , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                        , cols: [[{field: 'BalanceIndexStr', title: '余额类别', align: 'center', width: 265}
                            , {field: 'Count0', title: '兑换价格', align: 'center', width: 265}
                            , {field: 'Count1', title: '回购价格', align: 'center', width: 270}
                            , {fixed: 'right', title: '操作', width: 140, align: 'center', toolbar: '#barDemo2'}]]
                    });
                    //初始化输入框
                    balanceType = '';
                    balanceTypeStr = '';
                    xc.getBalanceTypeDic('', token, layer, form, 'balanceType');
                    $('#salePrice').val('');
                    $('#backPrice').val('');
                }
            } else {
                //表格数据增加一条
                priceArr.push({
                    'BalanceIndex': balanceType,
                    'BalanceIndexStr': balanceTypeStr,
                    'Count0': $('#salePrice').val(),
                    'Count1': $('#backPrice').val(),
                });
                //渲染表格
                table.render({
                    elem: '#priceTable'
                    , height: '250px'
                    , size: "sm"
                    , data: priceArr
                    , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                    , cols: [[{field: 'BalanceIndexStr', title: '余额类别', align: 'center', width: 265}
                        , {field: 'Count0', title: '兑换价格', align: 'center', width: 265}
                        , {field: 'Count1', title: '回购价格', align: 'center', width: 270}
                        , {fixed: 'right', title: '操作', width: 140, align: 'center', toolbar: '#barDemo2'}]]
                });
                //初始化输入框
                balanceType = '';
                balanceTypeStr = '';
                xc.getBalanceTypeDic('', token, layer, form, 'balanceType');
                $('#salePrice').val('');
                $('#backPrice').val('');
            }
        });
        //自动生成商品条码
        $('#createBarcodeBtn').on('click', function () {
            let obj = {'userToken': token, 'signkey': '1f626576304bf5d95b72ece2222e42c3'};
            let parasJson = JSON.stringify(obj);
            $.ajax({
                type: "post",
                url: '/XCCloud/GoodsInfo?action=GetGoodsBarCode',
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parasJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.result_code == 1) {
                        $('#Barcode').val(data.result_data.BarCode);
                    } else {
                        layer.msg(data.result_msg)
                    }
                }

            })
        });

        //修改
        $('#delBtn').click(function () {
            let checkStatus = table.checkStatus('productFileTable'); //test即为基础参数id对应的值
            let len = checkStatus.data.length;
            if (len >0) {
                let idArr=[];
                for(let i in checkStatus.data){
                    idArr.push(checkStatus.data[i].ID)
                }
                layer.confirm('确定删除该类别吗？', function(index){
                    let _obj={'id':idArr,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/GoodsInfo?action=DelGoodsInfo',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('删除成功',{time:1500},function () {
                                    location.reload();
                                })

                            }else {
                                layer.msg(data.result_msg||data.return_msg);
                            }
                        }
                    });
                });

            } else {
                layer.msg('请至少勾选一条数据！')
            }
        });
        $('#editBtn').click(function () {
            let checkStatus = table.checkStatus('productFileTable'); //test即为基础参数id对应的值
            let len = checkStatus.data.length;
            if (len == 1) {

                Id=checkStatus.data[0].ID;
                $('#Status').attr('disabled', false);
                form.render();
                let _obj = {'id': Id, 'userToken': token, 'signkey': '1f626576304bf5d95b72ece2222e42c3'};
                let url = '/XCCloud/GoodsInfo?action=GetGoodsInfo';
                let parasJson = JSON.stringify(_obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: {parasJson: parasJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        console.log(data);
                        if (data.result_code == 1) {
                            let arr = data.result_data;
                            Status = 1;
                            GoodType = arr.GoodType;
                            id = arr.ID;
                            balanceType = '';
                            balanceTypeStr = '';
                            priceArr = arr.goodInfoPrice;
                            table.render({
                                elem: '#priceTable'
                                , height: '250px'
                                , size: "sm"
                                , data: priceArr
                                , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                , cols: [[{field: 'BalanceIndexStr', title: '余额类别', align: 'center', width: 265}
                                    , {field: 'Count0', title: '兑换价格', align: 'center', width: 265}
                                    , {field: 'Count1', title: '回购价格', align: 'center', width: 270}
                                    , {fixed: 'right', title: '操作', width: 140, align: 'center', toolbar: '#barDemo2'}]]
                            });
                            AllowStorage = arr.AllowStorage;
                            ReturnFlag = arr.ReturnFlag;
                            AllowCreatePoint = arr.AllowCreatePoint;
                            time = arr.TimeType;
                            if (arr.AllowCreatePoint == 1) {
                                $('#AllowCreatePoint').attr({'checked': true})
                            } else {
                                $('#AllowCreatePoint').attr({'checked': false})
                            }
                            if (arr.ReturnFlag == 1) {
                                $('#ReturnFlag').attr({'checked': true})
                            } else {
                                $('#ReturnFlag').attr({'checked': false})
                            }
                            if (arr.FeeType == 0) {
                                money = 1;
                                present = 0;
                                $('#setmoney').val(arr.ReturnFee);
                                $('#money').attr({'checked': true})
                            } else {
                                money = 0;
                                present = 1;
                                $('#setpresent').val(arr.ReturnFee);
                                $('#present').attr({'checked': true})
                            }
                            $('#time').find('option[value="' + arr.TimeType + '"]').prop({'selected': true});
                            $('#Barcode').val(arr.Barcode);
                            $('#Source').val(arr.Source);
                            $('#Prices').val(arr.Price);
                            $('#createBarcodeBtn').addClass('layui-hide');
                            xc.getGoogsTypeDic(merchId, '商品类别', 'GoodType', form, layer, arr.GoodType);
                            xc.getBalanceTypeDic('', token, layer, form, 'balanceType');
                            $('#GoodName').val(arr.GoodName);
                            $('#sold').val(arr.ReturnTime);
                            $('#Note').val(arr.Note);
                            if (arr.GoodPhoteURL) {
                                $('#demo2').append('<div style="display: inline-block;position: relative" class="imgBox">' +
                                    '<button type="button" ><i class="layui-icon"><i class="layui-icon">&#xe640</i></i></button>' +
                                    '<img src="' + arr.GoodPhoteURL + '" class="layui-upload-img_md" ' +
                                    'style="display: block;width: 300px;height: 170px"></div>');
                                $('.imgBox button').click(function () {
                                    $(this).parent('div').remove();
                                });
                            }
                            form.render();
                            layer.open({
                                title: '新增商品',
                                area: '1030px',
                                type: 1,
                                content: $('#addNewProduct'),
                                cancel: function (index, layero) {
                                    location.href = 'giftList.html'
                                }
                            })
                        } else {
                            layer.msg(data.result_msg || data.return_msg)
                        }
                    }

                })

            } else {
                layer.msg('请且勾选一条数据！')
            }
        })
        $('#forbidBtn').click(function () {
            let checkStatus = table.checkStatus('productFileTable'); //test即为基础参数id对应的值
            let len = checkStatus.data.length;
            if (len == 1) {
                Id=checkStatus.data[0].ID;
            layer.confirm('确定修改为禁止入库吗？', function (index) {
                let _obj = {
                    'id': Id,
                    'allowStorage': 0,
                    'userToken': token,
                    'signkey': '1f626576304bf5d95b72ece2222e42c3'
                };
                let url = '/XCCloud/GoodsInfo?action=AllowGoodsStorage';
                let parasJson = JSON.stringify(_obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: {parasJson: parasJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        if (data.result_code == 1) {
                            xc.getInitData(parm);
                            layer.msg('修改状态成功！');
                        } else {
                            layer.msg(data.result_msg)
                        }
                    }
                })

            });
            } else {
                layer.msg('请且勾选一条数据！')
            }
        })
        $('#allowBtn').click(function () {
            let checkStatus = table.checkStatus('productFileTable'); //test即为基础参数id对应的值
            let len = checkStatus.data.length;
            if (len == 1) {
                Id=checkStatus.data[0].ID;
                layer.confirm('确定修改为可入库吗？', function (index) {
                    let _obj = {
                        'id': Id,
                        'allowStorage': 1,
                        'userToken': token,
                        'signkey': '1f626576304bf5d95b72ece2222e42c3'
                    };
                    let url = '/XCCloud/GoodsInfo?action=AllowGoodsStorage';
                    let parasJson = JSON.stringify(_obj);
                    $.ajax({
                        type: "post",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: {parasJson: parasJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                xc.getInitData(parm);
                                layer.msg('修改状态成功！');
                            } else {
                                layer.msg(data.result_msg)
                            }
                        }
                    })

                });
            } else {
                layer.msg('请且勾选一条数据！')
            }
        })


        //事件监听
        table.on('tool(priceTable)', (obj) => {
            let data = obj.data;
            let event = obj.event;
            if (event === 'del') { //查看
                for (let i in priceArr) {
                    if (priceArr[i].BalanceIndexStr == data.BalanceIndexStr) {
                        priceArr.splice(i, 1);
                        obj.del();
                    }
                }
            }
        })

        table.on('checkbox(productFileTable)', function (obj) {
            console.log(obj.data);

            let d=obj.data;
            if (obj.checked) {
                checkedArr.push(obj.data)
                if (d.AllowStorage == 1) {
                    $('#forbidBtn').removeClass('layui-hide');
                    $('#allowBtn').addClass('layui-hide');
                } else {
                    $('#allowBtn').removeClass('layui-hide');
                    $('#forbidBtn').addClass('layui-hide');

                }
            } else {
                for(let i in checkedArr){
                    if (checkedArr[i].ID==d.ID){
                        checkedArr.splice(i,1)
                    }
                }
                if(checkedArr.length>0){
                    if (checkedArr[checkedArr.length-1].AllowStorage == 1) {
                        $('#forbidBtn').removeClass('layui-hide');
                        $('#allowBtn').addClass('layui-hide');
                    } else {
                        $('#allowBtn').removeClass('layui-hide');
                        $('#forbidBtn').addClass('layui-hide');

                    }
                }else {
                    $('#allowBtn').addClass('layui-hide');
                    $('#forbidBtn').addClass('layui-hide');
                }

            }
        })
    });

</script>

<script type="text/html" id="barDemo2">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"> <i class="layui-icon">&#xe640;</i>删除</a>
</script>
<script type="text/html" id="AllowStorage">
    {{# if(d.AllowStorage==1){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="允许|禁止" class="tb_check" lay-filter="test"
           disabled>
    {{# }else{ }}
    <input type="checkbox" name="switch" lay-skin="switch" lay-text="允许|禁止" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
<script type="text/html" id="createPoint">
    {{# if(d.AllowCreatePoint==1){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test"
           disabled>
    {{# }else{ }}
    <input type="checkbox" name="switch" lay-skin="switch" lay-text="是|否" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
</html>