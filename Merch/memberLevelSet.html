<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>会员级别设定</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<style>
    .layui-colla-content1 .lfl1{width: 135px}
   .layui-colla-title{line-height: 34px;height: 34px;}
    .layui-form-pane .layui-inline .layui-form-label{padding: 8px 0;}
    #test2{width: 300px;height: 170px;border: 1px solid #8D8D8D;position: relative;}
    #imgBtn{width: 60px;height: 60px;position: absolute;top: 70px;left: 130px;cursor: pointer;}
    .imgBox button{position: absolute;top: 15px;right: 15px;}
    .imgBox button i {font-size: 24px;color: red;}
    #timeTypeSetBox .layui-input-inline,#timeTypeSetBox .layui-form-label{width: 90px;}
    /*.goodConvert .layui-input-inline{width: 140px;}*/
</style>
<body>
    <div class="layui-row" style="padding: 15px">
        <blockquote class="layui-elem-quote" style="text-align: right;padding-right: 100px;">
            <button type="button" class="layui-btn layui-btn-normal" id="searchBtn"><i class="layui-icon">&#xe615;</i>搜索</button>
             <button type="button" class="layui-btn layui-btn-normal" id="look"><i class="layui-icon">&#xe615;</i>查询</button>
             <button type="button" class="layui-btn layui-btn-normal" id="add"><i class="layui-icon">&#xe654;</i>新增</button>

        </blockquote>
        <div class="layui-col-md12 layui-col-lg12 layui-col-sm12">
            <table class="layui-hide" id="memberLevelTb"  lay-filter="memberLevelTb"></table>
        </div>
    </div>

  <!--//弹出层-->
  <div id="openModel" style="display: none;height: 550px;overflow-y: auto;">
      <form action="" class="layui-form layui-form-pane">
          <div class="layui-collapse" > <!--//lay-accordion-->
              <div class="layui-colla-item">
                  <!--<h2 class="layui-colla-title">封面</h2>-->
                  <div class="layui-colla-content layui-show layui-col-md12">
                      <div class="layui-card layui-col-md6" style="height: 192px">
                          <div class="layui-card-body">
                              <div class="layui-form-item">
                                  <div class="layui-inline">
                                      <label  class="layui-form-label" style="padding: 8px 0;">会员级别名称</label>
                                      <div class="layui-input-inline">
                                          <input type="text" class="layui-input" id="MemberLevelName">
                                      </div>
                                  </div>
                                  <div class="layui-inline goodIsAll">
                                      <label  class="layui-form-label" style="padding: 8px 0!important;">会员级别状态</label>
                                      <div class="layui-input-inline">
                                          <input type="checkbox" name="zzz" lay-skin="switch" lay-text="启用|禁用" id="State" lay-filter="State">
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="layui-card layui-col-md6">
                          <div class="layui-card-body">
                              <div id="test2">
                                  <div id="imgBtn" style="width: 80px;display: inline-block"><i class="layui-icon" style="font-size: 60px;color: #9F9F9F">&#xe654;</i></div>
                                  <div class="layui-upload-list" id="demo2" style="margin: 0;display: inline-block">
                                      <input id="nameImage" name="list[0]" maxlength="255" class="input-xlarge required" type="hidden">
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

              </div>
              <div class="layui-colla-item goodIsAll ">
                  <h2 class="layui-colla-title layui-col-md12">开卡</h2>
                  <div class="layui-colla-content  layui-colla-content1 " >
                     <div class="layui-form-item">
                         <div class="layui-inline">
                             <label  class="layui-form-label ">开户费</label>
                             <div class="layui-input-inline lfl1">
                                 <input type="text" class="layui-input" id="openFee">
                             </div>
                             <div class="layui-form-mid" style="width: 68.45px">(元)</div>
                         </div>
                         <div class="layui-inline">
                             <label  class="layui-form-label ">押金</label>
                             <div class="layui-input-inline lfl1">
                                 <input type="text" class="layui-input" id="deposit">
                             </div>
                             <div class="layui-form-mid">(元)</div>
                         </div>
                         <div class="layui-inline">
                             <label  class="layui-form-label" style="padding: 8px 0!important;">积分清零周期</label>
                             <div class="layui-input-inline lfl1">
                                 <input type="text" class="layui-input" id="clearPointDays">
                             </div>
                             <div class="layui-form-mid">(天)</div>
                         </div>
                         <div class="layui-inline">
                             <label  class="layui-form-label ">有效天数</label>
                             <div class="layui-input-inline lfl1">
                                 <input type="text" class="layui-input" id="validday">
                             </div>
                             <div class="layui-form-mid">(天)</div>
                         </div>
                         <div class="layui-inline">
                             <label  class="layui-form-label ">最小退币数</label>
                             <div class="layui-input-inline lfl1">
                                 <input type="text" class="layui-input" id="minCoin">
                             </div>
                             <div class="layui-form-mid">最大退币数</div>
                             <div class="layui-input-inline lfl1">
                                 <input type="text" class="layui-input" id="maxCoin">
                             </div>
                         </div>
                         <br>
                         <div class="layui-inline goodIsAll">
                             <label  class="layui-form-label" style="padding: 8px 0!important;">开卡需要授权</label>
                             <div class="layui-input-inline">
                                 <input type="checkbox" name="zzz" checked lay-skin="switch" lay-text="启用|禁用" id="needAuthor" lay-filter="needAuthor">
                             </div>
                         </div>
                         <div class="layui-inline goodIsAll">
                             <label  class="layui-form-label" style="padding: 8px 0!important;">身份证读卡</label>
                             <div class="layui-input-inline">
                                 <input type="checkbox" name="zzz"  checked lay-skin="switch" lay-text="启用|禁用" id="useReadID" lay-filter="useReadID">
                             </div>
                         </div>
                         <div class="layui-inline goodIsAll">
                             <div class="layui-input-inline">
                                 <input type="checkbox" title="一张身份证只能办一张卡"  checked   id="cardOnly" lay-filter="cardOnly">
                             </div>
                             <div class="layui-input-inline">
                                 <input type="checkbox"  title="一张手机号只能办一张卡"   checked   id="phoneOnly" lay-filter="phoneOnly">
                             </div>
                         </div>
                         <br>
                         <div class="layui-inline goodIsAll">
                             <label  class="layui-form-label ">手机号必填</label>
                             <div class="layui-input-inline">
                                 <input type="checkbox" name="zzz" lay-skin="switch" lay-text="启用|禁用" id="mustPhone" lay-filter="mustPhone">
                             </div>
                         </div>
                         <div class="layui-inline goodIsAll">
                             <label  class="layui-form-label">身份证必填</label>
                             <div class="layui-input-inline">
                                 <input type="checkbox" name="zzz" lay-skin="switch" lay-text="启用|禁用" id="mustIDCard" lay-filter="mustIDCard">
                             </div>
                         </div>
                         <div class="layui-inline goodIsAll">
                             <label  class="layui-form-label" goodIsAll>人脸识别</label>
                             <div class="layui-input-inline">
                                 <input type="checkbox" name="zzz" lay-skin="switch" lay-text="启用|禁用" id="readFace" lay-filter="readFace">
                             </div>
                         </div>
                         <div class="layui-inline goodIsAll">
                             <label  class="layui-form-label" >掌纹识别</label>
                             <div class="layui-input-inline">
                                 <input type="checkbox" name="zzz" lay-skin="switch" lay-text="启用|禁用" id="readPlam" lay-filter="readPlam">
                             </div>
                         </div>
                         <div class="layui-inline">
                             <label  class="layui-form-label" style="padding: 8px 0;">开卡套餐内容</label>
                             <div class="layui-input-inline">
                                <button type="button" class="layui-btn layui-btn-normal" id="lookGoods">查看开卡套餐内容</button>
                             </div>
                             <div class="layui-input-inline">
                                 <button type="button" class="layui-btn layui-btn-normal" id="setGoods">点击绑定开卡套餐内容</button>
                             </div>
                         </div>
                     </div>
                  </div>
              </div>
              <div class="layui-colla-item">
                  <h2 class="layui-colla-title">变更</h2>
                  <div class="layui-colla-content ">
                      <div class="layui-form-item">
                          <div class="layui-inline">
                              <label  class="layui-form-label">换卡费</label>
                              <div class="layui-input-inline">
                                  <input type="text" class="layui-input" id="changeFee">
                              </div>
                          </div>
                          <div class="layui-inline">
                              <label  class="layui-form-label">补卡费</label>
                              <div class="layui-input-inline">
                                  <input type="text" class="layui-input" id="rechangeFee">
                              </div>
                          </div>
                          <div class="layui-inline">
                              <label  class="layui-form-label">续期费</label>
                              <div class="layui-input-inline">
                                  <input type="text" class="layui-input" id="continueFee">
                              </div>
                          </div>
                          <div class="layui-inline"><label  class="layui-form-label">续期扣积分</label>
                              <div class="layui-input-inline"><input type="text" class="layui-input" id="continueUsePoint"></div>
                          </div>
                      </div>
                      <div class="layui-form-item">
                          <div class="layui-inline">
                              <label  class="layui-form-label">升级扣积分</label>
                              <div class="layui-input-inline"><input type="text" class="layui-input" id="updateUsePoint"></div>
                          </div>
                          <div class="layui-inline"><label class="layui-form-label" style="padding: 8px 0!important;">升级累计消费</label>
                              <div class="layui-input-inline"><input type="text" class="layui-input" id="consumeTotal"></div>
                          </div>
                          <div class="layui-inline"><label class="layui-form-label" style="padding: 8px 0!important;">升级到</label>
                              <div class="layui-input-inline">
                                  <select>
                                      <option value="0">不升级</option>
                                  </select>
                              </div>
                          </div>
                          <div class="layui-inline"><label  class="layui-form-label" style="padding: 8px 0!important;">降级非活跃天数</label>
                              <div class="layui-input-inline"><input type="text" class="layui-input" id="nonActiveDays"></div>
                          </div>
                          <div class="layui-inline"><label class="layui-form-label" style="padding: 8px 0!important;">降级到</label>
                              <div class="layui-input-inline">
                                  <select>
                                      <option value="0">不降级</option>
                                  </select>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <div class="layui-colla-item">
                  <h2 class="layui-colla-title">送币规则</h2>
                  <div class="layui-colla-content ">
                      <div class="layui-form-item">
                          <div class="layui-inline">
                              <label class="layui-form-label">送币频率</label>
                              <div class="layui-input-inline">
                                  <select name="" id="freeRate" lay-filter="freeRate"></select>
                              </div>
                          </div>
                          <div class="layui-inline">
                              <label  class="layui-form-label">送币数</label>
                              <div class="layui-input-inline">
                                  <input type="text" class="layui-input" id="freeCoin">
                              </div>
                          </div>
                          <div class="layui-inline">
                              <label  class="layui-form-label">送币方式</label>
                              <div class="layui-input-inline">
                                  <select name="" id="freeType" lay-filter="freeType"></select>
                              </div>
                          </div>
                          <div class="layui-inline">
                              <label  class="layui-form-label">送币条件</label>
                              <div class="layui-input-inline">
                                  <input type="text" class="layui-input" id="freeNeedWin" placeholder="需要输赢多少币才送">
                              </div>
                          </div>
                          <div class="layui-inline">
                              <label  class="layui-form-label" style="padding: 8px 0!important;">生日送币方式</label>
                              <div class="layui-input-inline">
                                  <select name="" id="birthdayFree" lay-filter="birthdayFree"></select>
                              </div>
                          </div>
                          <div class="layui-inline">
                              <label  class="layui-form-label">生日送币数</label>
                              <div class="layui-input-inline">
                                  <input type="text" class="layui-input" id="birthdayFreeCoin">
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="layui-colla-item">
                  <h2 class="layui-colla-title">商品兑换折扣率</h2>
                  <div class="layui-colla-content ">
                      <div class="layui-form-item goodConvert">
                          <div class="goodRules">
                              <div class="layui-inline" style="margin-right: 0;">
                                  <label class="layui-form-label" style="width: 80px;">余额类别</label>
                                  <div class="layui-input-inline" style="width: 100px;">
                                      <select name="" lay-filter="freeRate"></select>
                                  </div>
                              </div>
                              <div class="layui-inline" style="margin-right: 0;">
                                  <label  class="layui-form-label" style="width: 80px;">兑换折扣</label>
                                  <div class="layui-input-inline" style="width: 60px;">
                                      <input type="text" class="layui-input">
                                  </div>
                                  <div class="layui-form-mid">%</div>
                              </div>
                              <div class="layui-inline" style="margin-right: 0;">
                                  <div class="layui-input-inline" style="width: 110px;">
                                      <input type="checkbox"   title="需要授权" lay-skin="primary">
                                  </div>
                              </div>
                              <div class="layui-inline" style="margin-right: 0;">
                                  <label  class="layui-form-label" style="width: 100px;">最大存储余额</label>
                                  <div class="layui-input-inline" style="width: 90px;">
                                      <input type="text" class="layui-input" >
                                  </div>
                                  <div  class="layui-form-mid" style="width: 100px;">单词最大增加数</div>
                                  <div class="layui-input-inline" style="width: 88px;">
                                      <input type="text" class="layui-input">
                                  </div>
                              </div>
                          </div>

                          <div class="layui-btn-group">
                              <button class="layui-btn layui-btn-sm" type="button" id="addMore">
                                  <i class="layui-icon">&#xe654;</i>
                              </button>
                              <button class="layui-btn layui-btn-sm" type="button" id="reduceBtn">
                                  <i class="layui-icon">&#x1006;</i>
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="layui-colla-item">
                  <h2 class="layui-colla-title">兑换方式</h2>
                  <div class="layui-colla-content ">
                      <div class="layui-form-item">
                          <div class="layui-inline goodIsAll">
                              <label  class="layui-form-label ">允许退卡</label>
                              <div class="layui-input-inline">
                                  <input type="checkbox" name="zzz" lay-skin="switch" lay-text="启用|禁用" id="allowExitCard" lay-filter="allowExitCard">
                              </div>
                          </div>
                          <div class="layui-inline goodIsAll">
                              <label  class="layui-form-label">允许退款</label>
                              <div class="layui-input-inline">
                                  <input type="checkbox" name="zzz" lay-skin="switch" lay-text="启用|禁用" id="allowExitMoney" lay-filter="allowExitMoney">
                              </div>
                          </div>
                          <div class="layui-inline goodIsAll">
                              <label  class="layui-form-label" style="padding: 8px 0!important;">投币后拔卡锁机头</label>
                              <div class="layui-input-inline">
                                  <input type="checkbox" name="zzz" lay-skin="switch" lay-text="启用|禁用" id="lockHead" lay-filter="lockHead">
                              </div>
                          </div>
                          <div class="layui-inline goodIsAll">
                              <label  class="layui-form-label">允许下分</label>
                              <div class="layui-input-inline">
                                  <input type="checkbox" name="zzz" lay-skin="switch" lay-text="启用|禁用" id="allowExitCoinToCar" lay-filter="allowExitCoinToCar">
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="layui-colla-item">
                  <h2 class="layui-colla-title">预赠币</h2>
                  <div class="layui-colla-content ">
                      <div class="layui-form-item freeLast">
                          <div class="sendBox">
                              <div class="layui-inline reduceBox">
                                  <label  class="layui-form-label" style="width: 90px">充值满</label>
                                  <div class="layui-input-inline" style="width: 60px">
                                      <input type="text" class="layui-input" id="chargeTotal">
                                  </div>
                                  <div class="layui-form-mid">元，预赠方式</div>
                                  <div class="layui-input-inline" style="width: 130px">
                                      <select name="" id="freeBalanceType" lay-filter="freeBalanceType"></select>
                                  </div>
                                  <div class="layui-form-mid">元，预赠币</div>
                                  <div class="layui-input-inline" style="width: 60px">
                                      <input type="text" class="layui-input" id="freeCount">
                                  </div>
                                  <div class="layui-form-mid">最小间隔</div>
                                  <div class="layui-input-inline" style="width: 60px" >
                                      <input type="text" class="layui-input" id="minSpaceDays">
                                  </div>
                                  <div class="layui-form-mid">天,可领</div>
                                  <div class="layui-input-inline" style="width: 60px">
                                      <input type="text" class="layui-input" id="onceFreeCount">
                                  </div>
                                  <div class="layui-form-mid">币,有效天数</div>
                                  <div class="layui-input-inline" style="width: 60px">
                                      <input type="text" class="layui-input" id="expireDays">
                                  </div>
                                  <div class="layui-input-inline" style="width: 60px">
                                      <button type="button" class="layui-btn layui-btn-normal" id="addFreeRule">添加</button>
                                  </div>
                              </div>
                          </div>

                          <div class="layui-btn-group">
                              <button class="layui-btn layui-btn-sm" type="button" id="addMore1">
                                  <i class="layui-icon">&#xe654;</i>
                              </button>
                              <button class="layui-btn layui-btn-sm" type="button" id="reduceBtn1">
                                  <i class="layui-icon">&#x1006;</i>
                              </button>
                          </div>
                      </div>
                      <!--<div style="text-align:right;">-->

                      <!--</div>-->
                      <!--<table class="layui-hide" id="sendCoinTable" lay-filter="sendCoinTable"></table>-->
                  </div>
              </div>
          </div>

          <div style="text-align: right;padding-right: 80px;margin: 15px 0">
              <button type="button" class="layui-btn layui-btn-normal cancleBtn"><i class="layui-icon">&#xe603;</i>取消</button>
              <button type="reset" class="layui-btn layui-btn-danger" id="resetBtn"><i class="layui-icon">&#x1002;</i>重置</button>
              <button type="button" class="layui-btn layui-btn-normal" id="saveMLBtn"><i class="layui-icon">&#xe654;</i>确定</button>
          </div>
      </form>
  </div>
<!--绑定莱卡套餐弹窗-->
<div id="bindFood" style="display: none;padding: 15px">
    <form action="" class="layui-form">
        <div class="layui-form-item">
            <label for="" class="layui-form-label">选择套餐</label>
            <div class="layui-input-inline" id="foodListBox">

            </div>
        </div>
    </form>
    <div style="text-align:center;margin: 15px;">
        <button type="button" class="layui-btn" id="closeBtn">关闭</button>
        <button type="button" class="layui-btn" id="saveFood">保存</button>
    </div>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let merchId=JSON.parse(xc.getStorage('logMsg')).merchId;
    let memberLevelID;
    let arrSendCoinTable=[];
    let memberLevelFood=[];

    let index;//layer;
    let parm={'obj':{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
        'url':'/XCCloud/Member?action=QueryMemberLevel',
        'elem':'#memberLevelTb',
        'cols':[
            {field:'MemberLevelID', title:'级别编号', align: 'center', sort: true,width:80}
            ,{field:'MemberLevelName',title: '级别名称', align: 'center'}
            ,{field:'OpenFee', title: '开户费', align: 'center'}
            ,{field:'Deposit', title: '押金', align: 'center'}
            ,{field:'Validday', title: '有效天数', align: 'center',templet:'#changeLock',width:140}
            ,{field:'ContinueFee', title: '续费期', align: 'center'}
            ,{field:'UpdateUsePoint', title: '升级销毁积分', align: 'center'}
            ,{field:'ConsumeTotle', title: '升级累计金额', align: 'center'}
            ,{field:'BirthdayFreeStr', title: '生日送币方式', align: 'center'}
            ,{field:'FreeTypeStr', title: '送币方式', align: 'center'}
            ,{field:'LogName', title: '操作员', align: 'center'}
            ,{fixed: 'right',title:'操作', width:140, align:'center', toolbar: '#barDemo'}
        ]
    };
    xc.getInitData(parm);

   let needAuthor=1;let mustPhone=0;let mustIDCard=0;let useReadID=1;let readFace=0;let readPlam=0;

   let BirthdayFree='';let freeType='';let freeRate='';

   let freeBalanceType='';

   let  AllowExitCard=0,AllowExitMoney=0,AllowExitCoinToCar=0,LockHead=0,States=0;
    layui.use(['form','layer','table','element','upload'],()=> {
        let layer=layui.layer,
            table=layui.table,
            form=layui.form,
            element=layui.element;
          let  upload=layui.upload;

        $('#addMore').click(function () {
            $('.goodConvert').append($('body').find($('.goodRules')).eq(0).clone())
        });
        $('#reduceBtn').click(function () {
            if($('.goodConvert').find($('.goodRules')).length>1){
                $('.goodConvert').find($('.goodRules')).last().remove();
            }else {
            }
        });
        //新增按钮
        $('#add').on('click',()=>{
             needAuthor=1; mustPhone=0; mustIDCard=0; useReadID=1; readFace=0; readPlam=0;
             BirthdayFree=''; freeType=''; freeRate='';
             freeBalanceType='';
              AllowExitCard=0;AllowExitMoney=0;AllowExitCoinToCar=0;LockHead=0;States=0;
            newTable(table,arrSendCoinTable,layer,form);
            xc.setSelect('生日送币方式','birthdayFree');
            xc.setSelect('送币频率','freeRate');
            xc.setSelect('送币方式','freeType');
            xc.getBalanceTypeDic(token,layer,form,'freeBalanceType');
            layer.open({
                type:1,
                area:'1030px',
                shade:0.6,
                offset:'20px',
                content:$('#openModel')
            });
        });
        //提示
        $('#priceOff').on('blur',function () {
            if($(this).val()<0||parseInt($(this).val())>1){
                layer.tips('这个值必须在0-1之间','#priceOff')
            }
        });
        //绑定开卡套餐
        $('#setGoods').on('click',function () {
            getFoodList(token,form,layer);
            index= layer.open({
                type:1,
                area:'400px',
                content:$('#bindFood')
            })
        });
        //保存选中套餐
        $('#saveFood').on('click',function () {
            layer.close(index);
        });
        $('#closeBtn').on('click',function () {
            layer.close(index);
            memberLevelFood=[];
            $('#foodListBox').html('');
            form.render();
        });
        //监听选中的套餐设置
        form.on('checkbox(foodList)',function (data) {
            if (data.elem.checked==true){
                memberLevelFood.push({'FoodID':data.value});
            }else if(data.elem.checked==false){
                for (var i=0;i<memberLevelFood.length;i++){
                    if(memberLevelFood[i].FoodID==data.value){
                        memberLevelFood.splice(i,1)
                    }
                }
            }
        });
        //3.获取会员级别开卡套餐
        $('#lookGoods').click(function () {
            getFoodList(token,form,layer);
            if(memberLevelID&&memberLevelID!=''){
                let _obj={'memberLevelID':memberLevelID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type:'post',
                    url:'/XCCloud/Member?action=GetMemberLevelFoodList',
                    contentType: "application/json; charset=utf-8",
                    data:{parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        if (data.result_code == 1) {
                            let arr=data.result_data;
                            for(let i in arr){
                                $('#foodListBox').find('input[value="'+arr[i].FoodID+'"]').prop('checked',true)
                            }
                            form.render('checkbox');
                            index= layer.open({
                                type:1,
                                area:'400px',
                                content:$('#bindFood')
                            })
                        } else {
                            layer.msg(data.result_msg);
                        }
                    }
                })
            }else {
                layer.msg('请先绑定开卡套餐！')
            }

        });
         //修改
        table.on('tool(memberLevelTb)', (obj)=>{
            let data = obj.data; //获得当前行数据
            let layEvent = obj.event;
            $('#demo2').html("");
            memberLevelID=data.MemberLevelID;
            if(layEvent === 'edit'){ //修改按钮
                $('#resetBtn').trigger('click');
                // xc.setStorage('MemberLevelID',memberLevelID);
                let _obj={'memberLevelID':memberLevelID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let url='/XCCloud/Member?action=GetMemberLevelInfo';
                let parseJson=JSON.stringify(_obj);
                $.ajax({
                    type:'post',
                    url:url,
                    contentType: "application/json; charset=utf-8",
                    data: { parasJson: parseJson },
                    success:(data)=> {
                        data = JSON.parse(data);
                        console.log(data)
                        if(data.result_code==1){
                            getMemberFreeRule(memberLevelID,table,layer,form);
                            let arr=data.result_data;

                            $('#MemberLevelName').val(arr.MemberLevelName);
                                $('#openFee').val(arr.OpenFee);
                                $('#deposit').val(arr.Deposit);
                                $('#validday').val(arr.Validday);
                            States=arr.State;
                            if(arr.State==1){$('#State').attr('checked',true)
                            }else { $('#State').attr('checked',false)}
                                needAuthor=arr.NeedAuthor;//开卡需要授权
                                if(arr.NeedAuthor==1){$('#needAuthor').attr('checked',true)
                                }else { $('#needAuthor').attr('checked',false)}
                                mustPhone=arr.MustPhone;//手机必填
                                if(arr.MustPhone==1){$('#mustPhone').attr('checked',true)
                                }else { $('#mustPhone').attr('checked',false)}
                                mustIDCard=arr.MustIDCard;//身份证必填
                                if(arr.MustIDCard==1){$('#mustIDCard').attr('checked',true)
                                }else { $('#mustIDCard').attr('checked',false)}
                                useReadID=arr.UseReadID;//身份证读卡
                                if(arr.UseReadID==1){$('#useReadID').attr('checked',true)
                                }else { $('#useReadID').attr('checked',false)}
                                readFace=arr.ReadFace;//脸部识别
                                if(arr.ReadFace==1){$('#readFace').attr('checked',true)
                                }else { $('#readFace').attr('checked',false)}
                                readPlam=arr.ReadPlam;//读取掌纹
                                if(arr.ReadPlam==1){$('#readPlam').attr('checked',true)
                                }else { $('#readPlam').attr('checked',false)}
                                $('#changeFee').val(arr.ChangeFee);
                                $('#consumeTotal').val(arr.ConsumeTotle);
                                $('#continueFee').val(arr.ContinueFee);
                                $('#continueUsePoint').val(arr.ContinueUsePoint);
                                $('#nonActiveDays').val(arr.NonActiveDays);
                                $('#updateUsePoint').val(arr.UpdateUsePoint);
                                $('#priceOff').val(arr.PriceOFF);
                                $('#clearPointDays').val(arr.ClearPointDays);
                                freeType=arr.FreeType;

                                freeRate=arr.FreeRate;
                                $('#freeCoin').val(arr.FreeCoin);
                                $('#freeNeedWin').val(arr.FreeNeedWin);
                                BirthdayFree=arr.BirthdayFree;
                                $('#birthdayFreeCoin').val(arr.BirthdayFreeCoin);
                                $('#minCoin').val(arr.MinCoin);
                                $('#maxCoin').val(arr.MaxCoin);

                                AllowExitCard=arr.AllowExitCard;
                                if(arr.AllowExitCard==1){$('#allowExitCard').attr('checked',true)
                                }else { $('#allowExitCard').attr('checked',false)}
                                AllowExitMoney=arr.AllowExitMoney;
                                if(arr.AllowExitMoney==1){$('#allowExitMoney').attr('checked',true)
                                }else { $('#allowExitMoney').attr('checked',false)}
                                AllowExitCoinToCar=arr.AllowExitCoinToCard;
                                if(arr.AllowExitCoinToCard==1){$('#allowExitCoinToCar').attr('checked',true)
                                }else { $('#allowExitCoinToCar').attr('checked',false)}
                                LockHead=arr.LockHead;
                                if(arr.LockHead==1){$('#lockHead').attr('checked',true)
                                }else { $('#lockHead').attr('checked',false)}

                            xc.setSelect('生日送币方式','birthdayFree',arr.BirthdayFree);
                            xc.setSelect('送币频率','freeRate',arr.FreeRate);
                            xc.setSelect('送币方式','freeType',arr.FreeType);


                            $('#demo2') .append('<div style="display: inline-block;position: relative" class="imgBox">' +
                                '<button type="button" ><i class="layui-icon"><i class="layui-icon">&#xe640</i></i></button>' +
                                '<img src="'+ arr.CoverURL +'" class="layui-upload-img_md" ' +
                                'style="display: block;width: 300px;height: 170px"></div>');
                            $('.imgBox button').click(function () {
                                $(this).parent('div').remove();
                            });

                            // newTable(table,arrSendCoinTable,layer,form);
                            layer.open({
                                type:1,
                                area:'1000px',
                                shade:0.6,
                                content:$('#openModel')
                            });
                        }
                    }
                })
            }else if(layEvent === 'del'){
                layer.confirm('真的删除行么', function(index){
                    Id=data.ID;
                    let _obj={'memberLevelID':memberLevelID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/Member?action=DelMemberLevelInfo',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                obj.del();
                                layer.msg('删除成功',function () {
                                    xc.getInitData(parm);
                                })
                            } else {
                                layer.msg(data.result_msg);
                            }
                        }
                    })
                });
            }
        });

        $('#addFreeRule').on('click',function () {
            if($('#chargeTotal').val()==''||freeBalanceType==''||$('#freeCount').val()==''||$('#minSpaceDays').val()==''||
                $('#onceFreeCount').val()==''||$('#expireDays').val()==''){
                layer.msg('请检查是否有未填信息')
            }else {
                arrSendCoinTable.push({
                    'ChargeTotal':$('#chargeTotal').val(),
                    'FreeBalanceType':freeBalanceType,
                    'FreeCount':$('#freeCount').val(),
                    'MinSpaceDays':$('#minSpaceDays').val(),
                    'OnceFreeCount':$('#onceFreeCount').val(),
                    'ExpireDays':$('#expireDays').val(),
                });
                newTable(table,arrSendCoinTable,layer,form)

            }
        });
        //删除预赠币规则
        table.on('tool(sendCoinTable)', (obj)=>{
            let data = obj.data; //获得当前行数据
            let layEvent = obj.event;
             if(layEvent === 'del'){
                 for(let i in arrSendCoinTable){
                     if(arrSendCoinTable[i].ChargeTotal==data.ChargeTotal&&
                         arrSendCoinTable[i].FreeBalanceType==data.FreeBalanceType&&
                         arrSendCoinTable[i].FreeCount==data.FreeCount&&
                         arrSendCoinTable[i].MinSpaceDays==data.MinSpaceDays&&
                         arrSendCoinTable[i].OnceFreeCount==data.OnceFreeCount&&
                         arrSendCoinTable[i].ExpireDays==data.ExpireDays
                         ){
                         arrSendCoinTable.splice(i,1);
                         obj.del()
                     }
                 }

            }
        });
        var demoListViewStore=$('#demo2'),uploadListInsStore=upload.render({
            elem: '#imgBtn'
            ,url: '/XCCloud/Member?action=UploadCardCover'
            ,data:{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'}
            ,multiple: true
            ,accept:"images"
            ,size:1000
            ,auto:true
            ,done: function(res,index,upload){
                //上传完毕
                console.log(res);
                if(res.result_code==1){
                    $('#demo2').children('div[class="imgBox"]').remove();
                    $('#demo2 .loadTips').addClass('layui-hide');
                    $('#demo2') .append('<div style="display: inline-block;position: relative" class="imgBox">' +
                        '<button type="button" ><i class="layui-icon"><i class="layui-icon">&#xe640</i></i></button>' +
                        '<img src="'+ res.result_data[0].Value +'" alt="'+ res.result_data[0].Value +'" class="layui-upload-img_md" ' +
                        'style="display: block;width: 300px;height: 170px"></div>');
                    layer.msg("图片上传成功！");
                    $('.imgBox button').click(function () {
                        $(this).parent('div').remove();
                    });
                    $('.imgBox img').click(function () {
                        layer.open({
                            title:  res.result_data.ID,
                            type: 1,
                            area: ['600px','400px'], //宽高
                            content: '<div><img src="'+res.result_data[0].Value+'" alt="" style="display: block;"></div>'
                        });
                    });
                }else{
                    layer.msg(res.return_msg);
                }
            }
            ,error:function(index,upload){
                layer.msg("服务器返回错误！");
                layer.closeAll('loading');
            }
        });

        $('#saveMLBtn').on('click',function () {
            saveML(layer,token);
        });
      //送币频率
        form.on('select(freeRate)', function(data){
            freeRate=data.value;
        });
        //送币方式
        form.on('select(freeType)', function(data){
            freeType=data.value;
        });
        //生日送币方式
        form.on('select(birthdayFree)', function(data){
            BirthdayFree=data.value;
        });
        form.on('switch(needAuthor)', function(data){
            data.elem.checked==true ? needAuthor=1:needAuthor=0;
        });
        form.on('switch(useReadID)', function(data){
            data.elem.checked==true ? useReadID=1:useReadID=0;
        });
        form.on('switch(mustPhone)', function(data){
            data.elem.checked==true ? mustPhone=1:mustPhone=0;
        });
        form.on('switch(mustIDCard)', function(data){
            data.elem.checked==true ? mustIDCard=1:mustIDCard=0;
        });
        form.on('switch(readFace)', function(data){
            data.elem.checked==true ? readFace=1:readFace=0;
        });
        form.on('switch(readPlam)', function(data){
            data.elem.checked==true ? readPlam=1:readPlam=0;
        });
        form.on('switch(allowExitCard)', function(data){
            data.elem.checked==true ? AllowExitCard=1:AllowExitCard=0;
        });
        form.on('switch(allowExitMoney)', function(data){
            data.elem.checked==true ? AllowExitMoney=1:AllowExitMoney=0;
        });
        form.on('switch(LockHead)', function(data){
            data.elem.checked==true ? LockHead=1:LockHead=0;
        });
        form.on('switch(allowExitCoinToCar)', function(data){
            data.elem.checked==true ? AllowExitCoinToCar=1:AllowExitCoinToCar=0;
        });
        form.on('switch(State)', function(data){
            data.elem.checked==true ? States=1:States=0;
        });
        form.on('select(freeBalanceType)', function(data){
            freeBalanceType=data.value;
        });
    });
    var saveML=(layer,token)=>{

        let obj={
            'MemberLevelID':memberLevelID||'',
            'MerchID':merchId,
            'MemberLevelName':$('#MemberLevelName').val(),
            'coverURL':$('.layui-upload-img_md').attr('src'),
            'openFee':$('#openFee').val(),
            'Deposit':$('#deposit').val(),
            'Validday':$('#validday').val(),
            'needAuthor':needAuthor,//开卡需要授权
            'mustPhone':mustPhone,//手机必填
            'mustIDCard':mustIDCard,//身份证必填
            'useReadID':useReadID,//身份证读卡
            'readFace':readFace,//脸部识别
            'readPlam':readPlam,//读取掌纹
            'changeFee':$('#changeFee').val(),
            'consumeTotle':$('#consumeTotal').val(),
            'continueFee':$('#continueFee').val(),
            'continueUsePoint':$('#continueUsePoint').val(),
            'nonActiveDays':$('#nonActiveDays').val(),
            'updateUsePoint':$('#updateUsePoint').val(),
            'priceOff':$('#priceOff').val(),
            'clearPointDays':$('#clearPointDays').val(),
            'FreeType':freeType,
            'FreeRate':freeRate,
            'FreeCoin':$('#freeCoin').val(),

            'FreeNeedWin':$('#freeNeedWin').val(),
            'BirthdayFree':BirthdayFree,
            'BirthdayFreeCoin':$('#birthdayFreeCoin').val(),
            'minCoin':$('#minCoin').val(),
            'maxCoin':$('#maxCoin').val(),

            'AllowExitCard':AllowExitCard,
            'AllowExitMoney':AllowExitMoney,
            'AllowExitCoinToCard':AllowExitCoinToCar,
            'LockHead':LockHead,
            'State':States,
            'memberLevelFoods':memberLevelFood.length>0?memberLevelFood:null,
            'memberLevelFrees':arrSendCoinTable,
            'userToken':token,
            'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let url='/XCCloud/Member?action=SaveMemberLevel';
        let  parseJson=JSON.stringify(obj);
        console.log(parseJson);
        $.ajax({
            type:'post',
            url:url,
            contentType: "application/json; charset=utf-8",
            data: { parasJson: parseJson },
            success:(data)=>{
                data=JSON.parse(data);
                if(data.result_code=="1"){
                    layer.msg('操作成功！',{
                        time:1500
                    },function () {
                        location.href='memberLevelSet.html';
                    });
                }else {
                        layer.msg(data.result_msg);
                }
            }
        })
    };
    function getMemberFreeRule(m,table,layer,form) {
        let _obj={'memberLevelID':m,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(_obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/Member?action=GetMemberLevelFreeList',
            contentType: "application/json; charset=utf-8",
            data:{parasJson: parseJson},
            success: function (data) {
                data = JSON.parse(data);
                if (data.result_code == 1) {
                    arrSendCoinTable=data.result_data;
                    newTable(table,arrSendCoinTable,layer,form);
                } else {
                    layer.msg(data.result_msg);
                }
            }
        })
    }
    function newTable(table,arr,layer,form) {
            table.render({
                elem: '#sendCoinTable'
                , height:'250px'
                , data: arr
                , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                , cols: [[
                    {field:'ChargeTotal', title:'充值金额', align: 'center'}
                    ,{field:'FreeBalanceType',title: '赠送余额类别', align: 'center'} //width 支持：数字、百分比和不填写。
                    ,{field:'FreeCount', title: '赠送数量', align: 'center'}
                    ,{field:'MinSpaceDays', title: '最小间隔天数', align: 'center'}
                    ,{field:'OnceFreeCount', title: '单次领币数量', align: 'center'}
                    ,{field:'ExpireDays', title: '有效天数', align: 'center'}
                    ,{fixed: 'right',title:'操作', width:140, align:'center', toolbar: '#barDemo2'}]]
                , page: {page: true, limits: [5,10, 15, 20]}
                , limit: 5
                ,done:function () {
                    xc.getBalanceTypeDic(token,layer,form,'freeBalanceType');
                    $('.freeLast').find('input').val('')
                }
            });

    }
    //获取会员预赠币规则
    function getFoodList(token,form,layer) {
        let _obj={'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(_obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/Promotion?action=GetMemberFoodDic',
            contentType: "application/json; charset=utf-8",
            data:{parasJson: parseJson},
            success: function (data) {
                data = JSON.parse(data);
                if (data.result_code == 1) {
                    let arr=data.result_data;
                    $('#foodListBox').html('');
                    for(let i in arr){
                        $('#foodListBox').append('<input type="checkbox" lay-filter="foodList" value="'+arr[i].FoodID+'" title="'+arr[i].FoodName+'"> ')
                    }
                    form.render('checkbox');
                } else {
                    layer.msg(data.result_msg);
                }
            }
        })
    }
</script>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del">删除</a>
</script>
<script type="text/html" id="barDemo2">
    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del">删除</a>
</script>
</html>