<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>电子优惠券</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<style>
    .autoSort .layui-input-inline{
        width: 110px;
    }
</style>
<body>
<div class="layui-row" style="padding: 10px">
    <form action="" class="layui-form layui-form-pane" >
        <blockquote class="layui-elem-quote" style="text-align: right">
            <button type="button" class="layui-btn layui-btn-normal">查询模板</button>
            <button type="button" class="layui-btn layui-btn-normal add">新增</button>
        </blockquote>
        <div class="layui-col-md12 layui-col-lg12 layui-col-sm12">
            <table class="layui-hide" id="couponSetTable"  lay-filter="couponSetTable"></table>
        </div>
    </form>
</div>
<!--//弹窗-->
<div id="addOrModify" style="padding: 10px;display: none" class="goodIsAll">
    <form class="layui-form layui-form-pane" style="padding-left: 15px;">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">优惠券名</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" required id="CouponName">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">本券类型</label>
                <div class="layui-input-inline">
                    <input type="checkbox" name="switch" lay-skin="switch" lay-text="实物券|电子券" id='entryCouponFlag' lay-filter="entryCouponFlag">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">发行数量</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" lay-verify="number" id="PublishCount">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label  class="layui-form-label">派发途径</label>
                <div class="layui-input-inline">
                    <select name="" id="SendType" lay-filter="SendType">
                        <option value="0">消费赠券</option>
                        <option value="1">定向派发</option>
                        <option value="2">抽奖赠券</option>
                        <option value="3">街边派送</option>
                    </select>
                </div>
            </div>
            <ul style="display: inline-block">
                <li class="layui-hide" name="disturbBox">
                    <button type="button" class=" layui-btn layui-btn-normal" id="autoSendBtn">自动派发</button>
                    <button type="button" class=" layui-btn layui-btn-normal" id="setVipBtn">选取派发会员</button>
                </li>
                <li class="" name="disturbBox">
                    <div class="layui-inline">
                        <label  class="layui-form-label">消费满</label>
                        <div class="layui-input-inline" style="width: 90px">
                            <input type="text" class="layui-input" id="OverMoney" name="disturbInput">
                        </div>
                        <div class="layui-form-mid">送</div>
                        <div class="layui-input-inline" style="width: 90px">
                            <input type="text" class="layui-input" name="disturbInput" id="FreeCouponCount">
                            <input type="text" class="layui-input layui-hide" name="disturbInput" id="JackpotCount">
                        </div>
                        <div class="layui-form-mid" id="tips">张</div>
                    </div>
                    <div class="layui-inline layui-hide" id="JackpotActiveBox">
                        <label  class="layui-form-label">抽奖活动</label>
                        <div class="layui-input-inline" style="width: 142px">
                            <select name="" id="JackpotActive" lay-filter="JackpotActive"></select>
                        </div>
                    </div>
                </li>
            </ul>

        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">优惠券类别</label>
                <div class="layui-input-inline" style="width: 138px;">
                    <select id="CouponType" lay-filter="CouponType">

                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <input type="checkbox" checked name="like[write]" title="使用需要授权" lay-skin="primary" id="authorFlag" lay-filter="authorFlag">
            </div>
            <div class="layui-inline">
                <input type="checkbox" name="like[write]" title="允许叠加使用" lay-skin="primary" id="AllowOverOther" lay-filter="AllowOverOther">
            </div>
        </div>
        <!--使用类别为：代价券或折扣券时显示-->
        <div class="layui-form-item" id="saleShow">
            <div class="layui-inline">
                <label class="layui-form-label" style="padding: 8px 0;">折扣</label>
                <div class="layui-input-inline" style="width: 80px;">
                    <input type="text" class="layui-input" required id="CouponDiscount">
                </div>
                <div class="layui-form-mid">折</div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" style="padding: 8px 0;">使用门槛</label>
                <div class="layui-input-inline" style="width: 109px;">
                    <input type="text" class="layui-input" required placeholder="元" id="CouponThreshold">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" style="padding: 8px 0;">价值(抵用金额)</label>
                <div class="layui-input-inline" style="width: 109px;">
                    <input type="text" class="layui-input" required placeholder="元" id="couponValue">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" style="padding: 8px 0;">同时使用张数</label>
                <div class="layui-input-inline" style="width: 109px;">
                    <input type="text" class="layui-input" required placeholder="张" id="OverUseCount">
                </div>
            </div>
        </div>
        <!--使用类别为：兑币券时显示-->
        <div class="layui-form-item layui-hide" id="tokenShow">
            <div class="layui-inline">
                <label  class="layui-form-label">兑换类型</label>
                <div class="layui-input-inline">
                    <select name="" id="ChargeType" lay-filter="chargeType">
                        <option>-请选择-</option>
                        <option value="0">礼品</option>
                        <option value="1">游乐项目</option>
                        <option value="2">代币</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline chargeContentBox chargeGoods">
                <label  class="layui-form-label">兑换内容</label>
                <div class="layui-input-inline">
                    <select name="" id="GoodID" lay-filter="GoodID"></select>
                </div>
            </div>
            <div class="layui-inline chargeContentBox chargeProgect layui-hide">
                <label  class="layui-form-label">兑换内容</label>
                <div class="layui-input-inline">
                    <select name="" id="ProjectID" lay-filter="ProjectID"></select>
                </div>
            </div>
            <div class="layui-inline chargeContentBox chargeBalance layui-hide">
                <label  class="layui-form-label">余额类别</label>
                <div class="layui-input-inline">
                    <select name="" id="balanceType" lay-filter="balanceType"></select>
                </div>
            </div>
            <div class="layui-inline">
                <label  class="layui-form-label">兑换数量</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="ChargeCount">
                </div>
            </div>
        </div>
       <!--使用期限设置-->
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">使用期限</label>
                <div class="layui-input-inline">
                    <select id="usePried" lay-filter="usePried">
                        <option value="0" selected>当天</option>
                        <option value="1">本周</option>
                        <option value="2">本月</option>
                        <option value="3">本年</option>
                        <option value="4">自定期限</option>
                    </select>
                </div>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="StartDate" disabled>
                </div>
                <div class="layui-form-mid">至</div>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="EndDate" disabled>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">时段类型</label>
                <div class="layui-input-inline" style="width: 130px">
                    <select id="weekType" lay-filter="weekType">
                        <option value="0">自定义</option>
                        <option value="1">工作日</option>
                        <option value="2">周末</option>
                        <option value="3">节假日</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline" id="weekSetBox">
                <label class="layui-form-label">优惠周天</label>
                <div class="layui-input-inline" id="weekBox" style="width: 570px;border: 1px solid #aaa;height: 36px">

                </div>
            </div>
            <br>
            <div class="layui-inline" >
                <label class="layui-form-label">使用时段</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="StartTime">
                </div>
                <div class="layui-form-mid">
                    至
                </div>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="EndTime">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                    <label class="layui-form-label">不可用日期</label>
                    <div class="layui-input-inline">
                        <select id="noUsePried" lay-filter="noUsePried">
                            <option>-请选择-</option>
                            <option value="0" >当天</option>
                            <option value="1">本周</option>
                            <option value="2">本月</option>
                            <option value="3">本年</option>
                            <option value="4">自定期限</option>
                        </select>
                    </div>
            </div>
            <div class="layui-inline" >
                <label class="layui-form-label">不可用期限</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="NoStartDate" disabled placeholder="请设置开始日期">
                </div>
                <div class="layui-form-mid">
                    至
                </div>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="NoEndDate" disabled placeholder="请设置结束日期">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label" style="padding: 8px 0;">备注</label>
                <div class="layui-input-inline" style="width: 835px">
                    <input type="text" class="layui-input" required id="Note">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <blockquote class="layui-elem-quote" style="color: red;font-size: 16px">
              <i class="layui-icon">&#xe658;</i>提示：如果印刷编号为空，派发方式请选择街边派发。
            </blockquote>
        </div>
        <div style="text-align: right;margin-right: 100px;">
            <!--<button type="button" class="layui-btn-normal layui-btn" id="cancelBtn">取消</button>-->
            <!--<button type="reset" class="layui-btn layui-btn-danger" id="resetBtn"><i class="layui-icon">&#x1002;</i>重置</button>-->
            <button type="button" class="layui-btn layui-btn-normal" id="saveBtn"><i class="layui-icon">&#xe6af;</i>确定</button>
        </div>
    </form>
</div>
<!--适用门店的弹窗-->
<div class="chooseStore goodIsAll" style="display: none">
    <form action="" class="layui-form">
        <div class="layui-form-item">
            <label class="layui-form-label">适用门店</label>
            <div class="layui-input-inline" id="chooseStoreList">
            </div>
        </div>
    </form>
    <div style="text-align:right;padding-right: 50px;margin-bottom: 15px">
        <button type="button" class="layui-btn" id="cancelStorebtn">取消</button>
        <button type="button" class="layui-btn layui-btn-normal" id="saveStorebtn">确定</button>
    </div>
</div>
<!--分配会员弹窗-->
<div class="setVip goodIsAll" style="display: none;padding: 10px;">
    <form action="" class="layui-form">
        <div class="layui-form-item">
            <div class="layui-input-inline" id="setVipList">
            </div>
        </div>
    </form>
    <div style="text-align:right;padding-right: 50px;margin-bottom: 15px">
        <button type="button" class="layui-btn" id="cancelVipbtn">取消</button>
        <button type="button" class="layui-btn layui-btn-normal" id="saveVipbtn">确定</button>
    </div>
</div>
<!--优惠券调拨弹窗-->
<div class="couponTransfer goodIsAll" style="display: none;padding: 15px;">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <label class="layui-form-label">优惠券名</label>
            <div class="layui-input-block">
                <input type="text" class="layui-input" disabled id="transferName">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">有效期</label>
                <div class="layui-input-inline" style="width: 115px">
                    <input type="text" class="layui-input" disabled id="transferStartDate">
                </div>
                <div class="layui-form-mid">至</div>
                <div class="layui-input-inline" style="width: 115px">
                    <input type="text" class="layui-input" disabled id="transferEndDate">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">可调拨数量</label>
                <div class="layui-input-inline" style="width: 115px">
                    <input type="text" class="layui-input" disabled id="transferCount">
                </div>
            </div>
        </div>
        <div class="layui-form-item">

            <div class="layui-inline">
                <div class="layui-input-inline" >
                   <button type="button" class="layui-btn layui-btn-normal" id="toaddNextNo">添加号码段</button>
                </div>
                <div class="layui-input-inline">
                    <button type="button" class="layui-btn layui-bg-orange" id="clearNo">重新填写</button>
                </div>
            </div>
            <blockquote class="layui-elem-quote">
               <p class="barCoadBox"></p>
            </blockquote>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">调拨门店</label>
            <div class="layui-input-block">
                <select id="transferStore" lay-filter="transferStore"></select>
            </div>
        </div>
        <blockquote class="layui-elem-quote">
            <p style="color:#f00;">已显示调拨序号为可派发区间，请选择你要调拨的序号范围</p>
        </blockquote>
        <div style="text-align:center;">
            <button type="button" class="layui-btn layui-btn-primary" id="saveTransfer">保存</button>
        </div>
    </form>
</div>
<div id="selectNo" style="display:none; padding: 15px">
    <form action="" class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">调拨序号</label>
                <div class="layui-input-inline" style="width: 115px">
                    <input type="text" class="layui-input" id="transferStartNo">
                </div>
                <div class="layui-form-mid">至</div>
                <div class="layui-input-inline" style="width: 115px">
                    <input type="text" class="layui-input" id="transferEndNo">
                </div>
            </div>
        </div>
          <div style="text-align:center;">
              <button type="button" class="layui-btn layui-btn-normal" id="addNextNo">确定</button>
          </div>

    </form>
</div>
<!--优惠券派发弹窗-->
<div class="couponSend goodIsAll" style="display: none;padding: 15px;">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <label class="layui-form-label">优惠券名</label>
            <div class="layui-input-block">
                <input type="text" class="layui-input" disabled id="SendName">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">券类型</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" disabled id="SendCouponType">
                </div>
            </div>
            <div class="layui-inline" style="margin-right: 0;margin-left: 8px;">
                <label class="layui-form-label">可派发数量</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" disabled id="SendCouponCount">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">有效期</label>
                <div class="layui-input-inline" style="width: 115px">
                    <input type="text" class="layui-input" disabled id="SendStartDate">
                </div>
                <div class="layui-form-mid">至</div>
                <div class="layui-input-inline" style="width: 115px">
                    <input type="text" class="layui-input" disabled id="SendEndDate">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <div class="layui-input-inline" >
                    <button type="button" class="layui-btn layui-btn-normal" id="toaddSendNo">添加号码段</button>
                </div>
                <div class="layui-input-inline">
                    <button type="button" class="layui-btn layui-bg-orange" id="clearSendNo">重新填写</button>
                </div>
            </div>
            <blockquote class="layui-elem-quote">
                <p class="barSendBox"></p>
            </blockquote>
            <div class="layui-inline">
                <label class="layui-form-label">派发数量</label>
                <div class="layui-input-inline" style="width: 115px">
                    <input type="text" class="layui-input" id="canSend" disabled>
                </div>
            </div>
        </div>
        <blockquote class="layui-elem-quote">
            <p style="color:#f00;">已显示派发序号为可派发区间，请选择你要派发的序号范围</p>
        </blockquote>
        <div style="text-align:center;">
            <button type="button" class="layui-btn layui-btn-primary" id="saveSend">保存</button>
        </div>
    </form>
</div>

<div id="selectSendNo" style="display:none; padding: 15px">
    <form action="" class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">派发序号</label>
                <div class="layui-input-inline" style="width: 115px">
                    <input type="text" class="layui-input" id="SendStartNo">
                </div>
                <div class="layui-form-mid">至</div>
                <div class="layui-input-inline" style="width: 115px">
                    <input type="text" class="layui-input" id="SendEndNo">
                </div>
            </div>
        </div>
        <div style="text-align:center;">
            <button type="button" class="layui-btn layui-btn-normal" id="addSendNo">确定</button>
        </div>
    </form>
</div>
<!--优惠券--》实物券导出-->
<div class="couponExport goodIsAll" style="display: none;padding: 15px;">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <label class="layui-form-label">优惠券名</label>
            <div class="layui-input-block">
                <input type="text" class="layui-input" disabled id="exportName">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">券类型</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" disabled id="exportCouponType">
                </div>
            </div>
            <div class="layui-inline" style="margin-right: 0;margin-left: 8px;">
                <label class="layui-form-label">可导出数量</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" disabled id="exportCouponCount">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">有效期</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="exportStartDate" disabled>
                </div>
                <div class="layui-form-mid">至</div>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="exportEndDate" disabled>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">导出序号</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="exportStartNo">
                </div>
                <div class="layui-form-mid">至</div>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="exportEndNo">
                </div>
            </div>

        </div>
        <blockquote class="layui-elem-quote">
             <p style="color: red;">注意:只有实物券才可以导出</p>
        </blockquote>
        <div style="text-align:center;">
            <button type="button" class="layui-btn layui-btn-primary" id="exportBtn">确认导出</button>
        </div>
    </form>
</div>
<div id="transferList" style="padding: 15px;display: none">
    <table class="layui-hide" id="transferTable" lay-filter="transferTable"></table>
</div>
<!--自动派发弹窗-->
<div class="autoSort goodIsAll" style="display: none;padding: 15px;">
    <form action="" class="layui-form">
        <div class="layui-card layui-col-md9">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline" style="width: 190px">
                            <input type="checkbox" title="每月活跃次数" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input">
                        </div>
                        <div class="layui-form-mid">

                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="消费能力" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">天</option>
                                <option value="1">周</option>
                                <option value="2">月</option>
                                <option value="3">季</option>
                                <option value="4">年</option>
                            </select>
                        </div>
                        <div class="layui-form-mid">
                            消费
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input">
                        </div>
                        <div class="layui-form-mid">
                            元
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="输赢能力" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">天</option>
                                <option value="1">周</option>
                                <option value="2">月</option>
                                <option value="3">季</option>
                                <option value="4">年</option>
                            </select>
                        </div>
                        <div class="layui-form-mid">
                            输赢
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input">
                        </div>
                        <div class="layui-form-mid">
                            元
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="生日" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>

                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="会员级别" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">普通会员</option>
                                <option value="1">银卡</option>
                            </select>
                        </div>

                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="会员余额" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">积分</option>
                                <option value="1">彩票</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">大于</option>
                                <option value="1">小于</option>
                                <option value="1">等于</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-card layui-col-md3" >
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">派发周期</label>
                        <div class="layui-input-inline">
                            <select  id="d"></select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">派发时间</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">派发张数</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input">
                        </div>
                    </div>
                </div>

                <div style="text-align:center;">
                    <button type="button" class="layui-btn layui-btn-primary">确定</button>
                </div>
            </div>
        </div>
    </form>
</div>
<!--选取派发会员-->
<div class="selectMember" style="display: none;padding: 15px;">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
          <div class="layui-input-block">
              <button type="button" class="layui-btn layui-btn-normal" id="searchVipBtn">设置查询条件</button>
          </div>
        </div>
        <table class="layui-hide" id="memberTable" lay-filter="memberTable"></table>
        <div style="text-align:center;">
            <button type="button" class="layui-btn layui-btn-primary">确定</button>
        </div>
    </form>
</div>
<div class="sendMember goodIsAll" style="display: none;padding: 15px;">
    <form action="" class="layui-form">
        <div class="layui-card">
            <div class="layui-card-header">筛选条件</div>
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="每月活跃次数" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input">
                        </div>
                        <div class="layui-form-mid">

                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="消费能力" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">天</option>
                                <option value="1">周</option>
                                <option value="2">月</option>
                                <option value="3">季</option>
                                <option value="4">年</option>
                            </select>
                        </div>
                        <div class="layui-form-mid">
                            消费
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="消费能力" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">天</option>
                                <option value="1">周</option>
                                <option value="2">月</option>
                                <option value="3">季</option>
                                <option value="4">年</option>
                            </select>
                        </div>
                        <div class="layui-form-mid">
                            消费
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="生日" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>

                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="会员级别" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">普通会员</option>
                                <option value="1">银卡</option>
                            </select>
                        </div>

                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">或者</option>
                                <option value="1">并且</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="checkbox" title="会员余额" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">积分</option>
                                <option value="1">彩票</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select id="">
                                <option>-请选择-</option>
                                <option value="0">大于</option>
                                <option value="1">小于</option>
                                <option value="1">等于</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-card">
            <div class="layui-card-header">筛选条件</div>
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label">派发周期</label>
                    <div class="layui-input-block">
                        <select  id="d"></select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">派发时间</label>
                    <div class="layui-input-block">
                        <input type="text" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">派发张数</label>
                    <div class="layui-input-block">
                        <input type="text" class="layui-input">
                    </div>
                </div>
                <div style="text-align:center;">
                    <button type="button" class="layui-btn layui-btn-primary">确定</button>
                </div>
            </div>
        </div>
    </form>
</div>
<!--调拨明细弹窗-->

</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    layui.addcss('layui_font.css');
</script>
<script>
    // let modelHtml= $('#addOrModify').html();
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let Id='';
    let indexLayer;
    //初始化table
    let parm={'obj':{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
        'url':'/XCCloud/Coupon?action=QueryCouponInfo',
        'elem':'#couponSetTable',
        'cols':[
             {field:'ID', title:'优惠券规则ID', align: 'center', sort: true}
            ,{field:'CouponName',title: '优惠券名称', align: 'center'}
            ,{field:'CouponTypeStr', title: '券类别', align: 'center'}
            ,{field:'PublishCount', title: '发行张数', align: 'center'}
            ,{field:'NotAssignedCount', title: '未分配数量', align: 'center'}
            ,{field:'AssignedCount', title: '已调拨数量', align: 'center',templet:'#assigned'}
            ,{field:'SendCount', title: '派发张数', align: 'center'}
            ,{field:'UseCount', title: '已使用张数', align: 'center'}
            ,{field:'ActivatedCount', title: '剩余张数', align: 'center'}
            ,{field:'AuthorFlag', title: '使用需要授权', align: 'center',templet:'#AuthorFlag'}
            ,{field:'CreateTime', title: '创建时间', align: 'center'}
            ,{field:'OpUserName', title: '创建人', align: 'center'}
            ,{field:'AllowOverOther', title: '允许叠加使用', align: 'center',templet:'#AllowOverOther'}
            ,{field:'StartDate', title: '开始时间', align: 'center'}
            ,{field:'EndDate', title: '结束时间', align: 'center'}
            ,{field:'Context', title: '说明', align: 'center'}
            ,{field:'IsLock', title: '是否锁定', align: 'center',templet:'#isLock'}
            ,{fixed: 'right', title: '操作', width:400, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);

    let CouponType=0;
    let SendType=0;
    let entryCouponFlag=0;
    let authorFlag=1; let AllowOverOther=0;
    let chargeType='';//兑换类型
    let goodId='';
    let projectId='';
    let jackpotId='';
    let balanceIndex='';
    let memberId=[];
    let storeId=[];

    let weekType=0;let week=[];
    let transferStore='';
    let startNo;let endNo;
    let noArr=[];
    let noArrText='已选择号码段:';
    let noArrSend=[];
    let noArrSendText='已选择号码段:';

    layui.use(['form','layer','table','laydate'],()=>{
        let form=layui.form;
        let layer=layui.layer;
        let table=layui.table;
        let laydate=layui.laydate;
        $('#toaddNextNo').click(function () {
            indexLayer=layer.open({
                title:'添加号码段，点击可再次添加',
                type:'1',
                area:'430px',
                content:$('#selectNo')
            })
        });
        $('#toaddSendNo').click(function () {
            indexLayer=layer.open({
                title:'添加号码段，点击可再次添加',
                type:'1',
                area:'430px',
                content:$('#selectSendNo')
            })
        });
        //填写调拨号码段
        $('#addNextNo').click(function () {
            layer.close(indexLayer);
            noArr.push({'startNo':$('#transferStartNo').val(),'endNo':$('#transferEndNo').val()});
            noArrText+=$('#transferStartNo').val()+'-'+$('#transferEndNo').val()+','
            $('#transferStartNo').val('');
            $('#transferEndNo').val('');
            $('.barCoadBox').text(noArrText)
        });
        $('#addSendNo').click(function () {
            layer.close(indexLayer);
            if(noArrSend.length>0){
                if($('#SendStartNo').val()>noArrSend[noArrSend.length-1].endNo||$('#SendEndNo').val()<noArrSend[0].startNo){
                    noArrSend.push({'startNo':$('#SendStartNo').val(),'endNo':$('#SendEndNo').val()});
                    noArrSendText+=$('#SendStartNo').val()+'-'+$('#SendEndNo').val()+','
                    $('#SendStartNo').val('');
                    $('#SendEndNo').val('');
                    $('.barSendBox').text(noArrSendText);
                    let allCount=0;
                    for( let i in noArrSend){
                        allCount=parseInt(allCount)+parseInt(noArrSend[i].endNo)-parseInt(noArrSend[i].startNo)+1;
                    }
                    $('#canSend').val(allCount)
                }else {
                    layer.msg('  你输出的区间存在已派发部分，请核对后再次输入')
                }
            }else {
                noArrSend.push({'startNo':$('#SendStartNo').val(),'endNo':$('#SendEndNo').val()});
                noArrSendText+=$('#SendStartNo').val()+'-'+$('#SendEndNo').val()+','
                $('#SendStartNo').val('');
                $('#SendEndNo').val('');
                $('.barSendBox').text(noArrSendText);
                let allCount=0;
                for( let i in noArrSend){
                    allCount=parseInt(allCount)+parseInt(noArrSend[i].endNo)-parseInt(noArrSend[i].startNo)+1;
                }
                $('#canSend').val(allCount)
            }

        });
        //清空调拨号码段
        $('#clearNo').click(function () {
            noArr=[];
            noArrText='已选择号码段:';
            $('.barCoadBox').text(noArrText)
        });
        $('#clearSendNo').click(function () {
            noArrSend=[];
            noArrSendText='已选择号码段:';
            $('.barSendBox').text(noArrSendText)
        });
        //监听
        form.on('select(CouponType)',(data)=>{
            CouponType=data.value;
            if(data.value==2){
                $('#tokenShow').removeClass('layui-hide');
                $('#saleShow').addClass('layui-hide')
            } else {
                $('#saleShow').removeClass('layui-hide');
                $('#tokenShow').addClass('layui-hide');
            }
         });
        form.on('select(SendType)',(data)=>{
            SendType=data.value;
            jackpotId='';
            $('body').find('input[name="disturbInput"]').each(function () {
                $(this).val("");
            });
            if(data.value==3){
                $('body').find('li[name="disturbBox"]').each(function () {
                    $(this).addClass('layui-hide');
                });
                $('#JackpotActive').html('');
            } else if(data.value==2){
                $('body').find('li[name="disturbBox"]').eq(1).removeClass('layui-hide').siblings().addClass('layui-hide');
                $('#JackpotActiveBox').removeClass('layui-hide');
                $('#JackpotCount').removeClass('layui-hide').siblings().addClass('layui-hide');
                $('#tips').text('次');
                xc.getJackpotList(token,form);
            }else if(data.value==1){
                $('body').find('li[name="disturbBox"]').eq(0).removeClass('layui-hide').siblings().addClass('layui-hide');
                $('#JackpotActive').html('');
            }else if(data.value==0) {
                $('body').find('li[name="disturbBox"]').eq(1).removeClass('layui-hide').siblings().addClass('layui-hide');
                $('#JackpotActiveBox').addClass('layui-hide');
                $('#FreeCouponCount').removeClass('layui-hide').siblings().addClass('layui-hide');
                $('#tips').text('张');
                $('#JackpotActive').html('');
            }
            form.render('select','JackpotActive');
        });
        form.on('select(chargeType)',(data)=>{
            chargeType=data.value;
            $('#ChargeCount').val('');
            if(data.value==0){
                $('.chargeGoods').removeClass('layui-hide');
                $('.chargeProgect').addClass('layui-hide');
                $('.chargeBalance').addClass('layui-hide');
                projectId='';
                balanceIndex='';
                $('#ProjectID').html('');
                $('#balanceType').html('');
                xc.getChargeGood(token,form);
            } else if(data.value==1){
                $('.chargeGoods').addClass('layui-hide');
                $('.chargeProgect').removeClass('layui-hide');
                $('.chargeBalance').addClass('layui-hide');
                goodId='';
                balanceIndex='';
                $('#GoodID').html('');
                $('#balanceType').html('');
                xc.getChargeProgect(token,form)
            }else if(data.value==2){
                $('.chargeGoods').addClass('layui-hide');
                $('.chargeProgect').addClass('layui-hide');
                $('.chargeBalance').removeClass('layui-hide');
                goodId='';
                projectId='';
                xc.getBalanceTypeDic(token,layer,form,'balanceType');
                $('#GoodID').html('');
                $('#ProjectID').html('');
            }
            form.render('select');
        });
        form.on('select(GoodID)',(data)=>{
            goodId=data.value;
        });
        form.on('select(ProjectID)',(data)=>{
            projectId=data.value;
        });
        form.on('select(balanceType)',(data)=>{
            balanceIndex=data.value;
        });
        form.on('select(JackpotActive)',(data)=>{
            jackpotId=data.value;
        });
        form.on('switch(entryCouponFlag)',(data)=>{
            if(data.elem.checked==true){
                entryCouponFlag=1;
                $('#showPrint').removeClass('layui-hide');
            }else {
                entryCouponFlag=0;
                $('#showPrint').addClass('layui-hide');
            }
            console.log(entryCouponFlag)
        });
        form.on('checkbox(authorFlag)',(data)=>{
            if(data.elem.checked==true){
                authorFlag=1;
            }else {
                authorFlag=0;
            }
        });
        form.on('checkbox(AllowOverOther)',(data)=>{
            if(data.elem.checked==true){
                AllowOverOther=1;
            }else {
                AllowOverOther=0;
            }
        });
        //监听门店设置
        form.on('checkbox(chooseStore)',function (data) {
            if (data.elem.checked==true){
                storeId.push({'StoreID':data.value});
            }else if(data.elem.checked==false){
                for (var i=0;i<storeId.length;i++){
                    if(storeId[i].StoreID==data.value){
                        storeId.splice(i,1)
                    }
                }
            }
            console.log(storeId);
        });
        form.on('checkbox(weeks)', function(data){
            if (data.elem.checked==true){
                week.push(data.value);
            }else if(data.elem.checked==false){
                for (var i=0;i<week.length;i++){
                    if(week[i]==data.value){
                        week.splice(i,1);
                    }
                }
            }
        });
        //监听有效期间选择
        form.on('select(usePried)',function (data) {
            if(data.value==0){
                $('#StartDate').val(getDayStartDate()).prop('disabled',true);
                $('#EndDate').val(getDayStartDate()).prop('disabled',true);
            }else if(data.value==1){
                $('#StartDate').val(getWeekStartDate()).prop('disabled',true);
                $('#EndDate').val(getWeekEndDate()).prop('disabled',true);
            }else if(data.value==2){
                $('#StartDate').val(getMonthStartDate()).prop('disabled',true);
                $('#EndDate').val(getMonthEndDate()).prop('disabled',true);
            }else if(data.value==3){
                $('#StartDate').val(getYearStartDate()).prop('disabled',true);
                $('#EndDate').val(getYearEndDate()).prop('disabled',true);
            }else if(data.value==4){
                $('#StartDate').prop('disabled',false);
                $('#EndDate').prop('disabled',false);
                layer.msg('<p style="color: red">请自己设置有效期限</p>')
            }
        });
        //监听有效期间的可用期限
        form.on('select(weekType)',function (data) {
            weekType=data.value;
            week=[];
            if(data.value==0){
                $('#weekSetBox').removeClass('layui-hide');
                xc.AddWeeks('weekBox');
            }else {
                $('#weekSetBox').addClass('layui-hide');
            }
        });
        //监听不可用期限选择
        form.on('select(noUsePried)',function (data) {
            if(data.value==0){
                $('#NoStartDate').val(getDayStartDate()).prop('disabled',true);
                $('#NoEndDate').val(getDayStartDate()).prop('disabled',true);
            }else if(data.value==1){
                $('#NoStartDate').val(getWeekStartDate()).prop('disabled',true);
                $('#NoEndDate').val(getWeekEndDate()).prop('disabled',true);
            }else if(data.value==2){
                $('#NoStartDate').val(getMonthStartDate()).prop('disabled',true);
                $('#NoEndDate').val(getMonthEndDate()).prop('disabled',true);
            }else if(data.value==3){
                $('#NoStartDate').val(getYearStartDate()).prop('disabled',true);
                $('#NoEndDate').val(getYearEndDate()).prop('disabled',true);
            }else if(data.value==4){
                $('#NoStartDate').prop('disabled',false);
                $('#NoEndDate').prop('disabled',false);
                layer.msg('<p style="color: red">请自己设置不可用期限</p>')
            }else {
                $('#NoStartDate').val('').prop('disabled',true);
                $('#NoEndDate').val('').prop('disabled',true);
            }
        });
        form.on('select(transferStore)',(data)=>{
            transferStore=data.value;
        });
        //点击新增打开弹窗
        $('.add').on('click',()=>{
            Id='';//新增Id为空
            xc.setSelect('优惠券类别','CouponType');
            CouponType=0;
            SendType=0;
            entryCouponFlag=0;
            authorFlag=1;
            chargeType='';//兑换类型
            goodId='';
            projectId='';
            jackpotId='';
            memberId=[];
            storeId=[];
            weekType=0; week=[];
            // $('#addOrModify').html(modelHtml);

            xc.AddWeeks('weekBox');

            laydate.render({
                elem: '#StartDate'
                ,type: 'date'
                ,value: new Date()
            });
            laydate.render({
                elem: '#EndDate'
                ,type: 'date'
                ,value: new Date()
            });
            laydate.render({
                elem: '#NoStartDate'
                ,type: 'date'
            });
            laydate.render({
                elem: '#NoEndDate'
                ,type: 'date'
            });
            laydate.render({
                elem: '#StartTime'
                ,type: 'time'
                ,format: 'HH:mm'
                ,value: '00:00'
            });
            laydate.render({
                elem: '#EndTime'
                ,type: 'time'
                ,format: 'HH:mm'
                ,value: '23:59'
            });
            form.render();
            layer.open({
                title:'新增优惠券',
                type:'1',
                area:'1000px',
                content:$('#addOrModify')
            })
        });
        $('#saveStorebtn').on('click',()=>{
            let arr=[];
            if(storeId.length>0){
                for(let i in storeId){
                    arr.push(storeId[i].StoreID)
                }
            }
            let _obj={'couponID':Id,'storeIds':arr.length>0?arr.join('|'):'','userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'}
            let parseJson = JSON.stringify(_obj);
            $.ajax({
                type: 'post',
                url: '/XCCloud/Coupon?action=SaveCouponStores',
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parseJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.result_code == 1) {
                        layer.msg('适配门店设置完成',{time:1500},function () {
                            location.href='CouponSet.html';
                        })
                    }else {
                        layer.msg('操作失败！')
                    }
                }
            });
        });
        $('#cancelStorebtn').on('click',()=>{
            layer.close(indexLayer);
        });
        //设置自动派发的条件
        $('#autoSendBtn').on('click',()=>{
            layer.open({
                title:'设置派发会员',
                type:'1',
                area:'1000px',
                content:$('.autoSort')
            })
        });
        //选取派发会员
        $('#addOrModify').on('click','#setVipBtn',()=>{
            layer.open({
                title:'设置派发会员',
                type:'1',
                area:'1000px',
                content:$('.selectMember')
            })
        });
        //查询符合条件的会员
        $('#searchVipBtn').on('click','#setVipBtn',()=>{
            layer.open({
                title:'查询条件',
                type:'1',
                area:'1000px',
                content:$('.sendMember')
            })
        });
        $('#transferEndNo').on('blur',function () {
            $('#canTransfer').val(parseInt($(this).val())-parseInt($('#transferStartNo').val())+1)
        });
        //保存实物券调拨
        $('#saveTransfer').on('click',function () {
            let obj={'couponId':Id,
                'noArr':noArr,
                'storeId':transferStore,
                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parseJson = JSON.stringify(obj);
            if($('#transferStartNo').val()<startNo||$('#transferEndNo').val()>endNo||$('#transferStartNo').val()>$('#transferEndNo').val()){
                layer.msg('你输入的区间有误，请检查后再保存！')
            }else {
                if(transferStore==''){
                    layer.msg('请选择调拨门店或者先绑定适用门店')
                }else {
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/Coupon?action=SaveCouponNotAssigned',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data=JSON.parse(data);
                            console.log(data);
                            if(data.result_code==1){
                                layer.msg('优惠券调拨完成',{time:1500},function () {
                                    location.href='CouponSet.html';
                                })
                            }else {
                                layer.msg('优惠券调拨失败')
                            }
                        }
                    })
                }
            }

        });
        //保存派发信息
        $('#saveSend').on('click',function () {
            let obj={'couponId':Id,
                'noArr':noArrSend,
                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parseJson = JSON.stringify(obj);
            if($('#SendStartNo').val()<startNo||$('#SendEndNo').val()>endNo||$('#SendStartNo').val()>$('#SendEndNo').val()){
                layer.msg('你输入的区间有误，请检查后再保存！')
            }else {
                $.ajax({
                    type:'post',
                    url:'/XCCloud/Coupon?action=SaveCouponNotActivated',
                    contentType: "application/json; charset=utf-8",
                    data:{parasJson: parseJson},
                    success: function (data) {
                        data=JSON.parse(data);
                        console.log(data);
                        if(data.result_code==1){
                            layer.msg('优惠券派发完成',{time:1500},function () {
                                location.href='CouponSet.html';
                            })
                        }else {
                            layer.msg(data.result_msg||return_msg)
                        }
                    }
                })
            }

        });
        //调拨信息明细
        $('body').on('click','button[name="couponSendBtn"]',function () {
            let _couponid=$(this).prop('id');
            let  _AssignedCount=$(this).attr('data-id');
            let obj={'couponId':_couponid,
                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parseJson = JSON.stringify(obj);
            if(_AssignedCount>0){
                $.ajax({
                    type:'post',
                    url:'/XCCloud/Coupon?action=GetCouponAssigned',
                    contentType: "application/json; charset=utf-8",
                    data:{parasJson: parseJson},
                    success: function (data) {
                        data=JSON.parse(data);
                        if(data.result_code==1){
                            table.render({
                                elem: '#transferTable'
                                , height:'250px'
                                , size:"sm"
                                , data: data.result_data
                                , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                , cols: [[
                                    {field:'CouponName', title:'优惠券名称', align: 'center',width:175}
                                    ,{field:'StartEnd',title: '起止码', align: 'center',width:175} //width 支持：数字、百分比和不填写。
                                    ,{field:'AssignedCount', title: '调拨数量', align: 'center',width:139}
                                    ,{field:'StoreName', title: '调拨门店', align: 'center',width:175}
                                    ,{fixed: 'right',title:'操作', width:100, align:'center', toolbar: '#barDemo2'}]]
                                , page: {page: true, limits: [5,10, 15, 20, 30, 50, 100]}
                                , limit: 5
                            });
                            layer.open({
                                title:'优惠券调拨明细',
                                type:1,
                                area:'800px',
                                content:$('#transferList')
                            })
                        }else {
                            layer.msg('优惠券派发失败')
                        }
                    }
                })
            }else {
                layer.msg('当前优惠券没有调拨记录！')
            }


        });
        //确认导出
        $('#exportBtn').on('click',function () {
            let _obj={'couponID':Id,
                'startNo':$('#exportStartNo').val(),
                'endNo':$('#exportEndNo').val(),
                'userToken':token,
                'signkey':'1f626576304bf5d95b72ece2222e42c3'}
            let parseJson = JSON.stringify(_obj);
            $.ajax({
                type: 'post',
                url: '/XCCloud/Coupon?action=ExportCoupon',
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parseJson},
                success: function (data) {
                    data = JSON.parse(data);
                    console.log(data)
                    if (data.result_code == 1) {
                        document.location.href = "/Report/ToExcel.aspx?guid=" + data.result_data;
                        layer.closeAll()
                    }
                }
            })

        })
        //监听table工具栏
        table.on('tool(couponSetTable)',(obj)=>{
            var data = obj.data; //获得当前行数据
            let data1=obj.data;
            var layEvent = obj.event;
            if(layEvent === 'export'){ //导出
                Id=data.ID;
                $('#exportName').val(data.CouponName);
                $('#exportCouponType').val(data.CouponTypeStr);
                $('#exportCouponCount').val(data.PublishCount);
                $('#exportStartDate').val(data.StartDate);
                $('#exportEndDate').val(data.EndDate);
                layer.open({
                    title:'选择导出优惠券',
                    type:'1',
                    area:'670px',
                    content:$('.couponExport')
                })
            }else  if(layEvent === 'transfers'){ //调拨
                Id=data.ID;
                transferStore='';noArr=[];
                let _obj={'couponID':Id,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'}
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type: 'post',
                    url: '/XCCloud/Coupon?action=GetCouponNotAssigned',
                    contentType: "application/json; charset=utf-8",
                    data: {parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        if (data.result_code == 1) {
                            $('#transferName').val(data.result_data[0].CouponName);
                            $('#transferCount').val(data.result_data[0].NotAssignedCount);
                            $('#transferStartDate').val(data.result_data[0].StartDate);
                            $('#transferEndDate').val(data.result_data[0].EndDate);
                            // $('#transferStartNo').val(data.result_data[0].StartNo);
                            // $('#transferEndNo').val(data.result_data[0].EndNo);
                            // startNo=data.result_data[0].StartNo;
                            // endNo=data.result_data[0].EndNo;
                            $('#canTransfer').val(data.result_data[0].NotAssignedCount);
                            xc.sendStore('transferStore',Id,token,form,layer);
                            layer.open({
                                title:'选择调拨优惠券',
                                type:'1',
                                area:'670px',
                                content:$('.couponTransfer')
                            })
                        }
                    }
                });
            }else if(layEvent === 'lock'){ //删除
                layer.confirm('确定锁定该商户下所有门店的优惠券吗', function(index){
                    Id=data.ID;
                    let _obj={'couponId':data.ID,'isLock':1,'id':'','storeId':'','userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/Coupon?action=LockCoupon',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('锁定成功',{time:1500},function () {
                                    location.href='CouponSet.html'
                                });
                            } else {
                                layer.msg(data.result_msg);
                            }
                        }
                    })
                });
            } else if(layEvent === 'unlock'){ //删除
                layer.confirm('确定锁定该商户下所有门店的优惠券吗', function(index){
                    Id=data.ID;
                    let _obj={'couponId':data.ID,'isLock':0,'id':'','storeId':'','userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/Coupon?action=LockCoupon',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('解锁成功',{time:1500},function () {
                                    location.href='CouponSet.html'
                                });
                            } else {
                                layer.msg(data.result_msg);
                            }
                        }
                    })
                });
            }else  if(layEvent === 'setStore'){ //设置适用门店
                Id=data.ID;
                // xc.setUsefulStore(token,form);
                xc.getUsefulStore(Id,token,form,layer);
                form.render();
                indexLayer= layer.open({
                    // title:'设置适用门店',
                    type:1,
                    area:'500px',
                    content:$('.chooseStore')
                });
            }else  if(layEvent === 'send'){ //实物券派发
                Id=data.ID;
                transferStore='';
                if(data.NotActivatedCount>0){
                    let _obj={'couponID':Id,'userToken':token,'storeId':'','signkey':'1f626576304bf5d95b72ece2222e42c3'}
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type: 'post',
                        url: '/XCCloud/Coupon?action=GetCouponNotActivated',
                        contentType: "application/json; charset=utf-8",
                        data: {parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                $('#SendName').val(data.result_data[0].CouponName);
                                $('#SendCouponType').val(data1.CouponTypeStr);
                                $('#SendCouponCount').val(data.result_data[0].NotActivatedCount);
                                $('#SendStartDate').val(data.result_data[0].StartDate);
                                $('#SendEndDate').val(data.result_data[0].EndDate);
                                layer.open({
                                    title:'选择派发优惠券',
                                    type:'1',
                                    area:'670px',
                                    content:$('.couponSend')
                                })
                            }
                        }
                    });
                }else {
                   layer.msg('可派发数量为0');
                }
            }
        });
        table.on('tool(transferTable)',(obj)=>{
            var data = obj.data; //获得当前行数据
            let data1=obj.data;
            var layEvent = obj.event;
           if(layEvent === 'lock'){ //删除
                layer.confirm('确定锁定该商户下所有门店的优惠券吗', function(index){
                    let _obj={'couponId':data.CouponID,'isLock':1,'id':'','storeId':data.StoreID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/Coupon?action=LockCoupon',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('锁定成功',{time:1500},function () {
                                    location.href='CouponSet.html'
                                });
                            } else {
                                layer.msg(data.result_msg);
                            }
                        }
                    })
                });
            } else if(layEvent === 'unlock'){ //删除
                layer.confirm('确定锁定该商户下所有门店的优惠券吗', function(index){
                    let _obj={'couponId':data.CouponID,'isLock':0,'id':'','storeId':data.StoreID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/Coupon?action=LockCoupon',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('解锁成功',{time:1500},function () {
                                    location.href='CouponSet.html'
                                });
                            } else {
                                layer.msg(data.result_msg);
                            }
                        }
                    })
                });
            }
        });
        //保存优惠券信息
        xcActionSystem.prototype.saveCoupon=(layer)=>{
            var index = layer.load(0, {shade: false});
            let obj={'id':Id,
                        'merchId':'',
                        'couponName':$('#CouponName').val(),
                        'couponType':CouponType,
                        'entryCouponFlag':entryCouponFlag,
                        'authorFlag':authorFlag ,
                         'allowOverOther':AllowOverOther,
                        'overUseCount':$('#OverUseCount').val(),
                        'publishCount':$('#PublishCount').val(),
                        'couponValue':$('#couponValue').val(),
                        'couponDiscount':$('#CouponDiscount').val(),
                        'couponThreshold':$('#CouponThreshold').val(),
                        'startDate':$('#StartDate').val(),
                        'endDate':$('#EndDate').val(),
                        'weekType':weekType,
                        'week':week.length>0?week.join('|'):'',
                        'startTime':$('#StartTime').val(),
                        'endTime':$('#EndTime').val(),
                        'noStartDate':$('#NoStartDate').val(),
                        'noEndDate':$('#NoEndDate').val(),
                        'sendType':SendType,
                        'overMoney':$('#OverMoney').val(),
                        'freeCouponCount':$('#FreeCouponCount').val(),
                        'jackpotCount':$('#JackpotCount').val(),
                        'jackpotID':jackpotId,
                        'chargeType':chargeType,
                         'balanceIndex':'',
                        'chargeCount':$('#ChargeCount').val(),
                        'goodId':goodId,
                        'projectId':projectId,
                        'AutoSendCycle':'',
                        'AutoSendValue':'',
                        'AutoSendCount':'',
                        'couponConditions':[],
                        'memberIds':[],
                        'storeIds':storeId==''?'':storeId.join('|'),
                        'context':$('#Note').val(),
                        'userToken':token,
                        'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parseJson = JSON.stringify(obj);
            console.log(obj);
            $.ajax({
                type:'post',
                url:'/XCCloud/Coupon?action=SaveCouponInfo',
                contentType: "application/json; charset=utf-8",
                data:{parasJson: parseJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.result_code == 1) {
                        layer.close(index);
                        layer.msg('保存成功！');
                        location.href='CouponSet.html';
                    } else {
                        layer.msg(data.result_msg,{time:2000},function () {
                            layer.close(index);
                        });

                    }
                }
            })
        };
        $('#saveBtn').on('click',function () {
            xc.saveCoupon(layer)
        })

    });
    //加载抽奖规则
    xcActionSystem.prototype.getJackpotList=function (token,form,j) {
        let obj={'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/Jackpot?action=GetJackpotDic',
            contentType: "application/json; charset=utf-8",
            data:{parasJson: parseJson},
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code==1){
                    $('#JackpotActive').html('<option>-请选择-</option>');
                    let array=data.result_data;
                    for(let i in array){
                        if(j){
                            if(array[i].Key==j){
                                $('#JackpotActive').append('<option value="'+array[i].Key+'" selected>'+array[i].Value+'</option>')
                            }else {
                                $('#JackpotActive').append('<option value="'+array[i].Key+'">'+array[i].Value+'</option>')
                            }
                        }else {
                            $('#JackpotActive').append('<option value="'+array[i].Key+'">'+array[i].Value+'</option>')
                        }
                    }
                    form.render('select');
                }
            }
        })
    };
    //加载兑换奖品
    xcActionSystem.prototype.getChargeGood=function (token,form,j) {
        let obj={'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/GoodsInfo?action=GetGoodsDic',
            contentType: "application/json; charset=utf-8",
            data:{parasJson: parseJson},
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code==1){
                    $('#GoodID').html('<option>-请选择-</option>');
                    let array=data.result_data;
                    for(let i in array){
                        if(j){
                            if(array[i].ID==j){
                                $('#GoodID').append('<option value="'+array[i].ID+'" selected>'+array[i].GoodName+'</option>')
                            }else {
                                $('#GoodID').append('<option value="'+array[i].ID+'">'+array[i].GoodName+'</option>')
                            }
                        }else {
                            $('#GoodID').append('<option value="'+array[i].ID+'">'+array[i].GoodName+'</option>')
                        }

                    }
                    form.render('select');
                }
            }
        })
    };
    //加载兑换游乐项目
    xcActionSystem.prototype.getChargeProgect=function (token,form,j) {
        let obj={'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/Project?action=GetProjectDic',
            contentType: "application/json; charset=utf-8",
            data:{parasJson: parseJson},
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code==1){
                    $('#ProjectID').html('<option>-请选择-</option>');
                    let array=data.result_data;
                    for(let i in array){
                        $('#ProjectID').append('<option value="'+array[i].ID+'">'+array[i].ProjectName+'</option>')
                    }
                    $('#ProjectID').find('option[value="'+j+'"]').attr('selected',true);
                    form.render('select');
                }
            }
        })
    };
    //加载可选门店
    xcActionSystem.prototype.setUsefulStore=function (token,form,layer,selected) {
        let obj={'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/StoreInfo?action=GetUnderStores',
            contentType: "application/json; charset=utf-8",
            data:{parasJson: parseJson},
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code==1){
                    $('#chooseStoreList').html('');
                    let array=data.result_data;
                    for(let i in array){
                        if(selected){
                            let flag=false;
                             for(let j in selected){
                                 if(selected[j].StoreID==array[i].Key){
                                     flag=true;
                                 }
                             }
                             if(flag==true){
                                 $('#chooseStoreList').append('<input type="checkbox" checked lay-skin="primary" value="'
                                     +array[i].Key+'" lay-filter="chooseStore" title="'+array[i].Value+'">')
                             }else {
                                 $('#chooseStoreList').append('<input type="checkbox" lay-skin="primary" value="'
                                     +array[i].Key+'" lay-filter="chooseStore" title="'+array[i].Value+'">')
                             }
                        }else {
                            $('#chooseStoreList').append('<input type="checkbox" lay-skin="primary" value="'
                                +array[i].Key+'" lay-filter="chooseStore" title="'+array[i].Value+'">')
                        }
                    }
                    form.render('checkbox');

                }else {
                    layer.msg('获取门店列表失败')
                }
            }
        })
    };
   //获取已选门店
   xcActionSystem.prototype.getUsefulStore=function (couponId,token,form,layer) {
       let choseStore=JSON.parse(xcActionSystem.prototype.getStorage('choseStore'));
       let obj={'couponId':couponId,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
       let parseJson = JSON.stringify(obj);
       $.ajax({
           type:'post',
           url:'/XCCloud/Coupon?action=GetCouponStores',
           contentType: "application/json; charset=utf-8",
           data:{parasJson: parseJson},
           success: function (data) {
               data=JSON.parse(data);
               console.log(data);
               if(data.result_code==1){
                   storeId=data.result_data;
                   xc.setUsefulStore(token,form,layer,storeId)
               }else {
                   layer.msg('获取门店列表失败，err:'+data.result_msg||data.return_msg)
               }
           }
       })
   };
   //保存适用门店设置
    //加载会员列表
    xcActionSystem.prototype.getVip=function (token,form,layer) {
        let obj={'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/Member?action=GetMemberDic',
            contentType: "application/json; charset=utf-8",
            data:{parasJson: parseJson},
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code==1){
                    let arr=data.result_data;
                    if(arr.length>0){
                        $('#setVipList').html('');
                        for(let index in arr){
                            $('#setVipList').app('<input type="checkbox" value="'+arr[index].MemberID+'" lay-filter="vipList" lay-skin="primary" title="'+arr[index].MemberName+'">');
                        }
                        form.render('checkbox');
                        indexLayer= layer.open({
                            // title:'设置适用门店',
                            type:1,
                            area:'500px',
                            content:$('.setVip')
                        })
                    }else {
                        layer.msg('当前没有可设置的会员！')
                    }

                }
            }
        })
    };
    //加载可调拨门店
    xcActionSystem.prototype.sendStore=function (id,couponId,token,form,layer,selected) {
        let choseStore=JSON.parse(xcActionSystem.prototype.getStorage('choseStore'));
        let obj={'couponId':couponId,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/Coupon?action=GetCouponStores',
            contentType: "application/json; charset=utf-8",
            data:{parasJson: parseJson},
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code==1){
                 $('#'+id).html('<option>-请选择-</option>');
                 let arr=data.result_data;
                    for(let i in arr){
                        $('#'+id).append('<option value="'+arr[i].StoreID+'">'+arr[i].StoreName+'</option>')
                    }
                  form.render();
                }else {
                    layer.msg('获取门店列表失败')
                }
            }
        })
    }

</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="setStore">适用门店</a>
    {{# if(d.NotAssignedCount>0){ }}
    <a class="layui-btn layui-btn-xs layui-bg-cyan" lay-event="export"><i class="layui-icon layui-icon-zinbox-l"></i>导出</a>
    {{#  } }}
    {{# if(d.EntryCouponFlag==1&&d.NotAssignedCount>0){ }}
    <a class="layui-btn layui-btn-xs layui-bg-orange" lay-event="transfers"><i class="layui-icon">&#xe642;</i>优惠券调拨</a>
    {{#  } }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="send">实物券派发</a>
    {{# if(d.IsLock==1){ }}
    <a class="layui-btn layui-btn-xs layui-bg-green" lay-event="unlock"><i class="layui-icon layui-icon-zzunlock">解锁</i></a>
    {{# }else{ }}
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="lock"><i class="layui-icon layui-icon-zzunlock-alt">锁定</i></a>
    {{#  } }}
</script>
<script type="text/html" id="isLock">
    {{# if(d.IsLock==1){ }}
    <input type="checkbox"  name="switch" lay-skin="switch" lay-text="未锁|已锁" class="tb_check" lay-filter="test" disabled>
    {{# }else{ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="未锁|已锁" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
<script type="text/html" id="AuthorFlag">
    {{# if(d.AuthorFlag==1){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="yes|no" class="tb_check" lay-filter="test" disabled>
    {{# }else{ }}
    <input type="checkbox" name="switch" lay-skin="switch" lay-text="yes|no" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
<script type="text/html" id="AllowOverOther">
    {{# if(d.AllowOverOther==1){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="yes|no" class="tb_check" lay-filter="test" disabled>
    {{# }else{ }}
    <input type="checkbox" name="switch" lay-skin="switch" lay-text="yes|no" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
<script type="text/html" id="assigned">
    <button type="button" class="layui-btn layui-btn-xs layui-bg-orange" name='couponSendBtn' data-id="{{d.AssignedCount}}" style="width: 80px" id="{{d.ID}}"><i class="layui-icon layui-icon-zcamber-l"></i>{{d.AssignedCount}}</button>
</script>
<script type="text/html" id="barDemo2">
    {{# if(d.IsLock==1){ }}
    <a class="layui-btn layui-btn-xs layui-bg-green" lay-event="unlock"><i class="layui-icon layui-icon-zzunlock">解锁</i></a>
    {{# }else{ }}
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="lock"><i class="layui-icon layui-icon-zzunlock-alt">锁定</i></a>
    {{#  } }}
</script>
</html>
