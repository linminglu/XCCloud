<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>库存盘点</title>
    <link rel="stylesheet" href="layui/css/layui.css">
    <link rel="stylesheet" href="layui/css/layui_font.css">
</head>
<body>
    <div class="layui-row" style="padding:15px">
        <blockquote class="layui-elem-quote">
            <form class="layui-form layui-form-pane">
                <div class="layui-inline">
                    <label class="layui-form-label">库存类别</label>
                    <div class="layui-input-inline">
                        <select name="depotType" id="depotType" lay-filter="depotType">
                            <option value="">-请选择-</option>
                            <option value="0">仓库</option>
                            <option value="1">吧台</option>
                            <option value="2">自助机</option>
                            <option value="3">游戏机</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">选择仓库</label>
                    <div class="layui-input-inline">
                        <select name="depotList" id="depotList" lay-filter="depotList"></select>
                    </div>
                    <div class="layui-input-inline">
                        <button type="button" class="layui-btn layui-btn-normal" id="searchStock"><i class="layui-icon layui-icon-search"></i></button>
                        <button type="button" class="layui-btn layui-btn-danger" i18n-content="查询模板" id="checkMore">批量审核</button>
                    </div>
                </div>

                <div class="layui-inline" style="float:right;">
                    <button type="button" class="layui-btn layui-btn-normal" i18n-content="查询模板">查询模板</button>

                </div>
            </form>

            <!--<button type="button" class="layui-btn layui-btn-normal add" i18n-content="新增">新增</button>-->
        </blockquote>
        <table class="layui-hide" id="stockInventory" lay-filter="stockInventory"></table>
    </div>

<!--盘点-->
<div id="openModel" style="display: none;padding: 15px;">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <label class="layui-form-label">实际盘点数</label>
            <div class="layui-input-block">
                <input type="text" class="layui-input" id="inventoryCount">
            </div>
        </div>
    </form>
    <div style="text-align:right;">
        <button type="button" class="layui-btn layui-btn-normal" id="saveInventory">确定</button>
    </div>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let depotList='';let goodId='';let id='';
    let stockType='';
    let checkArr=[];
    layui.use(['form','table','layer'],function () {
        let form=layui.form;
        let table=layui.table;
        let layer=layui.layer;
        initTable(table,[]);
        xc.getDepotDic('','',token,layer,form,'depotList');
        //选择仓库后立即刷新
        form.on('select(depotType)',function (data) {

                stockType=data.value;

        })
        form.on('select(depotList)',function (data) {
            if(data.value!='-请选择-'){
                if(stockType!=''){
                    depotList=data.value;
                    var  obj={"stockIndex":depotList,'stockType':stockType,"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
                    var url="/XCCloud/GoodsInfo?action=QueryGoodsInventory";
                    var parasJson = JSON.stringify(obj);
                    $.ajax({
                        type: "post",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: {parasJson: parasJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            // console.log(data);
                            if (data.result_code == "1") {
                                initTable(table,data.result_data);
                            } else {
                                layer.msg(data.result_msg || data.return_msg);
                            }
                        }
                    })
                }else {
                    layer.msg('请选择库存类型')
                }

            }

        });
        //手动刷新
        $('#searchStock').on('click',function () {
            if(depotList==''){
                layer.msg('请先选择仓库！')
            }else {
                if(stockType!==''){
                    depotList=data.value;
                    var  obj={"stockIndex":depotList,'stockType':stockType,"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
                    var url="/XCCloud/GoodsInfo?action=QueryGoodsInventory";
                    var parasJson = JSON.stringify(obj);
                    $.ajax({
                        type: "post",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: {parasJson: parasJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            // console.log(data);
                            if (data.result_code == "1") {
                                initTable(table,data.result_data);
                            } else {
                                layer.msg(data.result_msg || data.return_msg);
                            }
                        }
                    })
                }else {
                    layer.msg('请选择库存类型')
                }
            }
        });
        //导出
        table.on('tool(stockInventory)',function (obj) {
            let _data=obj.data;
            let layEvent=obj.event;
            goodId=_data.GoodID;
            id=_data.ID;
            if(layEvent==='check'){
                layer.open({
                    title:"商品:"+_data.GoodName+"盘点",
                    type:1,
                    area:'600px',
                    content:$('#openModel')
                })
            }
        });
        table.on('checkbox(stockInventory)', function(obj){
            if (obj.type == "all") {

            } else {
                if(obj.checked==true){
                    checkArr.push({'id':obj.data.ID})
                }else {
                    for(let i in checkArr){
                        if(checkArr[i].id==obj.data.ID){
                            checkArr.splice(i,1)
                        }
                    }
                }
            }
        });
        $('#checkMore').on('click', function () {
            if(checkArr.length>0){
                var  obj={"goodsInventoryIDs":checkArr,"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
                var url="/XCCloud/GoodsInfo?action=CheckGoodsInventory";
                var parasJson = JSON.stringify(obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: {parasJson: parasJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        if (data.result_code == "1") {
                            layer.msg('审核完成',{time:1500},function(){
                                location.reload();
                            })
                        } else {
                            layer.msg(data.result_msg || data.return_msg);
                        }
                    }
                })
            }else {
                layer.msg('请先选择要审核的数据')
            }

        })
        $('#saveInventory').on('click',function(){
            var  obj={"goodsInventoryList":[{'id':id,'goodId':goodId,'depotId':depotList,'inventoryCount':$('#inventoryCount').val()}],
                "userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
            var url="/XCCloud/GoodsInfo?action=SaveGoodsInventory";
            var parasJson = JSON.stringify(obj);
            $.ajax({
                type: "post",
                url: url,
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parasJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.result_code == "1") {
                        layer.msg('盘点完成',{time:1500},function(){
                            location.reload();
                        })
                    } else {
                        layer.msg(data.result_msg || data.return_msg);
                    }
                }
            })
        })
    });
    function initTable(table,arr) {
        table.render({
            elem: '#stockInventory'
            , data: arr
            , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [[
                 {type:'checkbox'} ,
                {field: 'ID', title: '流水号', align: 'center'}
                , {field: 'GoodID', title: '商品ID', align: 'center'}
                , {field: 'Barcode', title: '商品条码', align: 'center'}
                , {field: 'GoodTypeStr', title: '商品类型', align: 'center'}
                , {field: 'GoodName', title: '商品名称', align: 'center'}
                , {field: 'Source', title: '添加来源', align: 'center',templet:'#charge'}
                , {field: 'MinValue', title: '库存下限', align: 'center'}
                , {field: 'MaxValue', title: '库存上限', align: 'center'}
                , {field: 'InitialTime', title: '期初时间', align: 'center'}
                , {field: 'InitialValue', title: '期初库存', align: 'center'}
                , {field: 'InitialAvgValue', title: '期初平均成本', align: 'center'}
                , {field: 'InitialTotal', title: '期初库存金额', align: 'center'}
                , {field: 'RemainCount', title: '当前库存', align: 'center'}
                , {field: 'RemainTotal', title: '当前库存金额', align: 'center'}
                , {field: 'UserName', title: '盘点人', align: 'center'}
                , {field: 'InventoryTime', title: '盘点时间', align: 'center'}
                , {field: 'InventoryCount', title: '盘点数量', align: 'center'}
                , {field: 'ErrorCount', title: '误差数量', align: 'center'}
                , {field: 'ErrorTotal', title: '误差金额', align: 'center'}
                , {field: 'ErrorRate', title: '误差率', align: 'center'}
                ,{fixed: 'right',title: '操作', width:140, align:'center', toolbar: '#barDemo'}]]
            , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
            , limit: 10
            ,done:function(){
                $('thead th[data-field="GoodID"]').css({'display':'none'});
                $('tbody td[data-field="GoodID"]').css({'display':'none'});
            }
        })
    }
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="check">盘点</a>
</script>
</html>