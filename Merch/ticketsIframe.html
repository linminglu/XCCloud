<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="layui/css/layui.css">
    <link rel="stylesheet" href="layui/css/layui_font.css">
    <title>Title</title>
    <style>
        .layui-form-item{
            margin-bottom: 0;}
         .layui-card-body .layui-table{
            margin: 0!important;
        }
    </style>
</head>
<body>
<div class="layui-row">
    <div class="goodIsAll" style="padding: 15px;max-height: 550px;overflow-y: auto" id=""  >
        <form class="layui-form layui-form-pane" lay-filter="formtest">
            <div class="layui-card">
                <div class="layui-card-header">基本信息</div>
                <div class="layui-card-body">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">门票名称</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="TicketName" name="TicketName">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">业务类别</label>
                            <div class="layui-input-inline">
                                <!--<select name="BusinessType" id="BusinessType" lay-filter="BusinessType">-->
                                    <!--<option value="0">门票</option>-->
                                    <!--<option value="1">包段优惠</option>-->
                                <!--</select>-->
                                <input type="text" class="layui-input" id="BusinessType" name="BusinessType" readonly>
                            </div>
                        </div>
                        <div class="layui-inline allowExitBox">
                            <label class="layui-form-label">允许离场时间</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="AllowExitTimes" name="AllowExitTimes">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">核销期</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="WriteOffDays" name="WriteOffDays">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">售价</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="Price" name="Price">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">税率</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="Tax" name="Tax">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item " >
                        <div class="layui-inline DivideTypeBox">
                            <label class="layui-form-label">分摊类别</label>
                            <div class="layui-input-inline">
                                <select name="DivideType" id="DivideType" lay-filter="DivideType">
                                    <option>-请选择-</option>
                                    <option value="0">一次性分摊</option>
                                    <option value="1">按次分摊</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline layui-hide" id="groupStart">
                            <label class="layui-form-label">起购人数</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="GroupStartupCount" name="GroupStartupCount">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item ">
                        <div class="layui-inline readFaceBox">
                            <div class="layui-input-inline">
                                <input type="checkbox" title="是否开启人脸识别" lay-skin="primary" name="ReadFace" lay-filter="ReadFace">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="checkbox" title="是否需要吧台激活" lay-skin="primary" name="ActiveBar" lay-filter="ActiveBar">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="checkbox" title="销售产生积分" lay-skin="primary" name="AllowCreatePoint" lay-filter="AllowCreatePoint">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline" style="width: 200px">
                                <input type="checkbox" title="是否需要授权才能销售" lay-skin="primary" name="SaleAuthor" lay-filter="SaleAuthor">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">有效期设置</div>
                <div class="layui-card-body">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">可用时段</label>
                            <div class="layui-input-inline">
                                <select name="EffactType" id="EffactType" lay-filter="timesType">//EffactType
                                    <option value="0" selected>有效时长</option>
                                    <option value="1">有效期限</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline time1">
                            <label class="layui-form-label">销售后</label>
                            <div class="layui-input-inline" style="width: 100px">
                                <input type="text" class="layui-input" name="EffactPeriodValue">
                            </div>
                            <div class="layui-input-inline" style="width: 100px">
                                <select name="EffactPeriodType" id="EffactPeriodType" lay-filter="EffactPeriodType">
                                    <option value="0" selected>天</option>
                                    <option value="1">周</option>
                                    <option value="2">月</option>
                                    <option value="3">季</option>
                                    <option value="4">年</option>
                                </select>
                            </div>
                            <div class="layui-form-mid">生效,有效期</div>
                            <div class="layui-input-inline" style="width: 100px">
                                <input type="text" class="layui-input" name="VaildPeriodValue">
                            </div>
                            <div class="layui-input-inline" style="width: 100px">
                                <select name="VaildPeriodType" id="VaildPeriodType" lay-filter="VaildPeriodType">
                                    <option value="0" selected>天</option>
                                    <option value="1">周</option>
                                    <option value="2">月</option>
                                    <option value="3">季</option>
                                    <option value="4">年</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline time2 layui-hide">
                            <label class="layui-form-label">时间范围</label>
                            <div class="layui-input-inline" style="width: 150px">
                                <select lay-filter="usePried">
                                    <option value="1">当天</option>
                                    <option value="2">本周</option>
                                    <option value="3">本月</option>
                                    <option value="4">本季</option>
                                    <option value="5">本年</option>
                                    <option value="0">自定义</option>
                                </select>
                            </div>
                            <div class="layui-input-inline" style="width: 150px">
                                <input type="text" class="layui-input" name="VaildStartDate" id="VaildStartDate">
                            </div>
                            <div class="layui-form-mid">
                                至
                            </div>
                            <div class="layui-input-inline" style="width: 150px">
                                <input type="text" class="layui-input" name="VaildEndDate" id="VaildEndDate">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">时段类型</label>
                            <div class="layui-input-inline">
                                <select id="poriedType" lay-filter="timeType" name="poriedType">
                                    <option value="0" selected>自定义</option>
                                    <option value="1" >工作日</option>
                                    <option value="2" >周末</option>
                                    <option value="3" >法定节假日</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline" id="weekSetBox">
                            <label class="layui-form-label">优惠周天</label>
                            <div class="layui-input-block" id="weekBox" style="width: 700px">

                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">生效时段</label>
                            <div class="layui-input-inline" style="margin-right: 5px">
                                <input type="text" name="StartTime" id="StartTime" class="layui-input">
                            </div>
                            <div class="layui-form-mid" style="margin-right: 5px">至</div>
                            <div class="layui-input-inline" >
                                <input type="text" name="EndTime" id="EndTime" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">不可用日期</label>
                            <div class="layui-input-inline">
                                <select name="noUsePried" id="noUsePried" lay-filter="noUsePried">
                                    <option value="6">不设置</option>
                                    <option value="1">当天</option>
                                    <option value="2">本周</option>
                                    <option value="3">本月</option>
                                    <option value="4">本季</option>
                                    <option value="5">本年</option>
                                    <option value="0">自定义</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">不可用期限</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" disabled name="NoStartDate" id="NoStartDate">
                            </div>
                            <div class="layui-form-mid">
                                至
                            </div>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" disabled name="NoEndDate" id="NoEndDate">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-card togetherBox">
                <div class="layui-card-header">陪同票</div>
                <div class="layui-card-body">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label for="" class="layui-form-label">现金</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" name="AccompanyCash">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label for="" class="layui-form-label">扣除种类</label>
                            <div class="layui-input-inline">
                                <select name="BalanceIndex" id="BalanceIndex" lay-filter="BalanceIndex"></select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label for="" class="layui-form-label">扣除数量</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" name="BalanceValue">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">退货信息</div>
                <div class="layui-card-body">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <div class="layui-input-inline" style="width: 120px">
                                <input type="checkbox" title="允许退票" lay-skin="primary" name="AllowExitTicket" lay-filter="AllowExitTicket">
                            </div>

                            <div class="layui-form-mid">销售</div>
                            <div class="layui-input-inline" style="width: 100px">
                                <input type="text" class="layui-input" name="ExitPeriodValue">
                            </div>
                            <div class="layui-input-inline" style="width: 100px">
                                <select name="ExitPeriodType" id="ExitPeriodType" lay-filter="ExitPeriodType">
                                    <option value="0">小时</option>
                                    <option value="1">天</option>
                                </select>
                            </div>
                            <div class="layui-form-mid">后不可退票</div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">退票方式</label>
                        <div class="layui-input-inline" style="width: 200px">
                            <input type="radio" name="ExitTicketType" title="按金额" value="0" lay-skin="primary" checked lay-filter="ExitTicketType">
                            <input type="radio" name="ExitTicketType" title="按比例" value="1" lay-skin="primary" lay-filter="ExitTicketType">
                        </div>
                        <div class="layui-input-inline " style="width: 100px" id="ETV1">
                            <input type="text" class="layui-input" name="ExitTicketVal1" placeholder="元">
                        </div>
                        <div class="layui-input-inline layui-hide" id="ETV2" style="width: 100px">
                            <input type="text" class="layui-input" name="ExitTicketVal2" placeholder="%">
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-card layui-hide" id="useReason">
                <div class="layui-card-header">使用限制</div>
                <div class="layui-card-body">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">限制条件</label>
                            <div class="layui-input-inline">
                                <select name="AllowRestrict" id="AllowRestrict" lay-filter="AllowRestrict">
                                    <option>-请选择-</option>
                                    <option value="0">不限次数</option>
                                    <option value="1">限定游玩次数</option>
                                </select>
                            </div>
                        </div>
                       <div class="layui-inline layui-hide" id="useReasonBox">
                           <div class="layui-input-inline">
                               <input type="checkbox" title="次数共享" lay-skin="primary" lay-filter="RestrictShareCount" name="RestrictShareCount">
                           </div>
                           <div class="layui-form-mid">每</div>
                           <div class="layui-input-inline" style="width: 70px">
                               <input type="text" class="layui-input" name="RestrictPreiodValue">
                           </div>
                           <div class="layui-input-inline">
                               <select name="RestrictPeriodType"  id="RestrictPeriodType" lay-filter="RestrictPeriodType">
                                   <option value="0">小时</option>
                                   <option value="1">天</option>
                               </select>
                           </div>
                           <div class="layui-form-mid">限制使用</div>
                           <div class="layui-input-inline" style="width: 70px">
                               <input type="text" class="layui-input" name="RestrctCount">
                           </div>
                           <div class="layui-form-mid">次</div>
                       </div>
                    </div>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">
                    <div class="layui-form-item" id="bindTimesBox">

                        <div class="layui-inline">
                            <div class="layui-form-mid" style="padding: 0!important;">
                                <button type="button" class="layui-btn" id="addPro">绑定项目>>添加项目</button>
                            </div>
                            <div class="layui-input-inline bindTimesBox" style="text-align:right;">
                                <input type="checkbox" title="次数共享" lay-filter="isShare" id="isShare" lay-skin="primary">
                            </div>
                        </div>
                        <div class="layui-inline bindTimesBox">
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="shareTimes" disabled>
                            </div>
                            <div class="layui-form-mid" style="padding: 0!important;">次</div>
                        </div>
                    </div>
                </div>
                <div class="layui-card-body">
                    <table class="layui-hide" id="proTable" lay-filter="proTable"></table>
                </div>

            </div>
            <div style="text-align: center;margin-bottom: 15px">
                <button type="button" class="tosecond layui-btn-normal layui-btn" id="save">确定</button>
            </div>
        </form>
    </div>
</div>
<div id="openModel" style="padding: 15px;display: none">
    <form action="" class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <label for="" class="layui-form-label">游乐项目</label>
            <div class="layui-input-block" >
                <select name="proList" id="proList" lay-filter="proList">

                </select>
            </div>
        </div>

    </form>
    <div style="text-align:center;" >
        <button type="button" class="layui-btn" id="savePro">确定</button>
    </div>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let  ticketSet=JSON.parse(xc.getStorage('ticketSet'));
    if(ticketSet.name=='times'){
        $('input[name="BusinessType"]').val('门票');
        BusinessType=0;
    }else if(ticketSet.name=='month'){
        $('.bindTimesBox').addClass('layui-hide');
        $('#useReason').removeClass('layui-hide');
        $('input[name="BusinessType"]').val('门票');
        BusinessType=0;
    }else if(ticketSet.name=='group'){
        $('#groupStart').removeClass('layui-hide');
        $('input[name="BusinessType"]').val('门票');
        BusinessType=0;
    }else if(ticketSet.name=='boardPackage'){
        $('input[name="BusinessType"]').val('机台打包');
        //机台打包禁用以下属性：允许离场时间，分摊类别，人脸识别，陪同票
        $('.allowExitBox').addClass('layui-hide');
        $('.DivideTypeBox').addClass('layui-hide');
        $('.readFaceBox').addClass('layui-hide');
        $('.togetherBox').addClass('layui-hide');

        BusinessType=2;
    }else if(ticketSet.name=='timeLimit'){
        $('.bindTimesBox').addClass('layui-hide');
        $('#useReason').removeClass('layui-hide');
        $('input[name="BusinessType"]').val('限时任玩');
        BusinessType=1;

        //包时任玩禁用以下属性：允许离场时间，分摊类别，人脸识别，陪同票，
        $('.allowExitBox').addClass('layui-hide');
        $('.DivideTypeBox').addClass('layui-hide');
        $('.readFaceBox').addClass('layui-hide');
        $('.togetherBox').addClass('layui-hide');
    }

    let   proListArr=[];
    let proList='';let ProjcetName='';let ProjcetType='';let ProjcetTypeStr='';let PushCoin1=0;
    let isShare=0;

    let DivideType=''; let ReadFace=0;let ActiveBar=0;let AllowCreatePoint=0;let SaleAuthor=0;
    let EffactType=0; let EffactPeriodType=0; let VaildPeriodType=0;let WeekType=0;let week=[];
    let BalanceIndex='';
    let AllowExitTicket=0;let ExitPeriodType=0;let ExitTicketType=0;//按金额
    let RestrictPeriodType='';let AllowRestrict='';let RestrictShareCount=0;
    layui.use(['table','form','layer','laydate'],function () {
        let table=layui.table;
        let form=layui.form;
        let layer=layui.layer;
        let laydate=layui.laydate;

        form.on('select(DivideType)',function (data){DivideType=data.value;});
        form.on('checkbox(ReadFace)',function (data){data.elem.checked==true? ReadFace=1: ReadFace=0});
        form.on('checkbox(ActiveBar)',function (data){data.elem.checked==true? ActiveBar=1: ActiveBar=0});
        form.on('checkbox(AllowCreatePoint)',function (data){data.elem.checked==true? AllowCreatePoint=1: AllowCreatePoint=0});
        form.on('checkbox(SaleAuthor)',function (data){data.elem.checked==true? SaleAuthor=1: SaleAuthor=0});
        //可用时段类型
        form.on('select(timesType)',function (data) {
            EffactType=data.value;
            if(data.value==0){
                $('.time1').removeClass('layui-hide');
                $('.time2').addClass('layui-hide')
            }else {
                $('.time2').removeClass('layui-hide');
                $('.time1').addClass('layui-hide')
            }
        });
        form.on('select(EffactPeriodType)',function (data){EffactPeriodType=data.value;});
        form.on('select(VaildPeriodType)',function (data){VaildPeriodType=data.value;});
        xc.AddWeeks('weekBox');
        xc. getBalanceTypeDic('',token,layer,form,'BalanceIndex');
        form.on('select(timeType)',(data)=>{
            WeekType=data.value;
            if(WeekType==0){
                $('#weekSetBox').css({'display':'inline-block'});
                form.render();
                xc.AddWeeks('weekBox');
            }else {
                $('#weekSetBox').css({'display':'none'});
                $('#weekBox').html('');
                week=[];
            }
        });
        form.on('select(BalanceIndex)',function (data){BalanceIndex=data.value;});
        form.on('checkbox(AllowExitTicket)',function (data){data.elem.checked==true? AllowExitTicket=1: AllowExitTicket=0});
        form.on('select(ExitPeriodType)',function (data){ExitPeriodType=data.value;});
        form.on('radio(ExitTicketType)', function(data){
            ExitTicketType=data.value
            if(data.value==0){
                $('#ETV1').removeClass('layui-hide');
                $('#ETV2').addClass('layui-hide');
            }else  if(data.value==1){
                $('#ETV2').removeClass('layui-hide');
                $('#ETV1').addClass('layui-hide');
            }
        });
        form.on('select(RestrictPeriodType)',function (data){
            RestrictPeriodType=data.value;
        });//限制类型
        form.on('select(AllowRestrict)',function (data){
            AllowRestrict=data.value;
            if(AllowRestrict==1){
                $('#useReasonBox').removeClass('layui-hide')
            }else {
                $('#useReasonBox').addClass('layui-hide')
            }

        });
        form.on('checkbox(RestrictShareCount)',function (data){data.elem.checked==true? RestrictShareCount=1: RestrictShareCount=0});
        //监听有效期间选择
        form.on('select(usePried)',function (data) {
            if(data.value==1){
                $('#VaildStartDate').val(getDayStartDate()).prop('disabled',true);
                $('#VaildEndDate').val(getDayStartDate()).prop('disabled',true);
            }else if(data.value==2){
                $('#VaildStartDate').val(getWeekStartDate()).prop('disabled',true);
                $('#VaildEndDate').val(getWeekEndDate()).prop('disabled',true);
            }else if(data.value==3){
                $('#VaildStartDate').val(getMonthStartDate()).prop('disabled',true);
                $('#VaildEndDate').val(getMonthEndDate()).prop('disabled',true);
            }else if(data.value==5){
                $('#VaildStartDate').val(getYearStartDate()).prop('disabled',true);
                $('#VaildEndDate').val(getYearEndDate()).prop('disabled',true);
            }else if(data.value==4){
                $('#VaildStartDate').val(getQuarterStartDate()).prop('disabled',true);
                $('#VaildEndDate').val(getQuarterEndDate()).prop('disabled',true);
            }else if(data.value==0){
                $('#VaildStartDate').prop('disabled',false);
                $('#VaildEndDate').prop('disabled',false);
                layer.msg('<p style="color: red">请自己设置有效期限</p>')
            }
        });
        //监听不可用期限选择
        form.on('select(noUsePried)',function (data) {
            if(data.value==1){
                $('#NoStartDate').val(getDayStartDate()).prop('disabled',true);
                $('#NoEndDate').val(getDayStartDate()).prop('disabled',true);
            }else if(data.value==2){
                $('#NoStartDate').val(getWeekStartDate()).prop('disabled',true);
                $('#NoEndDate').val(getWeekEndDate()).prop('disabled',true);
            }else if(data.value==3){
                $('#NoStartDate').val(getMonthStartDate()).prop('disabled',true);
                $('#NoEndDate').val(getMonthEndDate()).prop('disabled',true);
            }else if(data.value==5){
                $('#NoStartDate').val(getYearStartDate()).prop('disabled',true);
                $('#NoEndDate').val(getYearEndDate()).prop('disabled',true);
            }else if(data.value==4){
                $('#NoStartDate').val(getQuarterStartDate()).prop('disabled',true);
                $('#NoEndDate').val(getQuarterEndDate()).prop('disabled',true);
            }else if(data.value==0){
                $('#NoStartDate').prop('disabled',false);
                $('#NoEndDate').prop('disabled',false);
                layer.msg('<p style="color: red">请自己设置不可用期限</p>')
            }else  if(data.value==6){
                $('#NoStartDate').val('').prop('disabled',true);
                $('#NoEndDate').val('').prop('disabled',true);
            }
        });
        form.on('checkbox(weeks)', function(data){
            if (data.elem.checked==true){
                week.push(data.value);
                // weekStr.push(data.elem.title)
            }else if(data.elem.checked==false){
                for (var i=0;i<week.length;i++){
                    if(week[i]==data.value){
                        week.splice(i,1);
                        // weekStr.splice(i,1);
                    }
                }
            }
        });

        //渲染时间StartTime
        laydate.render({
            elem: '#StartTime',type: 'time'
        });
        laydate.render({
            elem: '#EndTime',type: 'time'
        });
        laydate.render({
            elem: '#VaildStartDate',type: 'date',value:new Date()
        });
        laydate.render({
            elem: '#VaildEndDate',type: 'date',value:new Date()
        });
        laydate.render({
            elem: '#NoStartDate',type: 'date'
        });
        laydate.render({
            elem: '#NoEndDate',type: 'date'
        });
        //绑定项目
        bindPro(ticketSet.name,table,[],'proTable');
        $('#addPro').on('click',function (){
            if(ticketSet.name=='times'){
                initProject(token,form,layer,'proList','0');
            }else if(ticketSet.name=='month'){
                initProject(token,form,layer,'proList','0');
            }else if(ticketSet.name=='group'){
                initProject(token,form,layer,'proList','0');
            }else if(ticketSet.name=='boardPackage'){
                initProject(token,form,layer,'proList','2');
            }else if(ticketSet.name=='timeLimit'){
                initProject(token,form,layer,'proList','1');
            }
            proList=''; ProjcetName=''; ProjcetType=''; ProjcetTypeStr=''; PushCoin1=0;
            if(isShare==1) {
                if ($('#shareTimes').val() == '') {
                    layer.msg('当前为次数共享模式,请先设置共享次数！', {time: 1500})
                }else if(Number($('#shareTimes').val())>0){
                    layer.open({
                        type:1,
                        area:'600px',
                        content:$('#openModel')
                    })
                }
            }else {
                layer.open({
                    type:1,
                    area:'600px',
                    content:$('#openModel')
                })
            }
        });
        form.on('select(proList)',(data)=>{
            proList=data.value;
            let  _Title='';
            _Title=data.elem[data.elem.selectedIndex].title;
            ProjcetName=data.elem[data.elem.selectedIndex].text;
            ProjcetType=_Title.split('|')[0];
            ProjcetTypeStr=_Title.split('|')[1];
            PushCoin1=_Title.split('|')[2];
        });
        form.on('checkbox(isShare)',(data)=>{
            if(data.elem.checked==true){
                isShare=1;
                for(let i in proListArr){
                    proListArr[i].AllowShareCount=1;
                }
                layer.msg('请填写共享次数,需大于0且必须填写！')
                table.render({
                    elem: '#proTable'
                    , height:'250px'
                    , size:"sm"
                    , data: proListArr
                    , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                    , cols: [[
                        {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                        ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                        ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                        ,{field:'UseCount', title: '游玩次数', align: 'center',width:140}
                        ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                        ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                    , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                    , limit: 10
                });
                $('#shareTimes').attr({'disabled':false})
            }else {
                isShare=0;
                for(let i in proListArr){
                    proListArr[i].AllowShareCount=0;
                }
                table.render({
                    elem: '#proTable'
                    , height:'250px'
                    , size:"sm"
                    , data: proListArr
                    , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                    , cols: [[
                        {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                        ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                        ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                        ,{field:'UseCount', title: '游玩次数', align: 'center',width:140,edit:true}
                        ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                        ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                    , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                    , limit: 10
                });
                $('#shareTimes').attr({'disabled':true}).val('')
            }
        });
        $('#shareTimes').on('keyup',function(e){
            if(e.keyCode>47&& e.keyCode<58||e.keyCode>95&& e.keyCode<106){
                if(Number($(this).val())>0){
                    for(let i in proListArr){
                        proListArr[i].UseCount=$('#shareTimes').val();
                        proListArr[i].WeightValue=parseInt($('#shareTimes').val())*parseInt(proListArr[i].PushCoin1)
                    }
                    table.render({
                        elem: '#proTable'
                        , height:'250px'
                        , size:"sm"
                        , data: proListArr
                        , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                        , cols: [[
                            {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                            ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                            ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                            ,{field:'UseCount', title: '游玩次数', align: 'center',width:140}
                            ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                            ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                        , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                        , limit: 10
                    });
                }
            }else {
                $(this).val('')
            }
        })
        $('#savePro').on('click',function () {
            if(proList!=''){

                if(ticketSet.way=='add'){
                    if(proListArr.length>0) {
                        let flag = false;
                        for (let i in proListArr) {
                            if (proListArr[i].ProjcetID == proList) {
                                flag = true;
                            }
                        }
                        if(flag){
                            layer.msg('该项目已绑定，请选择其他项目',{time:1500})
                        }else {
                            if(ticketSet.name=='times'||ticketSet.name=='group'||ticketSet.name=='boardPackage'){
                                if(isShare==1){
                                    if($('#shareTimes').val()==''){
                                        layer.msg('当前为次数共享模式,请先设置共享次数！')
                                    }else if($('#shareTimes').val()>0){
                                        proListArr.push({
                                            'ProjectTicketID':''
                                            ,'ProjcetID':proList
                                            ,'ProjectName':ProjcetName
                                            ,'ProjcetType':ProjcetType
                                            ,'ProjcetTypeStr':ProjcetTypeStr
                                            ,'PushCoin1':PushCoin1
                                            ,'UseCount':$('#shareTimes').val()
                                            ,'AllowShareCount':isShare
                                            ,'WeightValue':parseInt(PushCoin1)*parseInt($('#shareTimes').val())
                                        });
                                        table.render({
                                            elem: '#proTable'
                                            , height:'250px'
                                            , size:"sm"
                                            , data: proListArr
                                            , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                            , cols: [[
                                                {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                                                ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                                                ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                                                ,{field:'UseCount', title: '游玩次数', align: 'center',width:140}
                                                ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                                                ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                                            , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                                            , limit: 10
                                        });
                                    }
                                }else {
                                    proListArr.push({
                                        'ProjectTicketID':''
                                        ,'ProjcetID':proList
                                        ,'ProjectName':ProjcetName
                                        ,'ProjcetType':ProjcetType
                                        ,'ProjcetTypeStr':ProjcetTypeStr
                                        ,'PushCoin1':PushCoin1
                                        ,'UseCount':PushCoin1
                                        ,'AllowShareCount':isShare
                                        ,'WeightValue':parseInt(PushCoin1)*parseInt(PushCoin1)
                                    });
                                    table.render({
                                        elem: '#proTable'
                                        , height:'250px'
                                        , size:"sm"
                                        , data: proListArr
                                        , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                        , cols: [[
                                            {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                                            ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                                            ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                                            ,{field:'UseCount', title: '游玩次数', align: 'center',width:140,edit:true}
                                            ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                                            ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                                        , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                                        , limit: 10
                                    });
                                }

                            }else if(ticketSet.name=='month'||ticketSet.name=='timeLimit'){
                                proListArr.push({
                                    'ProjectTicketID':''
                                    ,'ProjcetID':proList
                                    ,'ProjectName':ProjcetName
                                    ,'ProjcetType':ProjcetType
                                    ,'ProjcetTypeStr':ProjcetTypeStr
                                    ,'WeightValue':0
                                });
                                bindPro(ticketSet.name,table,proListArr,'proTable');
                            }
                        }

                    }else {
                        if(ticketSet.name=='times'||ticketSet.name=='group'||ticketSet.name=='boardPackage'){
                            if(isShare==1){
                                    proListArr.push({
                                        'ProjectTicketID':''
                                        ,'ProjcetID':proList
                                        ,'ProjectName':ProjcetName
                                        ,'ProjcetType':ProjcetType
                                        ,'ProjcetTypeStr':ProjcetTypeStr
                                        ,'PushCoin1':PushCoin1
                                        ,'UseCount':$('#shareTimes').val()
                                        ,'AllowShareCount':isShare
                                        ,'WeightValue':parseInt(PushCoin1)*parseInt($('#shareTimes').val())
                                    });

                                table.render({
                                    elem: '#proTable'
                                    , height:'250px'
                                    , size:"sm"
                                    , data: proListArr
                                    , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                    , cols: [[
                                        {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                                        ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                                        ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                                        ,{field:'UseCount', title: '游玩次数', align: 'center',width:140}
                                        ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                                        ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                                    , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                                    , limit: 10
                                });
                            }else {
                                proListArr.push({
                                    'ProjectTicketID':ticketSet.id
                                    ,'ProjcetID':proList
                                    ,'ProjectName':ProjcetName
                                    ,'ProjcetType':ProjcetType
                                    ,'ProjcetTypeStr':ProjcetTypeStr
                                    ,'PushCoin1':PushCoin1
                                    ,'UseCount':PushCoin1
                                    ,'AllowShareCount':isShare
                                    ,'WeightValue':parseInt(PushCoin1)*parseInt(PushCoin1)
                                });
                                for(let i in proListArr){
                                    proListArr[i].AllowShareCount=0;
                                }
                                table.render({
                                    elem: '#proTable'
                                    , height:'250px'
                                    , size:"sm"
                                    , data: proListArr
                                    , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                    , cols: [[
                                        {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                                        ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                                        ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                                        ,{field:'UseCount', title: '游玩次数', align: 'center',width:140,edit:true}
                                        ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                                        ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                                    , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                                    , limit: 10
                                });
                            }

                        }else {
                            proListArr.push({'ProjectTicketID':''
                                ,'ProjcetID':proList
                                ,'ProjectName':ProjcetName
                                ,'ProjcetType':ProjcetType
                                ,'ProjcetTypeStr':ProjcetTypeStr
                                ,'WeightValue':PushCoin1});
                            bindPro(ticketSet.name,table,proListArr,'proTable');
                        }
                    }

                }else if(ticketSet.way=='modify'){
                    if(proListArr.length>0){
                        let flag=false;
                        for(let i in proListArr){
                            if(proListArr[i].ProjcetID==proList){
                                flag=true;
                            }
                        }
                        if(flag){
                            layer.msg('该项目已绑定，请选择其他项目',{time:1500})
                        }else {
                            if(ticketSet.name=='times'||ticketSet.name=='group'||ticketSet.name=='boardPackage'){
                                if(isShare==1){
                                    if($('#shareTimes').val()==''){
                                        layer.msg('当前为次数共享模式,请先设置共享次数！',{time:1500})
                                    }else if($('#shareTimes').val()>0){
                                        proListArr.push({
                                            'ProjectTicketID':ticketSet.id
                                            ,'ProjcetID':proList
                                            ,'ProjectName':ProjcetName
                                            ,'ProjcetType':ProjcetType
                                            ,'ProjcetTypeStr':ProjcetTypeStr
                                            ,'PushCoin1':PushCoin1
                                            ,'UseCount':$('#shareTimes').val()
                                            ,'AllowShareCount':isShare
                                            ,'WeightValue':parseInt(PushCoin1)*parseInt($('#shareTimes').val())
                                        });
                                    }
                                    for(let i in proListArr){
                                        proListArr[i].UseCount=$('#shareTimes').val();
                                        proListArr[i].WeightValue=parseInt($('#shareTimes').val())*parseInt(proListArr[i].PushCoin1)
                                    }
                                    table.render({
                                        elem: '#proTable'
                                        , height:'250px'
                                        , size:"sm"
                                        , data: proListArr
                                        , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                        , cols: [[
                                            {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                                            ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                                            ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                                            ,{field:'UseCount', title: '游玩次数', align: 'center',width:140}
                                            ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                                            ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                                        , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                                        , limit: 10
                                    });
                                }else {
                                    proListArr.push({
                                        'ProjectTicketID':ticketSet.id
                                        ,'ProjcetID':proList
                                        ,'ProjectName':ProjcetName
                                        ,'ProjcetType':ProjcetType
                                        ,'ProjcetTypeStr':ProjcetTypeStr
                                        ,'PushCoin1':PushCoin1
                                        ,'UseCount':PushCoin1
                                        ,'AllowShareCount':isShare
                                        ,'WeightValue':parseInt(PushCoin1)*parseInt(PushCoin1)
                                    });
                                    for(let i in proListArr){
                                        proListArr[i].AllowShareCount=0;
                                    }
                                    table.render({
                                        elem: '#proTable'
                                        , height:'250px'
                                        , size:"sm"
                                        , data: proListArr
                                        , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                        , cols: [[
                                            {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                                            ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                                            ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                                            ,{field:'UseCount', title: '游玩次数', align: 'center',width:140,edit:true}
                                            ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                                            ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                                        , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                                        , limit: 10
                                    });
                                }

                            }else {
                                proListArr.push({'ProjectTicketID':ticketSet.id
                                    ,'ProjcetID':proList
                                    ,'ProjectName':ProjcetName
                                    ,'ProjcetType':ProjcetType
                                    ,'ProjcetTypeStr':ProjcetTypeStr
                                    ,'WeightValue':PushCoin1});
                                bindPro(ticketSet.name,table,proListArr,'proTable');
                            }
                        }
                    }else {
                        if(ticketSet.name=='times'||ticketSet.name=='group'||ticketSet.name=='boardPackage'){
                            if(isShare==1){
                                    proListArr.push({
                                        'ProjectTicketID':ticketSet.id
                                        ,'ProjcetID':proList
                                        ,'ProjectName':ProjcetName
                                        ,'ProjcetType':ProjcetType
                                        ,'ProjcetTypeStr':ProjcetTypeStr
                                        ,'PushCoin1':PushCoin1
                                        ,'UseCount':$('#shareTimes').val()
                                        ,'AllowShareCount':isShare
                                        ,'WeightValue':parseInt(PushCoin1)*parseInt($('#shareTimes').val())
                                    });

                                for(let i in proListArr){
                                    proListArr[i].AllowShareCount=1;
                                }
                                table.render({
                                    elem: '#proTable'
                                    , height:'250px'
                                    , size:"sm"
                                    , data: proListArr
                                    , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                    , cols: [[
                                        {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                                        ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                                        ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                                        ,{field:'UseCount', title: '游玩次数', align: 'center',width:140}
                                        ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                                        ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                                    , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                                    , limit: 10
                                });
                            }else {
                                proListArr.push({
                                    'ProjectTicketID':ticketSet.id
                                    ,'ProjcetID':proList
                                    ,'ProjectName':ProjcetName
                                    ,'ProjcetType':ProjcetType
                                    ,'ProjcetTypeStr':ProjcetTypeStr
                                    ,'PushCoin1':PushCoin1
                                    ,'UseCount':PushCoin1
                                    ,'AllowShareCount':isShare
                                    ,'WeightValue':parseInt(PushCoin1)*parseInt(PushCoin1)
                                });
                                for(let i in proListArr){
                                    proListArr[i].AllowShareCount=0;
                                }
                                table.render({
                                    elem: '#proTable'
                                    , height:'250px'
                                    , size:"sm"
                                    , data: proListArr
                                    , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                    , cols: [[
                                        {field:'ProjectName', title:'项目名称', align: 'center',width:200}
                                        ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
                                        ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
                                        ,{field:'UseCount', title: '游玩次数', align: 'center',width:140,edit:true}
                                        ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
                                        ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]]
                                    , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                                    , limit: 10
                                });
                            }

                        }else {
                            proListArr.push({'ProjectTicketID':ticketSet.id
                                ,'ProjcetID':proList
                                ,'ProjectName':ProjcetName
                                ,'ProjcetType':ProjcetType
                                ,'ProjcetTypeStr':ProjcetTypeStr
                                ,'WeightValue':PushCoin1});
                            for(let i in proListArr){
                                proListArr[i].AllowShareCount=0;
                            }
                            bindPro(ticketSet.name,table,proListArr,'proTable');
                        }

                    }
                }

                layer.closeAll();
            }
        });
        $('#save').on('click',function () {
            saveTicketSet(ticketSet,layer);
        });

        //如果是修改
        if(ticketSet.way=='modify'){
                let _obj={'id':ticketSet.id,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type:'post',
                    url:'/XCCloud/ProjectTicket?action=GetProjectTicket',
                    contentType: "application/json; charset=utf-8",
                    data:{parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        console.log(data);
                        if (data.result_code == 1) {
                            let arr=data.result_data;
                            form.val('formtest',{
                                'TicketName':arr.TicketName,

                                'AllowExitTimes':arr.AllowExitTimes,
                                'WriteOffDays':arr.WriteOffDays,
                                'Price':arr.Price,
                                'Tax':arr.Tax,
                                'DivideType':arr.DivideType,
                                'ReadFace':arr.ReadFace==1?true:false,
                                'ActiveBar':arr.ActiveBar==1?true:false,
                                'AllowCreatePoint':arr.AllowCreatePoint==1?true:false,
                                'SaleAuthor':arr.SaleAuthor==1?true:false,
                                'EffactType':arr.EffactType,
                                'EffactPeriodValue':arr.EffactPeriodValue,
                                'EffactPeriodType':arr.EffactPeriodType,
                                'VaildPeriodValue':arr.VaildPeriodValue,
                                'VaildPeriodType':arr.VaildPeriodType,
                                'VaildStartDate':VaildPeriodType==1?arr.VaildStartDate.substring(0, 10):'',
                                'VaildEndDate':VaildPeriodType==1?arr.VaildEndDate.substring(0, 10):'',
                                'poriedType':arr.WeekType,

                                'NoStartDate':arr.NoStartDate!=null?arr.NoStartDate.substring(0, 10):'',
                                'NoEndDate':arr.NoEndDate!=null?arr.NoEndDate.substring(0, 10):'',
                                'AccompanyCash':arr.AccompanyCash,
                                'BalanceIndex':arr.BalanceIndex,
                                'BalanceValue':arr.BalanceValue,
                                'AllowExitTicket':arr.AllowExitTicket==1?true:false,
                                'ExitPeriodValue':arr.ExitPeriodValue,
                                'ExitPeriodType':arr.ExitPeriodType,
                                'ExitTicketVal1':arr.ExitTicketType==0?arr.ExitTicketValue:'',
                                'ExitTicketVal2':arr.ExitTicketType==1?arr.ExitTicketValue:'',

                                'AllowRestrict':arr.AllowRestrict,
                                'RestrctCount':arr.RestrctCount,
                                'RestrictPeriodType':arr.RestrictPeriodType,
                                'RestrictPreiodValue':arr.RestrictPreiodValue,
                                'RestrictShareCount':arr.RestrictShareCount==1?true:false,

                            });
//
                        if(arr.BusinessType==0){
                            $('#BusinessType').val('门票')
                        }else if(arr.BusinessType==1){
                            $('#BusinessType').val('限时任玩')
                        }else if(arr.BusinessType==2){
                            $('#BusinessType').val('机台打包')
                        }
//                            $('#StartTime').val(arr.StartTimeStr);
//                            $('#EndTime').val(arr.EndTimeStr);
                            laydate.render({
                                elem: '#StartTime',type: 'time',value:arr.StartTimeStr
                            });
                            laydate.render({
                                elem: '#EndTime',type: 'time',value:arr.EndTimeStr
                            });
                            if(arr.EffactType==0){
                                $('.time1').removeClass('layui-hide');
                                $('.time2').addClass('layui-hide')
                            }else if(arr.EffactType==1){
                                $('.time2').removeClass('layui-hide');
                                $('.time1').addClass('layui-hide')
                            }
                            if(arr.Week!=null){
                                   let arrWeek= arr.Week.split('|');
                                   for(let i in arrWeek){
                                       $('#weekBox').find('input[value="'+arrWeek[i]+'"]').attr('checked',true);
                                   }
                            }
                            proListArr=arr.ProjectTicketBinds;

                             DivideType=arr.DivideType;
                             ReadFace=arr.DivideType;
                             ActiveBar=arr.ActiveBar;
                             AllowCreatePoint=arr.AllowCreatePoint;
                             SaleAuthor=arr.SaleAuthor;
                             EffactType=arr.EffactType;
                             EffactPeriodType=arr.EffactPeriodType;
                             VaildPeriodType=arr.VaildPeriodType;
                             WeekType=arr.WeekType;
                             week=arr.Week!=null?arr.Week.split('|'):[];
                             BalanceIndex=arr.BalanceIndex;
                             AllowExitTicket=arr.AllowExitTicket;
                             ExitPeriodType=arr.ExitPeriodType;
                             ExitTicketType=arr.ExitTicketType;//按金额
                            RestrictPeriodType=arr.RestrictPeriodType;
                            RestrictShareCount=arr.RestrictShareCount;
                            AllowRestrict=arr.AllowRestrict;

                            bindPro(ticketSet.name,table,arr.ProjectTicketBinds,'proTable');

                            form.render();
                        } else {
                            layer.msg(data.result_msg||data.return_msg);
                        }
                    }
                })

        }
        table.on('tool(proTable)',function (obj) {
            let data=obj.data;
            let layevent=obj.event;
            if(layevent==='del'){
                for(let i in proListArr){
                    if(proListArr[i].ProjectID==data.ProjectID){
                        proListArr.splice(i,1);
                        obj.del()
                    }
                }
            }
        });
        table.on('edit(proTable)', function(obj){ //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
            let val=obj.value;
            if(ticketSet.name=='times'||ticketSet.name=='group' ||ticketSet.name=='boardPackage'){
                for(let i in proListArr){
                    if(proListArr[i].ProjcetID==obj.data.ProjcetID){
                        if(obj.field=='UseCount'){
                            proListArr[i].WeightValue=parseInt(obj.value)*parseInt( proListArr[i].PushCoin1);
                        }
                    }
                }
            }else if(ticketSet.name=='month'||ticketSet.name=='timeLimit'){

            }
            bindPro(ticketSet.name,table,proListArr,'proTable');
        });
    });
   let saveTicketSet= function (ticketSet,layer) {
       let _obj;
        if(ticketSet.name=='times'){
             _obj={
                'id':ticketSet.id,
                'MerchID':JSON.parse(xc.getStorage('logMsg')).merchId,
                'StoreID':JSON.parse(xc.getStorage('logMsg')).storeId,
                'TicketName':$('input[name="TicketName"]').val(),
                'TicketType':0,
                'BusinessType':0,
                'AllowExitTimes':$('input[name="AllowExitTimes"]').val(),
                'WriteOffDays':$('input[name="WriteOffDays"]').val(),
                'Price':$('input[name="Price"]').val(),
                'Tax':$('input[name="Tax"]').val(),
                'DivideType':DivideType,
                'ReadFace':ReadFace,
                'ActiveBar':ActiveBar,
                'AllowCreatePoint':AllowCreatePoint,
                'SaleAuthor':SaleAuthor,

                'EffactType':EffactType,
                'EffactPeriodValue':EffactType==0?$('input[name="EffactPeriodValue"]').val():'',
                'EffactPeriodType':EffactType==0?EffactPeriodType:'',
                'VaildPeriodValue':EffactType==0?$('input[name="VaildPeriodValue"]').val():'',
                'VaildPeriodType':EffactType==0?VaildPeriodType:'',
                'VaildStartDate':EffactType==1?$('input[name="VaildStartDate"]').val():'',
                'VaildEndDate':EffactType==1?$('input[name="VaildEndDate"]').val():'',
                'WeekType':WeekType,
                'Week':week.length>0?week.sort().join('|'):'',
                'StartTime':$('input[name="StartTime"]').val(),
                'EndTime':$('input[name="EndTime"]').val(),
                'NoStartDate':$('input[name="NoStartDate"]').val(),
                'NoEndDate':$('input[name="NoEndDate"]').val(),

                'AccompanyCash':$('input[name="AccompanyCash"]').val(),
                'BalanceIndex':BalanceIndex,
                'BalanceValue':$('input[name="BalanceValue"]').val(),

                'AllowExitTicket':AllowExitTicket,
                'ExitPeriodValue':$('input[name="ExitPeriodValue"]').val(),
                'ExitPeriodType':ExitPeriodType,
                'ExitTicketType':ExitTicketType,
                'ExitTicketValue':ExitTicketType==0?$('input[name="ExitTicketVal1"]').val():$('input[name="ExitTicketVal2"]').val(),
                'ProjectTicketBinds':proListArr,
                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        }else if(ticketSet.name=='month'){
            _obj={
                'id':ticketSet.id,
                'MerchID':JSON.parse(xc.getStorage('logMsg')).merchId,
                'StoreID':JSON.parse(xc.getStorage('logMsg')).storeId,
                'TicketName':$('input[name="TicketName"]').val(),
                'TicketType':1,
                'BusinessType':0,
                'AllowExitTimes':$('input[name="AllowExitTimes"]').val(),
                'WriteOffDays':$('input[name="WriteOffDays"]').val(),
                'Price':$('input[name="Price"]').val(),
                'Tax':$('input[name="Tax"]').val(),
                'DivideType':DivideType,
                'ReadFace':ReadFace,
                'ActiveBar':ActiveBar,
                'AllowCreatePoint':AllowCreatePoint,
                'SaleAuthor':SaleAuthor,

                'EffactType':EffactType,
                'EffactPeriodValue':EffactType==0?$('input[name="EffactPeriodValue"]').val():'',
                'EffactPeriodType':EffactType==0?EffactPeriodType:'',
                'VaildPeriodValue':EffactType==0?$('input[name="VaildPeriodValue"]').val():'',
                'VaildPeriodType':EffactType==0?VaildPeriodType:'',
                'VaildStartDate':EffactType==1?$('input[name="VaildStartDate"]').val():'',
                'VaildEndDate':EffactType==1?$('input[name="VaildEndDate"]').val():'',
                'WeekType':WeekType,
                'Week':week.length>0?week.join('|'):'',
                'StartTime':$('input[name="StartTime"]').val(),
                'EndTime':$('input[name="EndTime"]').val(),
                'NoStartDate':$('input[name="NoStartDate"]').val(),
                'NoEndDate':$('input[name="NoEndDate"]').val(),

                'AccompanyCash':$('input[name="AccompanyCash"]').val(),
                'BalanceIndex':BalanceIndex,
                'BalanceValue':$('input[name="BalanceValue"]').val(),

                'AllowExitTicket':AllowExitTicket,
                'ExitPeriodValue':$('input[name="ExitPeriodValue"]').val(),
                'ExitPeriodType':ExitPeriodType,
                'ExitTicketType':ExitTicketType,
                'ExitTicketValue':ExitTicketType==0?$('input[name="ExitTicketVal1"]').val():$('input[name="ExitTicketVal2"]').val(),
                'ProjectTicketBinds':proListArr,

                'AllowRestrict':AllowRestrict,
                'RestrictShareCount':AllowRestrict==1?RestrictShareCount:'',
                'RestrictPeriodType':AllowRestrict==1?RestrictPeriodType:'',
                'RestrictPreiodValue':AllowRestrict==1?$('input[name="RestrictPreiodValue"]').val():'',
                'RestrctCount':AllowRestrict==1?$('input[name="RestrctCount"]').val():'',

                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        }else if(ticketSet.name=='group'){
            _obj={
                'id':ticketSet.id,
                'MerchID':JSON.parse(xc.getStorage('logMsg')).merchId,
                'StoreID':JSON.parse(xc.getStorage('logMsg')).storeId,
                'TicketName':$('input[name="TicketName"]').val(),
                'TicketType':2,
                'BusinessType':0,
                'AllowExitTimes':$('input[name="AllowExitTimes"]').val(),
                'WriteOffDays':$('input[name="WriteOffDays"]').val(),
                'Price':$('input[name="Price"]').val(),
                'Tax':$('input[name="Tax"]').val(),
                'DivideType':DivideType,
                'ReadFace':ReadFace,
                'ActiveBar':ActiveBar,
                'AllowCreatePoint':AllowCreatePoint,
                'SaleAuthor':SaleAuthor,

                'EffactType':EffactType,
                'EffactPeriodValue':EffactType==0?$('input[name="EffactPeriodValue"]').val():'',
                'EffactPeriodType':EffactType==0?EffactPeriodType:'',
                'VaildPeriodValue':EffactType==0?$('input[name="VaildPeriodValue"]').val():'',
                'VaildPeriodType':EffactType==0?VaildPeriodType:'',
                'VaildStartDate':EffactType==1?$('input[name="VaildStartDate"]').val():'',
                'VaildEndDate':EffactType==1?$('input[name="VaildEndDate"]').val():'',
                'WeekType':WeekType,
                'Week':week.length>0?week.join('|'):'',
                'StartTime':$('input[name="StartTime"]').val(),
                'EndTime':$('input[name="EndTime"]').val(),
                'NoStartDate':$('input[name="NoStartDate"]').val(),
                'NoEndDate':$('input[name="NoEndDate"]').val(),

                'AccompanyCash':$('input[name="AccompanyCash"]').val(),
                'BalanceIndex':BalanceIndex,
                'BalanceValue':$('input[name="BalanceValue"]').val(),

                'AllowExitTicket':AllowExitTicket,
                'ExitPeriodValue':$('input[name="ExitPeriodValue"]').val(),
                'ExitPeriodType':ExitPeriodType,
                'ExitTicketType':ExitTicketType,
                'ExitTicketValue':ExitTicketType==0?$('input[name="ExitTicketVal1"]').val():$('input[name="ExitTicketVal2"]').val(),
                'ProjectTicketBinds':proListArr,

                'GroupStartupCount':$('input[name="GroupStartupCount"]').val(),
                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        }else if(ticketSet.name=='timeLimit'){
            _obj={
                'id':ticketSet.id,
                'MerchID':JSON.parse(xc.getStorage('logMsg')).merchId,
                'StoreID':JSON.parse(xc.getStorage('logMsg')).storeId,
                'TicketName':$('input[name="TicketName"]').val(),
                'TicketType':1,
                'BusinessType':1,
//                'AllowExitTimes':$('input[name="AllowExitTimes"]').val(),
                'WriteOffDays':$('input[name="WriteOffDays"]').val(),
                'Price':$('input[name="Price"]').val(),
                'Tax':$('input[name="Tax"]').val(),
//                'DivideType':DivideType,
//                'ReadFace':ReadFace,
                'ActiveBar':ActiveBar,
                'AllowCreatePoint':AllowCreatePoint,
                'SaleAuthor':SaleAuthor,

                'EffactType':EffactType,
                'EffactPeriodValue':EffactType==0?$('input[name="EffactPeriodValue"]').val():'',
                'EffactPeriodType':EffactType==0?EffactPeriodType:'',
                'VaildPeriodValue':EffactType==0?$('input[name="VaildPeriodValue"]').val():'',
                'VaildPeriodType':EffactType==0?VaildPeriodType:'',
                'VaildStartDate':EffactType==1?$('input[name="VaildStartDate"]').val():'',
                'VaildEndDate':EffactType==1?$('input[name="VaildEndDate"]').val():'',
                'WeekType':WeekType,
                'Week':week.length>0?week.join('|'):'',
                'StartTime':$('input[name="StartTime"]').val(),
                'EndTime':$('input[name="EndTime"]').val(),
                'NoStartDate':$('input[name="NoStartDate"]').val(),
                'NoEndDate':$('input[name="NoEndDate"]').val(),
//
//                'AccompanyCash':$('input[name="AccompanyCash"]').val(),
//                'BalanceIndex':BalanceIndex,
//                'BalanceValue':$('input[name="BalanceValue"]').val(),

                'AllowExitTicket':AllowExitTicket,
                'ExitPeriodValue':$('input[name="ExitPeriodValue"]').val(),
                'ExitPeriodType':ExitPeriodType,
                'ExitTicketType':ExitTicketType,
                'ExitTicketValue':ExitTicketType==0?$('input[name="ExitTicketVal1"]').val():$('input[name="ExitTicketVal2"]').val(),
                'ProjectTicketBinds':proListArr,

                'AllowRestrict':AllowRestrict,
                'RestrictShareCount':AllowRestrict==1?RestrictShareCount:'',
                'RestrictPeriodType':AllowRestrict==1?RestrictPeriodType:'',
                'RestrictPreiodValue':AllowRestrict==1?$('input[name="RestrictPreiodValue"]').val():'',
                'RestrctCount':AllowRestrict==1?$('input[name="RestrctCount"]').val():'',


                // 'GroupStartupCount':$('input[name="GroupStartupCount"]').val(),
                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        }else if(ticketSet.name=='boardPackage'){
            _obj={
                'id':ticketSet.id,
                'MerchID':JSON.parse(xc.getStorage('logMsg')).merchId,
                'StoreID':JSON.parse(xc.getStorage('logMsg')).storeId,
                'TicketName':$('input[name="TicketName"]').val(),
                'TicketType':0,
                'BusinessType':2,
//                'AllowExitTimes':$('input[name="AllowExitTimes"]').val(),
                'WriteOffDays':$('input[name="WriteOffDays"]').val(),
                'Price':$('input[name="Price"]').val(),
                'Tax':$('input[name="Tax"]').val(),
//                'DivideType':DivideType,
//                'ReadFace':ReadFace,
                'ActiveBar':ActiveBar,
                'AllowCreatePoint':AllowCreatePoint,
                'SaleAuthor':SaleAuthor,

                'EffactType':EffactType,
                'EffactPeriodValue':EffactType==0?$('input[name="EffactPeriodValue"]').val():'',
                'EffactPeriodType':EffactType==0?EffactPeriodType:'',
                'VaildPeriodValue':EffactType==0?$('input[name="VaildPeriodValue"]').val():'',
                'VaildPeriodType':EffactType==0?VaildPeriodType:'',
                'VaildStartDate':EffactType==1?$('input[name="VaildStartDate"]').val():'',
                'VaildEndDate':EffactType==1?$('input[name="VaildEndDate"]').val():'',
                'WeekType':WeekType,
                'Week':week.length>0?week.join('|'):'',
                'StartTime':$('input[name="StartTime"]').val(),
                'EndTime':$('input[name="EndTime"]').val(),
                'NoStartDate':$('input[name="NoStartDate"]').val(),
                'NoEndDate':$('input[name="NoEndDate"]').val(),

//                'AccompanyCash':$('input[name="AccompanyCash"]').val(),
//                'BalanceIndex':BalanceIndex,
//                'BalanceValue':$('input[name="BalanceValue"]').val(),

                'AllowExitTicket':AllowExitTicket,
                'ExitPeriodValue':$('input[name="ExitPeriodValue"]').val(),
                'ExitPeriodType':ExitPeriodType,
                'ExitTicketType':ExitTicketType,
                'ExitTicketValue':ExitTicketType==0?$('input[name="ExitTicketVal1"]').val():$('input[name="ExitTicketVal2"]').val(),
                'ProjectTicketBinds':proListArr,

                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        }
       let parseJson = JSON.stringify(_obj);
       $.ajax({
           type:'post',
           url:'/XCCloud/ProjectTicket?action=SaveProjectTicket',
           contentType: "application/json; charset=utf-8",
           data:{parasJson: parseJson},
           success: function (data) {
               data = JSON.parse(data);
               if (data.result_code == 1) {
                   layer.msg('设置成功',{time:1500},function () {
                       layer.closeAll();
                       parent.location.reload()
                   })
               } else {
                   layer.msg(data.result_msg||data.return_msg);
               }
           }
       })
    };
   function bindPro(type,table,datas,id) {
       let _cols=[];
       if(type=='times'||type=='group' ||type=='boardPackage'){
           _cols=[
               {field:'ProjectName', title:'项目名称', align: 'center',width:200}
               ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
               ,{field:'AllowShareCount', title: '次数共享', align: 'center',width:100,templet:'#allowShare'}
               ,{field:'UseCount', title: '游玩次数', align: 'center',width:140,edit:true}
               ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
               ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]
       }else if(type=='month'||type=='timeLimit'){
           _cols=[
               {field:'ProjectName', title:'项目名称', align: 'center',width:200}
               ,{field:'ProjcetTypeStr',title: '类别', align: 'center',width:160} //width 支持：数字、百分比和不填写。
//               ,{field:'UseCount', title: '游玩次数', align: 'center',width:140,edit:true}
               ,{field:'WeightValue', title: '权重值', align: 'center',width:175,edit:true}
               ,{fixed: 'right',title:'操作', width:180, align:'center', toolbar: '#barDemo2'}]
       }
       table.render({
           elem: '#'+id
           , height:'250px'
           , size:"sm"
           , data: datas
           , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
           , cols: [_cols]
           , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
           , limit: 10
       });
   }

   function generatelD(str) {
       var pad='00';
       return pad.substring(0,2-str.length)+str
   }

    function initProject(token,form,layer,id,businessType){
        let _obj={'businessType':businessType,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
        let parseJson = JSON.stringify(_obj);
        $.ajax({
            type:'post',
            url:'/XCCloud/ProjectTicket?action=GetProjectGameInfoList',
            contentType: "application/json; charset=utf-8",
            data:{parasJson: parseJson},
            success: function (data) {
                data = JSON.parse(data);
                if (data.result_code == 1) {
                    let arr=data.result_data;
                    $('#'+id).html('<option>-请选择-</option>');
                    for(let i in arr){
                        $('#'+id).append('<option value="'+arr[i].ProjectID+'" ' +
                                'title="'+arr[i].ProjcetType+'|'+arr[i].ProjcetTypeStr+'|'+arr[i].PushCoin1+'">'+arr[i].ProjectName+'</option>')
                    }
                    form.render();
                } else {
                    layer.msg(data.result_msg);
                }
            }
        });
    }
</script>
<script type="text/html"   id="barDemo2">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"><i class="layui-icon">&#xe640;</i>删除</a>
</script>
<script type="text/html" id="allowShare">
    {{# if(d.AllowShareCount==1){ }}
    <div style="width: 42px;height: 20px;line-height: 20px;background-color:#5FB878;border-radius: 11px;position: relative;">
        <em style="left: 5px;position: absolute;width: 25px;color: #fff;font-size: 10px">是</em>
        <i style="left: 32px;position: absolute;width: 16px;height: 16px;border-radius: 50%;"></i></div>
    {{# }else{ }}
    <div style="width: 42px;height: 20px;line-height: 20px;background-color:red;border-radius: 11px;position: relative;">
        <em style="left: 5px;position: absolute;width: 25px;color: #fff;font-size: 10px">否</em>
        <i style="left: 32px;position: absolute;width: 16px;height: 16px;border-radius: 50%;"></i></div>
    {{#  } }}
</script>
</html>