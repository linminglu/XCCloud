<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>会员档案查询</title>
    <link rel="stylesheet" href="../layui/css/layui.css">
    <link rel="stylesheet" href="../css/myxc.css">
</head>
<style>
    .a_line {
        display: inline-block;
        width: 100%;
        height: 100%;
        line-height: 100%;
    }

    .a_line:hover {
        text-decoration: underline;
    !important;
        color: red;
    }
</style>
<body>
<div class="layui-row reportPage">
    <div class="row-box">
        <div class="layui-col-md12 layui-col-sm12 layui-col-lg12">
            <blockquote class="layui-elem-quote layui-col-md12 layui-col-sm12 layui-col-lg12">
                <div class="layui-form layui-form-pane layui-col-md9" id="form1">
                    <div class="layui-form-item" id="serchMode"></div>
                </div>

                <div class="layui-col-md2" id="form2Box" style="">
                    <div class="layui-form layui-form-pane" id="form2" style="">
                        <div id="tantion" class="layui-form-item">
                        </div>
                    </div>
                </div>

                <button type="button" class="layui-btn layui-btn-normal layui-col-md1" i18n-content="查询模板"
                        id="searchBtn">查询
                </button>
            </blockquote>
        </div>
        <div class="layui-col-md12 layui-col-sm12 layui-col-lg12">
            <table class="layui-hide" lay-filter="mFileSearchTable" id="mFileSearchTable"></table>
        </div>
    </div>
</div>

<!--//挖掘会员卡详细信息-->
<div id="openModel" style="display: none">
    <form action="" id="memberInfo" lay-filter="memberInfo" class="layui-form layui-form-pane">
        <div class="layui-tab">
            <ul class="layui-tab-title">
                <li class="layui-this">会员信息</li>
                <li>销售记录</li>
                <li>游玩记录</li>
                <li>兑换记录</li>
                <li>门票信息</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <div class="layui-col-md12">
                        <div class="layui-col-md10">
                            <div class="layui-col-md12">
                                <div class="layui-card">
                                    <div class="layui-card-body">
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">会员姓名</label>
                                                <div class="layui-input-inline">
                                                    <input type="text" name="userName" class="layui-input" readonly>
                                                </div>
                                            </div>
                                            <div class="layui-inline">
                                                <label class="layui-form-label">生日</label>
                                                <div class="layui-input-inline">
                                                    <input type="text" name="birthday" class="layui-input" readonly>
                                                </div>
                                            </div>
                                            <div class="layui-inline" style="margin-right: 0;">
                                                <label class="layui-form-label">性别</label>
                                                <div class="layui-input-inline" style="margin-right: 0;">
                                                    <input type="text" name="gender" class="layui-input" readonly>
                                                </div>
                                            </div>
                                            <div class="layui-inline">
                                                <label class="layui-form-label">手机</label>
                                                <div class="layui-input-inline">
                                                    <input type="text" name="phone" class="layui-input" readonly>
                                                </div>
                                            </div>
                                            <div class="layui-inline">
                                                <label class="layui-form-label">证件号码</label>
                                                <div class="layui-input-inline">
                                                    <input type="text" name="IDCard" class="layui-input" readonly>
                                                </div>
                                            </div>
                                            <div class="layui-inline" style="margin-right: 0;">
                                                <label class="layui-form-label">微信</label>
                                                <div class="layui-input-inline" style="margin-right: 0;">
                                                    <input type="text" name="weChart" class="layui-input" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md12">
                                <div class="layui-card">
                                    <div class="layui-card-body">
                                        <div class="layui-form-item">
                                            <div class="layui-inline lay-bit">
                                                <label class="layui-form-label">允许投退币</label>
                                                <div class="layui-input-inline">
                                                    <input type="radio" name="allowExit" value="1" title="允许">
                                                    <input type="radio" name="allowExit" value="0" title="禁止" checked>
                                                </div>
                                            </div>
                                            <div class="layui-inline lay-bit">
                                                <label class="layui-form-label">允许兑币</label>
                                                <div class="layui-input-inline">
                                                    <input type="radio" name="exchangeCoin" value="1" title="允许">
                                                    <input type="radio" name="exchangeCoin" value="0" title="禁止"
                                                           checked>
                                                </div>
                                            </div>
                                            <div class="layui-inline lay-bit" style="margin-right: 0;">
                                                <label class="layui-form-label">允许购买实物币</label>
                                                <div class="layui-input-inline" style="margin-right: 0;">
                                                    <input type="radio" name="buyCoin" value="1" title="允许">
                                                    <input type="radio" name="buyCoin" value="0" title="禁止" checked>
                                                </div>
                                            </div>
                                            <div class="layui-inline lay-bit">
                                                <label class="layui-form-label" style="padding: 8px 0">允许手工存币</label>
                                                <div class="layui-input-inline">
                                                    <input type="radio" name="saveByHand" value="1" title="允许">
                                                    <input type="radio" name="saveByHand" value="0" title="禁止" checked>
                                                </div>
                                            </div>
                                            <div class="layui-inline lay-bit">
                                                <label class="layui-form-label">允许手工送币</label>
                                                <div class="layui-input-inline">
                                                    <input type="radio" name="sendByHand" value="1" title="允许">
                                                    <input type="radio" name="sendByHand" value="0" title="禁止" checked>
                                                </div>
                                            </div>
                                            <div class="layui-inline lay-bit" style="margin-right: 0;">
                                                <label class="layui-form-label">卡状态</label>
                                                <div class="layui-input-inline" style="margin-right: 0;">
                                                    <input type="radio" name="cardStatus" value="1" title="允许">
                                                    <input type="radio" name="cardStatus" value="0" title="禁止" checked>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-col-md2">
                            <img src="" alt="">
                        </div>
                    </div>


                    <div class="layui-col-md6">
                        <div class="layui-card">
                            <div class="layui-card-body">
                                <table class="layui-hide" id="balanceTable" lay-filter="balanceTable"></table>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-card">
                            <div class="layui-card-body">
                                <div class="layui-tab" id="cardInfoTab">
                                    <ul class="layui-tab-title">
                                        <li class="layui-this">主卡信息</li>
                                    </ul>
                                    <div class="layui-tab-content">
                                        <div class="layui-tab-item layui-show">
                                            <div class="layui-form-item">
                                                <label class="layui-form-label">卡号</label>
                                                <div class="layui-input-block">
                                                    <input type="text" class="layui-input" name="cardNo" readonly>
                                                </div>
                                            </div>
                                            <div class="layui-form-item">
                                                <label class="layui-form-label">等级</label>
                                                <div class="layui-input-block">
                                                    <input type="text" class="layui-input" name="cardLevel" readonly>
                                                </div>
                                            </div>
                                            <div class="layui-form-item">
                                                <label class="layui-form-label">押金</label>
                                                <div class="layui-input-block">
                                                    <input type="text" class="layui-input" name="cardDeposit" readonly>
                                                </div>
                                            </div>
                                            <div class="layui-form-item">
                                                <label class="layui-form-label">有效期</label>
                                                <div class="layui-input-block">
                                                    <input type="text" class="layui-input" name="cardValueTime"
                                                           readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
                <div class="layui-tab-item">内容2</div>
                <div class="layui-tab-item">内容3</div>
                <div class="layui-tab-item">内容4</div>
                <div class="layui-tab-item">内容5</div>
            </div>
        </div>
    </form>
</div>
<!--挖掘会员卡押金信息-->
<div id="openDeposit" style="display: none;padding: 15px">
    <table class="layui-hide" id="depositTable" lay-filter="depositTable"></table>
</div>
</body>
<script src="../js/jquery-1.8.3-min.js"></script>
<script src="../layui/layui.js"></script>
<script src="../js/storeSystem.js"></script>
<script src="../js/searchModel.js"></script>
<script>
    let xc = xcActionSystem.prototype;
    let token = xc.getStorage('token');
    let Id = '';
    //初始化table
    let parm = {
        'obj': {'conditions': [], 'userToken': token, 'signkey': '1f626576304bf5d95b72ece2222e42c3'},
        'url': '/XCCloud/MemberManage?action=QueryMemberInfo',
        'elem': '#mFileSearchTable',
        'cols': [{field:'ID',title:'id',align:'center'}
            ,{
                field: 'ICCardID', title: '会员卡号', align: 'center', sort: true, templet: function (d) {
                    return '<a href="javascript:void(0);" class="a_line aCardID">' + d.ICCardID + '</a>'
                }
            }
            , {field: 'CardName', title: '会员姓名', align: 'center'}
            , {field: 'MemberLevelName', title: '会员级别', align: 'center'}
            , {field: 'CardType', title: '卡类别', align: 'center', templet: '#_cardType'}
            , {
                field: 'Deposit', title: '押金', align: 'center', templet: function (d) {
                    return '<a href="javascript:void(0);" class="a_line memberDeposit">' + d.Deposit + '</a>'
                }
            }
            , {field: 'UpdateTime', title: '余额最后跟新时间', align: 'center'}
            , {field: 'EndDate', title: '过期日期', align: 'center'}
            , {
                field: 'CardSex', title: '性别', align: 'center', templet: function (d) {
                    if (d.CardSex == 0) {
                        return '男'
                    } else {
                        return '女'
                    }
                }
            }
            , {field: 'Mobile', title: '手机号码', align: 'center'}
            , {field: 'IDCard', title: '身份证', align: 'center'}
            , {field: 'CreateTime', title: '入会日期', align: 'center'}
            , {field: 'StoreName', title: '开卡门店', align: 'center'}
            , {
                field: 'CardStatus', title: '状态', align: 'center', templet: function (d) {
                    if (d.CardStatus == 1) {
                        return '正常'
                    } else {
                        return '禁用'
                    }
                }
            }
        ]
    };
    //100016360103001
    xc.getActiveTable(parm);
    layui.use(['form', 'layer', 'table', 'laydate', 'element'], function () {
        let form = layui.form;
        let layer = layui.layer;
        let table = layui.table;
        let laydate = layui.laydate;
        let element = layui.element;
        seachModel({
            'elem1': 'tantion',
            'elem2': 'serchMode',
            'pagename': 'memberInfoSearch',
            'processname': 'memberInfoSearch',
            'token': token,
            'form': form,
            'layer': layer,
            'searchBtn': 'searchBtn',
            'xc': xc,
            'parm': parm,
            'laydate': laydate,
            'active': ''
        });
        //根据会员卡号来查询会员详细信息
        $('.aCardID').on('click', function () {

            let _cardId = $(this).text();
            let obj = {icCardId: _cardId, userToken: token, sysId: '0', versionNo: '0.01'};
            let parseJson = JSON.stringify(obj);
            $.ajax({
                type: 'post',
                url: '/XCCloud/Member?action=getMenberCardInfoByICCardId',
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parseJson},
                success: function (data) {
                    data = JSON.parse(data);
                    console.log(data);
                    if (data.result_code == 1) {
                        let arr = data.result_data;
                        //初始化：会员基本信息、权限要求、主卡信息
                        form.val('memberInfo', {
                            'userName': arr.MemberInfo.UserName,
                            'birthday': arr.MemberInfo.Birthday,
                            'gender': arr.MemberInfo.Gender == 1 ? '女' : '男',
                            'phone': arr.MemberInfo.Mobile,
                            'IDCard': arr.MemberInfo.IDCardNo,
                            'cardNo': arr.ICCardId,
                            'cardLevel': arr.LevelName,
                            'cardDeposit': arr.Deposit,
                            'cardValueTime': arr.EndDate
                        });
                        //初始化：余额表格信息
                        table.render({
                            cols: [[
                                {field: 'BalanceName', title: '余额类别', align: 'center', rowspan: 2, width: 164},
                                {title: '余额', align: 'center', colspan: 3}],
                                [
                                    {field: 'Balance', title: '正价', align: 'center', width: 130}
                                    , {field: 'BalanceFree', title: '赠送', align: 'center', width: 130}
                                    , {field: 'TotalBalance', title: '总计', align: 'center', width: 130}
                                ]
                            ],
                            elem: '#balanceTable',
                            height: '260',
                            data: arr.MemberBalances
                        })
                        layer.open({
                            title: '信息',
                            type: 1,
                            area: '1200px',
                            content: $('#openModel')
                        })
                        //动态加载副卡信息
                        if (arr.ChildCardList.length > 0) {
                            for (let i in arr.ChildCardList) {
                                $('#cardInfoTab ul').append('<li>附属卡' + (i + 1) + '</li>>');
                                $('#cardInfoTab div.layui-tab-content').append('<div class="layui-tab-item">' +
                                    '</div>')
                            }
                        }
                    } else {
                        layer.msg(data.result_msg || data.return_msg);
                    }
                }
            })
        });

        //查询押金明细
        $('.memberDeposit').on('click', function () {
            let _cardId = $(this).parents('tr').children()[0].getElementsByClassName('layui-table-cell')[0].innerHTML;
            let obj = {id: _cardId, userToken: token, signkey: '1f626576304bf5d95b72ece2222e42c3'};
            let parseJson = JSON.stringify(obj);
            $.ajax({
                type: 'post',
                url: '/XCCloud/MemberManage?action=QueryMemberDepositInfo',
                contentType: "application/json; charset=utf-8",
                data: {parasJson: parseJson},
                success: function (data) {
                    data = JSON.parse(data);
                    // console.log(data);
                    if (data.result_code == 1) {
                        let arr = data.result_data;

                        //初始化：押金明细信息
                        table.render({
                            cols: [[
                                {field: 'ICCardID', title: '会员卡号', align: 'center',width:160},
                                {field: 'CardType', title: '卡类别', align: 'center',width:160},
                                {field: 'Deposit', title: '卡押金', align: 'center',width:160},
                                {field: 'CardName', title: '姓名', align: 'center',width:160},
                                {field: 'CardBirthday', title: '生日', align: 'center',width:160},
                                {field: 'CardSex', title: '性别', align: 'center',width:145}
                            ]
                            ],
                            elem: '#depositTable',
                            cellMinWidth:145,
                            data: arr
                            , skin: 'line'
                            , page: {page: true, limits: [10, 15, 20]}
                            , limit: 10
                        })
                        layer.open({
                            title: '押金明细',
                            type: 1,
                            area: '1000px',
                            content: $('#openDeposit')
                        })
                    } else {
                        layer.msg(data.result_msg || data.return_msg);
                    }
                }
            })
        });

        //查询卡类别明细

    })
</script>
</html>