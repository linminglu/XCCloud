<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>返还规则设置</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<body>
<div class="layui-row" style="padding: 15px">
    <blockquote class="layui-elem-quote" style="text-align: right;padding-right: 100px;">
        <!--<button type="button" class="layui-btn layui-btn-normal">查询模板</button>-->
        <button type="button" class="layui-btn layui-btn-normal add">新增</button>
    </blockquote>
    <div class="layui-col-md12 layui-col-lg12 layui-col-sm12">
        <table class="layui-hide" id="giveBackRuleTb"  lay-filter="giveBackRuleTb"></table>
    </div>
</div>
<div id="openModel" style="display: none;padding: 15px">
    <form action="" class="layui-form layui-form-pane goodIsAll">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">会员级别</label>
                <div class="layui-input-inline">
                    <select  id="memberLevel" lay-filter="memberLevel">

                    </select>
                </div>
            </div>
            <div class="layui-inline" style="margin-left: 10px;">
                <label class="layui-form-label">返还累计天数</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="totalDays">
                </div>
                <div class="layui-form-mid">填0表示仅当天有效</div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline ">
                <label  class="layui-form-label">返还方式</label>
                <div class="layui-input-inline">
                    <input type="checkbox" checked lay-skin="switch" id="Backtype" lay-filter="Backtype" lay-text="按自然日期|按营业日期">
                </div>
            </div>
            <div class="layui-inline " style="margin-left: 10px;">
                <label  class="layui-form-label">统计方式</label>
                <div class="layui-input-inline">
                    <input type="checkbox" checked lay-skin="switch" id="AllowContainToday" lay-filter="AllowContainToday" lay-text="包含当天|不包含当天">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label  class="layui-form-label">输币期间</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="backMin">
                </div>
                <div class="layui-form-mid">至</div>
                <div class="layui-input-inline">
                     <input type="text" class="layui-input" id="backMax">
                </div>

            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">返还比例</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="backScale">
                    <span class="layui-unit">%</span>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline" >
                <label  class="layui-form-label">返还卡少于</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="exitCardMin">
                </div>
                <div class="layui-form-mid">币不能退卡(返还到会员卡时无效)</div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline goodIsAll">
                <label  class="layui-form-label" style="padding: 8px 0;">是否扣除返还币</label>
                <div class="layui-input-inline">
                    <input type="checkbox" checked lay-skin="switch" id="AllowBackPrincipal" lay-filter="AllowBackPrincipal" lay-text="是|否">
                </div>
            </div>
        </div>
        <div style="text-align:center;margin: 15px 0">
            <button id="save" class="layui-btn layui-btn-normal" type="button">确定</button>
        </div>
    </form>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="edit"> <i class="layui-icon">&#xe642;</i>修改</a>
</script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');

    let _id;
    let memberLevel='';let memberLevelStr='';
    let Backtype=1;let AllowBackPrincipal=1;let AllowContainToday=1;

    let parm={'obj':{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
        'url':'/XCCloud/Parameter?action=GetGivebackRules',
        'elem':'#giveBackRuleTb',
        'cols':[
            {field:'ID', title:'规则ID', align: 'center', sort: true,width:80},
            {field:'MemberLevelName',title: '会员级别', align: 'center'}
            ,{field:'BackMin', title: '最小币数', align: 'center'}
            ,{field:'BackMax', title: '最大币数', align: 'center'}
            ,{field:'BackScale', title: '返还比例', align: 'center',templet:'#changeLock',width:140}
            ,{field:'ExitCardMin', title: '退卡时最小币数', align: 'center'}
            ,{field:'AllowBackPrincipal', title: '是否扣除返还币', align: 'center',templet:'#desale'}
            ,{field:'Backtype', title: '返还计算方式', align: 'center',templet:'#backType1'}
            ,{field:'TotalDays', title: '累计天数', align: 'center'}
            ,{field:'AllowContainToday', title: '是否统计当天', align: 'center',templet:'#countToday'}
            ,{fixed: 'right', title: '操作', width:90, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);

    layui.use(['form','table','layer'],()=>{
        let table=layui.table;
        let form=layui.form;
        form.on('select(memberLevel)',function (data) {
            memberLevel=data.value=='-请选择-'?'':data.value;
            memberLevelStr=data.elem[data.elem.selectedIndex].text;
        });
        form.on('switch(AllowBackPrincipal)',function (data) {
            if(data.elem.checked==true){
                AllowBackPrincipal=1;
            }else {
                AllowBackPrincipal=0;
            }
        });
        form.on('switch(AllowContainToday)',function (data) {
            if(data.elem.checked==true){
                AllowContainToday=1;
            }else {
                AllowContainToday=0;
            }
        });
        form.on('switch(Backtype)',function (data) {
            if(data.elem.checked==true){
                Backtype=1;
            }else {
                Backtype=0;
            }
        });
        //新增返还规则
        $('.add').on('click',function () {
            _id='';
           memberLevel=''; memberLevelStr='';
           Backtype=1;
           AllowBackPrincipal=1;
           AllowContainToday=1;
           xc.getMemberTypeDic(token,layer,form,'memberLevel');
            layui.layer.open({
                title:'新增返还规则',
                type:1,
                area:'910px',
                content:$('#openModel'),
                cancel:function () {
                    location.reload();
                }
            })
        });
        //保存返还规则
       $('#save').on('click',()=>{
           let obj={'id':_id,
               'memberLvlId':memberLevel,
               'backMin':$('#backMin').val(),
               'backMax':$('#backMax').val(),
               'backScale':$('#backScale').val(),
               'exitCardMin':$('#exitCardMin').val(),
               'allowBackPrincipal':AllowBackPrincipal,
               'backType':Backtype,
               'totalDays':$('#totalDays').val(),
               'allowContainToday':AllowContainToday,
               'userToken':token,
               'signkey':'1f626576304bf5d95b72ece2222e42c3'};
           var parasJson = JSON.stringify(obj);
           $.ajax({
               type: "post",
               url: '/XCCloud/Parameter?action=SaveGivebackRule',
               contentType: "application/json; charset=utf-8",
               data: { parasJson: parasJson },
               success: function (data) {
                   data=JSON.parse(data);
                   if(data.result_code==1){
                       layer.msg('保存成功',{time:500},function () {
                           location.href='giveBackRule.html'
                       })
                   }else {
                       layer.msg(data.result_msg||data.return_msg);
                   }
               }
           })
        });
        table.on('tool(giveBackRuleTb)',function (obj) {
             let data=obj.data;
             let layevent=obj.event;
             _id=data.ID;
             if(layevent==='edit'){
                     memberLevel=data.MemberLevelID;
                     xc.getMemberTypeDic(token,layer,form,'memberLevel',data.MemberLevelID);
                     $('#backMin').val(data.BackMin);
                     $('#backMax').val(data.BackMax);
                     $('#backScale').val(data.BackScale);
                     $('#exitCardMin').val(data.ExitCardMin);
                     AllowBackPrincipal=data.AllowBackPrincipal;
                     if(data.AllowBackPrincipal==1){
                         $('#AllowBackPrincipal').attr('checked',true)
                     }else {
                         $('#AllowBackPrincipal').attr('checked',false)
                     }
                     Backtype=data.Backtype;
                     if(data.Backtype==1){
                         $('#Backtype').attr('checked',true)
                     }else {
                         $('#Backtype').attr('checked',false)
                     }
                     $('#totalDays').val(data.TotalDays);
                     AllowContainToday=data.AllowContainToday;
                     if(data.AllowContainToday==1){
                         $('#AllowContainToday').attr('checked',true)
                     }else {
                         $('#AllowContainToday').attr('checked',false)
                     }
                     form.render()
                 layui.layer.open({
                     title:'修改返还规则',
                     type:1,
                     area:'900px',
                     content:$('#openModel'),
                     cancel:function () {
                         location.reload();
                     }
                 })
             }
        })
    })
</script>
<script type="text/html" id="countToday">
    {{# if(d.AllowContainToday==1){ }}
     是
    {{# }else{ }}
   否
    {{#  } }}
</script>
<script type="text/html" id="desale">
    {{# if(d.AllowBackPrincipal==1){ }}
    是
    {{# }else{ }}
    否
    {{#  } }}
</script>
<script type="text/html" id="backType1">
    {{# if(d.Backtype==1){ }}
    按自然日期
    {{# }else{ }}
    按营业日期
    {{#  } }}
</script>
</html>