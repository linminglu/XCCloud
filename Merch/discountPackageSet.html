<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>优惠套餐设定</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<style>
    .iframeBox{height: 100%;}
    .iframeBox .layui-tab-item{position: absolute;top:65px;left: 0;right: 0;bottom: 0;}
    .iframeBox iframe{border: none;min-width: 400px;}
    /*.layui-form-onswitch{*/
        /*border-color: #5FB878!important;*/
        /*background-color: #5FB878!important;*/
    /*}*/
    /*.layui-form-switch{*/
        /*height: 22px;*/
        /*line-height: 22px;*/
        /*width: 42px;*/
        /*border: 1px solid #d2d2d2;*/
        /*border-radius: 20px;*/
        /*background-color: #fff;*/
    /*}*/
    /*.layui-form-switch em{*/
        /*width: 25px;*/
        /*color: #999!important;*/
        /*font-size: 12px;}*/

    /*.layui-form-switch i{*/
        /*left: 5px;*/
        /*top: 3px;*/
        /*width: 16px;*/
        /*height: 16px;*/
        /*border-radius: 20px;*/
        /*background-color: #d2d2d2;*/
    /*}*/
    /*.layui-form-onswitch i{*/
        /*left: 32px;*/
    /*}*/

    /*.goodIsAll .layui-form-switch {*/
        /*height: 36px;*/
        /*line-height: 36px;*/
        /*width: 180px;*/
        /*border-radius: 5px;*/
        /*border: 1px solid #orangered;*/
        /*background-color: #999;*/
    /*}*/

    /*.goodIsAll .layui-form-switch i {*/
        /*left: 0px;*/
        /*top: 0px;*/
        /*width: 95px;*/
        /*height: 36px;*/
        /*margin-top: -1px;*/
        /*border-radius: 5px 0 0 5px;*/
        /*border: 1px solid #aaa;*/
        /*background-color: #fff;*/
    /*}*/

    /*.goodIsAll  .layui-form-switch em {*/
        /*width: 80px;*/
        /*color: #ffffff!important;*/
        /*font-size: 14px;*/
    /*}*/

    /*.goodIsAll .layui-form-onswitch {*/
        /*border-color: #1e9fff!important;*/
        /*background-color: #1e9fff!important;*/
    /*}*/

    /*.goodIsAll  .layui-form-onswitch i {*/
        /*left: 95px;*/
        /*border-radius: 0 5px 5px 0;*/
        /*border: 1px solid #aaa;*/
        /*margin-top: -1px;*/
    /*}*/


</style>
<style>
    .layui-form-pane .layui-inline .layui-form-label{padding: 8px 0;}
    #test2{width: 300px;height: 170px;margin: 40px auto;border: 1px solid #8D8D8D;position: relative;}
    #imgBtn{width: 60px;height: 60px;position: absolute;top: 55px;left: 130px;cursor: pointer;}
    .imgBox button{position: absolute;top: 15px;right: 15px;}
    .imgBox button i {font-size: 24px;color: red;}
    #timeTypeSetBox .layui-input-inline,#timeTypeSetBox .layui-form-label{width: 90px;}
</style>
<body>
   <div class="layui-row">
       <blockquote class="layui-elem-quote" style="text-align: right">
           <button type="button" class="layui-btn layui-btn-normal">查询模板</button>
           <button type="button" class="layui-btn layui-btn-normal addNewPackage">新增套餐</button>
       </blockquote>
       <div class="layui-col-md12 layui-col-lg12 layui-col-sm12">
           <table class="layui-hide" id="digitDestroyTb"  lay-filter="digitDestroyTb"></table>
       </div>
   </div>
<!--新增弹窗-->
<div id="openModel" style="display: none;padding: 10px;">
    <form action="" class="layui-form layui-form-pane">
        <div class="layui-collapse" lay-accordion>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title" style="height: 36px;line-height: 36px">基本设置</h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">套餐名称</label>
                            <div class="layui-input-inline">
                                <input name="" id="FoodName" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">套餐类别</label>
                            <div class="layui-input-inline">
                                <select id="FoodType" lay-filter="FoodType" ></select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" >有效期</label>
                            <div class="layui-input-inline" style="width: 100px">
                                <input type="text" class="layui-input" id="StartTime">
                            </div>
                            <div class="layui-form-mid">至</div>
                            <div class="layui-input-inline" style="width: 100px">
                                <input type="text" class="layui-input" id="EndTime">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" >散客价</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="ClientPrice">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" >会员价</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="MemberPrice">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" >会员卡续期日期</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="RenewDays" placeholder="0为不处理">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item goodIsAll">
                        <div class="layui-inline">
                            <label class="layui-form-label">默认打印凭条</label>
                            <div class="layui-input-inline" style="height: 36px;border: 1px solid rgb(230,230,230)">
                                <input type="checkbox" id="AllowPrint" name="open" lay-skin="switch" lay-filter="AllowPrint" lay-text="允许|禁止">
                            </div>
                        </div>
                        <div class="layui-inline goodIsAll">
                            <label class="layui-form-label">需要授权</label>
                            <div class="layui-input-inline" style="height: 36px;border: 1px solid rgb(230,230,230)">
                                <input type="checkbox" id="ForeAuthorize" name="open" lay-skin="switch" lay-filter="ForeAuthorize" lay-text="允许|禁止">
                            </div>
                        </div>
                        <div class="layui-inline goodIsAll">
                            <label class="layui-form-label">是否允许第三方</label>
                            <div class="layui-input-inline" style="height: 36px;border: 1px solid rgb(230,230,230)">
                                <input type="checkbox" id="AllowInternet" name="open" lay-skin="switch" lay-filter="AllowInternet" lay-text="允许|禁止">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item layui-hide" id="otherShow">
                        <div class="layui-inline">
                            <label class="layui-form-label" >美团ID</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="MeituanID">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" >点评ID</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="DianpinID">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label" >口碑ID</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="KoubeiID">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title" style="height: 36px;line-height: 36px">图片</h2>
                <div class="layui-colla-content" style="height: 280px;">
                        <div class="layui-col-md8">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label">余额类别</label>
                                    <div class="layui-input-inline">
                                        <select name="" id="BalanceType" lay-filter="BalanceType"></select>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">消耗价值</label>
                                    <div class="layui-input-inline" style="width: 120px">
                                        <input type="text" class="layui-input" id="UseCount">
                                    </div>
                                    <div class="layui-input-inline" style="width: 50px">
                                        <button type="button" class="layui-btn" id="addFoodSaleBtn">+</button>
                                    </div>
                                </div>
                            </div>
                            <table class="layui-hide" id="FoodSaleTable" lay-filter="FoodSaleTable"></table>
                        </div>
                        <div class="layui-col-md4">
                            <div id="test2">
                                <div id="imgBtn"><i class="layui-icon" style="font-size: 60px;color: #9F9F9F">&#xe654;</i></div>
                                <div class="layui-upload-list" id="demo2" style="margin: 0;">
                                    <input id="nameImage" name="list[0]" maxlength="255" class="input-xlarge required" type="hidden">
                                </div>
                            </div>
                        </div>
                </div>
            </div>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title" style="height: 36px;line-height: 36px">套餐内容设置</h2>
                <div class="layui-colla-content">
                    <div style="text-align:right;">
                        <!--<button type="button" class="layui-btn layui-btn-xs">增加</button>-->
                        <div class="layui-btn-group">
                            <button type="button" class="layui-btn layui-btn-xs" id="vipCoinBtn">会员币种</button>
                            <button type="button" class="layui-btn layui-btn-xs" id="giftsBtn">礼品</button>
                            <button type="button"class="layui-btn layui-btn-xs" id="ticketBtn">门票</button>
                            <button type="button" class="layui-btn layui-btn-xs" id="digitBtn">数字币</button>
                            <button type="button" class="layui-btn layui-btn-xs" id="onSaleBtn">优惠券</button>
                        </div>
                    </div>
                    <table class="layui-hide" lay-filter="projectCon" id="projectCon"></table>
                </div>
            </div>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title " style="height: 36px;line-height: 36px">优惠时段设定</h2>
                <div class="layui-colla-content ">
                    <div class="thread" style="position: relative;">
                        <button type="button" class="layui-btn layui-btn-normal timeSetBtn" id="tosetTime"><i class="layui-icon">&#xe614;</i>优惠时段设定</button>
                         <table class="layui-hide" id="ticketsTable"  lay-filter="ticketsTable"></table>
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align: right;margin-right: 100px;padding-top: 15px">
            <button type="reset" class="layui-btn layui-btn-normal" id="saveTimeReset"><i class="layui-icon">&#x1002;</i>重置</button>
            <button type="button" class="layui-btn layui-btn-normal" id="lastSave"><i class="layui-icon">&#xe6af;</i>确定</button>
        </div>
    </form>
</div>
<!--会员币种-->
<div id="openVip" style="display: none;padding: 10px;">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <label class="layui-form-label">种类</label>
            <div class="layui-input-block">
                <select id="vipCoinType" lay-filter="vipCoinType"></select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">数量</label>
            <div class="layui-input-block">
                <input type="text" class="layui-input" id="vipCoinCount">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">权重值</label>
            <div class="layui-input-block">
                <input type="text" class="layui-input" id="weightValue">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">有效期</label>
            <div class="layui-input-block">
                <input type="text" class="layui-input" id="vipDays">
            </div>
        </div>
        <div class="layui-form-item goodIsAll">
            <label class="layui-form-label">存储方式</label>
            <div class="layui-input-block">
                <input type="checkbox" id="OperateType" lay-skin="switch" lay-filter="OperateType" lay-text="充入卡|充电子币 ">
            </div>
        </div>
        <div style="text-align: center">
            <button type="button" class="layui-btn" id="openVipBtn">保存</button>
        </div>
    </form>
</div>
   <!--礼品-->
   <div id="openGift" style="display: none;padding: 10px;">
       <form class="layui-form layui-form-pane">
           <div class="layui-form-item">
               <div class="layui-inline">
                   <div class="layui-input-inline">
                       <input type="text" class="layui-input" id="ticketName">
                   </div>
                   <div class="layui-input-inline">
                       <button type="button" class="layui-btn" id="giftSearch"><i class="layui-icon">搜索</i></button>
                   </div>
               </div>
               <div class="layui-inline">
                   <label class="layui-form-label">有效期</label>
                   <div class="layui-input-inline">
                       <input type="text" class="layui-input" id="GiftDays">
                   </div>
               </div>
           </div>
           <table class="layui-hide" id="giftTable" lay-filter="giftTable"></table>
           <div style="text-align: center">
               <button type="button" class="layui-btn" id="openGiftBtn">保存</button>
           </div>
       </form>
   </div>
   <!--门票-->
   <div id="openTicket" style="display: none;padding: 10px;">
       <form class="layui-form layui-form-pane">
               <div class="layui-form-item">
                       <label class="layui-form-label">选择门票</label>
                       <div class="layui-input-inline">
                           <select id="ticketType" lay-filter="ticketType"></select>
                       </div>
               </div>
               <div class="layui-form-item">
                   <label class="layui-form-label">数量</label>
                   <div class="layui-input-inline">
                       <input type="text" class="layui-input" id="ticketCount">
                   </div>
               </div>
               <div class="layui-form-item">
                   <label class="layui-form-label">有效期</label>
                   <div class="layui-input-inline">
                       <input type="text" class="layui-input" id="ticketDays" readonly>
                   </div>
               </div>
           <div style="text-align: center">
               <button type="button" class="layui-btn" id="openTicketBtn">保存</button>
           </div>
       </form>
   </div>
   <!--数字币-->
   <div id="openDigit" style="display: none;padding: 10px;">
       <form class="layui-form layui-form-pane">
           <div class="layui-form-item">
                   <label class="layui-form-label">数字币</label>
                   <div class="layui-input-block">
                       <select name="" id="digitType" lay-filter="digitType"></select>
                   </div>
           </div>

           <div class="layui-form-item">
               <label class="layui-form-label">数量</label>
               <div class="layui-input-block">
                   <input type="text" id="digitCount" class="layui-input">
               </div>
           </div>
           <div class="layui-form-item">
               <label class="layui-form-label">有效期</label>
               <div class="layui-input-block">
                   <input type="text" id="digitDays" class="layui-input">
               </div>
           </div>
           <div style="text-align: center">
               <button type="button" class="layui-btn" id="openDigitBtn">保存</button>
           </div>
       </form>
   </div>
   <!--优惠券-->
   <div id="openOnSale" style="display: none;padding: 10px;">
       <form class="layui-form layui-form-pane">
           <div class="layui-form-item">
               <label class="layui-form-label">优惠券</label>
               <div class="layui-input-block">
                   <select name="" id="CouponType" lay-filter="CouponType"></select>
               </div>
           </div>
           <div class="layui-form-item">
               <label class="layui-form-label">数量</label>
               <div class="layui-input-block">
                   <input type="text" id="CouponCount" class="layui-input">
               </div>
           </div>
           <div class="layui-form-item">
               <label class="layui-form-label">权重</label>
               <div class="layui-input-block">
                   <input type="text" id="CouponWeight" class="layui-input">
               </div>
           </div>
           <div class="layui-form-item">
               <label class="layui-form-label">有效期</label>
               <div class="layui-input-block">
                   <input type="text" id="CouponDays" class="layui-input">
               </div>
           </div>
           <div style="text-align: center">
               <button type="button" class="layui-btn" id="openOnSaleBtn">保存</button>
           </div>
       </form>
   </div>
   <!--优惠时段设定-->
   <div id="saleTime" style="display: none;padding: 10px;height: 260px">
       <form id="timeSettingBox" class="layui-form layui-form-pane" style="border:  1px dashed #aaa;">
           <div class="layui-col-md2">
               <div class="layui-form-item">
                   <div class="layui-input-block" style="margin-left: 0px;height: 190px;overflow-y: scroll;border: 1px dashed #dedede;width: 160px" id="memberBox">

                   </div>
               </div>
           </div>
           <div class="layui-col-md10" id="timeTypeSetBox">
               <div class="layui-form-item" style="margin-bottom: 5px">
                   <div class="layui-inline">
                       <label class="layui-form-label">时段类型</label>
                       <div class="layui-input-inline" style="width: 200px">
                           <select id="poriedType" lay-filter="timeType">
                               <option value="0" selected>自定义</option>
                               <option value="1" >工作日</option>
                               <option value="2" >周末</option>
                               <option value="3" >法定节假日</option>
                           </select>
                       </div>
                   </div>
                   <div class="layui-inline" id="weekSetBox">
                       <label class="layui-form-label">优惠周天</label>
                       <div class="layui-input-block" id="weekBox" style="width: 700px">

                       </div>
                   </div>
               </div>
               <div class="layui-form-item">
                   <div class="layui-inline">
                       <label class="layui-form-label">生效时段</label>
                       <div class="layui-input-inline" style="margin-right: 5px">
                           <input type="text" name="price_min" id="StartDate" class="layui-input">
                       </div>
                       <div class="layui-form-mid" style="margin-right: 5px">至</div>
                       <div class="layui-input-inline" >
                           <input type="text" name="price_max" id="EndDate" class="layui-input">
                       </div>
                   </div>
                   <div class="layui-inline">
                       <label class="layui-form-label">散客优惠价</label>
                       <div class="layui-input-inline">
                           <input type="text" name="price_min" id="custorPrice" class="layui-input">
                       </div>
                   </div>
                   <div class="layui-inline">
                       <label class="layui-form-label">会员售价</label>
                       <div class="layui-input-inline">
                           <input type="text" name="price_min" id="VipPrice" class="layui-input">
                       </div>

                   </div>
                   <div class="layui-inline">
                       <label class="layui-form-label">每天限购</label>
                       <div class="layui-input-inline">
                           <input type="text" name="price_min" id="day_sale_count" class="layui-input">
                       </div>
                   </div>
                   <div class="layui-inline">
                       <label class="layui-form-label">每人会员限购</label>
                       <div class="layui-input-inline">
                           <input type="text" name="price_min" id="member_day_sale_count" class="layui-input">
                       </div>
                   </div>
                   <div class="layui-inline">
                       <label class="layui-form-label" style="padding: 8px 0;">调整会员级别</label>
                       <div class="layui-input-inline">
                           <select id="changeVip"></select>
                       </div>
                   </div>
               </div>
               <div class="layui-form-item" style="text-align: right;padding-right: 150px;margin-bottom: 15px" >
                   <button type="button" class="layui-btn layui-btn-normal" id="saveTimeCancle"><i class="layui-icon">&#xe603;</i>取消</button>
                   <button type="button" class="layui-btn layui-btn-normal" id="saveTimeSet"><i class="layui-icon">&#xe6af;</i>优惠时段添加</button>
               </div>
           </div>

       </form>
   </div>

</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    var xc=xcActionSystem.prototype;
    var token=xc.getStorage('token');
    let parm={'obj':{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
        'url':'/XCCloud/Promotion?action=GetFoodInfoList',
        'elem':'#digitDestroyTb',
        'cols':[
            {field:'FoodID', title:'套餐编号', align: 'center', sort: true}
            ,{field:'FoodName',title: '套餐名称', align: 'center'} //width 支持：数字、百分比和不填写。
            ,{field:'ClientPrice', title: '散客价', align: 'center'}
            ,{field:'MemberPrice', title: '会员价', align: 'center'}
            ,{field:'FoodTypeStr', title: '套餐类别', align: 'center'}
            // ,{field:'RechargeTypeStr', title: '充值方式', align: 'center'}
            ,{field:'AllowInternet', title: '是否允许第三方', align: 'center',templet:'#internet'}
            ,{field:'AllowPrint', title: '是否允许打印', align: 'center',templet:'#print'}
            ,{field:'ForeAuthorize', title: '是否允许前台授权', align: 'center',templet:'#authorize'}
            ,{field:'StartTime', title: '启用时间', align: 'center'}
            ,{field:'EndTime', title: '停用时间', align: 'center'}
            ,{fixed: 'right', title: '操作', width:260, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);
    let foodID='';
    let index;
    let FoodSale=[];//套餐余额消耗
    let FoodDetial=[];
    let FoodLevel=[];

    let FoodType='';//套餐类别
    let BalanceType='';//余额类别
    let BalanceTypeStr='';

    let vipCoinType='';let vipCoinTypeStr='';let OperateType=0;
    let digitType='';let digitTypeStr='';
    let giftList=[];
    let ticketType='';let ticketTypeStr='';
    let CouponType=''; let CouponTypeStr='';
    // let EntryCouponFlag='';

    let week=[];let weekStr=[];
    let memberLevelID=[];let MemberLevel=[];
    let timeType='0';let Time='';
    let AllowInternet=0;let AllowPrint=0;let ForeAuthorize=0;
    layui.use(['element','form','layer','table','laydate','upload'], function(){
        let element = layui.element,
            form=layui.form,
            layer=layui.layer,
            table=layui.table,
            upload=layui.upload,
           laydate=layui.laydate;
        form.on('select(FoodType)',function (data) {
            FoodType=data.value;
            // BalanceTypeStr=data.elem[data.elem.selectedIndex].text;
        });
        form.on('select(BalanceType)',function (data) {
            BalanceType=data.value;
            BalanceTypeStr=data.elem[data.elem.selectedIndex].text;
        });
        form.on('select(vipCoinType)',function (data) {
            vipCoinType=data.value;
            vipCoinTypeStr=data.elem[data.elem.selectedIndex].text;
        });
        form.on('select(ticketType)',function (data) {
            ticketType=data.value;
            ticketTypeStr=data.elem[data.elem.selectedIndex].text;
            $('#ticketDays').val(data.elem[data.elem.selectedIndex].title)
        });
        form.on('select(digitType)',function (data) {
            digitType=data.value;
            digitTypeStr=data.elem[data.elem.selectedIndex].text;
        });
        form.on('select(CouponType)',function (data) {
            CouponType=data.value;
            CouponTypeStr=data.elem[data.elem.selectedIndex].text;
            let time1=new Date(data.elem[data.elem.selectedIndex].title);
            let time2=new Date();
            console.log(parseInt((time1.getTime() - time2.getTime()) / (24*60*60*1000)));
            $('#CouponDays').val( parseInt((time1.getTime() - time2.getTime()) / (24*60*60*1000)))
        });
        form.on('switch(AllowInternet)',function (data) {
            if(data.elem.checked==true){
                AllowInternet=1;
                $('#otherShow').removeClass('layui-hide')
            }else {
                AllowInternet=0;
                $('#otherShow').addClass('layui-hide');
                $('#otherShow').find('input').val('');
            }
        });
        form.on('switch(AllowPrint)',function (data) {
            if(data.elem.checked==true){
                AllowPrint=1;
            }else {
                AllowPrint=0;
            }
        });
        form.on('switch(ForeAuthorize)',function (data) {
            if(data.elem.checked==true){
                ForeAuthorize=1;
            }else {
                ForeAuthorize=0;
            }
        });
        form.on('switch(OperateType)',function (data) {
            if(data.elem.checked==true){
                OperateType=1;
            }else {
                OperateType=0;
            }
        });

        form.on('select(typeCheck)',(data)=>{
            typeChecks=data.value;
        });
        form.on('select(timeType)',(data)=>{
            timeType=data.value;
            if(timeType==0){
                // $('#typeCheckBox').css({'display':'none'});
                $('#weekSetBox').css({'display':'inline-block'});
                // $('#typeCheck').html('<option value="0">工作日</option><option value="1">法定节假日</option><option value="2">周末</option>');
                form.render();
                xc.AddWeeks('weekBox');
            }else {
                $('#weekSetBox').css({'display':'none'});
                // $('#typeCheckBox').css({'display':'inline-block'});
                $('#weekBox').html('');
                week=[];
            }
        });
        form.on('checkbox(ml)', function(data){
            if (data.elem.checked==true){
                memberLevelID.push(data.value);
                MemberLevel.push(data.elem.title)
            }else if(data.elem.checked==false){
                for (var i=0;i<memberLevelID.length;i++){
                    if(memberLevelID[i]==data.value){
                        memberLevelID.splice(i,1);
                        MemberLevel.splice(i,1);
                    }
                }
            }
        });
        form.on('checkbox(weeks)', function(data){
            if (data.elem.checked==true){
                week.push(data.value);
                weekStr.push(data.elem.title)
            }else if(data.elem.checked==false){
                for (var i=0;i<week.length;i++){
                    if(week[i]==data.value){
                        week.splice(i,1);
                        weekStr.splice(i,1);
                    }
                }
            }
        });
        //渲染时间
        laydate.render({
            elem: '#StartTime',type: 'date',value:new Date()
        });
        laydate.render({
            elem: '#EndTime',type: 'date',value:new Date()
        });
        table.on('checkbox(giftTable)', function(obj){
            if (obj.type == "all") {
                var csss = $(".layui-table-cell.laytable-cell-checkbox");
                csss.each(function(index, e){
                    e.children[0].checked = false;
                    e.children[1].className="layui-unselect layui-form-checkbox";
                    giftList=[];
                });
            } else {
                if(obj.checked==true){
                    giftList=[{'FoodDetailType':1,
                        'FoodDetailTypeStr':'礼品',
                        'BalanceType':'',
                        'OperateType':'',
                        'ContainId':obj.data.ID,
                        'ProjectName':obj.data.GoodName,
                        'WeightValue':0,
                        'ContainCount':1,
                        'Days':$('#GiftDays').val()}]
                }else {
                    giftList=[];
                }
                var csss = $(".layui-table-cell.laytable-cell-checkbox");
                csss.each(function(index, e){
                    var dataIndex = e.parentNode.parentNode.getAttribute("data-index");
                    if (dataIndex != null) {
                        if(dataIndex != obj.data.LAY_TABLE_INDEX){
                            e.children[0].checked = false;
                            e.children[1].className="layui-unselect layui-form-checkbox";
                        }
                    } else {
                        e.children[0].checked = false;
                        e.children[1].className="layui-unselect layui-form-checkbox";
                    }
                });
            }
        });
        //新增一个套餐
     $('.addNewPackage').on('click',()=>{
          FoodSale=[];FoodDetial=[];FoodLevel=[];
          FoodType='';//套餐类别
          BalanceType='';//余额类别
          BalanceTypeStr='';
         xc.setSelect('套餐类别','FoodType');
         xc.getBalanceTypeDic(token,layer,form,'BalanceType');
         newTable(table,FoodSale,layer,form);
         newFoodDetialsTable(table,FoodDetial,layer,form);
         newFoodLevelTable(table,FoodLevel,layer,form);
         layer.open({
             title:'新增套餐',
             shade:0.6,
             type:1,
             area:'1100px',
             content:$('#openModel'),
         })
     });
     $('#addFoodSaleBtn').on('click',()=>{
         let flag=false;
         //当2个参数都填满后，点击向表里面加一条数据，初始化输入框
         if(BalanceType!=''&&$('#UseCount').val()!=''){
             if(FoodSale.length>0){
                 for(let i in FoodSale){
                     if(FoodSale[i].BalanceType==BalanceType){
                         flag=true;
                     }
                 }
             }
             if(flag==false){
                 FoodSale.push({
                     'BalanceType':BalanceType, 'BalanceTypeStr':BalanceTypeStr,
                     'UseCount':$('#UseCount').val()
                 });
                 newTable(table,FoodSale,layer,form);
                 $('#UseCount').val('');
                 // xc.setSelect('余额类别','BalanceType');
                 xc.getBalanceTypeDic(token,layer,form,'BalanceType')
                 BalanceType='';BalanceTypeStr='';
             }else {
                 layer.msg('请选择其他的余额类别或者删除该类别重新设置！')
             }

         }else {
             layer.msg('请设置参数！')
         }
         });
        //会员币种
        $('#vipCoinBtn').on('click',()=>{
            // xc.setSelect('余额类别','vipCoinType');
            xc.getBalanceTypeDic(token,layer,form,'vipCoinType')
            vipCoinType=''; vipCoinTypeStr=''
            index= layer.open({
                title:'新增套餐',
                shade:0.6,
                type:1,
                area:'500px',
                content:$('#openVip'),
            })
        });
        //礼品
        $('#giftsBtn').on('click',()=>{
            initGoodsTb();
            giftList=[];
            index= layer.open({
                title:'新增套餐',
                shade:0.6,
                type:1,
                area:'700px',
                content:$('#openGift'),
            })
        });
        //门票
        $('#ticketBtn').on('click',()=>{
           xc. GetTicketProjectDic (token,layer,form,'ticketType');
             ticketType=''; ticketTypeStr='';
              index=  layer.open({
                title:'新增套餐',
                shade:0.6,
                type:1,
                area:'500px',
                content:$('#openTicket'),
            })
        });
        //数字币
        $('#digitBtn').on('click',()=>{
            xc.getDigitFoodDic(token,layer,form,'digitType');
             digitType=''; digitTypeStr='';
            index= layer.open({
                title:'新增套餐',
                shade:0.6,
                type:1,
                area:'500px',
                content:$('#openDigit'),
            })
        });
        //优惠券
        $('#onSaleBtn').on('click',()=>{
            xc.getCouponDic(token,layer,form,'CouponType');
             CouponType='';  CouponTypeStr='';
          index=layer.open({
                title:'新增套餐',
                shade:0.6,
                type:1,
                area:'500px',
                content:$('#openOnSale'),
            })
        });

        //保存套餐内容
        $('#openVipBtn').on('click',()=>{
            FoodDetial.push({ 'FoodDetailType':0,
                        'FoodDetailTypeStr':'会员币种',
                'BalanceType':vipCoinType,
                'OperateType':OperateType,
                'ContainId':'',
                'ProjectName':'数字币',
                'ContainCount':$('#vipCoinCount').val(),
                'WeightValue':$('#weightValue').val(),
                'Days':$('#vipDays').val()});
            layer.close(index);
            newFoodDetialsTable(table,FoodDetial,layer,form)
        });
        $('#openGiftBtn').on('click',()=>{
            if(giftList[0].Days=''){
                layer.msg('请填写有效期')
            }else {
                giftList[0].Days=$('#GiftDays').val();
                FoodDetial=FoodDetial.concat(giftList);
                layer.close(index);
                newFoodDetialsTable(table,FoodDetial,layer,form)
            }
        });
        $('#openTicketBtn').on('click',()=>{
            FoodDetial.push({ 'FoodDetailType':2,
                'FoodDetailTypeStr':'门票',
                'BalanceType':'',
                'OperateType':'',
                'ContainId':ticketType,
                'ProjectName':ticketTypeStr,
                'ContainCount':$('#ticketCount').val(),
                'WeightValue':'0',
                'Days':$('#ticketDays').val()});
            layer.close(index);
            newFoodDetialsTable(table,FoodDetial,layer,form)
        });
        $('#openDigitBtn').on('click',()=>{
            FoodDetial.push({ 'FoodDetailType':3,
                'FoodDetailTypeStr':'数字币',
                'BalanceType':'',
                'OperateType':'',
                'ContainId':digitType,
                'ProjectName':'数字币',
                'ContainCount':$('#digitCount').val(),
                'WeightValue':'0',
                'Days':$('#digitDays').val()});
            layer.close(index);
            newFoodDetialsTable(table,FoodDetial,layer,form)
        });
        $('#openOnSaleBtn').on('click',()=>{
            FoodDetial.push({ 'FoodDetailType':4,
                'FoodDetailTypeStr':'优惠券',
                'BalanceType':'',
                'OperateType':'',
                'ContainId':CouponType,
                'ProjectName':CouponTypeStr,
                'ContainCount':$('#CouponCount').val(),
                'WeightValue':$('#CouponWeight').val(),
                'Days':$('#CouponDays').val()});
            layer.close(index);
            newFoodDetialsTable(table,FoodDetial,layer,form)
        });
        var demoListViewStore=$('#demo2'),uploadListInsStore=upload.render({
            elem: '#imgBtn'
            ,url: '/XCCloud/Promotion?action=UploadFoodPhoto'
            ,data:{'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'}
            ,multiple: true
            ,accept:"images"
            ,size:1000
            ,auto:true
            ,done: function(res,index,upload){
                //上传完毕
                console.log(res);
                if(res.result_code==1){
                    $('#demo2').children('div[class="imgBox"]').remove();
                    $('#demo2 .loadTips').addClass('layui-hide');
                    $('#demo2') .append('<div style="display: inline-block;position: relative" class="imgBox">' +
                        '<button type="button" ><i class="layui-icon"><i class="layui-icon">&#xe640</i></i></button>' +
                        '<img src="'+ res.result_data[0].Value +'" alt="'+ res.result_data[0].Value +'" class="layui-upload-img_md" ' +
                        'style="display: block;width: 300px;height: 170px"></div>');
                    layer.msg("图片上传成功！");
                    $('.imgBox button').click(function () {
                        $(this).parent('div').remove();
                    });
                    $('.imgBox img').click(function () {
                        layer.open({
                            title:  res.result_data.ID,
                            type: 1,
                            area: ['600px','400px'], //宽高
                            content: '<div><img src="'+res.result_data[0].Value+'" alt="" style="display: block;"></div>'
                        });
                    });
                }else{
                    layer.msg(res.return_msg);
                }
            }
            ,error:function(index,upload){
                layer.msg("服务器返回错误！");
                layer.closeAll('loading');
            }
        });
    //    ............................................................................
        $('.timeSetBtn').on('click',()=>{
            laydate.render({
                elem: '#StartDate',type: 'time',value:new Date()
            });
            laydate.render({
                elem: '#EndDate',type: 'time',value:new Date()
            });
            xc.SearchMemberLevel1('memberBox', token, layer);
            xc.AddWeeks('weekBox');
            $('#weekSetBox').css({'display':'inline-block'});
             week=[];weekStr=[]; memberLevelID=[];MemberLevel=[];timeType='0';Time='';
            index=layer.open({
                title:'新增套餐',
                shade:0.6,
                type:1,
                area:'1030px',
                content:$('#saleTime'),
            })
        });
        $('#saveTimeSet').on('click',function () {
            FoodLevel.push({'MemberLevelIDs':memberLevelID.join('|'),
            'MemberLevels':MemberLevel.join('|'),
            'TimeType':timeType,
            'week':week.join('|'),
            'WeekStr':weekStr.join('|'),
            'StartTime':$('#StartDate').val(),
            'EndTime':$('#EndDate').val(),
            'Time':$('#StartDate').val()+'~'+$('#EndDate').val(),
            'ClientPrice':$('#custorPrice').val(),
            'VIPPrice':$('#VipPrice').val(),
            'day_sale_count':$('#day_sale_count').val(),
            'member_day_sale_count':$('#member_day_sale_count').val(),
            'UpdateLevelID':'0'});
            newFoodLevelTable(table,FoodLevel,layer,form);
            layer.close(index);
        });
    //修改主表
        table.on('tool(digitDestroyTb)', function(obj){
            var data = obj.data;
            var layEvent = obj.event;
           foodID=data.FoodID;
            var foodName=data.FoodName;
            if(layEvent === 'detail'){ //查看
                let _obj={'foodId':foodID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'}
                var parasJson = JSON.stringify(_obj);
                $.ajax({
                    type: "post",
                    url: '/XCCloud/Promotion?action=GetFoodInfo',
                    contentType: "application/json; charset=utf-8",
                    data: { parasJson: parasJson },
                    success: function (data) {
                        data=JSON.parse(data);
                        if(data.result_code==1){
                           console.log(data)
                            let arr=data.result_data;
                            $('#FoodName').val(arr.FoodName||'');
                            FoodType=arr.FoodType;
                            xc.setSelect('套餐类别','FoodType',arr.FoodType);
                            xc.getBalanceTypeDic(token,layer,form,'BalanceType');
                            BalanceType='';//余额类别
                            BalanceTypeStr='';
                            $('#StartTime').val(arr.StartTime||'');
                            $('#EndTime').val(arr.EndTime||'');
                            $('#RenewDays').val(arr.RenewDays||'');
                            AllowInternet=arr.AllowInternet;
                            if(arr.AllowInternet==1){
                                $('#AllowInternet').attr('checked',true);
                                $('#otherShow').removeClass('layui-hide')
                            }else {
                                $('#AllowInternet').attr('checked',false)
                                $('#otherShow').addClass('layui-hide')
                            }
                            AllowPrint=arr.AllowPrint;
                            if(arr.AllowPrint==1){
                                $('#AllowPrint').attr('checked',true)
                            }else {
                                $('#AllowPrint').attr('checked',false)
                            }
                            ForeAuthorize=arr.ForeAuthorize;
                            if(arr.ForeAuthorize==1){
                                $('#ForeAuthorize').attr('checked',true)
                            }else {
                                $('#ForeAuthorize').attr('checked',false)
                            }
                            $('#MeituanID').val(arr.MeituanID||'');
                            $('#DianpinID').val(arr.DianpinID||'');
                            $('#KoubeiID').val(arr.KoubeiID||'');
                            $('#ClientPrice').val(arr.ClientPrice);
                            $('#MemberPrice').val(arr.MemberPrice);
                            FoodSale=arr.FoodSales;
                            newTable(table,arr.FoodSales,layer,form);
                            FoodDetial=arr.FoodDetials;
                            newFoodDetialsTable(table,arr.FoodDetials,layer,form)
                            FoodLevel=arr.FoodLevels;
                            newFoodLevelTable(table,arr.FoodLevels,layer,form);
                            if(arr.ImageURL!=""){
                                $('#demo2') .append('<div style="display: inline-block;position: relative" class="imgBox">' +
                                    '<button type="button" ><i class="layui-icon"><i class="layui-icon">&#xe640</i></i></button>' +
                                    '<img src="'+ arr.ImageURL +'" class="layui-upload-img_md" ' +
                                    'style="display: block;width: 300px;height: 170px"></div>');
                                $('.imgBox button').click(function () {
                                    $(this).parent('div').remove();
                                });
                            }
                            form.render();
                            layer.open({
                                title:'修改:'+foodName+'"套餐',
                                type:1,
                                area:'1100px',
                                content:$('#openModel'),
                            })
                        }else {
                            layer.msg('操作失败')
                        }
                    }

                })


           }
     });
         //删除套餐余额消耗
        table.on('tool(FoodSaleTable)', function(obj){
            let data = obj.data;
            let layEvent = obj.event;
            if(layEvent === 'del'){ //查看
                for(let i in FoodSale){
                    if(FoodSale[i].BalanceType==data.BalanceType){
                        FoodSale.splice(i,1);
                        obj.del();
                    }
                }
            }
        });
        //删除套餐内容
        table.on('tool(projectCon)', function(obj){
            let data = obj.data;
            let layEvent = obj.event;
            if(layEvent === 'del'){ //查看
                for(let i in FoodDetial){
                    if(FoodDetial[i].FoodDetailType==data.FoodDetailType&&
                        FoodDetial[i].BalanceType==data.BalanceType&&
                        FoodDetial[i].OperateType==data.OperateType&&
                        FoodDetial[i].ContainId==data.ContainId&&
                        FoodDetial[i].ContainCount==data.ContainCount&&
                        FoodDetial[i].WeightValue==data.WeightValue&&
                        FoodDetial[i].Days==data.Days){
                        FoodDetial.splice(i,1);
                        console.log(FoodDetial)
                        obj.del();
                    }
                }
            }
        });
        table.on('tool(ticketsTable)', function(obj){
            let data = obj.data;
            let layEvent = obj.event;
            if(layEvent === 'del'){ //查看
                for(let i in FoodLevel){
                    console.log(FoodLevel[i]);
                    console.log(data);
                    if(FoodLevel[i].MemberLevelIDs==data.MemberLevelIDs&&
                        FoodLevel[i].Week==data.Week&&
                        FoodLevel[i].StartTime==data.StartTime&&
                        FoodLevel[i].EndTime==data.EndTime&&
                        FoodLevel[i].ClientPrice==data.ClientPrice&&
                        FoodLevel[i].VIPPrice==data.VIPPrice&&
                        FoodLevel[i].day_sale_count==data.day_sale_count&&
                        FoodLevel[i].member_day_sale_count==data.member_day_sale_count&&
                        FoodLevel[i].TimeType==data.TimeType&&
                        FoodLevel[i].UpdateLevelID==data.UpdateLevelID){
                        FoodLevel.splice(i,1);
                        obj.del();
                    }
                }
            }
        });
     //保存主套餐
        $('#lastSave').on('click',function () {
            let obj={'FoodId':foodID,
                'foodName':$('#FoodName').val(),
                'foodType':FoodType,
                'startTime':$('#StartTime').val(),
                'endTime':$('#EndTime').val(),
                'ImageURL':$('.layui-upload-img_md').attr('src'),
                'foodState':0,
                'renewDays':$('#RenewDays').val(),
                'allowInternet':AllowInternet,
                'allowPrint':AllowPrint,
                'foreAuthorize':ForeAuthorize,
                'meituanID':$('#MeituanID').val(),
                'DianpinID':$('#DianpinID').val(),
                'KoubeiID':$('#KoubeiID').val(),
                'clientPrice':$('#ClientPrice').val(),
                'memberPrice':$('#MemberPrice').val(),
                'foodSales':FoodSale.length>0?FoodSale:null,
                'foodDetials':FoodDetial.length>0?FoodDetial:null,
                'foodLevels':FoodLevel.length>0?FoodLevel:null,
                'userToken':token,
                'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let url='/XCCloud/Promotion?action=SaveFoodInfo';
            var parasJson = JSON.stringify(obj);
            console.log(parasJson)
            $.ajax({
                type: "post",
                url: url,
                contentType: "application/json; charset=utf-8",
                data: { parasJson: parasJson },
                success: function (data) {
                    data=JSON.parse(data);
                    if(data.result_code==1){
                        layer.msg('保存成功',{time:1000},function () {
                            location.href='discountPackageSet.html'
                        })
                    }else {
                        layer.msg('操作失败')
                    }
                }

            })
        })
    });
    function newTable(table,arr,layer,form) {
        table.render({
            elem: '#FoodSaleTable'
            , height:'220px'
            ,size:'sm'
            , data: arr
            , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [[
                 {field:'BalanceTypeStr', title: '余额类型', align: 'center',width:250}
                ,{field:'UseCount', title: '消耗数量', align: 'center',width:250}
                ,{fixed: 'right',title:'操作', width:195, align:'center', toolbar: '#barDemo2'}]]
            , page: {page: true, limits: [5,10, 15, 20]}
            , limit: 5
            ,done:function () {
                xc.getBalanceTypeDic(token,layer,form,'freeBalanceType');
                $('.freeLast').find('input').val('')
            }
        });
    }
    function newFoodDetialsTable(table,arr,layer,form) {
        table.render({
            elem: '#projectCon'
            , height:'230px'
            ,size:'sm'
            , data: arr
            , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [[
                 {field:'FoodDetailTypeStr', title: '套餐种类类别', align: 'center'}
                // ,{field:'BalanceType', title: '余额类别', align: 'center'}
                ,{field:'OperateType', title: '操作类型', align: 'center',templet:'#operateType1'}
                ,{field:'ProjectName', title: '套餐名字', align: 'center'}
                ,{field:'ContainCount', title: '套餐内容数量', align: 'center'}
                ,{field:'WeightValue', title: '权重值', align: 'center'}
                ,{field:'Days', title: '有效期', align: 'center'}
                ,{fixed: 'right',title:'操作', width:140, align:'center', toolbar: '#barDemo1'}]]
            , page: {page: true, limits: [5,10, 15, 20]}
            , limit: 5
            // ,done:function () {
            //     xc.getBalanceTypeDic(token,layer,form,'freeBalanceType');
            //     $('.freeLast').find('input').val('')
            // }
        });
    }
    function newFoodLevelTable(table,arr,layer,form) {
        table.render({
            elem: '#ticketsTable'
            , height:'250px'
            ,size:'sm'
            , data: arr
            , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [[
                {field:'MemberLevels', title: '会员级别', align: 'center'}
                ,{field:'TimeType', title: '时段类型', align: 'center',templet:'#timeType1'}
                ,{field:'WeekStr', title: '有效周', align: 'center'}
                ,{field:'StartTime', title: '开始时段', align: 'center'}
                ,{field:'EndTime', title: '结束时段', align: 'center'}
                ,{field:'ClientPrice', title: '游客优惠价', align: 'center'}
                ,{field:'VIPPrice', title: '会员优惠价', align: 'center'}
                ,{field:'day_sale_count', title: '每天限额', align: 'center'}
                ,{field:'member_day_sale_count', title: '会员每天限额', align: 'center'}
                ,{field:'UpdateLevelID', title: '下一级', align: 'center'}
                ,{fixed: 'right',title:'操作', width:140, align:'center', toolbar: '#barDemo1'}]]
            , page: {page: true, limits: [5,10, 15, 20]}
            , limit: 5
            // ,done:function () {
            //     xc.getBalanceTypeDic(token,layer,form,'freeBalanceType');
            //     $('.freeLast').find('input').val('')
            // }
        });
    }
    function initGoodsTb() {
        var searchText=$('#ticketName').val();
        var parm={'obj':{'goodNameOrBarcode':searchText,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'},
            'url':'/XCCloud/Promotion?action=GetGoodsInfoList',
            'elem':'#giftTable',
            'height':'210px',
            'size':'sm',
            'cols':[  {type:'checkbox'},
                {field:'ID', title: '商品ID', align: 'center'}
                ,{field:'Barcode', title: '商品条码', align: 'center'}
                ,{field:'GoodName', title: '商品名称', align: 'center'}
                ,{field:'GoodTypeStr', title: '商品类别', align: 'center'}
            ]};
        xc.getInitData(parm);
    }
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-bg-orange" lay-event="set"> <i class="layui-icon">&#xe642;</i>适用门店</a>
    <a class="layui-btn layui-btn-xs" lay-event="detail"> <i class="layui-icon">&#xe642;</i>编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"> <i class="layui-icon">&#xe642;</i>删除</a>
</script>
<script type="text/html" id="barDemo1">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"> <i class="layui-icon">&#xe642;</i>删除</a>
</script>
<script type="text/html" id="barDemo2">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"> <i class="layui-icon">&#xe642;</i>删除</a>
</script>
<script type="text/html" id="operateType1">
    {{# if(d.OperateType=='1'){ }}
  存入会员卡
    {{# }else if(d.OperateType=='0'){ }}
 直接充值
    {{#  } }}
</script>
<script type="text/html" id="timeType1">
    {{# if(d.TimeType==0){ }}
    自定义
    {{# }else if(d.TimeType==1){ }}
    工作日
    {{# }else if(d.TimeType==2){ }}
      周末
    {{# }else if(d.TimeType==3){ }}
      法定节假日
    {{#  } }}
</script>
<script type="text/html" id="internet">
    {{# if(d.AllowInternet=='允许'){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="允许|禁止" class="tb_check" lay-filter="test" disabled>
    {{# }else{ }}
    <input type="checkbox" name="switch" lay-skin="switch" lay-text="允许|禁止" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
<script type="text/html" id="print">
    {{# if(d.AllowPrint=='允许'){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="允许|禁止" class="tb_check" lay-filter="test" disabled>
    {{# }else{ }}
    <input type="checkbox" name="switch" lay-skin="switch" lay-text="允许|禁止" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
<script type="text/html" id="authorize">
    {{# if(d.ForeAuthorize=='允许'){ }}
    <input type="checkbox" checked name="switch" lay-skin="switch" lay-text="允许|禁止" class="tb_check" lay-filter="test"disabled >
    {{# }else{ }}
    <input type="checkbox" name="switch" lay-skin="switch" lay-text="允许|禁止" class="tb_check" lay-filter="test" disabled>
    {{#  } }}
</script>
</html>