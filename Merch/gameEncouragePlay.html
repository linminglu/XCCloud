<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>鼓励续完</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<body>
<div class="layui-row" style="padding:15px">
    <blockquote class="layui-elem-quote" style="text-align: right">
        <button type="button" class="layui-btn layui-btn-normal" i18n-content="查询模板">查询模板</button>
        <button type="button" class="layui-btn layui-btn-normal add" i18n-content="新增">新增</button>
    </blockquote>
    <table class="layui-hide" id="encouragePlay" lay-filter="encouragePlay"></table>
</div>
<!--//弹窗层   -->
<div id="openModel" style="padding: 15px;display: none;" class="goodIsAll">
    <form action="" class="layui-form layui-form-pane" lay-filter="formtest">
        <div class="layui-col-md4">
            <div id="xtree1" style="width:300px;border:1px solid #e2e2e2;padding: 10px 0 25px 5px;height: 377px;overflow: auto"></div>
        </div>
        <div class="layui-col-md8">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">时间范围</label>
                    <div class="layui-input-inline" style="width: 150px">
                        <select lay-filter="usePried">
                            <option value="0">自定义</option>
                            <option value="1">当天</option>
                            <option value="2">本周</option>
                            <option value="3">本月</option>
                            <option value="4">本季</option>
                            <option value="5">本年</option>
                        </select>
                    </div>
                    <div class="layui-input-inline" style="width: 150px">
                        <input type="text" class="layui-input" name="StartDate" id="StartDate">
                    </div>
                    <div class="layui-form-mid">
                        至
                    </div>
                    <div class="layui-input-inline" style="width: 150px">
                        <input type="text" class="layui-input" name="EndDate" id="EndDate">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">时段类型</label>
                    <div class="layui-input-inline">
                        <select id="poriedType" lay-filter="timeType" name="poriedType">
                            <option value="0" selected>自定义</option>
                            <option value="1" >工作日</option>
                            <option value="2" >周末</option>
                            <option value="3" >法定节假日</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline" id="weekSetBox">
                    <label class="layui-form-label">优惠周天</label>
                    <div class="layui-input-block" id="weekBox" style="width: 700px">

                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">生效时段</label>
                    <div class="layui-input-inline" style="margin-right: 5px">
                        <input type="text" name="StartTime" id="StartTime" class="layui-input">
                    </div>
                    <div class="layui-form-mid" style="margin-right: 5px">至</div>
                    <div class="layui-input-inline" >
                        <input type="text" name="EndTime" id="EndTime" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 130px">最大续玩时间间隔</label>
                    <div class="layui-input-inline">
                        <input type="text" name="ContinueTimes" class="layui-input">
                    </div>
                    <div class="layui-form-mid">分钟</div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">使用说明</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" name="Note">
                </div>
            </div>
            <div class="layui-form-item goodConvert">
                <div class="layui-inline goodRules" >
                    <label class="layui-form-label">余额类别</label>
                    <div class="layui-input-inline" style="width: 130px">
                        <input type="text" class="layui-input" name="GameTims">
                    </div>
                    <div class="layui-form-mid">局以内,每局减免</div>
                    <div class="layui-input-inline"  style="width: 130px">
                        <input type="text" class="layui-input" name="EncouragePrice">
                    </div>
                    <div class="layui-form-mid">币</div>
                </div>
                <div class="layui-inline" style="width: 80px">
                    <div class="layui-btn-group">
                        <button class="layui-btn layui-btn-sm" type="button" id="addGoods">
                            <i class="layui-icon">&#xe654;</i>
                        </button>
                        <button class="layui-btn layui-btn-sm" type="button" id="reduceGoods">
                            <i class="layui-icon">&#x1006;</i>
                        </button>
                    </div>
                </div>

            </div>
        </div>

    </form>
    <div style="text-align:center;" class="layui-col-md12">
        <button type="button" id="save" class="layui-btn">确定</button>
    </div>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="layui/layui-xtree-game.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    var xc=xcActionSystem.prototype;
    var token=xc.getStorage('token');
    var parm = {
        'obj': {'userToken': token, 'signkey': '1f626576304bf5d95b72ece2222e42c3'},
        'url': '/XCCloud/GameEncourage?action=QueryGameEncourage',
        'elem': '#encouragePlay',
        'cols': [{field: 'ID', title: '流水号', align: 'center'}
            , {field: 'GameName', title: '游戏机名称', align: 'center'}
            , {field: 'ValidDate', title: '有效期限', align: 'center'}
            , {field: 'Note', title: '说明', align: 'center'}
            ,{fixed: 'right',title: '操作', width:240, align:'center', toolbar: '#barDemo'}]
    };
    xc.getInitData(parm);
    let id='';let gameArr=[];let checkedArr=[];
    let week=[];let WeekType=0;
    let GameList='';
    var xtree3;

    $('#addGoods').click(function () {
        $('.goodConvert').append($('body').find($('.goodRules')).eq(0).clone())
    });
    $('#reduceGoods').click(function () {
        if($('.goodConvert').find($('.goodRules')).length>1){
            $('.goodConvert').find($('.goodRules')).last().remove();
        }else {
        }
    });
    layui.use(['table','form','layer','laydate'],function () {
        let table=layui.table;let form=layui.form;let layer=layui.layer;let laydate=layui.laydate;
        var  obj={"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
        var url="/XCCloud/GameInfo?action=GetGameTypeGameList";
        var parasJson = JSON.stringify(obj);
        $.ajax({
            type: "post",
            url: url,
            contentType: "application/json; charset=utf-8",
            data: {parasJson: parasJson},
            success: function (data) {
                data = JSON.parse(data);
                console.log(data);
                if(data.result_code==1){
                    gameArr=data.result_data.children;
                    gameArr.splice(0,1);
                    xtree3=new layuiXtree({
                        elem: 'xtree1'                  //必填
                        , form: form                    //必填
                        , data: gameArr//必填
                        , isopen: true  //加载完毕后的展开状态，默认值：true
                        , ckall: true    //启用全选功能，默认值：false
                        , ckallback: function () { } //全选框状态改变后执行的回调函数
                        ,checkedArr:checkedArr
                        ,single:true
                    });
                }
            }
        });
        laydate.render({
            elem: '#StartDate',type: 'date',value:new Date()
        });
        laydate.render({
            elem: '#EndDate',type: 'date',value:new Date()
        });
        laydate.render({
            elem: '#StartTime',type: 'time',value:'00:00:00'
        });
        laydate.render({
            elem: '#EndTime',type: 'time',value:'23:59:59'
        });
        //监听有效期间选择
        form.on('select(usePried)',function (data) {
            if(data.value==1){
                $('#StartDate').val(getDayStartDate()).prop('disabled',true);
                $('#EndDate').val(getDayStartDate()).prop('disabled',true);
            }else if(data.value==2){
                $('#StartDate').val(getWeekStartDate()).prop('disabled',true);
                $('#EndDate').val(getWeekEndDate()).prop('disabled',true);
            }else if(data.value==3){
                $('#StartDate').val(getMonthStartDate()).prop('disabled',true);
                $('#EndDate').val(getMonthEndDate()).prop('disabled',true);
            }else if(data.value==5){
                $('#StartDate').val(getYearStartDate()).prop('disabled',true);
                $('#EndDate').val(getYearEndDate()).prop('disabled',true);
            }else if(data.value==4){
                $('#StartDate').val(getQuarterStartDate()).prop('disabled',true);
                $('#EndDate').val(getQuarterEndDate()).prop('disabled',true);
            }else if(data.value==0){
                $('#StartDate').prop('disabled',false);
                $('#EndDate').prop('disabled',false);
                layer.msg('<p style="color: red">请自己设置有效期限</p>')
            }
        });
        xc.AddWeeks('weekBox');
        form.on('select(timeType)',(data)=>{
            WeekType=data.value;
            if(WeekType==0){
                $('#weekSetBox').css({'display':'inline-block'});
                form.render();
                xc.AddWeeks('weekBox');
            }else {
                $('#weekSetBox').css({'display':'none'});
                $('#weekBox').html('');
                week=[];
            }
        });
        form.on('checkbox(weeks)', function(data){
            if (data.elem.checked==true){
                week.push(data.value);
            }else if(data.elem.checked==false){
                for (var i=0;i<week.length;i++){
                    if(week[i]==data.value){
                        week.splice(i,1);
                    }
                }
            }
        });
        //新增，存入一个cook
        $('.add').on('click',function (){
            id=''; week=[]; WeekType=0;
            GameList='';
            layer.open({
                title:'新增',
                type:1,
                area:'1045px',
                content:$('#openModel')
            });
        });
        $('#save').on('click',function () {
            var oCks = xtree3.GetChecked(); //获取全部选中的末级节点checkbox对象，返回的为Array
            for (var i = 0; i < oCks.length; i++) {
                GameList=oCks[0].value;
            }
            let _EncourageList=[];
            $('.goodConvert .goodRules').each(function () {
                if($(this).find('input[name="GameTims"]').val()!=''&&
                    $(this).find('input[name="EncouragePrice"]').val()!=''
                ){
                    _EncourageList.push({
                        'GameTims': $(this).find('input[name="GameTims"]').val(),
                        'EncouragePrice': $(this).find('input[name="EncouragePrice"]').val()
                    });
                }
            });
            let obj={'id':id,
                'MerchID':JSON.parse(xc.getStorage('logMsg')).merchId,
                'StoreID':JSON.parse(xc.getStorage('logMsg')).storeId,
                'WeekType':WeekType,
                'week':week.length>0?week.sort().join('|'):'',
                'StartTime':$('input[name="StartTime"]').val(),
                'EndTime':$('input[name="EndTime"]').val(),
                'StartDate':$('input[name="StartDate"]').val(),
                'EndDate':$('input[name="EndDate"]').val(),
                'ContinueTimes':$('input[name="ContinueTimes"]').val(),
                'Note':$('input[name="Note"]').val(),
                'gameIndex':GameList,
                'EncourageList':_EncourageList,
                'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'
            };

            let parseJson = JSON.stringify(obj);
            $.ajax({
                type:'post',
                url:'/XCCloud/GameEncourage?action=SaveGameEncourage',
                contentType: "application/json; charset=utf-8",
                data:{parasJson: parseJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.result_code == 1) {
                        layer.msg('设置成功',{time:1500},function () {
                            location.reload()
                        })
                    } else {
                        layer.msg(data.result_msg||data.return_msg);
                    }
                }
            })
        });

        table.on('tool(encouragePlay)',function (obj) {
            let data=obj.data;
            let layEvent=obj.event;
            id=data.ID;
            if(layEvent==='del'){
                layer.confirm('确定停用此设置吗？', function(index){
                    let _obj={'id':data.ID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/GameEncourage?action=DelGameEncourage',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('本规则停用成功',{time:1500},function () {
                                    layer.close(index);
                                    location.reload()
                                })
                            } else {
                                layer.msg(data.result_msg);
                            }
                        }
                    })
                });
            }else if(layEvent==='modify'){
                let _obj={'id':data.ID,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type:'post',
                    url:'/XCCloud/GameEncourage?action=GetGameEncourage',
                    contentType: "application/json; charset=utf-8",
                    async:false,
                    data:{parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        if (data.result_code == 1) {
                            let arr=data.result_data;
                            form.val('formtest',{
                                'StartDate':arr.StartDate.substring(0, 10),
                                'EndDate':arr.EndDate.substring(0, 10),
                                'poriedType':arr.WeekType,
                                'ContinueTimes':arr.ContinueTimes,
                                'Note':arr.Note
                            });
                            $('#StartTime').val(generatelD(arr.StartTime.Hours) +':'+generatelD(arr.StartTime.Minutes) +':'+generatelD(arr.StartTime.Seconds));
                            $('#EndTime').val(generatelD(arr.EndTime.Hours) +':'+generatelD(arr.EndTime.Minutes) +':'+generatelD(arr.EndTime.Seconds));
                            checkedArr=[arr.GameIndex];
                            // GameList=arr.GameList;
                            var  obj1={"dictKey":'游戏机类型','enabled':1,'pDicKey':'',"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
                            var url="/XCCloud/Dictionary?action=GetNodes";
                            var parasJson = JSON.stringify(obj1);
                            $.ajax({
                                type: "post",
                                url: url,
                                contentType: "application/json; charset=utf-8",
                                data: {parasJson: parasJson},
                                async:false,
                                success: function (data) {
                                    data = JSON.parse(data);
                                    if(data.result_code==1){
                                        gameArr=data.result_data.children;
                                        gameArr.splice(0,1);
                                        xtree3=new layuiXtree({
                                            elem: 'xtree1'                  //必填
                                            , form: form                    //必填
                                            , data: gameArr//必填
                                            , isopen: true  //加载完毕后的展开状态，默认值：true
                                            , ckall: true    //启用全选功能，默认值：false
                                            , ckallback: function () { } //全选框状态改变后执行的回调函数
                                            ,checkedArr:checkedArr
                                            ,single:true
                                        });
                                    }
                                }
                            });
                            if(arr.Week!=''){
                                let arrWeek= arr.Week.split('|');
                                for(let i in arrWeek){
                                    $('#weekBox').find('input[value="'+arrWeek[i]+'"]').attr('checked',true);
                                }
                            }
                            form.render();
                            week=arr.Week!=''?arr.Week.split('|'):[];
                            WeekType=arr.WeekType;

                            if(arr.EncourageList.length==1){
                                $('.goodRules input[name="GameTims"]').val(arr.EncourageList[0].GameTims);
                                $('.goodRules input[name="EncouragePrice"]').val(arr.EncourageList[0].EncouragePrice);
                            }else if(arr.length>1){
                                for(let i=1;i<arr.EncourageList.length;i++){
                                    $('.goodConvert').append($('body').find($('.goodRules')).eq(0).clone())
                                }
                                for(let i=0;i<arr.EncourageList.length;i++){
                                    $('.goodConvert').find($('.goodRules')).eq(i).find('input[name="GameTims"]').val(arr.EncourageList[i].GameTims);
                                    $('.goodConvert').find($('.goodRules')).eq(i).find('input[name="EncouragePrice"]').val(arr.EncourageList[i].EncouragePrice);
                                }
                            }
                            layer.open({
                                title:'修改设置',
                                type:1,
                                area:'1045px',
                                content:$('#openModel')
                            });
                        } else {
                            layer.msg(data.result_msg);
                        }
                    }
                })


            }
        });
    });
    function generatelD(str) {
        var pad='00';
        return pad.substring(0,2-str.length)+str
    }
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"><i class="layui-icon">&#xe640;</i>删除</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="modify"><i class="layui-icon">&#xe642;</i>修改</a>
</script>
</html>