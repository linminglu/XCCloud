<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>库存管理</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<body>
    <div class="layui-row" style="padding:15px">
    <blockquote class="layui-elem-quote">
        <form class="layui-form layui-form-pane">
            <div class="layui-inline">
                <label class="layui-form-label">选择仓库</label>
                <div class="layui-input-inline">
                    <select name="depotList" id="depotList" lay-filter="depotList"></select>
                </div>
                <div class="layui-input-inline">
                    <button type="button" class="layui-btn layui-btn-normal" id="searchStock"><i class="layui-icon layui-icon-search"></i></button>
                </div>
            </div>

            <div class="layui-inline" style="float:right;">
                <button type="button" class="layui-btn layui-btn-normal" i18n-content="查询模板">查询模板</button>
            </div>
        </form>

        <!--<button type="button" class="layui-btn layui-btn-normal add" i18n-content="新增">新增</button>-->
    </blockquote>
    <table class="layui-hide" id="stockManage" lay-filter="stockManage"></table>
</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    let xc=xcActionSystem.prototype;
    let token=xc.getStorage('token');
    let depotList='';
    layui.use(['form','table','layer'],function () {
        let form=layui.form;
        let table=layui.table;
        let layer=layui.layer;
        initTable(table,[]);
        xc.getDepotDic('','',token,layer,form,'depotList');
        form.on('select(depotList)',function (data) {
            depotList=data.value;
        });
        $('#searchStock').on('click',function () {
            if(depotList==''){
                layer.msg('请先选择仓库！')
            }else {
                var  obj={"depotId":depotList,"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
                var url="/XCCloud/GoodsInfo?action=QueryGoodsStock";
                var parasJson = JSON.stringify(obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: {parasJson: parasJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        // console.log(data);
                        if (data.result_code == "1") {
                            initTable(table,data.result_data);
                        } else {
                            layer.msg(data.result_msg || data.return_msg);
                        }
                    }

                })
            }
        });
        //导出
        table.on('tool(stockManage)',function (obj) {
            let _data=obj.data;
            let layEvent=obj.event;
            if(layEvent==='export'){
                var  obj={"depotId":_data.ID,"userToken":token,"signkey":"1f626576304bf5d95b72ece2222e42c3"};
                var url="/XCCloud/GoodsInfo?action=ExportGoodsUnderWarning";
                var parasJson = JSON.stringify(obj);
                $.ajax({
                    type: "post",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: {parasJson: parasJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        if (data.result_code == "1") {
                            window.open('/XCCloud/Report.aspx?guid='+data.result_data)
                        } else {
                            layer.msg(data.result_msg || data.return_msg);
                        }
                    }

                })
            }
        })
    });
    function initTable(table,arr) {
        table.render({
            elem: '#stockManage'
            , data: arr
            , cellMinWidth: 120 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , cols: [[
                // {type:'ckeckbox'} ,
                  {field: 'ID', title: '商品ID', align: 'center'}
                , {field: 'Barcode', title: '商品条码', align: 'center'}
                , {field: 'GoodTypeStr', title: '商品类型', align: 'center'}
                , {field: 'GoodName', title: '商品名称', align: 'center'}
                , {field: 'Source', title: '添加来源', align: 'center',templet:'#charge'}
                , {field: 'MinValue', title: '库存下限', align: 'center'}
                , {field: 'MaxValue', title: '库存上限', align: 'center'}
                , {field: 'InitialTime', title: '期初时间', align: 'center'}
                , {field: 'InitialValue', title: '期初库存', align: 'center'}
                , {field: 'InitialAvgValue', title: '期初平均成本', align: 'center'}
                , {field: 'InitialTotal', title: '期初库存金额', align: 'center'}
                , {field: 'RemainCount', title: '当前库存', align: 'center'}
                , {field: 'RemainTotal', title: '当前库存金额', align: 'center'}
                , {field: 'AvailableCount', title: '可调拨数', align: 'center'}
                ,{fixed: 'right',title: '操作', width:140, align:'center', toolbar: '#barDemo'}]]
            , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
            , limit: 10
        })
    }
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="export">导出预警商品</a>
</script>
</html>