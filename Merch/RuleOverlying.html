<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="layui/css/layui.css">
    <link rel="stylesheet" href="layui/css/layui_font.css">
</head>
<style>
    #ruleTreeTable tr td{
        text-align: center;}
</style>
<body>
<div class="layui-row" style="padding: 15px;">
   <div class="layui-card layui-col-md12">
       <div class="layui-card-header">优惠叠加规则设定</div>
       <div class="layui-card-body">
           <div class="layui-col-lg3 layui-col-md4 ">
               <ul id="tree"></ul>
           </div>
           <div class="layui-col-lg9 layui-col-md8 ">
               <table class="" id="ruleTreeTable" lay-filter="ruleTreeTable" border="1">

               </table>
           </div>
       </div>
   </div>
    <div class="layui-col-md12" style="text-align:center;">
        <button type="button" class="layui-btn" id="save">保存</button>
    </div>
</div>

</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/storeSystem.js"></script>
<script>
    $(function () {
        let xc=xcActionSystem.prototype;
        let token=xc.getStorage('token');
        let tableData=[];
        layui.use(['form','layer','tree','table'],function () {
            let form=layui.form;
            let layer=layui.layer;
            let tree=layui.tree;
            let table=layui.table;
            let _ruleId='';let _ruleType='';
            let _obj={'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
            let parseJson = JSON.stringify(_obj);
            $.ajax({
                type:'post',
                url:'/XCCloud/RuleOverlying?action=QueryRuleOverlying',
                contentType: "application/json; charset=utf-8",
                data:{parasJson: parseJson},
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.result_code == 1) {
                        console.log(data);
                        let treeData=[
                            {name:'满减规则',spread: true,children:[]},
                            {name:'优惠券',spread: true,children:[
                                    {name:'代金券',spread: true,children:[]},
                                    { name:'折扣券',spread: true,children:[]},
                                    { name:'兑换券',spread: true,children:[]}
                                ]}
                        ];
                        tableData=data.result_data;
                        initTable('ruleTreeTable',tableData);
                        for( let i in tableData){
                            if(tableData[i].typeName=='满减规则'){
                                treeData[0].children.push({
                                    name:tableData[i].name,
                                    id:tableData[i].ruleId,
                                    ruleType:tableData[i].ruleType
                                    ,spread: true
                                })
                            }else {
                                if( tableData[i].couponType==0){

                                    treeData[1].children[0].children.push({
                                        name:tableData[i].name,
                                        id:tableData[i].ruleId,
                                        ruleType:tableData[i].ruleType
                                        ,spread: true
                                    })
                                }else if(tableData[i].couponType==1){
                                    treeData[1].children[1].children.push({
                                        name:tableData[i].name,
                                        id:tableData[i].ruleId,
                                        ruleType:tableData[i].ruleType
                                        ,spread: true
                                    })
                                }else if(tableData[i].couponType==2){
                                    treeData[1].children[2].children.push({
                                        name:tableData[i].name,
                                        id:tableData[i].ruleId,
                                        ruleType:tableData[i].ruleType
                                        ,spread: true
                                    })
                                }

                            }
                        }
                        layui.tree({
                            elem:'#tree',
                            nodes:treeData,
                            click:function (node) {
                                $(this.elem).find('cite').each(function () {
                                    if($(this).text()==node.name){
                                        $(this).parent().css('color','blue')
                                    }else {
                                        $(this).parent().css('color','#333')
                                    }
                                    form.render()
                                });
                                console.log(node)
                                if(node.id!=undefined&&node.ruleType!=undefined){

                                    getRule(node.ruleType,node.id,table);
                                     _ruleId=node.id;
                                    _ruleType=node.ruleType;
                                }else {
                                    _ruleId=''
                                    _ruleType=''
                                }

                            }
                        })
                    } else {
                        layer.msg(data.result_msg);
                    }
                }
            });

            //保存
            $('#save').click(function () {
                let ruleOverlying=[];
                $('#ruleTreeTable').find('input[type="checkbox"]').each(function () {
                    if($(this).attr('checked')){
                        ruleOverlying.push({ 'ruleId':$(this).parents('tr').find('td').eq(2).text(),
                        'ruleType':$(this).parents('tr').find('td').eq(1).text()})
                    }
                });
                console.log(ruleOverlying)
                if(_ruleId!=''){
                    let _obj={'ruleId':_ruleId,'ruleType':_ruleType,'ruleOverlyings':ruleOverlying,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                    let parseJson = JSON.stringify(_obj);
                    $.ajax({
                        type:'post',
                        url:'/XCCloud/RuleOverlying?action=SaveRuleOverlying',
                        contentType: "application/json; charset=utf-8",
                        data:{parasJson: parseJson},
                        success: function (data) {
                            data = JSON.parse(data);
                            if (data.result_code == 1) {
                                layer.msg('保存成功',{time:1500},function () {
                                    location.reload();
                                })
                            }else {
                                layer.msg(data.result_msg||data.return_msg)
                            }
                        }
                     })
                }else {
                    layer.msg('请先在左边选择一条优惠规则')
                }

            })
        });
        let  showRule=function(token,layer,layui,table) {
          let _obj={'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
          let parseJson = JSON.stringify(_obj);
          $.ajax({
              type:'post',
              url:'/XCCloud/RuleOverlying?action=QueryRuleOverlying',
              contentType: "application/json; charset=utf-8",
              data:{parasJson: parseJson},
              success: function (data) {
                  data = JSON.parse(data);
                  if (data.result_code == 1) {
                  let treeData=[
                      {name:'满减规则',spread: true,children:[]},
                      {name:'优惠券',spread: true,children:[
                          {name:'代金券',spread: true,children:[]},
                              { name:'折扣券',spread: true,children:[]},
                                   { name:'兑换券',spread: true,children:[]}
                                   ]}
                                   ];
                  tableData=data.result_data;
                  initTable('ruleTreeTable',tableData);
                  for( let i in tableData){
                     if(tableData[i].typeName=='满减规则'){
                         treeData[0].children.push({
                             name:tableData[i].name,
                             id:tableData[i].ruleId,
                             ruleType:tableData[i].ruleType
                             ,spread: true
                         })
                     }else {
                         if( tableData[i].couponType==0){

                             treeData[1].children[0].children.push({
                                 name:tableData[i].name,
                                 id:tableData[i].ruleId,
                                 ruleType:tableData[i].ruleType
                                 ,spread: true
                             })
                         }else if(tableData[i].couponType==1){
                             treeData[1].children[1].children.push({
                                 name:tableData[i].name,
                                 id:tableData[i].ruleId,
                                 ruleType:tableData[i].ruleType
                                 ,spread: true
                             })
                         }else if(tableData[i].couponType==2){
                             treeData[1].children[2].children.push({
                                 name:tableData[i].name,
                                 id:tableData[i].ruleId,
                                 ruleType:tableData[i].ruleType
                                 ,spread: true
                             })
                         }

                     }
                 }
                  layui.tree({
                    elem:'#tree',
                    nodes:treeData,
                    click:function (node) {
                        if(node.id!=undefined&&node.ruleType!=undefined){
                            getRule(node.ruleType,node.id,table)
                        }
                    }
                })
                  } else {
                      layer.msg(data.result_msg);
                  }
              }
          })
        };
        //格式化表格
        function initTable(id,tableData,checked) {
            $('#'+id).removeClass('layui-hide').html(' <tr style="height: 40px;">' +
                '                   <td style="width: 50px;">选择</td>' +
                '                   <td class="layui-hide">ruleType</td>' +
                '                   <td class="layui-hide">ruleId</td>' +
                '                   <td style="width: 300px;"> 名称</td>' +
                '                   <td style="width: 300px;">规则名称</td>' +
                '                   </tr>' +
                '                   <tr id="clone" class="clone layui-hide" style="height: 40px;">' +
                '                       <td style="width: 50px"><input type="checkbox"></td>' +
                '                       <td class="layui-hide"></td>' +
                '                       <td class="layui-hide"></td>' +
                '                       <td style="width: 300px;"></td>' +
                '                       <td style="width: 300px;"></td>' +
                '                   </tr>');
            for( let i in tableData){
                if(checked){
                    let flag=false;
                    for(let j in checked ){
                        if(tableData[i].ruleType==checked[j].RuleType&&tableData[i].ruleId==checked[j].RuleID){
                            flag=true;
                            break;
                        }
                    }
                    if(flag==true){
                        let cloneTr=$('#clone').clone().attr({'id':''}).removeClass('layui-hide');
                        cloneTr.find('td').eq(0).html('<input type="checkbox" checked>');
                        cloneTr.find('td').eq(1).text(tableData[i].ruleType);
                        cloneTr.find('td').eq(2).text(tableData[i].ruleId);
                        cloneTr.find('td').eq(3).text(tableData[i].name);
                        cloneTr.find('td').eq(4).text(tableData[i].typeName);
                        $('#'+id).append(cloneTr);
                    }else {
                        let cloneTr=$('#clone').clone().attr({'id':''}).removeClass('layui-hide');
                        cloneTr.find('td').eq(1).text(tableData[i].ruleType);
                        cloneTr.find('td').eq(2).text(tableData[i].ruleId);
                        cloneTr.find('td').eq(3).text(tableData[i].name);
                        cloneTr.find('td').eq(4).text(tableData[i].typeName);
                        $('#'+id).append(cloneTr);
                    }
                }else {
                    let cloneTr=$('#clone').clone().attr({'id':''}).removeClass('layui-hide');
                    cloneTr.find('td').eq(1).text(tableData[i].ruleType);
                    cloneTr.find('td').eq(2).text(tableData[i].ruleId);
                    cloneTr.find('td').eq(3).text(tableData[i].name);
                    cloneTr.find('td').eq(4).text(tableData[i].typeName);
                    $('#'+id).append(cloneTr);
                }

            }

        };
        //获取本规则可以叠加的规则
        function getRule(ruleType,ruleId) {
            if(ruleType!=''||ruleId!=''){
                let _obj={'ruleType':ruleType,'ruleId':ruleId,'userToken':token,'signkey':'1f626576304bf5d95b72ece2222e42c3'};
                let parseJson = JSON.stringify(_obj);
                $.ajax({
                    type:'post',
                    url:'/XCCloud/RuleOverlying?action=GetRuleOverlying',
                    contentType: "application/json; charset=utf-8",
                    data:{parasJson: parseJson},
                    success: function (data) {
                        data = JSON.parse(data);
                        if (data.result_code == 1) {
                            let arr=data.result_data;
                            initTable('ruleTreeTable',tableData,arr);
                        } else {
                            layer.msg(data.result_msg||data.return_msg);
                        }
                    }
                })
            }else {
                layer.msg('请检查规则是否设置正确！')
            }

        };
    })
</script>
</html>