<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>吧台</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- 引入样式 -->
	<link rel="stylesheet" href="css/ydui.rem.css">
	<!-- 引入rem自适应类库 -->
	<script src="js/ydui.flexible.js"></script>
	<style>
		[v-cloak] {
			display: none;
		}
	</style>
</head>
<body>
<div id="app" v-cloak>

</div>
<script src="js/jquery-2.1.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/swiper.min.js"></script>
<!-- 引入 Vue -->
<script src="js/vue.js"></script>
<script src="js/axios.min.js"></script>
<script>
    /*var appendNumber = 4;
    var prependNumber = 1;*/
    var swiper = new Swiper('.swiper-container', {
        /*pagination: '.swiper-pagination',*/
        nextButton: '.swiper-button-next',
        prevButton: '.swiper-button-prev',
        slidesPerView: 6,
        centeredSlides: false,
        paginationClickable: true,
        spaceBetween: 30
    });
</script>
<script>
    var sysId = 0; //调用方应用Id
    var versionNo= "0.01"; //版本号
    var htmlFnc = new Vue({
        el: '#app',
        data:{
            salesIS: true,
            tbodyData:tbodyData,
            userToken:'',
            storeId:''
        },
        mounted: function () {
            this.Initialize()
        },
        methods: {
            Initialize:function () {
                var that =this;
                var userToken = getStorage("userToken");      	//获取userToken
                var storeId = getStorage("storeId");       		//storeId
                that.userToken = userToken;
                that.storeId = storeId;

                var obj={
                    sysId: sysId,
                    versionNo: versionNo,
                    deviceToken:that.deviceToken
                };
                axios.post('/xcgamemana/store?action=storeInfoByTerminalNo', obj).then(function (res) {
                    that.$dialog.loading.close();
                    that.msgPrompt(res.data);
                    console.log(res.data);
                    if (res.data.result_code === '1') {
                        that.storeId = res.data.result_data.storeId;
                        that.deviceName = res.data.result_data.deviceName;
                        that.stateName = res.data.result_data.stateName;
                        that.deviceType =res.data.result_data.deviceType;
                        console.log(that.memberToken == "");
                        if(that.memberToken == ""){
                            console.log(111);
                            var memData={
                                sysId: sysId,
                                versionNo: versionNo,
                                storeId: that.storeId,
                                mobileToken: that.mobileToken
                            };
                            axios.post('/xcgamemana/token?action=getMemberToken', memData).then(function (res) {
                                that.$dialog.loading.close();
                                that.msgPrompt(res.data);
                                console.log(res.data);
                                if (res.data.result_code === '1') {
                                    that.memberToken = res.data.result_data.memberToken;
                                    that.balance = res.data.result_data.member.balance;
                                    setStorage("memberToken",memberToken);
                                    that.GetGameInfo();
                                }
                            }).catch(function (err) {
                                that.$dialog.loading.close();
                                console.log(err);
                            });

                        }else {
                            that.GetGameInfo();
                        }
                    }
                }).catch(function (err) {
                    that.$dialog.loading.close();
                    console.log(err);
                })
            },
			getaMeal:function() {			//获取销售列表
				var that = this;
                var obj={"sysId": "0","versionNo": "0.0.0.1",'userToken':that.userToken ,'memberLevelId':"",'foodType':'1','storeId':that.storeId};
                axios.post('/api/XCCloud/Foods.ashx?action=getFoodInfo', obj).then(function (res) {
                    that.$dialog.loading.close();
                    that.msgPrompt(res.data);
                    console.log(res.data);
                    if (res.data.result_code === '1') {
                        that.storeId = res.data.result_data.storeId;
                        that.deviceName = res.data.result_data.deviceName;
                        that.stateName = res.data.result_data.stateName;
                        that.deviceType =res.data.result_data.deviceType;
                        console.log(that.memberToken == "");
                        if(that.memberToken == ""){
                            console.log(111);
                            var memData={
                                sysId: sysId,
                                versionNo: versionNo,
                                storeId: that.storeId,
                                mobileToken: that.mobileToken
                            };
                            axios.post('/xcgamemana/token?action=getMemberToken', memData).then(function (res) {
                                that.$dialog.loading.close();
                                that.msgPrompt(res.data);
                                console.log(res.data);
                                if (res.data.result_code === '1') {
                                    that.memberToken = res.data.result_data.memberToken;
                                    that.balance = res.data.result_data.member.balance;
                                    setStorage("memberToken",memberToken);
                                    that.GetGameInfo();
                                }
                            }).catch(function (err) {
                                that.$dialog.loading.close();
                                console.log(err);
                            });

                        }else {
                            that.GetGameInfo();
                        }
                    }
                }).catch(function (err) {
                    that.$dialog.loading.close();
                    console.log(err);
                });

        var url="/api/XCCloud/Foods.ashx?action=getFoodInfo";           //登录接口
        var parasJson = JSON.stringify(obj);
        if(userToken != null) {
            $.ajax({
                type: "post",
                url: url,
                contentType: "application/json; charset=utf-8",
                data: parasJson,
                success: function (res) {
                    res = JSON.parse(res);
                    console.log(res);
                    if (res.result_code === "1") {
                        $(".sales").find("ul").removeClass("hidden");
                        console.log("成功");
                        tbodyData  = res.result_data;
                        new Vue({
                            el: '#v-for-object',
                            data: {
                                salesIS: true,
                                tbodyData:tbodyData,
                                activeColor: '#17ceca'
                            },
                            methods: {
                                deletePerson: function(index) {
                                    console.log("点击的索引值"+index);
                                    console.log("foodid"+tbodyData[index].foodId );
                                    console.log("shopData长度是否为0"+shopData.length === 0);
                                    if(shopData.length === 0){
                                        shopData .push({
                                            allowPrint: tbodyData[index].allowPrint,
                                            coins: tbodyData[index].coins,
                                            detailsCount: tbodyData[index].detailsCount,
                                            foodId: tbodyData[index].foodId,
                                            foodName: tbodyData[index].foodName,
                                            foodType: tbodyData[index].foodType,
                                            rechargeType: tbodyData[index].rechargeType,
                                            vipPrice: tbodyData[index].vipPrice,
                                            amount: 1,
                                            selected: 'A',
                                            options: [
                                                { text: '单价', value: 'A' },
                                                { text: '代币', value: 'B' },
                                                { text: '彩票', value: 'C' }
                                            ]
                                        });
                                        setTimeout(function () {
                                            $("#v-for-tbody tr:last").addClass('end').siblings().removeClass('end');
                                        },50);
//
                                        console.log("新加的"+shopData)
                                    }else {
                                        for (var i = 0; i < shopData.length; i++){
                                            console.log(tbodyData[index].foodId === shopData[i].foodId);
                                            if (tbodyData[index].foodId === shopData[i].foodId) {
                                                foodId = i;
                                                console.log("遍历的i"+i);
                                                break;
                                            }else {
                                                foodId = ""
                                            }
                                        }
                                        console.log("遍历的i（索引值）"+foodId);
                                        if (foodId === "") {
//                                            shopData .push(tbodyData[i]);
                                            shopData .push({
                                                allowPrint: tbodyData[i].allowPrint,
                                                coins: tbodyData[i].coins,
                                                detailsCount: tbodyData[i].detailsCount,
                                                foodId: tbodyData[i].foodId,
                                                foodName: tbodyData[i].foodName,
                                                foodType: tbodyData[i].foodType,
                                                rechargeType: tbodyData[i].rechargeType,
                                                vipPrice: tbodyData[i].vipPrice,
                                                amount: 1,
                                                selected: 'A',
                                                options: [
                                                    { text: '单价', value: 'A' },
                                                    { text: '代币', value: 'B' }
                                                ]
                                            });
                                            console.log("新加的"+shopData);
                                            setTimeout(function () {
                                                $("#v-for-tbody tr:last").addClass('end').siblings().removeClass('end');
                                            },50);
//
                                            console.log()
                                        }else {
                                            shopData[foodId].amount =shopData[foodId].amount+1;
                                            console.log("原来的"+shopData);
                                            console.log(foodId);
                                        }

                                    }
                                    console.log(shopData)
                                }
                            }
                        });
                    }
                }
            })
        }
    },
            callBackFnc: function (data) {
                this.msgPrompt(data);
                if(data.result_code == "1" && data.result_data.answerOjb.result_code == "1"){
                    this.$dialog.toast({
                        mes:data.result_data.answerOjb.answerMsg,
                        timeout: 1500,
                        icon: 'success'
                    });

                }
            },
            callBackFnc2: function (data) {
                var that = this;
                this.msgPrompt(data);
                if(data.result_code != 1){
                    that.load()
                }
            },
            GetGameInfo:function () {
                var that =this;
                this.$dialog.loading.open('');
                var obj={
                    sysId: sysId,
                    versionNo: versionNo,
                    deviceToken: that.deviceToken,
                    memberToken: that.memberToken
                };
                axios.post('/XCGame/Game?action=GetGameInfo', obj).then(function (res) {
                    that.$dialog.loading.close();
                    that.msgPrompt(res.data);
                    console.log(res.data);
                    if (res.data.result_code === '1') {
                        var gameType = res.data.result_data.gameType;
                        that.gameType =gameType;
                        if (gameType == "投币类"){
                            console.log(res.data.result_data.gameFreeRule != "");
                            if (res.data.result_data.gameFreeRule != "") {
                                var gamePlaylist_ = [];
                                for (var i = 0; i < res.data.result_data.gameFreeRule.length; i++) gamePlaylist_.push({
                                    needCoin: parseInt(res.data.result_data.gameFreeRule[i].needCoin) / parseInt(res.data.result_data.price),
                                    freeCoin: parseInt(res.data.result_data.gameFreeRule[i].freeCoin) / parseInt(res.data.result_data.price),
                                    id: res.data.result_data.gameFreeRule[i].id
                                });
                                console.log(gamePlaylist_);
                                that.gamePlaylist=gamePlaylist_;
                                console.log(that.gamePlaylist);
                            }
                            that.gameGive = true;
                            that.gameGiveActivity = true;
                            that.deleteHide = res.data.result_data.discountPrice;
                            that.price =  res.data.result_data.price;
                            that.discountPrice =  res.data.result_data.discountPrice;
                        } else if (gameType == "博彩类"){
                            console.log(res.data.result_data.gameFreeRule == "");
                            if (res.data.result_data.gameFreeRule != ""){
                                that.discountList=res.data.result_data.gameFreeRule;
                                that.headerBtn=true;
                            }
                            that.gameGaming=true;
                            that.gameGamingActivity=true;
                            that.discountPrice = res.data.result_data.discountPrice;
                            that.gamePlaylist = res.data.result_data.gameFreeRule;
                            that.putCoins =  "";
                        }
                    }
                }).catch(function (err) {
                    that.$dialog.loading.close();
                    console.log(err);
                })
            },
            getFoods:function () {
                var that =this;
                this.$dialog.loading.open('');
                var obj={
                    sysId: sysId,
                    versionNo: versionNo,
                    storeId: that.storeId,
                    memberToken: that.memberToken
                };
                axios.post('/xcgame/Foods?action=getfoods', obj).then(function (res) {
                    that.$dialog.loading.close();
                    that.msgPrompt(res.data);
                    console.log(res.data);
                    if (res.data.result_code === '1') {
                        var newsList = [];
                        console.log(that.gameType );
                        if (that.gameType == "投币类") {
                            for (var i = 0; i < res.data.result_data.length; i++) {
                                if (res.data.result_data[i].sendCoinQuantity == 0) {
                                    var sendCoinQuantity = ""
                                } else {
                                    var sendCoinQuantity = "+" + res.data.result_data[i].sendCoinQuantity
                                }
                                newsList.push({
                                    foodID: res.data.result_data[i].foodID,
                                    foodName: res.data.result_data[i].foodName,
                                    foodPrice: res.data.result_data[i].foodPrice,
                                    coinQuantity: res.data.result_data[i].coinQuantity,
                                    sendCoinQuantity: sendCoinQuantity
                                })
                            }
                            that.list = newsList;
                        } else if (that.gameType == "博彩类") {
                            for (var i = 0; i < res.data.result_data.length; i++) {
                                if (res.data.result_data[i].isQuickFood == 1) {
                                    var indexQuick = i
                                }
                            }
                            console.log(indexQuick);
                            var quickPrice = res.data.result_data[indexQuick].coinQuantity / res.data.result_data[indexQuick].foodPrice;
                            console.log(quickPrice);
                            newsList.push(
                                {
                                    foodID: res.data.result_data[indexQuick].foodID,
                                    foodPrice: 50,
                                    coinQuantity: 50 * quickPrice,
                                    sendCoinQuantity: "",
                                    foodName: res.data.result_data[indexQuick].foodName
                                },
                                {
                                    foodID: res.data.result_data[indexQuick].foodID,
                                    foodPrice: 100,
                                    coinQuantity: 100 * quickPrice,
                                    sendCoinQuantity: "",
                                    foodName: res.data.result_data[indexQuick].foodName
                                },
                                {
                                    foodID: res.data.result_data[indexQuick].foodID,
                                    foodPrice: 200,
                                    coinQuantity: 200 * quickPrice,
                                    sendCoinQuantity: "",
                                    foodName: res.data.result_data[indexQuick].foodName
                                },
                                {
                                    foodID: res.data.result_data[indexQuick].foodID,
                                    foodPrice: 500,
                                    coinQuantity: 500 * quickPrice,
                                    sendCoinQuantity: "",
                                    foodName: res.data.result_data[indexQuick].foodName
                                },
                                {
                                    foodID: res.data.result_data[indexQuick].foodID,
                                    foodPrice: 1000,
                                    coinQuantity: 1000 * quickPrice,
                                    sendCoinQuantity: "",
                                    foodName: res.data.result_data[indexQuick].foodName
                                });
                            that.list = newsList;
                        }
                    }
                }).catch(function (err) {
                    that.$dialog.loading.close();
                    console.log(err);
                })
            },
            gamePlay:function () {  //玩一局
                var that = this;
                if (parseInt(that.balance) >= parseInt(that.deleteHide) && that.stateName =="设备正常") {
                    var putCoinData ={
                        sysId: sysId,
                        versionNo: versionNo,
                        deviceToken: that.deviceToken,
                        memberToken: that.memberToken,
                        coins: that.deleteHide
                    };
                    that.putCoin(putCoinData);
                } else if(that.stateName !="设备正常"){
                    that.$dialog.toast({
                        mes: that.stateName,
                        timeout: 1500,
                        icon: 'error'
                    });
                }else {
                    that.$dialog.toast({
                        mes: "余额不足!",
                        timeout: 1500,
                        icon: 'error'
                    });
                }
            },
            activityPutBtn:function (index) {
                var that =this;
                if(parseInt(that.balance) >= parseInt(that.gamePlaylist[index].needCoin) && that.stateName =="设备正常"){
                    this.$dialog.loading.open('');
                    console.log(that.gamePlaylist[index]);
                    if(that.gameType == "投币类"){
                        var putCoinData ={
                            sysId: sysId,
                            versionNo: versionNo,
                            deviceToken: that.deviceToken,
                            memberToken: that.memberToken,
                            coins: parseInt(that.gamePlaylist[index].needCoin)*parseInt(that.discountPrice),
                            gameRuleId:that.gamePlaylist[index].id
                        };
                    }else if(that.gameType == "博彩类"){
                        var putCoinData ={
                            sysId: sysId,
                            versionNo: versionNo,
                            deviceToken: that.deviceToken,
                            memberToken: that.memberToken,
                            coins: that.gamePlaylist[index].needCoin,
                            gameRuleId:that.gamePlaylist[index].id
                        };
                    }
                    that.putCoin(putCoinData);
                }else if(that.stateName !="设备正常"){
                    that.$dialog.toast({
                        mes: that.stateName,
                        timeout: 1500,
                        icon: 'error'
                    });
                }else {
                    that.$dialog.toast({
                        mes: "余额不足!",
                        timeout: 1500,
                        icon: 'error'
                    });
                }
            },
            putCoin:function (putCoinData) {
                var that =this;
                this.$dialog.loading.open('');
                axios.post('/xcgame/flw_485_coin?action=flw_485_coinPut', putCoinData).then(function (res) {
                    that.$dialog.loading.close();
                    that.msgPrompt(res.data);
                    console.log(res.data);
                    if (res.data.result_code === '1') {
                        that.$dialog.toast({
                            mes: "投币成功！",
                            timeout: 1500,
                            icon: 'success'
                        });
                    }
                }).catch(function (err) {
                    that.$dialog.loading.close();
                    console.log(err);
                })
            },
            gamePutBtn:function () {
                var that = this;
                console.log(that.stateName !="设备正常");
                if (parseInt(that.balance) >= parseInt(that.putCoins) && that.stateName =="设备正常") {
                    var putCoin_ =parseInt(parseInt(that.putCoins)/parseInt(that.discountPrice))*parseInt(that.discountPrice);
                    that.$dialog.confirm({
                        title: '温馨提示!',
                        mes: '确认投币' + putCoin_ + "个",
                        opts: (function () {
                            var putCoinData ={
                                sysId: sysId,
                                versionNo: versionNo,
                                deviceToken: that.deviceToken,
                                memberToken: that.memberToken,
                                coins: putCoin_
                            };
                            that.putCoin(putCoinData);
                        })
                    });
                } else {
                    if(that.putCoins ==""){
                        that.$dialog.toast({
                            mes: "请先输入投币数!",
                            timeout: 1500,
                            icon: 'error'
                        });
                    }else if(that.stateName !="设备正常"){
                        that.$dialog.toast({
                            mes: that.stateName,
                            timeout: 1500,
                            icon: 'error'
                        });
                    }else {
                        that.$dialog.toast({
                            mes: "余额不足!",
                            timeout: 1500,
                            icon: 'error'
                        });
                    }
                }

            },
            ExitCoin: function () {      //退币
                var that = this;
                var obj={
                    sysId: sysId,
                    versionNo: versionNo,
                    deviceToken:that.deviceToken,
                    memberToken: that.memberToken
                };
                if (that.stateName == "设备正常"){
                    this.$dialog.loading.open('');
                    this.$dialog.confirm({
                        title: '温馨提示!',
                        mes: '确认退币!',
                        opts: (function () {
                            axios.post('/xcgame/flw_485_coin?action=flw_485_coinExit', obj).then(function (res) {
                                that.$dialog.loading.close();
                                that.msgPrompt(res.data);
                                console.log(res.data);
                                if (res.data.result_code === '1') {
                                    that.$dialog.toast({
                                        mes: "退币成功！",
                                        timeout: 1500,
                                        icon: 'success'
                                    });
                                }
                            }).catch(function (err) {
                                that.$dialog.loading.close();
                                console.log(err);
                            })
                        })
                    })
                }else {
                    that.$dialog.toast({
                        mes: that.stateName,
                        timeout: 1500,
                        icon: 'error'
                    });
                }
            },
            recharge:function () {
                var that =this;
                that.show2 = true;
                that.getFoods()
            },
            rechargeBtn:function (index) {
                var that =this;
                if (/MicroMessenger/.test(window.navigator.userAgent)) {
                    var openId =getStorage("openId")||"";
                    var obj={
                        sysId: sysId,
                        versionNo: versionNo,
                        mobileToken:that.mobileToken,
                        openId:openId,
                        memberToken:that.memberToken,
                        storeId:that.storeId,
                        buyType:"充值",
                        productName:that.list[index].foodName,
                        foodid:that.list[index].foodID,
                        payPrice:that.list[index].foodPrice,
                        coins:that.list[index].coinQuantity,
                        deviceToken:''
                    };
                    that.$dialog.loading.open();
                    axios.post(url_getPposWxPay, obj).then(function (res) {
                        that.$dialog.loading.close();
                        console.log(res.data);
                        that.msgPrompt(res.data);
                        if (res.data.result_code === '1') {
                            WeixinJSBridge.invoke(
                                'getBrandWCPayRequest',
                                {
                                    "appId": res.data.result_data.appId,     //公众号名称，由商户传入
                                    "timeStamp": res.data.result_data.timeStamp,         //时间戳，自1970年以来的秒数
                                    "nonceStr": res.data.result_data.nonceStr, //随机串
                                    "package": res.data.result_data.package,
                                    "signType": "MD5",         //微信签名方式：
                                    "paySign": res.data.result_data.paySign //微信签名
                                },
                                function (res) {
//                                    alert(JSON.stringify(res));
                                    if (res.err_msg == "get_brand_wcpay_request:ok") {
                                        that.$dialog.toast({
                                            mes: "付款成功!",
                                            timeout:1500,
                                            icon: 'success'
                                        });
                                    }
                                }
                            );
                        }
                    }).catch(function (err) {
                        that.$dialog.loading.close();
                        console.log(err);
                    })
                } else if (/AlipayClient/.test(window.navigator.userAgent)) {
                    var aliId =getStorage("userId")||"";
                    var obj={
                        sysId: sysId,
                        versionNo: versionNo,
                        mobileToken:that.mobileToken,
                        aliId:aliId,
                        memberToken:that.memberToken,
                        storeId:that.storeId,
                        buyType:"充值",
                        productName:that.list[index].foodName,
                        foodid:that.list[index].foodID,
                        payPrice:that.list[index].foodPrice,
                        coins:that.list[index].coinQuantity,
                        deviceToken:''
                    };
                    that.$dialog.loading.open();
                    axios.post("/Payment?action=createAlipayOrder", obj).then(function (res) {
                        that.$dialog.loading.close();
                        console.log(res.data);
                        that.msgPrompt(res.data);
                        if (res.data.result_code === '1') {
                            AlipayJSBridge.call("tradePay", {
                                tradeNO: res.data.result_data.tradeNO
                            }, function(result) {
//                                alert(JSON.stringify(result));
                                if(result.resultCode == "9000"){
                                    that.$dialog.toast({
                                        mes: "付款成功!",
                                        timeout:1500,
                                        icon: 'success'
                                    });
                                }else if(result.resultCode == "6001"){
                                    that.$dialog.toast({
                                        mes: "取消支付!",
                                        timeout:1500,
                                        icon: 'error'
                                    });
                                }else if(result.resultCode == "6002"){
                                    that.$dialog.toast({
                                        mes: "网络出错!",
                                        timeout:1500,
                                        icon: 'error'
                                    });
                                }else {
                                    that.$dialog.toast({
                                        mes: "订单支付失败!",
                                        timeout: 1500,
                                        icon: 'error'
                                    });
                                }
//                            alert(JSON.stringify(result));
                            });
                        }
                    }).catch(function (err) {
                        that.$dialog.loading.close();
                        console.log(err);
                    })
                } else {
                    that.$dialog.toast({
                        mes: "暂不支持此浏览器支付!",
                        timeout:1500,
                        icon: 'error'
                    });
                    console.log("")
                }
            },
            msgPrompt:function (res) {
                if(res.return_code == 0){
                    this.$dialog.toast({
                        mes: res.return_msg,
                        timeout: 1500,
                        icon: 'error'
                    });
                }else if(res.result_code == 0){
                    this.$dialog.toast({
                        mes: res.result_msg,
                        timeout: 1500,
                        icon: 'error'
                    });
                }
            }
        }
    });
    //存储session
    function setStorage(key,value) {
        if(window.localStorage){
            value = JSON.stringify(value); //转化为JSON字符串
            var storage=window.localStorage;
            storage.setItem(key,value);
        }
    }
    //删除session
    function removeStorage(key) {
        if(window.localStorage){
            var storage=window.localStorage;
            storage.removeItem(key);
        }
    }
    //获取session
    function getStorage(key) {
        if(window.localStorage){
            value = JSON.parse(localStorage.getItem(key));
            return value;
        }
    }
</script>
</body>
</html>
