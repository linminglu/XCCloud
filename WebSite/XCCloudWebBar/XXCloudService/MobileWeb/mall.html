<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>莘拍档</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 引入样式 -->
    <link rel="stylesheet" href="css/ydui.rem.css">
    <!-- 引入rem自适应类库 -->
    <script src="js/ydui.flexible.js"></script>
    <style>
        .yd-grids-txt span{display: block;}
        .yd-grids-txt .spanSty{font-weight: 600;margin-top: 0.15rem;}
        .morePlay span{font-size: 0.3rem;line-height: 0.45rem;color: #999;}
        .morePlayImg{display: flex;flex-direction: row;justify-content:center;}
        .morePlayImg img{width: 0.4rem;height: 0.4rem;margin-right: 0.08rem}
        .rechargeImg{display: flex;flex-direction: row;justify-content:center;margin-top: 0.2rem;}
        .rechargeImg img{width: 0.32rem;height: 0.32rem;margin-right: 0.08rem;margin-top: 0.03rem;}
        .cancel{display: flex;flex-direction: row-reverse;justify-content:right;margin-top: 0.2rem;}
        .cancel img{width: 0.36rem;height: 0.36rem;margin-right: 0.3rem;margin-top: 0.1rem;}
        .morePlay span.other{font-size: 0.36rem;color: #1296db;line-height: 0.9rem;}
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <yd-navbar title="莘拍档">
        <router-link to="index.html" slot="left">
            <yd-navbar-back-icon @click.native="goBack">返回</yd-navbar-back-icon>
        </router-link>
        <!-- <router-link slot="right">
            <img slot="icon" class="cardIcon" src="images/addpic.png" >
        </router-link> -->
    </yd-navbar>
    <yd-grids-group :rows="3" title="卡余额">
        <yd-grids-item v-for="item in cardBalanceList">
            <span slot="text">{{item.BalanceName}}</span>
            <span slot="text" class="spanSty">{{item.Quantity}}</span>
        </yd-grids-item>
    </yd-grids-group>
    <yd-grids-group :rows="2" title="快速充值">
        <yd-grids-item v-for="(item,index) in rechargeData" class="morePlay" @click.native="recharge(index)">
            <span slot="text">{{item.FoodName}}</span>
            <div slot="text" class="rechargeImg"><img slot="icon" src='images/money.png'><span slot="text">{{item.Price}}</span></div>
        </yd-grids-item>
        <yd-grids-item class="morePlay" @click.native="modalShow = true">
            <span slot="text" class="other">其他</span>
            <!-- <div slot="text" class="rechargeImg"><span slot="text">&nbsp;</span></div> -->
        </yd-grids-item>
    </yd-grids-group>
    <yd-popup v-model="modalShow" position="bottom" height="40%">
        <div class="cancel"><img slot="icon" src='images/cancel.png' @click="modalShow = false"></div>
        <yd-cell-item>
            <span slot="left">充值数量：</span>
            <yd-input slot="right" required v-model="otherInput" max="20" placeholder="请输入购买数量"></yd-input>
        </yd-cell-item>
        <p>当前购买套餐</p>
        <p>当前购买金额</p>
        <yd-button size="large" type="primary">确认购买</yd-button>
    </yd-popup>
</div>
<!-- 引入 Vue -->
<script src="js/vue.js"></script>
<script src="js/jquery-1.8.3-min.js"></script>
<!-- 引入组件库 -->
<script src="js/ydui.rem.js"></script>
<script src="js/axios.min.js"></script>
<script src="js/alipayjsapi.min.js"></script>
<script>
    var sysId = 0; //调用方应用Id
    var versionNo= "0.89"; //版本号
    var htmlfnc = new Vue({
        el: '#app',
        data:{
            userThirdId:'',
            otherInput:'',
            rechargeData:[],
            cardBalanceList:[],
            modalShow: false,
            show2: false,
        },
        mounted: function () {
            this.Load()
        },
        methods: {
            Load:function () {
                var that =this;
                var userThirdId = getStorage("userThirdId")||"";       //获取第三方令牌
                that.userThirdId = userThirdId;
                this.$dialog.loading.open('');
                var obj={sysId: sysId,versionNo: versionNo,token:that.userThirdId};
                axios.post('/XCCloudH5/Member?action=getMemberInfo', obj).then(function (res) {
                    that.$dialog.loading.close();
                    that.msgPrompt(res.data);
                    console.log(res.data);
                    if (res.data.result_code === '1') {
                        that.cardBalanceList =res.data.result_data.CurrentCardInfo.CardBalanceList;
                    }
                }).catch(function (err) {
                    that.$dialog.loading.close();
                    console.log(err);
                });
                var Recharge ={sysId: sysId,versionNo: versionNo,token:that.userThirdId};
                console.log(Recharge);
                axios.post('/XCCloudH5/Member?action=getRechargeFood',Recharge).then(function (res) {
                    that.$dialog.loading.close();
                    that.msgPrompt(res.data);
                    console.log(res.data);
                    if (res.data.result_code === '1') {
                        // var rechargeData = res.data.result_data
                        // var other = {FoodId:158,FoodName:"其他",FoodType:"other",ImageURL:"",Note:"",Price:""}
                        // rechargeData.push(other)
                        // console.log(rechargeData)
                        // that.rechargeData = rechargeData
                        // console.log(that.rechargeData)
                        that.rechargeData = res.data.result_data
                    }
                }).catch(function (err) {
                    that.$dialog.loading.close();
                    console.log(err);
                });

            },
//          返回
            goBack:function () {
                window.location.href = "index.html";
            },
            recharge:function (index) {
                var that = this;
                this.$dialog.loading.open('');
                var obj={
                    sysId: sysId,
                    versionNo: versionNo,
                    foodId: that.rechargeData[index].foodId,
                    token: that.userThirdId
                };
                console.log(obj);
                axios.post('/XCCloudH5/Member?action=createRechargeOrder', obj).then(function (res) {
                    that.$dialog.loading.close();
                    that.msgPrompt(res.data);
                    console.log(res.data);
                    if (res.data.result_code === '1') {
                       var orderId = res.data.result_data.OrderId;
                       var orderData={
                            sysId: sysId,
                            versionNo: versionNo,
                            orderId: orderId,
                            token: that.userThirdId
                        };
                       axios.post('/Payment?action=getPposWxPay', orderData).then(function (res) {
                            that.$dialog.loading.close();
                            that.msgPrompt(res.data);
                            console.log(res.data);
                            if (res.data.result_code === '1') {
                                WeixinJSBridge.invoke(
                                    'getBrandWCPayRequest',
                                    {
                                        "appId": res.data.result_data.appId,     //公众号名称，由商户传入
                                        "timeStamp": res.data.result_data.timeStamp,         //时间戳，自1970年以来的秒数
                                        "nonceStr": res.data.result_data.nonceStr, //随机串
                                        "package": res.data.result_data.package,
                                        "signType": "MD5",         //微信签名方式：
                                        "paySign": res.data.result_data.paySign //微信签名
                                    },
                                    function (res) {
                                        if (res.err_msg == "get_brand_wcpay_request:ok") {
                                            that.$dialog.toast({
                                                mes: "付款成功!",
                                                timeout:1500,
                                                icon: 'success'
                                            });
                                        }
                                    }
                                );
                            }
                        }).catch(function (err) {
                            that.$dialog.loading.close();
                            console.log(err);
                        })
                    }
                }).catch(function (err) {
                    that.$dialog.loading.close();
                    console.log(err);
                })
            },
            msgPrompt:function (res) {
                if(res.return_code == 0){
                    this.$dialog.toast({
                        mes: res.return_msg,
                        timeout: 1500,
                        icon: 'error'
                    });
                }else if(res.result_code == 0){
                    this.$dialog.toast({
                        mes: res.result_msg,
                        timeout: 1500,
                        icon: 'error'
                    });
                }
            }
        }
    });
    //存储session
    function setStorage(key,value) {
        if(window.localStorage){
            value = JSON.stringify(value); //转化为JSON字符串
            var storage=window.localStorage;
            storage.setItem(key,value);
        }
    }
    //删除session
    function removeStorage(key) {
        if(window.localStorage){
            var storage=window.localStorage;
            storage.removeItem(key);
        }
    }
    //获取session
    function getStorage(key) {
        if(window.localStorage){
            value = JSON.parse(localStorage.getItem(key));
            return value;
        }
    }
</script>
</body>
</html>