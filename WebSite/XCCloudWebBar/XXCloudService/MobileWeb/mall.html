<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>莘拍档</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 引入样式 -->
    <link rel="stylesheet" href="css/ydui.rem.css">
    <!-- 引入rem自适应类库 -->
    <script src="js/ydui.flexible.js"></script>
    <style>
        .payClass {width: 100%; height: 1.5rem; overflow: hidden; position: fixed; display: flex; flex-direction: row;justify-content: space-between; bottom: 0; left: 0; z-index: 2000;background-color: #fff;}
        .payClass img{width: 1.5rem;height: 1.5rem;margin-left: 0.3rem;}
        .total{height: 1.3rem;margin-top:0.1rem;color: red;text-align: center;}
        .total p{line-height: 0.6rem;font-size: 0.4rem;font-weight: 500;}
        .payBtn{width: 2.5rem;margin-right: 0.3rem;}

        .section_image{width: 1rem;height: 1rem;display: inline-block;}
        .section_items{display:flex;flex-direction: row;justify-content: space-between;padding:0.3rem;border-bottom:1px solid #ddd;position: relative;}
        .section_cont{font-size:0.26rem;color:#a9a9a9;min-width: 5em;}
        .section_rig{font-size:0.26rem;color:#a9a9a9}
        .section_rig input{border: none;border-bottom: 1px solid #4cd864;margin-top: 0.2rem;}
        .BuyCoins{display: inline-block;width:0.8rem;height:0.8rem;font-size:0.26rem;border-radius:100%;background:#d24a58;line-height: 0.8rem;color:#fff;text-align: center; margin-top:0.16rem;  }
        .BuyCoinsBlue{background:#1E90FF; margin-left: 0.3rem;}
        .addcard_img{width: 0.8rem;height: 0.8rem;display: inline-block;}
        .addcard{text-align: center;margin: 0.2rem;}
        .hid_cont{ display:flex;flex-direction: row;justify-content: space-between;padding: 0.2rem 0.3rem;  border-bottom:1px solid #ddd;font-size: 0.3rem;color: #999;  }
        .hid_btn{height: 0.5rem;font-size: 0.24rem;line-height: 0.5rem;margin-top: 0.1rem;color: #fff;background: #1E90FF;}
        .hid_contSty{display: flex;flex-direction: row;}
        .hid_contStys{width: 1.6rem;text-align: left;color: #d24a58;}
        .inputNumber{width: 8em;}
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div v-for="(item,index) in list" :key="index">
        <div class='section_items'>
            <img class="section_image" slot="img" src="images/foods.png">
            <div class="section_cont">
                <div class='hid_contSty'>
                    <p class='hid_contStys'>套餐名：</p>
                    <p>{{item.foodName}}</p>
                </div>
                <div class='hid_contSty'>
                    <p class='hid_contStys'>价格：</p>
                    <p>{{item.foodPrice}}</p>
                </div>
                <div class='hid_contSty'>
                    <p class='hid_contStys'>数量：</p>
                    <p>{{item.coinQuantity}}{{item.sendCoinQuantity}}</p>
                </div>
            </div>
            <div class="section_rig">
                <p>请输入购买数量</p>
                <input class="inputNumber" v-model="list[index].inputValue" type="number" @input="valueChange(index)"/>
            </div>
        </div>
    </div>
    <div class="payClass" v-show="payCarShow">
        <img src="images/shoppingcard.png">
        <div class='total'>
            <p>￥{{payn}}</p>
            <p>{{totalCoins}}币</p>
        </div>
        <yd-button class="payBtn" size="large" type="warning" @click.native="payBtn">结算</yd-button>
    </div>
</div>

<!-- 引入 Vue -->
<script src="js/vue.js"></script>
<script src="js/jquery-1.8.3-min.js"></script>
<!-- 引入组件库 -->
<script src="js/ydui.rem.js"></script>
<script src="js/axios.min.js"></script>
<script src="js/alipayjsapi.min.js"></script>
<script>
    var sysId = 0; //调用方应用Id
    var versionNo= "0.89"; //版本号
    var htmlfnc = new Vue({
        el: '#app',
        data:{
            mobileToken:'',
            memberTokens:'',
            payCarShow:false,
            list:[],
            payn:'',
            indexValue:'',
            payNumber:"",
            totalCoins:''
        },
        mounted: function () {
            this.Load()
        },
        methods: {
            Load:function () {
                var that = this;
                var memberTokens = getStorage("memberTokens") ||"";     //获取
                var mobileToken = getStorage("mobileToken") ||"";    //获取
                that.mobileToken = mobileToken;
                that.memberTokens = memberTokens;
                var obj={"sysId": sysId,"versionNo": versionNo,storeId: memberTokens.storeId, memberToken: memberTokens.memberToken};
                this.$dialog.loading.open('');
                if (memberTokens != "") {
                    axios.post("/xcgame/Foods?action=getfoods", obj).then(function (res) {
                        that.$dialog.loading.close();
                        that.msgPrompt(res.data);
                        console.log(res.data);
                        if (res.data.result_code === '1') {
                            var jsonData = [];
                            for (var i = 0; i < res.data.result_data.length; i++) {
                                if (res.data.result_data[i].sendCoinQuantity == 0) {
                                    var sendCoinQuantity = ""
                                } else {
                                    var sendCoinQuantity = "+" + res.data.result_data[i].sendCoinQuantity
                                }
                                jsonData.push({
                                    foodID: res.data.result_data[i].foodID,
                                    foodName: res.data.result_data[i].foodName,
                                    foodPrice: res.data.result_data[i].foodPrice,
                                    coinQuantity: res.data.result_data[i].coinQuantity,
                                    isQuickFood: res.data.result_data[i].isQuickFood,
                                    sendCoin: res.data.result_data[i].sendCoinQuantity,
                                    sendCoinQuantity: sendCoinQuantity,
                                    inputValue:""
                                });
                            }
                            that.list=jsonData;
                            console.log(that.list);
                        }
                    }).catch(function (err) {
                        that.$dialog.loading.close();
                        console.log(err);
                    });
                }

            },
            valueChange:function(index) {
                var that = this;
                for (var i = 0; i < that.list.length; i++) {
                    if(i != index){
                        that.list[i].inputValue =""
                    }
                }
                if(that.list[index].inputValue.length>6){
                    that.list[index].inputValue=that.list[index].inputValue.slice(0,6);
                }
                that.indexValue = index;
                that.payNumber = that.list[index].inputValue;
                if (that.list[index].inputValue.length ==0 || parseInt(that.payNumber) <= 0){
                    that.payCarShow =true;
                    that.payn =0;
                    that.totalCoins = 0;
                } else {
                    that.payCarShow = true;
                    var pay_n = parseInt(that.payNumber) * that.list[index].foodPrice;
                    console.log(that.payNumber);
                    console.log(parseInt(that.list[index].coinQuantity)+that.list[index].sendCoinQuantity);
                    console.log(parseInt(that.list[index].coinQuantity));
                    console.log(that.list[index].sendCoinQuantity);
                    console.log(that.list[index].sendCoin);
                    that.payn = pay_n.toFixed(2);
                    that.totalCoins = parseInt(that.payNumber) * (parseInt(that.list[index].coinQuantity)+that.list[index].sendCoin);
                }
            },
            payBtn: function(e){   //支付按钮
                var that = this;
                if (/MicroMessenger/.test(window.navigator.userAgent)) {
                    var openId =getStorage("openId")||"";
                    var obj={
                        "sysId": sysId,
                        "versionNo": versionNo,
                        mobileToken:that.mobileToken,
                        openId:openId,
                        memberToken:that.memberTokens.memberToken,
                        storeId:that.memberTokens.storeId,
                        buyType:"充值",
                        productName:that.list[that.indexValue].foodName,
                        foodid:that.list[that.indexValue].foodID,
                        payPrice:that.payn,
                        coins:that.totalCoins,
                        deviceToken:''
                    };
                    that.$dialog.loading.open();
                    axios.post("/Payment?action=getPposWxPay", obj).then(function (res) {
                        that.$dialog.loading.close();
                        console.log(res.data);
                        that.msgPrompt(res.data);
                        if (res.data.result_code === '1') {
                            WeixinJSBridge.invoke(
                                'getBrandWCPayRequest',
                                {
                                    "appId": res.data.result_data.appId,     //公众号名称，由商户传入
                                    "timeStamp": res.data.result_data.timeStamp,         //时间戳，自1970年以来的秒数
                                    "nonceStr": res.data.result_data.nonceStr, //随机串
                                    "package": res.data.result_data.package,
                                    "signType": "MD5",         //微信签名方式：
                                    "paySign": res.data.result_data.paySign //微信签名
                                },
                                function (res) {
                                    //                                    alert(JSON.stringify(res));
                                    if (res.err_msg == "get_brand_wcpay_request:ok") {
                                        that.$dialog.toast({
                                            mes: "付款成功!",
                                            timeout:1500,
                                            icon: 'success'
                                        });
                                    }
                                }
                            );
                        }
                    }).catch(function (err) {
                        that.$dialog.loading.close();
                        console.log(err);
                    })
                } else if (/AlipayClient/.test(window.navigator.userAgent)) {
                    var aliId =getStorage("userId")||"";
                    var obj={
                        "sysId": sysId,
                        "versionNo": versionNo,
                        mobileToken:that.mobileToken,
                        aliId:aliId,
                        memberToken:that.memberTokens.memberToken,
                        storeId:that.memberTokens.storeId,
                        buyType:"充值",
                        productName:that.list[that.indexValue].foodName,
                        foodid:that.list[that.indexValue].foodID,
                        payPrice:that.payn,
                        coins:that.totalCoins,
                        deviceToken:''
                    };
                    var obj={"sysId": sysId,"versionNo": versionNo,mobileToken:that.mobileToken,aliId:aliId,memberToken:that.memberTokens.memberToken,storeId:that.memberTokens.storeId,buyType:"充值",productName:that.list[that.indexValue].foodName,foodid:that.list[that.indexValue].foodID,payPrice:that.payn,coins:that.totalCoins};
                    that.$dialog.loading.open();
                    axios.post("/Payment?action=createAlipayOrder", obj).then(function (res) {
                        that.$dialog.loading.close();
                        console.log(res.data);
                        that.msgPrompt(res.data);
                        if (res.data.result_code === '1') {
                            AlipayJSBridge.call("tradePay", {
                                tradeNO: res.data.result_data.tradeNO
                            }, function(result) {
                                //                                alert(JSON.stringify(result));
                                if(result.resultCode == "9000"){
                                    that.$dialog.toast({
                                        mes: "付款成功!",
                                        timeout:1500,
                                        icon: 'success'
                                    });

                                }else if(result.resultCode == "6001"){
                                    that.$dialog.toast({
                                        mes: "取消支付!",
                                        timeout:1500,
                                        icon: 'error'
                                    });
                                }else if(result.resultCode == "6002"){
                                    that.$dialog.toast({
                                        mes: "网络出错!",
                                        timeout:1500,
                                        icon: 'error'
                                    });
                                }else {
                                    that.$dialog.toast({
                                        mes: "订单支付失败!",
                                        timeout: 1500,
                                        icon: 'error'
                                    });
                                }
                                //                            alert(JSON.stringify(result));
                            });
                        }
                    }).catch(function (err) {
                        that.$dialog.loading.close();
                        console.log(err);
                    })
                } else {
                    that.$dialog.toast({
                        mes: "暂不支持此浏览器支付!",
                        timeout:1500,
                        icon: 'error'
                    });
                }
            },
            msgPrompt:function (res) {
                if(res.return_code == 0){
                    this.$dialog.toast({
                        mes: res.return_msg,
                        timeout: 1500,
                        icon: 'error'
                    });
                }else if(res.result_code == 0){
                    this.$dialog.toast({
                        mes: res.result_msg,
                        timeout: 1500,
                        icon: 'error'
                    });
                }
            }
        }
    });
    //存储session
    function setStorage(key,value) {
        if(window.localStorage){
            value = JSON.stringify(value); //转化为JSON字符串
            var storage=window.localStorage;
            storage.setItem(key,value);
        }
    }
    //删除session
    function removeStorage(key) {
        if(window.localStorage){
            var storage=window.localStorage;
            storage.removeItem(key);
        }
    }
    //获取session
    function getStorage(key) {
        if(window.localStorage){
            value = JSON.parse(localStorage.getItem(key));
            return value;
        }
    }
</script>
</body>
</html>