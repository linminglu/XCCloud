<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>boss查看界面</title>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>
<body>
  <div class="layui-row" style="padding: 0 15px">
      <div style="padding-right: 100px;margin: 15px 0;">
          <form action="" class="layui-form layui-form-pane">
              <div class="layui-form-item">
                  <div class="layui-inline">
                      <label class="layui-form-label">门店ID</label>
                      <div class="layui-input-inline">
                          <input type="text" class="layui-input" id="searchId">
                      </div>

                  </div>
                  <div class="layui-inline">
                      <label class="layui-form-label">公司名称</label>
                      <div class="layui-input-inline">
                          <input type="text" class="layui-input" id="searchName">
                      </div>

                  </div>
                  <div class="layui-inline">
                      <label class="layui-form-label">电话</label>
                      <div class="layui-input-inline">
                          <input type="text" class="layui-input" id="searchPhone">
                      </div>
                      <div class="layui-form-mid" style="padding: 0!important;">
                          <button type="button" class="layui-btn" id="searchBtn"><i class="layui-icon">&#xe615;</i></button>
                      </div>
                  </div>
                  <div class="layui-inline">
                      <button type="button" class="layui-btn layui-btn-normal" id="addNew">
                          <i class="layui-icon">&#xe654;</i>新增
                      </button>
                  </div>
              </div>
          </form>
      </div>
      <table class="bossLookTable" lay-filter="bossLookTable"></table>
      <blockquote class="site-text layui-elem-quote">
          <p> 备注：1.部分参数需要进行格式验证，保存信息的时候请确定参数格式正确！2.显示不全的部分可以拖动表头查看，或者单击</p>
      </blockquote>
  </div>

<!--//弹出层-->
<div id="openModel" style="display: none;padding: 15px">
    <form action="" class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">门店ID</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="storeId" placeholder="门店ID/storeId">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">公司名称</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="companyName" placeholder="公司名称/companyName">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">老板姓名</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="bossName" placeholder="老板姓名/boss">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">省份</label>
                <div class="layui-input-inline">
                    <select name="" id="provience" lay-filter="provience">

                    </select>
                </div>
            </div>

            <div class="layui-inline" style="width: 623px">
                <label class="layui-form-label">地址</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" id="adress" placeholder="地址/adress">
                </div>
            </div>
            <br>
            <div class="layui-inline">
                <label class="layui-form-label">手机号码</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="cellPhone" placeholder="手机/cellPhone">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">电话</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="phoneNumber" placeholder="电话/tellphone">
                </div>
            </div>

            <div class="layui-inline">
                <label class="layui-form-label">创建日期</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="createDate" placeholder="创建日期/createDate">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">修改时间</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="modifyDate" placeholder="修改时间/modifyDate">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">管理员</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="manager" placeholder="管理员/devoloper">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">店铺密码</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="storePassword" placeholder="密码/storePassword">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">店铺名称</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="storeName" placeholder="店铺名称/storeName">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">费率(‰)</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="free" placeholder="扣率/free">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">客户类型</label>
                <div class="layui-input-inline">
                    <select lay-filter="storeType" id="storeType">
                        <option>-请选择-</option>
                        <option value="代理商">代理商</option>
                        <option value="终端客户">终端客户</option>
                    </select>
                </div>
            </div>

            <div class="layui-inline" style="width: 623px">
                <label class="layui-form-label">父门店ID</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" id="parentIds" placeholder="多个ID用','隔开">
                </div>
            </div> <br>
           <div class="layui-inline">
               <label class="layui-form-label" style="height: 100px">备注</label>
               <div class="layui-input-inline">
                   <textarea class="layui-textarea" style="width: 835px" id="note"></textarea>
               </div>
           </div>

        </div>
        <div class="btnBox" style="text-align: right;padding-right: 150px;margin: 15px 0;"  >
            <button type="button" class="layui-btn layui-btn-danger" id="cancel"><i class="layui-icon">&#x1006;</i>取消</button>
            <button type="reset" class="layui-btn " id="resetBtn"><i class="layui-icon">&#x1002;</i>重置</button>
            <button type="button" class="layui-btn layui-btn-normal" id="save"><i class="layui-icon">&#xe605;</i>保存</button>
        </div>
    </form>

</div>
</body>
<script src="js/jquery-1.8.3-min.js"></script>
<script src="layui/layui.js"></script>
<script>
    var url = window.location.href;  //获取网址字符串
    var _token = url.substr(url.indexOf("=")+1,url.length);

    //省份
    let _provience='';
    //客户类型
    let _clienttype='';
    $('#resetBtn').click(function () {
        _provience='';
        _clienttype='';
    });
    //初始化表格
     function initTable(token) {
         layui.use('layer',()=>{
          var index = layer.load(2, {shade: false});
         let arr=[]
         let _obj={'userToken':token,'sysId':'0','versionNo': '0.0.0.1'};
         let url='/XCGamemana/store?action=getStoreList';

         let parasJson = JSON.stringify(_obj);
         $.ajax({
             type: "post",
             url: url,
             contentType: "application/json; charset=utf-8",
             data: { parasJson: parasJson },
             success: function (data) {
                 data=JSON.parse(data);

                 if(data.result_code==1){
                     arr=data.result_data;
                     layui.use('table',function () {
                         let table=layui.table;
                         table.render({
                             elem:'.bossLookTable',
                             data:arr,
                             cols:[[
                                 {field:'id', title:'门店ID', align: 'center', sort: true}
                                 ,{field:'companyname',title: '公司名', align: 'center',width:200} //width 支持：数字、百分比和不填写。
                                 ,{field:'province', title: '省', align: 'center'}
                                 ,{field:'address', title: '地址', align: 'center',width:310}
                                 ,{field:'boss', title: '老板姓名', align: 'center'}
                                 ,{field:'phone', title: '手机号码', align: 'center'}
                                 ,{field:'telphone', title: '电话', align: 'center',width:135}
                                 ,{field:'client_level', title: '客户级别', align: 'center'}
                                 ,{field:'clienttype', title: '客户类别', align: 'center'}
                                 ,{field:'updatetime', title: '修改时间', align: 'center',width:185}
                                 // ,{field:'power_due_date', title: 'id', align: 'center'}
                                 ,{field:'note', title: '注释', align: 'center'}
                                 ,{field:'parentid', title: '父门店ID', align: 'center'}
                                 ,{field:'developer', title: '管理员', align: 'center'}
                                 ,{field:'store_password', title: '店密码', align: 'center',width:150}
                                 ,{field:'store_dbname', title: '店名称', align: 'center'}
                                 ,{field:'wxfee', title: '扣率', align: 'center'}
                                 ,{fixed: 'right', title: '操作', width:200, align:'center', toolbar: '#barDemo'}
                             ]],
                             cellMinWidth: 120
                             , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                             , limit: 15

                         })
                     })
                     layui.layer.close(index);
                 }
             }
         })

         })
     }
     initTable(_token);
     function searchBy(token) {
         let storeIdSear=$('#searchId').val();
         let nameSearch=$('#searchName').val();
         let phoneSearch=$('#searchPhone').val();
         let _obj={'userToken':token,'sysId':'0',"versionNo": "0.0.0.1",
             'storeId':storeIdSear,'companyname':nameSearch,'phone':phoneSearch};
         let url='/XCGamemana/store?action=getStoreList';
         let parasJson = JSON.stringify(_obj);
         $.ajax({
             type: "post",
             url: url,
             contentType: "application/json; charset=utf-8",
             data: { parasJson: parasJson },
             success: function (data) {
                 data=JSON.parse(data);

                 if(data.result_code==1){

                  let  arr=data.result_data;

                     layui.use('table',function () {
                         let table=layui.table;
                         table.render({
                             elem:'.bossLookTable',
                             // data:data.Result_Data,
                             data:arr,
                             cols:[[
                                 {field:'id', title:'门店ID', align: 'center', sort: true}
                                 ,{field:'companyname',title: '公司名', align: 'center'} //width 支持：数字、百分比和不填写。
                                 ,{field:'province', title: '省', align: 'center'}
                                 ,{field:'address', title: '地址', align: 'center'}
                                 ,{field:'boss', title: '老板姓名', align: 'center'}
                                 ,{field:'phone', title: '手机号码', align: 'center'}
                                 ,{field:'telphone', title: '电话', align: 'center'}
                                 ,{field:'client_level', title: '客户级别', align: 'center'}
                                 ,{field:'clienttype', title: '客户类别', align: 'center'}
                                 ,{field:'updatetime', title: '修改时间', align: 'center'}
                                 // ,{field:'power_due_date', title: 'id', align: 'center'}
                                 ,{field:'note', title: '注释', align: 'center'}
                                 ,{field:'parentid', title: '父门店ID', align: 'center'}
                                 ,{field:'developer', title: '管理员', align: 'center'}
                                 ,{field:'store_password', title: '店密码', align: 'center'}
                                 ,{field:'store_dbname', title: '店名称', align: 'center'}
                                 ,{field:'wxfee', title: '扣率', align: 'center'}
                                 ,{field:'StoreType', title: '注释', align: 'center'}
                                 ,{field:'State', title: '是否有效', align: 'center'}
                                 ,{fixed: 'right', title: '操作', width:200, align:'center', toolbar: '#barDemo'}
                             ]],
                             cellMinWidth: 120
                             , page: {page: true, limits: [10, 15, 20, 30, 50, 100]}
                             , limit: 15
                         })
                     })
                 }
             }
         })
     }

     //设置省份下拉框
    function setProvience(form,_pro) {
         $('#provience').html('<option>-请选择省份-</option>');
        let arrPro=['北京市','天津市','上海市','重庆市','河北省','山西省','辽宁省','吉林省','黑龙江省','江苏省',
            '浙江省','安徽省','福建省','江西省','山东省','河南省','湖北省','湖南省','广东省','海南省','四川省',
            '贵州省','云南省','陕西省','甘肃省','青海省','台湾省','内蒙古自治区','广西壮族自治区','西藏自治区',
            '宁夏回族自治区','新疆维吾尔自治区','香港特别行政区','澳门特别行政区'];
        for( let i in arrPro){
            $('#provience').append('<option value="'+arrPro[i]+'">'+arrPro[i]+'</option>');
        }
        if(_pro){
            $('#provience').find('option[value="'+_pro+'"]').attr('selected',true);
            _provience=_pro;
        }
        form.render();
    }
    //添加门店
    function addNewStore(layer,_url) {
        let _pId=[];
         if($('#parentIds').val()!=""){
              _pId=$('#parentIds').val().split(',');
             for(var i in _pId){
                 if(_pId[i]==''){
                     _pId.splice(i,1)
                 }
             }
           _pId= _pId.join(',')
         }else {
             _pId='';
         }

      let  parasObj = {
            "userToken": _token,
            "sysId": "0",
            "versionNo": "0.0.0.1",
            "storeId": $('#storeId').val(),
            "companyname": $('#companyName').val(),
            "province":_provience,
            "address":$('#adress').val(),
            "boss": $('#bossName').val(),
            "phone": $('#cellPhone').val(),
            "telphone": $('#phoneNumber').val(),
            "clienttype": _clienttype,
            "power_due_date": $('#modifyDate').val(),
            "note": $('#note').val(),
            "parentid":_pId,
            "developer": $('#manager').val(),
            "store_password": $('#storePassword').val(),
            "wxfee":$('#free').val()
        };
      // console.log(parasObj);
        let url = _url;
        let parasJson = JSON.stringify(parasObj);
        $.ajax({
                type: "post",
                url: url,
                contentType: "application/json; charset=utf-8",
                data: { parasJson: parasJson },
                success: function (data) {
                    data=JSON.parse(data);
                    // console.log(data)
                    if(data.result_code==1){
                        layer.msg('门店添加成功！');
                        layer.closeAll();
                        initTable(_token);
                    }else {
                        layer.msg(data.result_msg)}
                }
            })
    }
//根据店id查询
    function getStoreByid(token,storeId,layer,laydate,form) {
        let parasObj = {
            "userToken": token,
            "sysId": "0",
            "versionNo": "0.0.0.1",
            "storeId": storeId
        };
        let url = "/XCGamemana/store?action=getStore";
        let parasJson = JSON.stringify(parasObj);
        $.ajax({
            type: "post",
            url: url,
            contentType: "application/json; charset=utf-8",
            data: { parasJson: parasJson },
            success: function (data) {
                data=JSON.parse(data);
                if(data.result_code==1){
                    let arr=data.result_data;
                    $('#storeId').val(arr.id);
                    $('#adress').val(arr.address);
                    $('#bossName').val(arr.boss);
                    $('#companyName').val(arr.companyname);
                    laydate.render({
                        elem: '#createDate'
                        ,value: arr.createtime
                    });
                    $('#manager').val(arr.developer);
                    $('#note').val(arr.note);
                    $('#cellPhone').val(arr.phone);
                    setProvience(form,arr.province);
                    _provience=arr.province;
                    $('#storeName').val(arr.store_dbname);
                    $('#storePassword').val(arr.store_password);
                    $('#phoneNumber').val(arr.telphone);
                    $('#parentIds').val(arr.parentid);
                    laydate.render({
                        elem: '#modifyDate'
                        ,value: arr.updatetime
                    });
                    $('#free').val(arr.wxfee);
                    layer.open({
                        type:1,
                        area:'995px',
                        content:$('#openModel')
                    });
                }else {
                    layer.msg('获取数据失败！');
                }
            }
        })

    }
     layui.use(['table','form','laydate'],function () {
         let table=layui.table;
         let form=layui.form;
         let layer=layui.layer;
         let laydate=layui.laydate;
         laydate.render({
             elem: '#createDate'
             ,type: 'datetime'
             ,value: new Date() //参数即为：2018-08-20 20:08:08 的时间戳
         });
         laydate.render({
             elem: '#modifyDate'
             ,type: 'datetime'
             ,value: new Date() //参数即为：2018-08-20 20:08:08 的时间戳
         });
         form.on('select(provience)',function (data) {
             _provience=data.value;
         });
         form.on('select(storeType)',function (data) {
             _clienttype=data.value;
         });
         table.on('tool(bossLookTable)',function (obj) {
             let data = obj.data; //获得当前行数据
             let layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
             let tr = obj.tr; //获得当前行 tr 的DOM对象

             if(layEvent === 'detail'){ //查看
                 getStoreByid(_token,data.id,layer,laydate,form);
                 $('.btnBox').css('display','none')
             }else if(layEvent==='edit'){
                 //弹窗是修改门店
                 if (!window.localStorage) {
                     layui.use('layer', function () {
                         var layer = layui.layer;
                         layer.msg("当前浏览器不支持该网站，为了您的体验请使用最新浏览器！")
                     });
                 } else {
                     var storage = window.localStorage;
                     storage.setItem('add_update', 'update');
                 }
                 getStoreByid(_token,data.id,layer,laydate,form);
                 $('.btnBox').css('display','block')
             }else if(layEvent==='del'){
                 layer.confirm('真的删除行么', function(index){
                     let _obj={'storeId':data.id,'sysId':'0','versionNo':'0.0.0.1','userToken':_token};
                     let url='/XCGamemana/store?action=removeStore';
                     let parasJson = JSON.stringify(_obj);
                     $.ajax({
                         type: "post",
                         url: url,
                         contentType: "application/json; charset=utf-8",
                         data: { parasJson: parasJson },
                         success: function (data) {
                             data=JSON.parse(data);
                             if(data.result_code==1){
                                 obj.del();
                                 layer.close(index);
                             }else {layer.msg('操作失败！')}
                         }
                     })

                 });
             }
         });

         $('#addNew').on('click',function () {
             setProvience(form);
             layer.open({
                 type:1,
                 area:'995px',
                 content:$('#openModel')
             });
             //弹窗是新增门店
             $('.btnBox').css('display','block');
             $('#resetBtn').click();
             if (!window.localStorage) {
                 layui.use('layer', function () {
                     var layer = layui.layer;
                     layer.msg("当前浏览器不支持该网站，为了您的体验请使用最新浏览器！")
                 });
             } else {
                 var storage = window.localStorage;
                 storage.setItem('add_update', 'add');
             }
         });
         $('#save').on('click',function (aaa) {
             let storage = window.localStorage;
             let add_update = localStorage.getItem('add_update');
             if(add_update=='add'){
                 addNewStore(layer,'/XCGamemana/store?action=addStore');
             }else  if(add_update=='update'){
                 addNewStore(layer,'/XCGamemana/store?action=updateStore');
             }
         });
         $('#cancel').on('click',function () {
             layer.closeAll();
         });
         $('#searchBtn').on('click',function () {
             searchBy(_token);
         })
     })
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>
    <a class="layui-btn layui-btn-xs" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
</html>